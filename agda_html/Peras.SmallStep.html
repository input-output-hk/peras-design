<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Peras.SmallStep</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="Agda.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<pre class="Agda"><a id="9" class="Keyword">module</a> <a id="16" href="Peras.SmallStep.html" class="Module">Peras.SmallStep</a> <a id="32" class="Keyword">where</a>
</pre>
<!--
<pre class="Agda"><a id="55" class="Keyword">open</a> <a id="60" class="Keyword">import</a> <a id="67" href="Prelude.AssocList.html" class="Module">Prelude.AssocList</a>
<a id="85" class="Keyword">open</a> <a id="90" class="Keyword">import</a> <a id="97" href="Prelude.DecEq.html" class="Module">Prelude.DecEq</a> <a id="111" class="Keyword">using</a> <a id="117" class="Symbol">(</a><a id="118" href="Prelude.DecEq.html#62" class="Record">DecEq</a><a id="123" class="Symbol">)</a>
<a id="125" class="Keyword">open</a> <a id="130" class="Keyword">import</a> <a id="137" href="Prelude.Default.html" class="Module">Prelude.Default</a> <a id="153" class="Keyword">using</a> <a id="159" class="Symbol">(</a><a id="160" href="Prelude.Default.html#100" class="Record">Default</a><a id="167" class="Symbol">)</a>
<a id="169" class="Keyword">open</a> <a id="174" href="Prelude.Default.html#100" class="Module">Default</a> <a id="182" class="Symbol">⦃...⦄</a>

<a id="189" class="Keyword">open</a> <a id="194" class="Keyword">import</a> <a id="201" href="Prelude.InferenceRules.html" class="Module">Prelude.InferenceRules</a>
<a id="224" class="Keyword">open</a> <a id="229" class="Keyword">import</a> <a id="236" href="Prelude.Init.html" class="Module">Prelude.Init</a> <a id="249" class="Keyword">hiding</a> <a id="256" class="Symbol">(</a><a id="257" href="Data.List.Relation.Binary.Sublist.Setoid.html#1567" class="Function Operator">_⊆_</a><a id="260" class="Symbol">)</a>

<a id="263" class="Keyword">open</a> <a id="268" href="Prelude.Init.html#940" class="Module">Nat</a> <a id="272" class="Keyword">using</a> <a id="278" class="Symbol">(</a><a id="279" href="Data.Nat.Properties.html#3311" class="Function Operator">_≟_</a><a id="282" class="Symbol">;</a> <a id="284" href="Data.Nat.Properties.html#6146" class="Function Operator">_≤?_</a><a id="288" class="Symbol">;</a> <a id="290" href="Data.Nat.Base.html#1477" class="Function Operator">_≤ᵇ_</a><a id="294" class="Symbol">;</a> <a id="296" href="Data.Nat.Properties.html#6212" class="Function Operator">_≥?_</a><a id="300" class="Symbol">;</a> <a id="302" href="Data.Nat.Base.html#7279" class="Function Operator">_%_</a><a id="305" class="Symbol">;</a> <a id="307" href="Data.Nat.Properties.html#10900" class="Function Operator">_&gt;?_</a><a id="311" class="Symbol">;</a> <a id="313" href="Data.Nat.Base.html#3260" class="Record">NonZero</a><a id="320" class="Symbol">)</a>
<a id="322" class="Keyword">open</a> <a id="327" href="Prelude.Init.html#2456" class="Module">L</a> <a id="329" class="Keyword">using</a> <a id="335" class="Symbol">(</a><a id="336" href="Data.List.Base.html#4538" class="Function">concat</a><a id="342" class="Symbol">)</a>
<a id="344" class="Keyword">open</a> <a id="349" href="Prelude.Init.html#2546" class="Module">L.All</a> <a id="355" class="Keyword">using</a> <a id="361" class="Symbol">(</a><a id="362" href="Data.List.Relation.Unary.All.html#1627" class="Datatype">All</a><a id="365" class="Symbol">)</a>
<a id="367" class="Keyword">open</a> <a id="372" href="Prelude.Init.html#2680" class="Module">L.Any</a> <a id="378" class="Keyword">using</a> <a id="384" class="Symbol">(</a><a id="385" href="Data.List.Relation.Unary.Any.html#1163" class="Datatype">Any</a><a id="388" class="Symbol">;</a> <a id="390" href="Data.List.Relation.Unary.Any.html#2138" class="Function Operator">_─_</a><a id="393" class="Symbol">;</a> <a id="395" href="Data.List.Relation.Unary.Any.html#2694" class="Function">any?</a><a id="399" class="Symbol">)</a> <a id="401" class="Keyword">renaming</a> <a id="410" class="Symbol">(</a><a id="411" href="Data.List.Relation.Unary.Any.html#2027" class="Function Operator">_∷=_</a> <a id="416" class="Symbol">to</a> <a id="419" class="Function Operator">_∷ˡ=_</a><a id="424" class="Symbol">)</a>

<a id="427" class="Keyword">open</a> <a id="432" class="Keyword">import</a> <a id="439" href="Peras.Block.html" class="Module">Peras.Block</a>
<a id="451" class="Keyword">open</a> <a id="456" class="Keyword">import</a> <a id="463" href="Peras.Chain.html" class="Module">Peras.Chain</a>
<a id="475" class="Keyword">open</a> <a id="480" class="Keyword">import</a> <a id="487" href="Peras.Crypto.html" class="Module">Peras.Crypto</a>
<a id="500" class="Keyword">open</a> <a id="505" class="Keyword">import</a> <a id="512" href="Peras.Numbering.html" class="Module">Peras.Numbering</a>
<a id="528" class="Keyword">open</a> <a id="533" class="Keyword">import</a> <a id="540" href="Peras.Params.html" class="Module">Peras.Params</a>

<a id="554" class="Keyword">open</a> <a id="559" class="Keyword">import</a> <a id="566" href="Data.List.Relation.Binary.Subset.Propositional.html" class="Module">Data.List.Relation.Binary.Subset.Propositional</a> <a id="613" class="Symbol">{</a><a id="614" class="Argument">A</a> <a id="616" class="Symbol">=</a> <a id="618" href="Peras.Block.html#2807" class="Record">Block</a><a id="623" class="Symbol">}</a> <a id="625" class="Keyword">using</a> <a id="631" class="Symbol">(</a><a id="632" href="Data.List.Relation.Binary.Subset.Setoid.html#825" class="Function Operator">_⊆_</a><a id="635" class="Symbol">)</a>
<a id="637" class="Keyword">open</a> <a id="642" class="Keyword">import</a> <a id="649" href="Data.List.Relation.Binary.Subset.Propositional.html" class="Module">Data.List.Relation.Binary.Subset.Propositional</a> <a id="696" class="Symbol">{</a><a id="697" class="Argument">A</a> <a id="699" class="Symbol">=</a> <a id="701" href="Peras.Block.html#2849" class="Record">Certificate</a><a id="712" class="Symbol">}</a> <a id="714" class="Keyword">renaming</a> <a id="723" class="Symbol">(</a><a id="724" href="Data.List.Relation.Binary.Subset.Setoid.html#825" class="Function Operator">_⊆_</a> <a id="728" class="Symbol">to</a> <a id="731" class="Function Operator">_⊆ᶜ_</a><a id="735" class="Symbol">)</a>

<a id="738" class="Keyword">import</a> <a id="745" href="Haskell.Prelude.html" class="Module">Haskell.Prelude</a> <a id="761" class="Symbol">as</a> <a id="764" class="Module">H</a> <a id="766" class="Comment">-- TODO: drop agda2hs Prelude here</a>

<a id="802" class="Keyword">open</a> <a id="807" href="Peras.Block.html#1872" class="Module">Honesty</a> <a id="815" class="Keyword">public</a>
<a id="822" class="Keyword">open</a> <a id="827" href="Peras.Crypto.html#2161" class="Module">MembershipProof</a> <a id="843" class="Keyword">public</a>
<a id="850" class="Keyword">open</a> <a id="855" href="Peras.Crypto.html#3115" class="Module">Signature</a> <a id="865" class="Keyword">public</a>
<a id="872" class="Keyword">open</a> <a id="877" href="Peras.Numbering.html#1669" class="Module">RoundNumber</a> <a id="889" class="Keyword">public</a>
<a id="896" class="Keyword">open</a> <a id="901" href="Peras.Block.html#1448" class="Module">Party</a>
</pre>-->
<h1 id="small-step-semantics">Small-step semantics</h1>
<p>The small-step semantics of the <strong>Ouroboros Peras</strong>
protocol define the evolution of the global state of the system
modelling <em>honest</em> and <em>adversarial</em> parties. The number
of parties is fixed during the execution of the protocol and the list of
parties has to be provided as a module parameter. In addition the model
is parameterized by the lotteries (for slot leadership and voting
committee membership) as well as the type of the block tree. Furthermore
adversarial parties share generic, adversarial state.</p>
<p>References:</p>
<ul>
<li>Formalizing Nakamoto-Style Proof of Stake, Søren Eller Thomsen and
Bas Spitters</li>
</ul>
<h3 id="parameters">Parameters</h3>
<p>The parameters for the <em>Peras</em> protocol and hash functions are
defined as instance arguments of the module.</p>
<pre class="Agda"><a id="1681" class="Keyword">module</a> <a id="1688" href="Peras.SmallStep.html#1688" class="Module">_</a> <a id="1690" class="Symbol">⦃</a> <a id="1692" href="Peras.SmallStep.html#1692" class="Bound">_</a> <a id="1694" class="Symbol">:</a> <a id="1696" href="Peras.Crypto.html#1994" class="Record">Hashable</a> <a id="1705" href="Peras.Block.html#2807" class="Record">Block</a> <a id="1711" class="Symbol">⦄</a>
         <a id="1722" class="Symbol">⦃</a> <a id="1724" href="Peras.SmallStep.html#1724" class="Bound">_</a> <a id="1726" class="Symbol">:</a> <a id="1728" href="Peras.Crypto.html#1994" class="Record">Hashable</a> <a id="1737" class="Symbol">(</a><a id="1738" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="1743" href="Peras.Block.html#2329" class="Function">Tx</a><a id="1745" class="Symbol">)</a> <a id="1747" class="Symbol">⦄</a>
         <a id="1758" class="Symbol">⦃</a> <a id="1760" href="Peras.SmallStep.html#1760" class="Bound">_</a> <a id="1762" class="Symbol">:</a> <a id="1764" href="Peras.Params.html#166" class="Record">Params</a> <a id="1771" class="Symbol">⦄</a>
         <a id="1782" class="Symbol">⦃</a> <a id="1784" href="Peras.SmallStep.html#1784" class="Bound">_</a> <a id="1786" class="Symbol">:</a> <a id="1788" href="Peras.Chain.html#2526" class="Record">Network</a> <a id="1796" class="Symbol">⦄</a>
         <a id="1807" class="Symbol">⦃</a> <a id="1809" href="Peras.SmallStep.html#1809" class="Bound">_</a> <a id="1811" class="Symbol">:</a> <a id="1813" href="Peras.Chain.html#2260" class="Record">Postulates</a> <a id="1824" class="Symbol">⦄</a>

         <a id="1836" class="Keyword">where</a>
</pre>
The block tree, resp. the validity of the chain is defined with respect
of the parameters.
<pre class="Agda">  <a id="1951" class="Keyword">open</a> <a id="1956" href="Peras.Crypto.html#1994" class="Module">Hashable</a> <a id="1965" class="Symbol">⦃...⦄</a>
  <a id="1973" class="Keyword">open</a> <a id="1978" href="Peras.Params.html#166" class="Module">Params</a> <a id="1985" class="Symbol">⦃...⦄</a>
  <a id="1993" class="Keyword">open</a> <a id="1998" href="Peras.Chain.html#2526" class="Module">Network</a> <a id="2006" class="Symbol">⦃...⦄</a>
  <a id="2014" class="Keyword">open</a> <a id="2019" href="Peras.Chain.html#2260" class="Module">Postulates</a> <a id="2030" class="Symbol">⦃...⦄</a>
</pre>
<h4 id="messages">Messages</h4>
Messages for sending and receiving chains and votes. Note, in the
<em>Peras</em> protocol certificates are not diffused explicitly.
<pre class="Agda">  <a id="2190" class="Keyword">data</a> <a id="2195" href="Peras.SmallStep.html#2195" class="Datatype">Message</a> <a id="2203" class="Symbol">:</a> <a id="2205" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="2210" class="Keyword">where</a>
    <a id="2220" href="Peras.SmallStep.html#2220" class="InductiveConstructor">ChainMsg</a> <a id="2229" class="Symbol">:</a> <a id="2231" class="Symbol">{</a><a id="2232" href="Peras.SmallStep.html#2232" class="Bound">c</a> <a id="2234" class="Symbol">:</a> <a id="2236" href="Peras.Chain.html#3111" class="Function">Chain</a><a id="2241" class="Symbol">}</a> <a id="2243" class="Symbol">→</a> <a id="2245" href="Peras.Chain.html#6113" class="Datatype">ValidChain</a> <a id="2256" href="Peras.SmallStep.html#2232" class="Bound">c</a> <a id="2258" class="Symbol">→</a> <a id="2260" href="Peras.SmallStep.html#2195" class="Datatype">Message</a>
    <a id="2272" href="Peras.SmallStep.html#2272" class="InductiveConstructor">VoteMsg</a> <a id="2280" class="Symbol">:</a> <a id="2282" class="Symbol">{</a><a id="2283" href="Peras.SmallStep.html#2283" class="Bound">v</a> <a id="2285" class="Symbol">:</a> <a id="2287" href="Peras.Chain.html#1472" class="Record">Vote</a><a id="2291" class="Symbol">}</a> <a id="2293" class="Symbol">→</a> <a id="2295" href="Peras.Chain.html#2648" class="Function">ValidVote</a> <a id="2305" href="Peras.SmallStep.html#2283" class="Bound">v</a> <a id="2307" class="Symbol">→</a> <a id="2309" href="Peras.SmallStep.html#2195" class="Datatype">Message</a>
</pre>
Messages can be delayed by a number of slots
<pre class="Agda">  <a id="2376" href="Peras.SmallStep.html#2376" class="Function">Delay</a> <a id="2382" class="Symbol">=</a> <a id="2384" href="Data.Fin.Base.html#1154" class="Datatype">Fin</a> <a id="2388" class="Symbol">(</a><a id="2389" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="2393" class="Symbol">(</a><a id="2394" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="2398" href="Peras.Chain.html#2559" class="Field">Δ</a><a id="2399" class="Symbol">))</a>

  <a id="2405" class="Keyword">pattern</a> <a id="2413" href="Peras.SmallStep.html#2413" class="InductiveConstructor">𝟘</a> <a id="2415" class="Symbol">=</a> <a id="2417" href="Data.Fin.Base.html#1176" class="InductiveConstructor">fzero</a>
  <a id="2425" class="Keyword">pattern</a> <a id="2433" href="Peras.SmallStep.html#2433" class="InductiveConstructor">𝟙</a> <a id="2435" class="Symbol">=</a> <a id="2437" href="Data.Fin.Base.html#1197" class="InductiveConstructor">fsuc</a> <a id="2442" href="Data.Fin.Base.html#1176" class="InductiveConstructor">fzero</a>
  <a id="2450" class="Keyword">pattern</a> <a id="2458" href="Peras.SmallStep.html#2458" class="InductiveConstructor">𝟚</a> <a id="2460" class="Symbol">=</a> <a id="2462" href="Data.Fin.Base.html#1197" class="InductiveConstructor">fsuc</a> <a id="2467" class="Symbol">(</a><a id="2468" href="Data.Fin.Base.html#1197" class="InductiveConstructor">fsuc</a> <a id="2473" href="Data.Fin.Base.html#1176" class="InductiveConstructor">fzero</a><a id="2478" class="Symbol">)</a>
</pre>
Messages are put into an envelope and assigned to a party. The message
can be delayed.
<pre class="Agda">  <a id="2581" class="Keyword">record</a> <a id="2588" href="Peras.SmallStep.html#2588" class="Record">Envelope</a> <a id="2597" class="Symbol">:</a> <a id="2599" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="2604" class="Keyword">where</a>
    <a id="2614" class="Keyword">constructor</a> <a id="2626" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">⦅_,_,_,_⦆</a>
    <a id="2640" class="Keyword">field</a>
      <a id="2652" href="Peras.SmallStep.html#2652" class="Field">partyId</a> <a id="2660" class="Symbol">:</a> <a id="2662" href="Peras.Block.html#1264" class="Function">PartyId</a>
      <a id="2676" href="Peras.SmallStep.html#2676" class="Field">honesty</a> <a id="2684" class="Symbol">:</a> <a id="2686" href="Peras.Block.html#1872" class="Datatype">Honesty</a> <a id="2694" href="Peras.SmallStep.html#2652" class="Field">partyId</a>
      <a id="2708" href="Peras.SmallStep.html#2708" class="Field">message</a> <a id="2716" class="Symbol">:</a> <a id="2718" href="Peras.SmallStep.html#2195" class="Datatype">Message</a>
      <a id="2732" href="Peras.SmallStep.html#2732" class="Field">delay</a> <a id="2738" class="Symbol">:</a> <a id="2740" href="Peras.SmallStep.html#2376" class="Function">Delay</a>

  <a id="2749" class="Keyword">open</a> <a id="2754" href="Peras.SmallStep.html#2588" class="Module">Envelope</a>
</pre>
<h4 id="block-tree">Block-tree</h4>
A block-tree is defined by properties - an implementation of the
block-tree has to fulfil all the properties mentioned below:
<pre class="Agda">  <a id="2920" class="Keyword">record</a> <a id="2927" href="Peras.SmallStep.html#2927" class="Record">IsTreeType</a> <a id="2938" class="Symbol">{</a><a id="2939" href="Peras.SmallStep.html#2939" class="Bound">T</a> <a id="2941" class="Symbol">:</a> <a id="2943" href="Agda.Primitive.html#388" class="Primitive">Type</a><a id="2947" class="Symbol">}</a>
                    <a id="2969" class="Symbol">(</a><a id="2970" href="Peras.SmallStep.html#2970" class="Bound">tree₀</a> <a id="2976" class="Symbol">:</a> <a id="2978" href="Peras.SmallStep.html#2939" class="Bound">T</a><a id="2979" class="Symbol">)</a>
                    <a id="3001" class="Symbol">(</a><a id="3002" href="Peras.SmallStep.html#3002" class="Bound">addChain</a> <a id="3011" class="Symbol">:</a> <a id="3013" href="Peras.SmallStep.html#2939" class="Bound">T</a> <a id="3015" class="Symbol">→</a> <a id="3017" class="Symbol">{</a><a id="3018" href="Peras.SmallStep.html#3018" class="Bound">c</a> <a id="3020" class="Symbol">:</a> <a id="3022" href="Peras.Chain.html#3111" class="Function">Chain</a><a id="3027" class="Symbol">}</a> <a id="3029" class="Symbol">→</a> <a id="3031" href="Peras.Chain.html#6113" class="Datatype">ValidChain</a> <a id="3042" href="Peras.SmallStep.html#3018" class="Bound">c</a> <a id="3044" class="Symbol">→</a> <a id="3046" href="Peras.SmallStep.html#2939" class="Bound">T</a><a id="3047" class="Symbol">)</a>
                    <a id="3069" class="Symbol">(</a><a id="3070" href="Peras.SmallStep.html#3070" class="Bound">chains</a> <a id="3077" class="Symbol">:</a> <a id="3079" href="Peras.SmallStep.html#2939" class="Bound">T</a> <a id="3081" class="Symbol">→</a> <a id="3083" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="3088" href="Peras.Chain.html#3111" class="Function">Chain</a><a id="3093" class="Symbol">)</a>
                    <a id="3115" class="Symbol">(</a><a id="3116" href="Peras.SmallStep.html#3116" class="Bound">preferredChain</a> <a id="3131" class="Symbol">:</a> <a id="3133" href="Peras.SmallStep.html#2939" class="Bound">T</a> <a id="3135" class="Symbol">→</a> <a id="3137" href="Peras.Chain.html#3111" class="Function">Chain</a><a id="3142" class="Symbol">)</a>
                    <a id="3164" class="Symbol">(</a><a id="3165" href="Peras.SmallStep.html#3165" class="Bound">addVote</a> <a id="3173" class="Symbol">:</a> <a id="3175" href="Peras.SmallStep.html#2939" class="Bound">T</a> <a id="3177" class="Symbol">→</a> <a id="3179" class="Symbol">{</a><a id="3180" href="Peras.SmallStep.html#3180" class="Bound">v</a> <a id="3182" class="Symbol">:</a> <a id="3184" href="Peras.Chain.html#1472" class="Record">Vote</a><a id="3188" class="Symbol">}</a> <a id="3190" class="Symbol">→</a> <a id="3192" href="Peras.Chain.html#2648" class="Function">ValidVote</a> <a id="3202" href="Peras.SmallStep.html#3180" class="Bound">v</a> <a id="3204" class="Symbol">→</a> <a id="3206" href="Peras.SmallStep.html#2939" class="Bound">T</a><a id="3207" class="Symbol">)</a>
                    <a id="3229" class="Symbol">(</a><a id="3230" href="Peras.SmallStep.html#3230" class="Bound">votes</a> <a id="3236" class="Symbol">:</a> <a id="3238" href="Peras.SmallStep.html#2939" class="Bound">T</a> <a id="3240" class="Symbol">→</a> <a id="3242" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="3247" href="Peras.Chain.html#1472" class="Record">Vote</a><a id="3251" class="Symbol">)</a>
                    <a id="3273" class="Symbol">(</a><a id="3274" href="Peras.SmallStep.html#3274" class="Bound">certs</a> <a id="3280" class="Symbol">:</a> <a id="3282" href="Peras.SmallStep.html#2939" class="Bound">T</a> <a id="3284" class="Symbol">→</a> <a id="3286" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="3291" href="Peras.Block.html#2849" class="Record">Certificate</a><a id="3302" class="Symbol">)</a>
                    <a id="3324" class="Symbol">(</a><a id="3325" href="Peras.SmallStep.html#3325" class="Bound">cert₀</a> <a id="3331" class="Symbol">:</a> <a id="3333" href="Peras.Block.html#2849" class="Record">Certificate</a><a id="3344" class="Symbol">)</a>
         <a id="3355" class="Symbol">:</a> <a id="3357" href="Agda.Primitive.html#388" class="Primitive">Type₁</a> <a id="3363" class="Keyword">where</a>

    <a id="3374" class="Keyword">field</a>
</pre>
Properties that must hold with respect to chains, certificates and
votes.
<pre class="Agda">      <a id="3472" href="Peras.SmallStep.html#3472" class="Field">instantiated</a> <a id="3485" class="Symbol">:</a>
        <a id="3495" href="Peras.SmallStep.html#3116" class="Bound">preferredChain</a> <a id="3510" href="Peras.SmallStep.html#2970" class="Bound">tree₀</a> <a id="3516" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="3518" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>

      <a id="3528" href="Peras.SmallStep.html#3528" class="Field">instantiated-certs</a> <a id="3547" class="Symbol">:</a>
        <a id="3557" href="Peras.SmallStep.html#3274" class="Bound">certs</a> <a id="3563" href="Peras.SmallStep.html#2970" class="Bound">tree₀</a> <a id="3569" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="3571" href="Peras.SmallStep.html#3325" class="Bound">cert₀</a> <a id="3577" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="3579" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>

      <a id="3589" href="Peras.SmallStep.html#3589" class="Field">instantiated-votes</a> <a id="3608" class="Symbol">:</a>
        <a id="3618" href="Peras.SmallStep.html#3230" class="Bound">votes</a> <a id="3624" href="Peras.SmallStep.html#2970" class="Bound">tree₀</a> <a id="3630" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="3632" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>

      <a id="3642" href="Peras.SmallStep.html#3642" class="Field">extendable-chain</a> <a id="3659" class="Symbol">:</a> <a id="3661" class="Symbol">∀</a> <a id="3663" class="Symbol">(</a><a id="3664" href="Peras.SmallStep.html#3664" class="Bound">t</a> <a id="3666" class="Symbol">:</a> <a id="3668" href="Peras.SmallStep.html#2939" class="Bound">T</a><a id="3669" class="Symbol">)</a> <a id="3671" class="Symbol">{</a><a id="3672" href="Peras.SmallStep.html#3672" class="Bound">c</a> <a id="3674" class="Symbol">:</a> <a id="3676" href="Peras.Chain.html#3111" class="Function">Chain</a><a id="3681" class="Symbol">}</a> <a id="3683" class="Symbol">(</a><a id="3684" href="Peras.SmallStep.html#3684" class="Bound">vc</a> <a id="3687" class="Symbol">:</a> <a id="3689" href="Peras.Chain.html#6113" class="Datatype">ValidChain</a> <a id="3700" href="Peras.SmallStep.html#3672" class="Bound">c</a><a id="3701" class="Symbol">)</a>
        <a id="3711" class="Symbol">→</a> <a id="3713" href="Peras.SmallStep.html#3274" class="Bound">certs</a> <a id="3719" class="Symbol">(</a><a id="3720" href="Peras.SmallStep.html#3002" class="Bound">addChain</a> <a id="3729" href="Peras.SmallStep.html#3664" class="Bound">t</a> <a id="3731" href="Peras.SmallStep.html#3684" class="Bound">vc</a><a id="3733" class="Symbol">)</a> <a id="3735" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="3737" href="Haskell.Prim.Foldable.html#528" class="Field">H.foldr</a> <a id="3745" href="Peras.Chain.html#3286" class="Function">insertCert</a> <a id="3756" class="Symbol">(</a><a id="3757" href="Peras.SmallStep.html#3274" class="Bound">certs</a> <a id="3763" href="Peras.SmallStep.html#3664" class="Bound">t</a><a id="3764" class="Symbol">)</a> <a id="3766" class="Symbol">(</a><a id="3767" href="Peras.Chain.html#3194" class="Function">certsFromChain</a> <a id="3782" href="Peras.SmallStep.html#3672" class="Bound">c</a><a id="3783" class="Symbol">)</a>

<a id="3786" class="Comment">{-
      valid : ∀ (t : T)
        → ValidChain (preferredChain t)
-}</a>

      <a id="3863" href="Peras.SmallStep.html#3863" class="Field">optimal</a> <a id="3871" class="Symbol">:</a> <a id="3873" class="Symbol">∀</a> <a id="3875" class="Symbol">(</a><a id="3876" href="Peras.SmallStep.html#3876" class="Bound">c</a> <a id="3878" class="Symbol">:</a> <a id="3880" href="Peras.Chain.html#3111" class="Function">Chain</a><a id="3885" class="Symbol">)</a> <a id="3887" class="Symbol">(</a><a id="3888" href="Peras.SmallStep.html#3888" class="Bound">t</a> <a id="3890" class="Symbol">:</a> <a id="3892" href="Peras.SmallStep.html#2939" class="Bound">T</a><a id="3893" class="Symbol">)</a>
        <a id="3903" class="Symbol">→</a> <a id="3905" class="Keyword">let</a>
            <a id="3921" href="Peras.SmallStep.html#3921" class="Bound">b</a> <a id="3923" class="Symbol">=</a> <a id="3925" href="Peras.SmallStep.html#3116" class="Bound">preferredChain</a> <a id="3940" href="Peras.SmallStep.html#3888" class="Bound">t</a>
            <a id="3954" href="Peras.SmallStep.html#3954" class="Bound">cts</a> <a id="3958" class="Symbol">=</a> <a id="3960" href="Peras.SmallStep.html#3274" class="Bound">certs</a> <a id="3966" href="Peras.SmallStep.html#3888" class="Bound">t</a>
          <a id="3978" class="Keyword">in</a>
          <a id="3991" href="Peras.Chain.html#6113" class="Datatype">ValidChain</a> <a id="4002" href="Peras.SmallStep.html#3876" class="Bound">c</a>
        <a id="4012" class="Symbol">→</a> <a id="4014" href="Peras.SmallStep.html#3876" class="Bound">c</a> <a id="4016" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="4018" href="Peras.SmallStep.html#3070" class="Bound">chains</a> <a id="4025" href="Peras.SmallStep.html#3888" class="Bound">t</a>
        <a id="4035" class="Symbol">→</a> <a id="4037" href="Peras.Chain.html#5590" class="Function Operator">∥</a> <a id="4039" href="Peras.SmallStep.html#3876" class="Bound">c</a> <a id="4041" href="Peras.Chain.html#5590" class="Function Operator">∥</a> <a id="4043" href="Peras.SmallStep.html#3954" class="Bound">cts</a> <a id="4047" href="Data.Nat.Base.html#1691" class="Datatype Operator">≤</a> <a id="4049" href="Peras.Chain.html#5590" class="Function Operator">∥</a> <a id="4051" href="Peras.SmallStep.html#3921" class="Bound">b</a> <a id="4053" href="Peras.Chain.html#5590" class="Function Operator">∥</a> <a id="4055" href="Peras.SmallStep.html#3954" class="Bound">cts</a>

      <a id="4066" href="Peras.SmallStep.html#4066" class="Field">self-contained</a> <a id="4081" class="Symbol">:</a> <a id="4083" class="Symbol">∀</a> <a id="4085" class="Symbol">(</a><a id="4086" href="Peras.SmallStep.html#4086" class="Bound">t</a> <a id="4088" class="Symbol">:</a> <a id="4090" href="Peras.SmallStep.html#2939" class="Bound">T</a><a id="4091" class="Symbol">)</a>
        <a id="4101" class="Symbol">→</a> <a id="4103" href="Peras.SmallStep.html#3116" class="Bound">preferredChain</a> <a id="4118" href="Peras.SmallStep.html#4086" class="Bound">t</a> <a id="4120" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="4122" href="Peras.SmallStep.html#3070" class="Bound">chains</a> <a id="4129" href="Peras.SmallStep.html#4086" class="Bound">t</a>

<a id="4132" class="Comment">{-
      valid-votes : ∀ (t : T)
        → All ValidVote (votes t)
-}</a>

      <a id="4209" href="Peras.SmallStep.html#4209" class="Field">unique-votes</a> <a id="4222" class="Symbol">:</a> <a id="4224" class="Symbol">∀</a> <a id="4226" class="Symbol">(</a><a id="4227" href="Peras.SmallStep.html#4227" class="Bound">t</a> <a id="4229" class="Symbol">:</a> <a id="4231" href="Peras.SmallStep.html#2939" class="Bound">T</a><a id="4232" class="Symbol">)</a> <a id="4234" class="Symbol">{</a><a id="4235" href="Peras.SmallStep.html#4235" class="Bound">v</a> <a id="4237" class="Symbol">:</a> <a id="4239" href="Peras.Chain.html#1472" class="Record">Vote</a><a id="4243" class="Symbol">}</a> <a id="4245" class="Symbol">(</a><a id="4246" href="Peras.SmallStep.html#4246" class="Bound">vv</a> <a id="4249" class="Symbol">:</a> <a id="4251" href="Peras.Chain.html#2648" class="Function">ValidVote</a> <a id="4261" href="Peras.SmallStep.html#4235" class="Bound">v</a><a id="4262" class="Symbol">)</a>
        <a id="4272" class="Symbol">→</a> <a id="4274" class="Keyword">let</a> <a id="4278" href="Peras.SmallStep.html#4278" class="Bound">vs</a> <a id="4281" class="Symbol">=</a> <a id="4283" href="Peras.SmallStep.html#3230" class="Bound">votes</a> <a id="4289" href="Peras.SmallStep.html#4227" class="Bound">t</a>
          <a id="4301" class="Keyword">in</a>
          <a id="4314" href="Peras.SmallStep.html#4235" class="Bound">v</a> <a id="4316" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="4318" href="Peras.SmallStep.html#4278" class="Bound">vs</a>
        <a id="4329" class="Symbol">→</a> <a id="4331" href="Peras.SmallStep.html#4278" class="Bound">vs</a> <a id="4334" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="4336" href="Peras.SmallStep.html#3230" class="Bound">votes</a> <a id="4342" class="Symbol">(</a><a id="4343" href="Peras.SmallStep.html#3165" class="Bound">addVote</a> <a id="4351" href="Peras.SmallStep.html#4227" class="Bound">t</a> <a id="4353" href="Peras.SmallStep.html#4246" class="Bound">vv</a><a id="4355" class="Symbol">)</a>

      <a id="4364" href="Peras.SmallStep.html#4364" class="Field">no-equivocations</a> <a id="4381" class="Symbol">:</a> <a id="4383" class="Symbol">∀</a> <a id="4385" class="Symbol">(</a><a id="4386" href="Peras.SmallStep.html#4386" class="Bound">t</a> <a id="4388" class="Symbol">:</a> <a id="4390" href="Peras.SmallStep.html#2939" class="Bound">T</a><a id="4391" class="Symbol">)</a> <a id="4393" class="Symbol">{</a><a id="4394" href="Peras.SmallStep.html#4394" class="Bound">v</a> <a id="4396" class="Symbol">:</a> <a id="4398" href="Peras.Chain.html#1472" class="Record">Vote</a><a id="4402" class="Symbol">}</a> <a id="4404" class="Symbol">(</a><a id="4405" href="Peras.SmallStep.html#4405" class="Bound">vv</a> <a id="4408" class="Symbol">:</a> <a id="4410" href="Peras.Chain.html#2648" class="Function">ValidVote</a> <a id="4420" href="Peras.SmallStep.html#4394" class="Bound">v</a><a id="4421" class="Symbol">)</a>
        <a id="4431" class="Symbol">→</a> <a id="4433" class="Keyword">let</a> <a id="4437" href="Peras.SmallStep.html#4437" class="Bound">vs</a> <a id="4440" class="Symbol">=</a> <a id="4442" href="Peras.SmallStep.html#3230" class="Bound">votes</a> <a id="4448" href="Peras.SmallStep.html#4386" class="Bound">t</a>
          <a id="4460" class="Keyword">in</a>
          <a id="4473" href="Data.List.Relation.Unary.Any.html#1163" class="Datatype">Any</a> <a id="4477" class="Symbol">(</a><a id="4478" href="Peras.SmallStep.html#4394" class="Bound">v</a> <a id="4480" href="Peras.Chain.html#2931" class="Datatype Operator">∻_</a><a id="4482" class="Symbol">)</a> <a id="4484" href="Peras.SmallStep.html#4437" class="Bound">vs</a>
        <a id="4495" class="Symbol">→</a> <a id="4497" href="Peras.SmallStep.html#4437" class="Bound">vs</a> <a id="4500" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="4502" href="Peras.SmallStep.html#3230" class="Bound">votes</a> <a id="4508" class="Symbol">(</a><a id="4509" href="Peras.SmallStep.html#3165" class="Bound">addVote</a> <a id="4517" href="Peras.SmallStep.html#4386" class="Bound">t</a> <a id="4519" href="Peras.SmallStep.html#4405" class="Bound">vv</a><a id="4521" class="Symbol">)</a>

      <a id="4530" href="Peras.SmallStep.html#4530" class="Field">quorum-cert</a> <a id="4542" class="Symbol">:</a> <a id="4544" class="Symbol">∀</a> <a id="4546" class="Symbol">(</a><a id="4547" href="Peras.SmallStep.html#4547" class="Bound">t</a> <a id="4549" class="Symbol">:</a> <a id="4551" href="Peras.SmallStep.html#2939" class="Bound">T</a><a id="4552" class="Symbol">)</a> <a id="4554" class="Symbol">(</a><a id="4555" href="Peras.SmallStep.html#4555" class="Bound">b</a> <a id="4557" class="Symbol">:</a> <a id="4559" href="Peras.Block.html#2807" class="Record">Block</a><a id="4564" class="Symbol">)</a> <a id="4566" class="Symbol">(</a><a id="4567" href="Peras.SmallStep.html#4567" class="Bound">r</a> <a id="4569" class="Symbol">:</a> <a id="4571" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="4572" class="Symbol">)</a>
        <a id="4582" class="Symbol">→</a> <a id="4584" href="Data.List.Base.html#5083" class="Function">length</a> <a id="4591" class="Symbol">(</a><a id="4592" href="Data.List.Base.html#10878" class="Function">filter</a> <a id="4599" class="Symbol">(λ</a> <a id="4602" class="Symbol">{</a><a id="4603" href="Peras.SmallStep.html#4603" class="Bound">v</a> <a id="4605" class="Symbol">→</a>
                    <a id="4627" class="Symbol">(</a><a id="4628" href="Peras.Numbering.html#1729" class="Field">getRoundNumber</a> <a id="4643" class="Symbol">(</a><a id="4644" href="Peras.Chain.html#1518" class="Field">votingRound</a> <a id="4656" href="Peras.SmallStep.html#4603" class="Bound">v</a><a id="4657" class="Symbol">)</a> <a id="4659" href="Data.Nat.Properties.html#3311" class="Function Operator">≟</a> <a id="4661" href="Peras.SmallStep.html#4567" class="Bound">r</a><a id="4662" class="Symbol">)</a>
              <a id="4678" href="Relation.Nullary.Decidable.Core.html#2609" class="Function Operator">×-dec</a> <a id="4684" class="Symbol">(</a><a id="4685" href="Peras.Chain.html#1620" class="Field">blockHash</a> <a id="4695" href="Peras.SmallStep.html#4603" class="Bound">v</a> <a id="4697" href="Peras.Block.html#3542" class="Function Operator">≟-BlockHash</a> <a id="4709" href="Peras.Crypto.html#2033" class="Field">hash</a> <a id="4714" href="Peras.SmallStep.html#4555" class="Bound">b</a><a id="4715" class="Symbol">)}</a>
            <a id="4730" class="Symbol">)</a> <a id="4732" class="Symbol">(</a><a id="4733" href="Peras.SmallStep.html#3230" class="Bound">votes</a> <a id="4739" href="Peras.SmallStep.html#4547" class="Bound">t</a><a id="4740" class="Symbol">))</a> <a id="4743" href="Data.Nat.Base.html#2259" class="Function Operator">≥</a> <a id="4745" href="Peras.Params.html#263" class="Field">τ</a>
        <a id="4755" class="Symbol">→</a> <a id="4757" href="Data.List.Relation.Unary.Any.html#1163" class="Datatype">Any</a> <a id="4761" class="Symbol">(λ</a> <a id="4764" class="Symbol">{</a><a id="4765" href="Peras.SmallStep.html#4765" class="Bound">c</a> <a id="4767" class="Symbol">→</a>
            <a id="4781" class="Symbol">(</a><a id="4782" href="Peras.Numbering.html#1729" class="Field">getRoundNumber</a> <a id="4797" class="Symbol">(</a><a id="4798" href="Peras.Block.html#2948" class="Field">round</a> <a id="4804" href="Peras.SmallStep.html#4765" class="Bound">c</a><a id="4805" class="Symbol">)</a> <a id="4807" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="4809" href="Peras.SmallStep.html#4567" class="Bound">r</a><a id="4810" class="Symbol">)</a>
          <a id="4822" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="4824" class="Symbol">(</a><a id="4825" href="Peras.Block.html#2976" class="Field">blockRef</a> <a id="4834" href="Peras.SmallStep.html#4765" class="Bound">c</a> <a id="4836" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="4838" href="Peras.Crypto.html#2033" class="Field">hash</a> <a id="4843" href="Peras.SmallStep.html#4555" class="Bound">b</a><a id="4844" class="Symbol">)</a> <a id="4846" class="Symbol">})</a> <a id="4849" class="Symbol">(</a><a id="4850" href="Peras.SmallStep.html#3274" class="Bound">certs</a> <a id="4856" href="Peras.SmallStep.html#4547" class="Bound">t</a><a id="4857" class="Symbol">)</a>
</pre>
In addition to chains the block-tree manages votes and certificates as
well. The block-tree type is defined as follows:
<pre class="Agda">  <a id="4993" class="Keyword">record</a> <a id="5000" href="Peras.SmallStep.html#5000" class="Record">TreeType</a> <a id="5009" class="Symbol">(</a><a id="5010" href="Peras.SmallStep.html#5010" class="Bound">T</a> <a id="5012" class="Symbol">:</a> <a id="5014" href="Agda.Primitive.html#388" class="Primitive">Type</a><a id="5018" class="Symbol">)</a> <a id="5020" class="Symbol">:</a> <a id="5022" href="Agda.Primitive.html#388" class="Primitive">Type₁</a> <a id="5028" class="Keyword">where</a>

    <a id="5039" class="Keyword">field</a>
      <a id="5051" href="Peras.SmallStep.html#5051" class="Field">tree₀</a> <a id="5057" class="Symbol">:</a> <a id="5059" href="Peras.SmallStep.html#5010" class="Bound">T</a>

      <a id="5068" href="Peras.SmallStep.html#5068" class="Field">addChain</a> <a id="5077" class="Symbol">:</a> <a id="5079" href="Peras.SmallStep.html#5010" class="Bound">T</a> <a id="5081" class="Symbol">→</a> <a id="5083" class="Symbol">{</a><a id="5084" href="Peras.SmallStep.html#5084" class="Bound">c</a> <a id="5086" class="Symbol">:</a> <a id="5088" href="Peras.Chain.html#3111" class="Function">Chain</a><a id="5093" class="Symbol">}</a> <a id="5095" class="Symbol">→</a> <a id="5097" href="Peras.Chain.html#6113" class="Datatype">ValidChain</a> <a id="5108" href="Peras.SmallStep.html#5084" class="Bound">c</a> <a id="5110" class="Symbol">→</a> <a id="5112" href="Peras.SmallStep.html#5010" class="Bound">T</a>
      <a id="5120" href="Peras.SmallStep.html#5120" class="Field">chains</a> <a id="5127" class="Symbol">:</a> <a id="5129" href="Peras.SmallStep.html#5010" class="Bound">T</a> <a id="5131" class="Symbol">→</a> <a id="5133" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="5138" href="Peras.Chain.html#3111" class="Function">Chain</a>
      <a id="5150" href="Peras.SmallStep.html#5150" class="Field">preferredChain</a> <a id="5165" class="Symbol">:</a> <a id="5167" href="Peras.SmallStep.html#5010" class="Bound">T</a> <a id="5169" class="Symbol">→</a> <a id="5171" href="Peras.Chain.html#3111" class="Function">Chain</a>

      <a id="5184" href="Peras.SmallStep.html#5184" class="Field">addVote</a> <a id="5192" class="Symbol">:</a> <a id="5194" href="Peras.SmallStep.html#5010" class="Bound">T</a> <a id="5196" class="Symbol">→</a> <a id="5198" class="Symbol">{</a><a id="5199" href="Peras.SmallStep.html#5199" class="Bound">v</a> <a id="5201" class="Symbol">:</a> <a id="5203" href="Peras.Chain.html#1472" class="Record">Vote</a><a id="5207" class="Symbol">}</a> <a id="5209" class="Symbol">→</a> <a id="5211" href="Peras.Chain.html#2648" class="Function">ValidVote</a> <a id="5221" href="Peras.SmallStep.html#5199" class="Bound">v</a> <a id="5223" class="Symbol">→</a> <a id="5225" href="Peras.SmallStep.html#5010" class="Bound">T</a>
      <a id="5233" href="Peras.SmallStep.html#5233" class="Field">votes</a> <a id="5239" class="Symbol">:</a> <a id="5241" href="Peras.SmallStep.html#5010" class="Bound">T</a> <a id="5243" class="Symbol">→</a> <a id="5245" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="5250" href="Peras.Chain.html#1472" class="Record">Vote</a>

      <a id="5262" href="Peras.SmallStep.html#5262" class="Field">certs</a> <a id="5268" class="Symbol">:</a> <a id="5270" href="Peras.SmallStep.html#5010" class="Bound">T</a> <a id="5272" class="Symbol">→</a> <a id="5274" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="5279" href="Peras.Block.html#2849" class="Record">Certificate</a>

    <a id="5296" href="Peras.SmallStep.html#5296" class="Function">cert₀</a> <a id="5302" class="Symbol">:</a> <a id="5304" href="Peras.Block.html#2849" class="Record">Certificate</a>
    <a id="5320" href="Peras.SmallStep.html#5296" class="Function">cert₀</a> <a id="5326" class="Symbol">=</a> <a id="5328" href="Peras.Block.html#2926" class="InductiveConstructor">MkCertificate</a> <a id="5342" class="Symbol">(</a><a id="5343" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="5357" class="Number">0</a><a id="5358" class="Symbol">)</a> <a id="5360" class="Symbol">(</a><a id="5361" href="Peras.Crypto.html#1583" class="InductiveConstructor">MkHash</a> <a id="5368" href="Peras.Crypto.html#676" class="Postulate">emptyBS</a><a id="5375" class="Symbol">)</a>

    <a id="5382" class="Keyword">field</a>
      <a id="5394" href="Peras.SmallStep.html#5394" class="Field">is-TreeType</a> <a id="5406" class="Symbol">:</a> <a id="5408" href="Peras.SmallStep.html#2927" class="Record">IsTreeType</a>
                      <a id="5441" href="Peras.SmallStep.html#5051" class="Field">tree₀</a> <a id="5447" href="Peras.SmallStep.html#5068" class="Field">addChain</a> <a id="5456" href="Peras.SmallStep.html#5120" class="Field">chains</a> <a id="5463" href="Peras.SmallStep.html#5150" class="Field">preferredChain</a>
                      <a id="5500" href="Peras.SmallStep.html#5184" class="Field">addVote</a> <a id="5508" href="Peras.SmallStep.html#5233" class="Field">votes</a> <a id="5514" href="Peras.SmallStep.html#5262" class="Field">certs</a> <a id="5520" href="Peras.SmallStep.html#5296" class="Function">cert₀</a>

    <a id="5531" href="Peras.SmallStep.html#5531" class="Function">latestCertOnChain</a> <a id="5549" class="Symbol">:</a> <a id="5551" href="Peras.SmallStep.html#5010" class="Bound">T</a> <a id="5553" class="Symbol">→</a> <a id="5555" href="Peras.Block.html#2849" class="Record">Certificate</a>
    <a id="5571" href="Peras.SmallStep.html#5531" class="Function">latestCertOnChain</a> <a id="5589" class="Symbol">=</a>
      <a id="5597" href="Peras.Block.html#3080" class="Function">latestCert</a> <a id="5608" href="Peras.SmallStep.html#5296" class="Function">cert₀</a> <a id="5614" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="5616" href="Data.List.Base.html#1716" class="Function">L.mapMaybe</a> <a id="5627" href="Peras.Block.html#3326" class="Field">certificate</a> <a id="5639" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="5641" href="Peras.SmallStep.html#5150" class="Field">preferredChain</a>

    <a id="5661" href="Peras.SmallStep.html#5661" class="Function">latestCertSeen</a> <a id="5676" class="Symbol">:</a> <a id="5678" href="Peras.SmallStep.html#5010" class="Bound">T</a> <a id="5680" class="Symbol">→</a> <a id="5682" href="Peras.Block.html#2849" class="Record">Certificate</a>
    <a id="5698" href="Peras.SmallStep.html#5661" class="Function">latestCertSeen</a> <a id="5713" class="Symbol">=</a> <a id="5715" href="Peras.Block.html#3080" class="Function">latestCert</a> <a id="5726" href="Peras.SmallStep.html#5296" class="Function">cert₀</a> <a id="5732" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="5734" href="Peras.SmallStep.html#5262" class="Field">certs</a>

    <a id="5745" href="Peras.SmallStep.html#5745" class="Function">hasCert</a> <a id="5753" class="Symbol">:</a> <a id="5755" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="5767" class="Symbol">→</a> <a id="5769" href="Peras.SmallStep.html#5010" class="Bound">T</a> <a id="5771" class="Symbol">→</a> <a id="5773" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="5782" href="Peras.SmallStep.html#5745" class="Function">hasCert</a> <a id="5790" class="Symbol">(</a><a id="5791" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="5805" href="Peras.SmallStep.html#5805" class="Bound">r</a><a id="5806" class="Symbol">)</a> <a id="5808" class="Symbol">=</a> <a id="5810" href="Data.List.Relation.Unary.Any.html#1163" class="Datatype">Any</a> <a id="5814" class="Symbol">((</a><a id="5816" href="Peras.SmallStep.html#5805" class="Bound">r</a> <a id="5818" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡_</a><a id="5820" class="Symbol">)</a> <a id="5822" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="5824" href="Peras.Block.html#3001" class="Function">roundNumber</a><a id="5835" class="Symbol">)</a> <a id="5837" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="5839" href="Peras.SmallStep.html#5262" class="Field">certs</a>

    <a id="5850" href="Peras.SmallStep.html#5850" class="Function">hasCert?</a> <a id="5859" class="Symbol">:</a> <a id="5861" class="Symbol">(</a><a id="5862" href="Peras.SmallStep.html#5862" class="Bound">r</a> <a id="5864" class="Symbol">:</a> <a id="5866" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a><a id="5877" class="Symbol">)</a> <a id="5879" class="Symbol">(</a><a id="5880" href="Peras.SmallStep.html#5880" class="Bound">t</a> <a id="5882" class="Symbol">:</a> <a id="5884" href="Peras.SmallStep.html#5010" class="Bound">T</a><a id="5885" class="Symbol">)</a> <a id="5887" class="Symbol">→</a> <a id="5889" href="Relation.Nullary.Decidable.Core.html#1485" class="Record">Dec</a> <a id="5893" class="Symbol">(</a><a id="5894" href="Peras.SmallStep.html#5745" class="Function">hasCert</a> <a id="5902" href="Peras.SmallStep.html#5862" class="Bound">r</a> <a id="5904" href="Peras.SmallStep.html#5880" class="Bound">t</a><a id="5905" class="Symbol">)</a>
    <a id="5911" href="Peras.SmallStep.html#5850" class="Function">hasCert?</a> <a id="5920" class="Symbol">(</a><a id="5921" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="5935" href="Peras.SmallStep.html#5935" class="Bound">r</a><a id="5936" class="Symbol">)</a> <a id="5938" class="Symbol">=</a> <a id="5940" href="Data.List.Relation.Unary.Any.html#2694" class="Function">any?</a> <a id="5945" class="Symbol">((</a><a id="5947" href="Peras.SmallStep.html#5935" class="Bound">r</a> <a id="5949" href="Data.Nat.Properties.html#3311" class="Function Operator">≟_</a><a id="5951" class="Symbol">)</a> <a id="5953" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="5955" href="Peras.Block.html#3001" class="Function">roundNumber</a><a id="5966" class="Symbol">)</a> <a id="5968" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="5970" href="Peras.SmallStep.html#5262" class="Field">certs</a>

    <a id="5981" href="Peras.SmallStep.html#5981" class="Function">hasVote</a> <a id="5989" class="Symbol">:</a> <a id="5991" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="6003" class="Symbol">→</a> <a id="6005" href="Peras.SmallStep.html#5010" class="Bound">T</a> <a id="6007" class="Symbol">→</a> <a id="6009" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="6018" href="Peras.SmallStep.html#5981" class="Function">hasVote</a> <a id="6026" class="Symbol">(</a><a id="6027" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="6041" href="Peras.SmallStep.html#6041" class="Bound">r</a><a id="6042" class="Symbol">)</a> <a id="6044" class="Symbol">=</a> <a id="6046" href="Data.List.Relation.Unary.Any.html#1163" class="Datatype">Any</a> <a id="6050" class="Symbol">((</a><a id="6052" href="Peras.SmallStep.html#6041" class="Bound">r</a> <a id="6054" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡_</a><a id="6056" class="Symbol">)</a> <a id="6058" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6060" href="Peras.Chain.html#1680" class="Function">votingRound&#39;</a><a id="6072" class="Symbol">)</a> <a id="6074" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6076" href="Peras.SmallStep.html#5233" class="Field">votes</a>

    <a id="6087" href="Peras.SmallStep.html#6087" class="Function">hasVote?</a> <a id="6096" class="Symbol">:</a> <a id="6098" class="Symbol">(</a><a id="6099" href="Peras.SmallStep.html#6099" class="Bound">r</a> <a id="6101" class="Symbol">:</a> <a id="6103" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a><a id="6114" class="Symbol">)</a> <a id="6116" class="Symbol">(</a><a id="6117" href="Peras.SmallStep.html#6117" class="Bound">t</a> <a id="6119" class="Symbol">:</a> <a id="6121" href="Peras.SmallStep.html#5010" class="Bound">T</a><a id="6122" class="Symbol">)</a> <a id="6124" class="Symbol">→</a> <a id="6126" href="Relation.Nullary.Decidable.Core.html#1485" class="Record">Dec</a> <a id="6130" class="Symbol">(</a><a id="6131" href="Peras.SmallStep.html#5981" class="Function">hasVote</a> <a id="6139" href="Peras.SmallStep.html#6099" class="Bound">r</a> <a id="6141" href="Peras.SmallStep.html#6117" class="Bound">t</a><a id="6142" class="Symbol">)</a>
    <a id="6148" href="Peras.SmallStep.html#6087" class="Function">hasVote?</a> <a id="6157" class="Symbol">(</a><a id="6158" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="6172" href="Peras.SmallStep.html#6172" class="Bound">r</a><a id="6173" class="Symbol">)</a> <a id="6175" class="Symbol">=</a> <a id="6177" href="Data.List.Relation.Unary.Any.html#2694" class="Function">any?</a> <a id="6182" class="Symbol">((</a><a id="6184" href="Peras.SmallStep.html#6172" class="Bound">r</a> <a id="6186" href="Data.Nat.Properties.html#3311" class="Function Operator">≟_</a><a id="6188" class="Symbol">)</a> <a id="6190" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6192" href="Peras.Chain.html#1680" class="Function">votingRound&#39;</a><a id="6204" class="Symbol">)</a> <a id="6206" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6208" href="Peras.SmallStep.html#5233" class="Field">votes</a>

    <a id="6219" href="Peras.SmallStep.html#6219" class="Function">allBlocks</a> <a id="6229" class="Symbol">:</a> <a id="6231" href="Peras.SmallStep.html#5010" class="Bound">T</a> <a id="6233" class="Symbol">→</a> <a id="6235" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="6240" href="Peras.Block.html#2807" class="Record">Block</a>
    <a id="6250" href="Peras.SmallStep.html#6219" class="Function">allBlocks</a> <a id="6260" class="Symbol">=</a> <a id="6262" href="Data.List.Base.html#4538" class="Function">concat</a> <a id="6269" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6271" href="Peras.SmallStep.html#5120" class="Field">chains</a>
</pre>
<h3 id="additional-parameters">Additional parameters</h3>
<p>In order to define the semantics the following parameters are
required additionally:</p>
<ul>
<li>The type of the block-tree</li>
<li>adversarialState₀ is the initial adversarial state</li>
<li>Tx selection function per party and slot number</li>
<li>The list of parties</li>
</ul>
<pre class="Agda">  <a id="6568" class="Keyword">module</a> <a id="6575" href="Peras.SmallStep.html#6575" class="Module">Semantics</a>
           <a id="6596" class="Symbol">{</a><a id="6597" href="Peras.SmallStep.html#6597" class="Bound">T</a> <a id="6599" class="Symbol">:</a> <a id="6601" href="Agda.Primitive.html#388" class="Primitive">Type</a><a id="6605" class="Symbol">}</a> <a id="6607" class="Symbol">{</a><a id="6608" href="Peras.SmallStep.html#6608" class="Bound">blockTree</a> <a id="6618" class="Symbol">:</a> <a id="6620" href="Peras.SmallStep.html#5000" class="Record">TreeType</a> <a id="6629" href="Peras.SmallStep.html#6597" class="Bound">T</a><a id="6630" class="Symbol">}</a>
           <a id="6643" class="Symbol">{</a><a id="6644" href="Peras.SmallStep.html#6644" class="Bound">S</a> <a id="6646" class="Symbol">:</a> <a id="6648" href="Agda.Primitive.html#388" class="Primitive">Type</a><a id="6652" class="Symbol">}</a> <a id="6654" class="Symbol">{</a><a id="6655" href="Peras.SmallStep.html#6655" class="Bound">adversarialState₀</a> <a id="6673" class="Symbol">:</a> <a id="6675" href="Peras.SmallStep.html#6644" class="Bound">S</a><a id="6676" class="Symbol">}</a>
           <a id="6689" class="Symbol">{</a><a id="6690" href="Peras.SmallStep.html#6690" class="Bound">txSelection</a> <a id="6702" class="Symbol">:</a> <a id="6704" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="6715" class="Symbol">→</a> <a id="6717" href="Peras.Block.html#1264" class="Function">PartyId</a> <a id="6725" class="Symbol">→</a> <a id="6727" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="6732" href="Peras.Block.html#2329" class="Function">Tx</a><a id="6734" class="Symbol">}</a>
           <a id="6747" class="Symbol">{</a><a id="6748" href="Peras.SmallStep.html#6748" class="Bound">parties</a> <a id="6756" class="Symbol">:</a> <a id="6758" href="Peras.Block.html#2033" class="Function">Parties</a><a id="6765" class="Symbol">}</a> <a id="6767" class="Comment">-- TODO: use parties from blockTrees</a>
                               <a id="6835" class="Comment">-- i.e. allow dynamic participation</a>
           <a id="6882" class="Keyword">where</a>

    <a id="6893" class="Keyword">open</a> <a id="6898" href="Peras.SmallStep.html#5000" class="Module">TreeType</a> <a id="6907" href="Peras.SmallStep.html#6608" class="Bound">blockTree</a>

    <a id="6922" class="Keyword">private</a>
      <a id="6936" class="Keyword">instance</a>
        <a id="6953" href="Peras.SmallStep.html#6953" class="Function">Default-T</a> <a id="6963" class="Symbol">:</a> <a id="6965" href="Prelude.Default.html#100" class="Record">Default</a> <a id="6973" href="Peras.SmallStep.html#6597" class="Bound">T</a>
        <a id="6983" href="Peras.SmallStep.html#6953" class="Function">Default-T</a> <a id="6993" class="Symbol">.</a><a id="6994" href="Prelude.Default.html#140" class="Field">def</a> <a id="6998" class="Symbol">=</a> <a id="7000" href="Peras.SmallStep.html#5051" class="Function">tree₀</a>
</pre>
<h4 id="block-tree-update">Block-tree update</h4>
<p>Updating the block-tree upon receiving a message for vote and block
messages.</p>
<pre class="Agda">    <a id="7125" class="Keyword">data</a> <a id="7130" href="Peras.SmallStep.html#7130" class="Datatype Operator">_[_]→_</a> <a id="7137" class="Symbol">:</a> <a id="7139" href="Peras.SmallStep.html#6597" class="Bound">T</a> <a id="7141" class="Symbol">→</a> <a id="7143" href="Peras.SmallStep.html#2195" class="Datatype">Message</a> <a id="7151" class="Symbol">→</a> <a id="7153" href="Peras.SmallStep.html#6597" class="Bound">T</a> <a id="7155" class="Symbol">→</a> <a id="7157" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="7162" class="Keyword">where</a>

      <a id="7175" href="Peras.SmallStep.html#7175" class="InductiveConstructor">VoteReceived</a> <a id="7188" class="Symbol">:</a> <a id="7190" class="Symbol">∀</a> <a id="7192" class="Symbol">{</a><a id="7193" href="Peras.SmallStep.html#7193" class="Bound">v</a> <a id="7195" href="Peras.SmallStep.html#7195" class="Bound">vv</a> <a id="7198" href="Peras.SmallStep.html#7198" class="Bound">t</a><a id="7199" class="Symbol">}</a> <a id="7201" class="Symbol">→</a>
          <a id="7213" href="Prelude.InferenceRules.html#45702" class="Function Operator">────────────────────────────</a>
          <a id="7252" href="Peras.SmallStep.html#7198" class="Bound">t</a> <a id="7254" href="Peras.SmallStep.html#7130" class="Datatype Operator">[</a> <a id="7256" href="Peras.SmallStep.html#2272" class="InductiveConstructor">VoteMsg</a> <a id="7264" class="Symbol">{</a><a id="7265" href="Peras.SmallStep.html#7193" class="Bound">v</a><a id="7266" class="Symbol">}</a> <a id="7268" href="Peras.SmallStep.html#7195" class="Bound">vv</a> <a id="7271" href="Peras.SmallStep.html#7130" class="Datatype Operator">]→</a> <a id="7274" href="Peras.SmallStep.html#5184" class="Function">addVote</a> <a id="7282" href="Peras.SmallStep.html#7198" class="Bound">t</a> <a id="7284" href="Peras.SmallStep.html#7195" class="Bound">vv</a>

      <a id="7294" href="Peras.SmallStep.html#7294" class="InductiveConstructor">ChainReceived</a> <a id="7308" class="Symbol">:</a> <a id="7310" class="Symbol">∀</a> <a id="7312" class="Symbol">{</a><a id="7313" href="Peras.SmallStep.html#7313" class="Bound">c</a> <a id="7315" href="Peras.SmallStep.html#7315" class="Bound">vc</a> <a id="7318" href="Peras.SmallStep.html#7318" class="Bound">t</a><a id="7319" class="Symbol">}</a> <a id="7321" class="Symbol">→</a>
          <a id="7333" href="Prelude.InferenceRules.html#45468" class="Function Operator">──────────────────────────────</a>
          <a id="7374" href="Peras.SmallStep.html#7318" class="Bound">t</a> <a id="7376" href="Peras.SmallStep.html#7130" class="Datatype Operator">[</a> <a id="7378" href="Peras.SmallStep.html#2220" class="InductiveConstructor">ChainMsg</a> <a id="7387" class="Symbol">{</a><a id="7388" href="Peras.SmallStep.html#7313" class="Bound">c</a><a id="7389" class="Symbol">}</a> <a id="7391" href="Peras.SmallStep.html#7315" class="Bound">vc</a> <a id="7394" href="Peras.SmallStep.html#7130" class="Datatype Operator">]→</a> <a id="7397" href="Peras.SmallStep.html#5068" class="Function">addChain</a> <a id="7406" href="Peras.SmallStep.html#7318" class="Bound">t</a> <a id="7408" href="Peras.SmallStep.html#7315" class="Bound">vc</a>
</pre>
<h4 id="vote-in-round">Vote in round</h4>
<p>When does a party vote in a round? The protocol expects regular
voting, i.e. if in the previous round a quorum has been achieved or that
voting resumes after a cool-down phase.</p>
<h4 id="blockselection">BlockSelection</h4>
<pre class="Agda">    <a id="7645" href="Peras.SmallStep.html#7645" class="Function">BlockSelection&#39;</a> <a id="7661" class="Symbol">:</a> <a id="7663" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="7674" class="Symbol">→</a> <a id="7676" href="Peras.Chain.html#3111" class="Function">Chain</a> <a id="7682" class="Symbol">→</a> <a id="7684" href="Peras.Crypto.html#1542" class="Record">Hash</a> <a id="7689" href="Peras.Block.html#2807" class="Record">Block</a>
    <a id="7699" href="Peras.SmallStep.html#7645" class="Function">BlockSelection&#39;</a> <a id="7715" class="Symbol">(</a><a id="7716" href="Peras.Numbering.html#779" class="InductiveConstructor">MkSlotNumber</a> <a id="7729" href="Peras.SmallStep.html#7729" class="Bound">s</a><a id="7730" class="Symbol">)</a> <a id="7732" class="Symbol">=</a>
      <a id="7740" href="Peras.Block.html#5471" class="Function">tipHash</a> <a id="7748" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="7750" href="Data.List.Base.html#10878" class="Function">filter</a> <a id="7757" class="Symbol">(λ</a> <a id="7760" class="Symbol">{</a><a id="7761" href="Peras.SmallStep.html#7761" class="Bound">b</a> <a id="7763" class="Symbol">→</a> <a id="7765" class="Symbol">(</a><a id="7766" href="Peras.Block.html#3465" class="Function">slotNumber&#39;</a> <a id="7778" href="Peras.SmallStep.html#7761" class="Bound">b</a><a id="7779" class="Symbol">)</a> <a id="7781" href="Agda.Builtin.Nat.html#336" class="Primitive Operator">+</a> <a id="7783" href="Peras.Params.html#235" class="Field">L</a> <a id="7785" href="Data.Nat.Properties.html#6146" class="Function Operator">≤?</a> <a id="7788" href="Peras.SmallStep.html#7729" class="Bound">s</a><a id="7789" class="Symbol">})</a>

    <a id="7797" href="Peras.SmallStep.html#7797" class="Function">BlockSelection</a> <a id="7812" class="Symbol">:</a> <a id="7814" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="7825" class="Symbol">→</a> <a id="7827" href="Peras.SmallStep.html#6597" class="Bound">T</a> <a id="7829" class="Symbol">→</a> <a id="7831" href="Peras.Crypto.html#1542" class="Record">Hash</a> <a id="7836" href="Peras.Block.html#2807" class="Record">Block</a>
    <a id="7846" href="Peras.SmallStep.html#7797" class="Function">BlockSelection</a> <a id="7861" href="Peras.SmallStep.html#7861" class="Bound">s</a> <a id="7863" class="Symbol">=</a> <a id="7865" href="Peras.SmallStep.html#7645" class="Function">BlockSelection&#39;</a> <a id="7881" href="Peras.SmallStep.html#7861" class="Bound">s</a> <a id="7883" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="7885" href="Peras.SmallStep.html#5150" class="Function">preferredChain</a>
</pre>
<h4 id="voting-rules">Voting rules</h4>
VR-1A: A party has seen a certificate cert-r−1 for round r−1
<pre class="Agda">    <a id="7996" href="Peras.SmallStep.html#7996" class="Function">VotingRule-1A</a> <a id="8010" class="Symbol">:</a> <a id="8012" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="8024" class="Symbol">→</a> <a id="8026" href="Peras.SmallStep.html#6597" class="Bound">T</a> <a id="8028" class="Symbol">→</a> <a id="8030" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="8039" href="Peras.SmallStep.html#7996" class="Function">VotingRule-1A</a> <a id="8053" class="Symbol">(</a><a id="8054" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="8068" href="Peras.SmallStep.html#8068" class="Bound">r</a><a id="8069" class="Symbol">)</a> <a id="8071" href="Peras.SmallStep.html#8071" class="Bound">t</a> <a id="8073" class="Symbol">=</a> <a id="8075" href="Peras.SmallStep.html#8068" class="Bound">r</a> <a id="8077" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="8079" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="8083" class="Symbol">(</a><a id="8084" href="Peras.Block.html#3001" class="Function">roundNumber</a> <a id="8096" class="Symbol">(</a><a id="8097" href="Peras.SmallStep.html#5661" class="Function">latestCertSeen</a> <a id="8112" href="Peras.SmallStep.html#8071" class="Bound">t</a><a id="8113" class="Symbol">))</a>
</pre>
VR-1B: The extends the block certified by cert-r−1,
<pre class="Agda">    <a id="8185" href="Peras.SmallStep.html#8185" class="Function">VotingRule-1B</a> <a id="8199" class="Symbol">:</a> <a id="8201" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="8212" class="Symbol">→</a> <a id="8214" href="Peras.SmallStep.html#6597" class="Bound">T</a> <a id="8216" class="Symbol">→</a> <a id="8218" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="8227" href="Peras.SmallStep.html#8185" class="Function">VotingRule-1B</a> <a id="8241" href="Peras.SmallStep.html#8241" class="Bound">s</a> <a id="8243" href="Peras.SmallStep.html#8243" class="Bound">t</a> <a id="8245" class="Symbol">=</a> <a id="8247" href="Peras.Chain.html#4442" class="Function">Extends</a> <a id="8255" class="Symbol">(</a><a id="8256" href="Peras.SmallStep.html#7797" class="Function">BlockSelection</a> <a id="8271" href="Peras.SmallStep.html#8241" class="Bound">s</a> <a id="8273" href="Peras.SmallStep.html#8243" class="Bound">t</a><a id="8274" class="Symbol">)</a> <a id="8276" class="Symbol">(</a><a id="8277" href="Peras.SmallStep.html#5661" class="Function">latestCertSeen</a> <a id="8292" href="Peras.SmallStep.html#8243" class="Bound">t</a><a id="8293" class="Symbol">)</a> <a id="8295" class="Symbol">(</a><a id="8296" href="Peras.SmallStep.html#5120" class="Function">chains</a> <a id="8303" href="Peras.SmallStep.html#8243" class="Bound">t</a><a id="8304" class="Symbol">)</a>
</pre>
VR-1: Both VR-1A and VR-1B hold
<pre class="Agda">    <a id="8354" href="Peras.SmallStep.html#8354" class="Function">VotingRule-1</a> <a id="8367" class="Symbol">:</a> <a id="8369" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="8380" class="Symbol">→</a> <a id="8382" href="Peras.SmallStep.html#6597" class="Bound">T</a> <a id="8384" class="Symbol">→</a> <a id="8386" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="8395" href="Peras.SmallStep.html#8354" class="Function">VotingRule-1</a> <a id="8408" href="Peras.SmallStep.html#8408" class="Bound">s</a> <a id="8410" href="Peras.SmallStep.html#8410" class="Bound">t</a> <a id="8412" class="Symbol">=</a>
        <a id="8422" href="Peras.SmallStep.html#7996" class="Function">VotingRule-1A</a> <a id="8436" class="Symbol">(</a><a id="8437" href="Peras.Chain.html#5472" class="Function">v-round</a> <a id="8445" href="Peras.SmallStep.html#8408" class="Bound">s</a><a id="8446" class="Symbol">)</a> <a id="8448" href="Peras.SmallStep.html#8410" class="Bound">t</a>
      <a id="8456" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="8458" href="Peras.SmallStep.html#8185" class="Function">VotingRule-1B</a> <a id="8472" href="Peras.SmallStep.html#8408" class="Bound">s</a> <a id="8474" href="Peras.SmallStep.html#8410" class="Bound">t</a>
</pre>
VR-2A: The last certificate a party has seen is from a round at least R
rounds back
<pre class="Agda">    <a id="8576" href="Peras.SmallStep.html#8576" class="Function">VotingRule-2A</a> <a id="8590" class="Symbol">:</a> <a id="8592" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="8604" class="Symbol">→</a> <a id="8606" href="Peras.SmallStep.html#6597" class="Bound">T</a> <a id="8608" class="Symbol">→</a> <a id="8610" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="8619" href="Peras.SmallStep.html#8576" class="Function">VotingRule-2A</a> <a id="8633" class="Symbol">(</a><a id="8634" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="8648" href="Peras.SmallStep.html#8648" class="Bound">r</a><a id="8649" class="Symbol">)</a> <a id="8651" href="Peras.SmallStep.html#8651" class="Bound">t</a> <a id="8653" class="Symbol">=</a> <a id="8655" href="Peras.SmallStep.html#8648" class="Bound">r</a> <a id="8657" href="Data.Nat.Base.html#2259" class="Function Operator">≥</a> <a id="8659" href="Peras.Block.html#3001" class="Function">roundNumber</a> <a id="8671" class="Symbol">(</a><a id="8672" href="Peras.SmallStep.html#5661" class="Function">latestCertSeen</a> <a id="8687" href="Peras.SmallStep.html#8651" class="Bound">t</a><a id="8688" class="Symbol">)</a> <a id="8690" href="Agda.Builtin.Nat.html#336" class="Primitive Operator">+</a> <a id="8692" href="Peras.Params.html#221" class="Field">R</a>
</pre>
VR-2B: The last certificate included in a party’s current chain is from
a round exactly c⋆K rounds ago for some c : ℕ, c ≥ 0 <!--
<pre class="Agda">    <a id="8840" href="Peras.SmallStep.html#8840" class="Function Operator">_mod_</a> <a id="8846" class="Symbol">:</a> <a id="8848" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="8850" class="Symbol">→</a> <a id="8852" class="Symbol">(</a><a id="8853" href="Peras.SmallStep.html#8853" class="Bound">n</a> <a id="8855" class="Symbol">:</a> <a id="8857" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="8858" class="Symbol">)</a> <a id="8860" class="Symbol">→</a> <a id="8862" class="Symbol">⦃</a> <a id="8864" href="Data.Nat.Base.html#3260" class="Record">NonZero</a> <a id="8872" href="Peras.SmallStep.html#8853" class="Bound">n</a> <a id="8874" class="Symbol">⦄</a> <a id="8876" class="Symbol">→</a> <a id="8878" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
    <a id="8884" href="Peras.SmallStep.html#8840" class="Function Operator">_mod_</a> <a id="8890" href="Peras.SmallStep.html#8890" class="Bound">a</a> <a id="8892" href="Peras.SmallStep.html#8892" class="Bound">b</a> <a id="8894" class="Symbol">⦃</a> <a id="8896" href="Peras.SmallStep.html#8896" class="Bound">prf</a> <a id="8900" class="Symbol">⦄</a> <a id="8902" class="Symbol">=</a> <a id="8904" href="Data.Nat.Base.html#7279" class="Function Operator">_%_</a> <a id="8908" href="Peras.SmallStep.html#8890" class="Bound">a</a> <a id="8910" href="Peras.SmallStep.html#8892" class="Bound">b</a> <a id="8912" class="Symbol">⦃</a> <a id="8914" href="Peras.SmallStep.html#8896" class="Bound">prf</a> <a id="8918" class="Symbol">⦄</a>
</pre>-->
<pre class="Agda">    <a id="8940" href="Peras.SmallStep.html#8940" class="Function">VotingRule-2B</a> <a id="8954" class="Symbol">:</a> <a id="8956" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="8968" class="Symbol">→</a> <a id="8970" href="Peras.SmallStep.html#6597" class="Bound">T</a> <a id="8972" class="Symbol">→</a> <a id="8974" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="8983" href="Peras.SmallStep.html#8940" class="Function">VotingRule-2B</a> <a id="8997" class="Symbol">(</a><a id="8998" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="9012" href="Peras.SmallStep.html#9012" class="Bound">r</a><a id="9013" class="Symbol">)</a> <a id="9015" href="Peras.SmallStep.html#9015" class="Bound">t</a> <a id="9017" class="Symbol">=</a>
        <a id="9027" href="Peras.SmallStep.html#9012" class="Bound">r</a> <a id="9029" href="Data.Nat.Base.html#2289" class="Function Operator">&gt;</a> <a id="9031" href="Peras.Block.html#3001" class="Function">roundNumber</a> <a id="9043" class="Symbol">(</a><a id="9044" href="Peras.SmallStep.html#5531" class="Function">latestCertOnChain</a> <a id="9062" href="Peras.SmallStep.html#9015" class="Bound">t</a><a id="9063" class="Symbol">)</a>
      <a id="9071" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="9073" href="Peras.SmallStep.html#9012" class="Bound">r</a> <a id="9075" href="Peras.SmallStep.html#8840" class="Function Operator">mod</a> <a id="9079" href="Peras.Params.html#207" class="Field">K</a> <a id="9081" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="9083" class="Symbol">(</a><a id="9084" href="Peras.Block.html#3001" class="Function">roundNumber</a> <a id="9096" class="Symbol">(</a><a id="9097" href="Peras.SmallStep.html#5531" class="Function">latestCertOnChain</a> <a id="9115" href="Peras.SmallStep.html#9015" class="Bound">t</a><a id="9116" class="Symbol">))</a> <a id="9119" href="Peras.SmallStep.html#8840" class="Function Operator">mod</a> <a id="9123" href="Peras.Params.html#207" class="Field">K</a>
</pre>
VR-2: Both VR-2A and VR-2B hold
<pre class="Agda">    <a id="9173" href="Peras.SmallStep.html#9173" class="Function">VotingRule-2</a> <a id="9186" class="Symbol">:</a> <a id="9188" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="9200" class="Symbol">→</a> <a id="9202" href="Peras.SmallStep.html#6597" class="Bound">T</a> <a id="9204" class="Symbol">→</a> <a id="9206" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="9215" href="Peras.SmallStep.html#9173" class="Function">VotingRule-2</a> <a id="9228" href="Peras.SmallStep.html#9228" class="Bound">r</a> <a id="9230" href="Peras.SmallStep.html#9230" class="Bound">t</a> <a id="9232" class="Symbol">=</a>
        <a id="9242" href="Peras.SmallStep.html#8576" class="Function">VotingRule-2A</a> <a id="9256" href="Peras.SmallStep.html#9228" class="Bound">r</a> <a id="9258" href="Peras.SmallStep.html#9230" class="Bound">t</a>
      <a id="9266" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="9268" href="Peras.SmallStep.html#8940" class="Function">VotingRule-2B</a> <a id="9282" href="Peras.SmallStep.html#9228" class="Bound">r</a> <a id="9284" href="Peras.SmallStep.html#9230" class="Bound">t</a>
</pre>
If either VR-1A and VR-1B or VR-2A and VR-2B hold, voting is expected
<pre class="Agda">    <a id="9372" href="Peras.SmallStep.html#9372" class="Function">VotingRule</a> <a id="9383" class="Symbol">:</a> <a id="9385" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="9396" class="Symbol">→</a> <a id="9398" href="Peras.SmallStep.html#6597" class="Bound">T</a> <a id="9400" class="Symbol">→</a> <a id="9402" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="9411" href="Peras.SmallStep.html#9372" class="Function">VotingRule</a> <a id="9422" href="Peras.SmallStep.html#9422" class="Bound">s</a> <a id="9424" href="Peras.SmallStep.html#9424" class="Bound">t</a> <a id="9426" class="Symbol">=</a>
        <a id="9436" href="Peras.SmallStep.html#8354" class="Function">VotingRule-1</a> <a id="9449" href="Peras.SmallStep.html#9422" class="Bound">s</a> <a id="9451" href="Peras.SmallStep.html#9424" class="Bound">t</a>
      <a id="9459" href="Data.Sum.Base.html#625" class="Datatype Operator">⊎</a> <a id="9461" href="Peras.SmallStep.html#9173" class="Function">VotingRule-2</a> <a id="9474" class="Symbol">(</a><a id="9475" href="Peras.Chain.html#5472" class="Function">v-round</a> <a id="9483" href="Peras.SmallStep.html#9422" class="Bound">s</a><a id="9484" class="Symbol">)</a> <a id="9486" href="Peras.SmallStep.html#9424" class="Bound">t</a>
</pre>
<h3 id="state">State</h3>
<p>The small-step semantics rely on a global state, which consists of
the following fields:</p>
<ul>
<li>Current slot of the system</li>
<li>Map with local state per party</li>
<li>All the messages that have been sent but not yet been delivered</li>
<li>All the messages that have been sent</li>
<li>Adversarial state</li>
</ul>
<pre class="Agda">    <a id="9793" class="Keyword">record</a> <a id="9800" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="9806" class="Symbol">:</a> <a id="9808" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="9813" class="Keyword">where</a>
      <a id="9825" class="Keyword">constructor</a> <a id="9837" href="Peras.SmallStep.html#9837" class="InductiveConstructor Operator">⟦_,_,_,_,_⟧</a>
      <a id="9855" class="Keyword">field</a>
        <a id="9869" href="Peras.SmallStep.html#9869" class="Field">clock</a> <a id="9875" class="Symbol">:</a> <a id="9877" href="Peras.Numbering.html#742" class="Record">SlotNumber</a>
        <a id="9896" href="Peras.SmallStep.html#9896" class="Field">blockTrees</a> <a id="9907" class="Symbol">:</a> <a id="9909" href="Prelude.AssocList.html#211" class="Function">AssocList</a> <a id="9919" href="Peras.Block.html#1264" class="Function">PartyId</a> <a id="9927" href="Peras.SmallStep.html#6597" class="Bound">T</a>
        <a id="9937" href="Peras.SmallStep.html#9937" class="Field">messages</a> <a id="9946" class="Symbol">:</a> <a id="9948" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="9953" href="Peras.SmallStep.html#2588" class="Record">Envelope</a>
        <a id="9970" href="Peras.SmallStep.html#9970" class="Field">history</a> <a id="9978" class="Symbol">:</a> <a id="9980" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="9985" href="Peras.SmallStep.html#2195" class="Datatype">Message</a>
        <a id="10001" href="Peras.SmallStep.html#10001" class="Field">adversarialState</a> <a id="10018" class="Symbol">:</a> <a id="10020" href="Peras.SmallStep.html#6644" class="Bound">S</a>

      <a id="10029" href="Peras.SmallStep.html#10029" class="Function">blockTrees&#39;</a> <a id="10041" class="Symbol">:</a> <a id="10043" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="10048" href="Peras.SmallStep.html#6597" class="Bound">T</a>
      <a id="10056" href="Peras.SmallStep.html#10029" class="Function">blockTrees&#39;</a> <a id="10068" class="Symbol">=</a> <a id="10070" href="Data.List.Base.html#1631" class="Function">map</a> <a id="10074" href="Data.Product.Base.html#650" class="Field">proj₂</a> <a id="10080" href="Peras.SmallStep.html#9896" class="Field">blockTrees</a>

      <a id="10098" href="Peras.SmallStep.html#10098" class="Function">v-rnd</a> <a id="10104" class="Symbol">:</a> <a id="10106" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a>
      <a id="10124" href="Peras.SmallStep.html#10098" class="Function">v-rnd</a> <a id="10130" class="Symbol">=</a> <a id="10132" href="Peras.Chain.html#5472" class="Function">v-round</a> <a id="10140" href="Peras.SmallStep.html#9869" class="Field">clock</a>

      <a id="10153" href="Peras.SmallStep.html#10153" class="Function">v-rnd&#39;</a> <a id="10160" class="Symbol">:</a> <a id="10162" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
      <a id="10170" href="Peras.SmallStep.html#10153" class="Function">v-rnd&#39;</a> <a id="10177" class="Symbol">=</a> <a id="10179" href="Peras.Numbering.html#1729" class="Field">getRoundNumber</a> <a id="10194" href="Peras.SmallStep.html#10098" class="Function">v-rnd</a>
</pre>
<h4 id="progress">Progress</h4>
Rather than keeping track of progress, we introduce a predicate stating
that all messages that are not delayed have been delivered. This is a
precondition that must hold before transitioning to the next slot.
<pre class="Agda">    <a id="10440" href="Peras.SmallStep.html#10440" class="Function">Fetched</a> <a id="10448" class="Symbol">:</a> <a id="10450" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="10456" class="Symbol">→</a> <a id="10458" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="10467" href="Peras.SmallStep.html#10440" class="Function">Fetched</a> <a id="10475" class="Symbol">=</a> <a id="10477" href="Data.List.Relation.Unary.All.html#1627" class="Datatype">All</a> <a id="10481" class="Symbol">(λ</a> <a id="10484" class="Symbol">{</a> <a id="10486" href="Peras.SmallStep.html#10486" class="Bound">z</a> <a id="10488" class="Symbol">→</a> <a id="10490" href="Peras.SmallStep.html#2732" class="Field">delay</a> <a id="10496" href="Peras.SmallStep.html#10486" class="Bound">z</a> <a id="10498" href="Relation.Binary.PropositionalEquality.Core.html#858" class="Function Operator">≢</a> <a id="10500" href="Peras.SmallStep.html#2413" class="InductiveConstructor">𝟘</a> <a id="10502" class="Symbol">})</a> <a id="10505" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="10507" href="Peras.SmallStep.html#9937" class="Field">messages</a>
      <a id="10522" class="Keyword">where</a> <a id="10528" class="Keyword">open</a> <a id="10533" href="Peras.SmallStep.html#9800" class="Module">State</a>
</pre>
Predicate for a global state stating that the current slot is the last
slot of a voting round.
<pre class="Agda">    <a id="10650" href="Peras.SmallStep.html#10650" class="Function">LastSlotInRound</a> <a id="10666" class="Symbol">:</a> <a id="10668" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="10674" class="Symbol">→</a> <a id="10676" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="10685" href="Peras.SmallStep.html#10650" class="Function">LastSlotInRound</a> <a id="10701" href="Peras.SmallStep.html#10701" class="Bound">M</a> <a id="10703" class="Symbol">=</a>
      <a id="10711" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="10715" class="Symbol">(</a><a id="10716" href="Peras.Chain.html#5410" class="Function">rnd</a> <a id="10720" class="Symbol">(</a><a id="10721" href="Peras.Numbering.html#800" class="Field">getSlotNumber</a> <a id="10735" href="Peras.SmallStep.html#9869" class="Field">clock</a><a id="10740" class="Symbol">))</a> <a id="10743" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="10745" href="Peras.Chain.html#5410" class="Function">rnd</a> <a id="10749" class="Symbol">(</a><a id="10750" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="10754" class="Symbol">(</a><a id="10755" href="Peras.Numbering.html#800" class="Field">getSlotNumber</a> <a id="10769" href="Peras.SmallStep.html#9869" class="Field">clock</a><a id="10774" class="Symbol">))</a>
      <a id="10783" class="Keyword">where</a> <a id="10789" class="Keyword">open</a> <a id="10794" href="Peras.SmallStep.html#9800" class="Module">State</a> <a id="10800" href="Peras.SmallStep.html#10701" class="Bound">M</a>
</pre>
<pre class="Agda">    <a id="10818" href="Peras.SmallStep.html#10818" class="Function">LastSlotInRound?</a> <a id="10835" class="Symbol">:</a> <a id="10837" class="Symbol">(</a><a id="10838" href="Peras.SmallStep.html#10838" class="Bound">s</a> <a id="10840" class="Symbol">:</a> <a id="10842" href="Peras.SmallStep.html#9800" class="Record">State</a><a id="10847" class="Symbol">)</a> <a id="10849" class="Symbol">→</a> <a id="10851" href="Relation.Nullary.Decidable.Core.html#1485" class="Record">Dec</a> <a id="10855" class="Symbol">(</a><a id="10856" href="Peras.SmallStep.html#10650" class="Function">LastSlotInRound</a> <a id="10872" href="Peras.SmallStep.html#10838" class="Bound">s</a><a id="10873" class="Symbol">)</a>
    <a id="10879" href="Peras.SmallStep.html#10818" class="Function">LastSlotInRound?</a> <a id="10896" href="Peras.SmallStep.html#10896" class="Bound">M</a> <a id="10898" class="Symbol">=</a>
      <a id="10906" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="10910" class="Symbol">(</a><a id="10911" href="Peras.Chain.html#5410" class="Function">rnd</a> <a id="10915" class="Symbol">(</a><a id="10916" href="Peras.Numbering.html#800" class="Field">getSlotNumber</a> <a id="10930" href="Peras.SmallStep.html#9869" class="Field">clock</a><a id="10935" class="Symbol">))</a> <a id="10938" href="Data.Nat.Properties.html#3311" class="Function Operator">≟</a> <a id="10940" href="Peras.Chain.html#5410" class="Function">rnd</a> <a id="10944" class="Symbol">(</a><a id="10945" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="10949" class="Symbol">(</a><a id="10950" href="Peras.Numbering.html#800" class="Field">getSlotNumber</a> <a id="10964" href="Peras.SmallStep.html#9869" class="Field">clock</a><a id="10969" class="Symbol">))</a>
      <a id="10978" class="Keyword">where</a> <a id="10984" class="Keyword">open</a> <a id="10989" href="Peras.SmallStep.html#9800" class="Module">State</a> <a id="10995" href="Peras.SmallStep.html#10896" class="Bound">M</a>
</pre>
Predicate for a global state stating that the next slot will be in a new
voting round.
<pre class="Agda">    <a id="11100" href="Peras.SmallStep.html#11100" class="Function">NextSlotInSameRound</a> <a id="11120" class="Symbol">:</a> <a id="11122" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="11128" class="Symbol">→</a> <a id="11130" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="11139" href="Peras.SmallStep.html#11100" class="Function">NextSlotInSameRound</a> <a id="11159" href="Peras.SmallStep.html#11159" class="Bound">M</a> <a id="11161" class="Symbol">=</a>
      <a id="11169" href="Peras.Chain.html#5410" class="Function">rnd</a> <a id="11173" class="Symbol">(</a><a id="11174" href="Peras.Numbering.html#800" class="Field">getSlotNumber</a> <a id="11188" href="Peras.SmallStep.html#9869" class="Field">clock</a><a id="11193" class="Symbol">)</a> <a id="11195" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="11197" href="Peras.Chain.html#5410" class="Function">rnd</a> <a id="11201" class="Symbol">(</a><a id="11202" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="11206" class="Symbol">(</a><a id="11207" href="Peras.Numbering.html#800" class="Field">getSlotNumber</a> <a id="11221" href="Peras.SmallStep.html#9869" class="Field">clock</a><a id="11226" class="Symbol">))</a>
      <a id="11235" class="Keyword">where</a> <a id="11241" class="Keyword">open</a> <a id="11246" href="Peras.SmallStep.html#9800" class="Module">State</a> <a id="11252" href="Peras.SmallStep.html#11159" class="Bound">M</a>
</pre>
<pre class="Agda">    <a id="11270" href="Peras.SmallStep.html#11270" class="Function">NextSlotInSameRound?</a> <a id="11291" class="Symbol">:</a> <a id="11293" class="Symbol">(</a><a id="11294" href="Peras.SmallStep.html#11294" class="Bound">s</a> <a id="11296" class="Symbol">:</a> <a id="11298" href="Peras.SmallStep.html#9800" class="Record">State</a><a id="11303" class="Symbol">)</a> <a id="11305" class="Symbol">→</a> <a id="11307" href="Relation.Nullary.Decidable.Core.html#1485" class="Record">Dec</a> <a id="11311" class="Symbol">(</a><a id="11312" href="Peras.SmallStep.html#11100" class="Function">NextSlotInSameRound</a> <a id="11332" href="Peras.SmallStep.html#11294" class="Bound">s</a><a id="11333" class="Symbol">)</a>
    <a id="11339" href="Peras.SmallStep.html#11270" class="Function">NextSlotInSameRound?</a> <a id="11360" href="Peras.SmallStep.html#11360" class="Bound">M</a> <a id="11362" class="Symbol">=</a>
      <a id="11370" href="Peras.Chain.html#5410" class="Function">rnd</a> <a id="11374" class="Symbol">(</a><a id="11375" href="Peras.Numbering.html#800" class="Field">getSlotNumber</a> <a id="11389" href="Peras.SmallStep.html#9869" class="Field">clock</a><a id="11394" class="Symbol">)</a> <a id="11396" href="Data.Nat.Properties.html#3311" class="Function Operator">≟</a> <a id="11398" href="Peras.Chain.html#5410" class="Function">rnd</a> <a id="11402" class="Symbol">(</a><a id="11403" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="11407" class="Symbol">(</a><a id="11408" href="Peras.Numbering.html#800" class="Field">getSlotNumber</a> <a id="11422" href="Peras.SmallStep.html#9869" class="Field">clock</a><a id="11427" class="Symbol">))</a>
      <a id="11436" class="Keyword">where</a> <a id="11442" class="Keyword">open</a> <a id="11447" href="Peras.SmallStep.html#9800" class="Module">State</a> <a id="11453" href="Peras.SmallStep.html#11360" class="Bound">M</a>
</pre>
<p>Predicate for a global state asserting that parties of the voting
committee for a the current voting round have voted. This is needed as a
condition when transitioning from one voting round to another.</p>
<strong>TODO</strong>: Properly define the condition for required votes
<pre class="Agda">    <a id="11733" href="Peras.SmallStep.html#11733" class="Function">RequiredVotes</a> <a id="11747" class="Symbol">:</a> <a id="11749" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="11755" class="Symbol">→</a> <a id="11757" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="11766" href="Peras.SmallStep.html#11733" class="Function">RequiredVotes</a> <a id="11780" href="Peras.SmallStep.html#11780" class="Bound">M</a> <a id="11782" class="Symbol">=</a>
         <a id="11793" href="Data.List.Relation.Unary.Any.html#1163" class="Datatype">Any</a> <a id="11797" class="Symbol">(</a><a id="11798" href="Peras.SmallStep.html#9372" class="Function">VotingRule</a> <a id="11809" href="Peras.SmallStep.html#9869" class="Field">clock</a> <a id="11815" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="11817" href="Data.Product.Base.html#650" class="Field">proj₂</a><a id="11822" class="Symbol">)</a> <a id="11824" href="Peras.SmallStep.html#9896" class="Field">blockTrees</a>
       <a id="11842" class="Symbol">→</a> <a id="11844" href="Data.List.Relation.Unary.Any.html#1163" class="Datatype">Any</a> <a id="11848" class="Symbol">(</a><a id="11849" href="Peras.SmallStep.html#5981" class="Function">hasVote</a> <a id="11857" class="Symbol">(</a><a id="11858" href="Peras.Chain.html#5472" class="Function">v-round</a> <a id="11866" href="Peras.SmallStep.html#9869" class="Field">clock</a><a id="11871" class="Symbol">)</a> <a id="11873" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="11875" href="Data.Product.Base.html#650" class="Field">proj₂</a><a id="11880" class="Symbol">)</a> <a id="11882" href="Peras.SmallStep.html#9896" class="Field">blockTrees</a>
      <a id="11899" class="Keyword">where</a> <a id="11905" class="Keyword">open</a> <a id="11910" href="Peras.SmallStep.html#9800" class="Module">State</a> <a id="11916" href="Peras.SmallStep.html#11780" class="Bound">M</a>
</pre>
Ticking the global clock increments the slot number and decrements the
delay of all the messages in the message buffer.
<pre class="Agda">    <a id="12054" href="Peras.SmallStep.html#12054" class="Function">tick</a> <a id="12059" class="Symbol">:</a> <a id="12061" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="12067" class="Symbol">→</a> <a id="12069" href="Peras.SmallStep.html#9800" class="Record">State</a>
    <a id="12079" href="Peras.SmallStep.html#12054" class="Function">tick</a> <a id="12084" href="Peras.SmallStep.html#12084" class="Bound">M</a> <a id="12086" class="Symbol">=</a>
      <a id="12094" class="Keyword">record</a> <a id="12101" href="Peras.SmallStep.html#12084" class="Bound">M</a>
        <a id="12111" class="Symbol">{</a> <a id="12113" href="Peras.SmallStep.html#9869" class="Field">clock</a> <a id="12119" class="Symbol">=</a> <a id="12121" href="Peras.Numbering.html#821" class="Function">next</a> <a id="12126" href="Peras.SmallStep.html#9869" class="Field">clock</a>
        <a id="12140" class="Symbol">;</a> <a id="12142" href="Peras.SmallStep.html#9937" class="Field">messages</a> <a id="12151" class="Symbol">=</a>
            <a id="12165" href="Data.List.Base.html#1631" class="Function">map</a> <a id="12169" class="Symbol">(λ</a> <a id="12172" class="Keyword">where</a> <a id="12178" href="Peras.SmallStep.html#12178" class="Bound">e</a> <a id="12180" class="Symbol">→</a> <a id="12182" class="Keyword">record</a> <a id="12189" href="Peras.SmallStep.html#12178" class="Bound">e</a> <a id="12191" class="Symbol">{</a> <a id="12193" href="Peras.SmallStep.html#2732" class="Field">delay</a> <a id="12199" class="Symbol">=</a> <a id="12201" href="Data.Fin.Base.html#6461" class="Function">pred</a> <a id="12206" class="Symbol">(</a><a id="12207" href="Peras.SmallStep.html#2732" class="Field">delay</a> <a id="12213" href="Peras.SmallStep.html#12178" class="Bound">e</a><a id="12214" class="Symbol">)</a> <a id="12216" class="Symbol">})</a>
              <a id="12233" href="Peras.SmallStep.html#9937" class="Field">messages</a>
        <a id="12250" class="Symbol">}</a>
      <a id="12258" class="Keyword">where</a> <a id="12264" class="Keyword">open</a> <a id="12269" href="Peras.SmallStep.html#9800" class="Module">State</a> <a id="12275" href="Peras.SmallStep.html#12084" class="Bound">M</a>
</pre>
Updating the global state inserting the updated block-tree for a given
party, adding messages to the message buffer for the other parties and
appending the history
<pre class="Agda">    <a id="12457" href="Peras.SmallStep.html#12457" class="Function Operator">_,_,_,_⇑_</a> <a id="12467" class="Symbol">:</a> <a id="12469" href="Peras.SmallStep.html#2195" class="Datatype">Message</a> <a id="12477" class="Symbol">→</a> <a id="12479" href="Peras.SmallStep.html#2376" class="Function">Delay</a> <a id="12485" class="Symbol">→</a> <a id="12487" href="Peras.Block.html#1264" class="Function">PartyId</a> <a id="12495" class="Symbol">→</a> <a id="12497" href="Peras.SmallStep.html#6597" class="Bound">T</a> <a id="12499" class="Symbol">→</a> <a id="12501" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="12507" class="Symbol">→</a> <a id="12509" href="Peras.SmallStep.html#9800" class="Record">State</a>
    <a id="12519" href="Peras.SmallStep.html#12519" class="Bound">m</a> <a id="12521" href="Peras.SmallStep.html#12457" class="Function Operator">,</a> <a id="12523" href="Peras.SmallStep.html#12523" class="Bound">d</a> <a id="12525" href="Peras.SmallStep.html#12457" class="Function Operator">,</a> <a id="12527" href="Peras.SmallStep.html#12527" class="Bound">p</a> <a id="12529" href="Peras.SmallStep.html#12457" class="Function Operator">,</a> <a id="12531" href="Peras.SmallStep.html#12531" class="Bound">l</a> <a id="12533" href="Peras.SmallStep.html#12457" class="Function Operator">⇑</a> <a id="12535" href="Peras.SmallStep.html#12535" class="Bound">M</a> <a id="12537" class="Symbol">=</a>
      <a id="12545" class="Keyword">record</a> <a id="12552" href="Peras.SmallStep.html#12535" class="Bound">M</a>
        <a id="12562" class="Symbol">{</a> <a id="12564" href="Peras.SmallStep.html#9896" class="Field">blockTrees</a> <a id="12575" class="Symbol">=</a> <a id="12577" href="Prelude.AssocList.html#1398" class="Function">set</a> <a id="12581" href="Peras.SmallStep.html#12527" class="Bound">p</a> <a id="12583" href="Peras.SmallStep.html#12531" class="Bound">l</a> <a id="12585" href="Peras.SmallStep.html#9896" class="Field">blockTrees</a>
        <a id="12604" class="Symbol">;</a> <a id="12606" href="Peras.SmallStep.html#9937" class="Field">messages</a> <a id="12615" class="Symbol">=</a>
            <a id="12629" href="Data.List.Base.html#1631" class="Function">map</a> <a id="12633" class="Symbol">(</a><a id="12634" href="Data.Product.Base.html#3109" class="Function">uncurry</a> <a id="12642" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">⦅_,_,</a> <a id="12648" href="Peras.SmallStep.html#12519" class="Bound">m</a> <a id="12650" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">,</a> <a id="12652" href="Peras.SmallStep.html#12523" class="Bound">d</a> <a id="12654" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">⦆</a><a id="12655" class="Symbol">)</a>
              <a id="12671" class="Symbol">(</a><a id="12672" href="Data.List.Base.html#10878" class="Function">filter</a> <a id="12679" class="Symbol">(</a><a id="12680" href="Relation.Nullary.Decidable.Core.html#2517" class="Function">¬?</a> <a id="12683" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="12685" class="Symbol">(</a><a id="12686" href="Peras.SmallStep.html#12527" class="Bound">p</a> <a id="12688" href="Data.Nat.Properties.html#3311" class="Function Operator">≟_</a><a id="12690" class="Symbol">)</a> <a id="12692" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="12694" href="Data.Product.Base.html#636" class="Field">proj₁</a><a id="12699" class="Symbol">)</a> <a id="12701" href="Peras.SmallStep.html#6748" class="Bound">parties</a><a id="12708" class="Symbol">)</a>
            <a id="12722" href="Data.List.Base.html#1954" class="Function Operator">++</a> <a id="12725" href="Peras.SmallStep.html#9937" class="Field">messages</a>
        <a id="12742" class="Symbol">;</a> <a id="12744" href="Peras.SmallStep.html#9970" class="Field">history</a> <a id="12752" class="Symbol">=</a> <a id="12754" href="Peras.SmallStep.html#12519" class="Bound">m</a> <a id="12756" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="12758" href="Peras.SmallStep.html#9970" class="Field">history</a>
        <a id="12774" class="Symbol">}</a>
      <a id="12782" class="Keyword">where</a> <a id="12788" class="Keyword">open</a> <a id="12793" href="Peras.SmallStep.html#9800" class="Module">State</a> <a id="12799" href="Peras.SmallStep.html#12535" class="Bound">M</a>

    <a id="12806" href="Peras.SmallStep.html#12806" class="Function Operator">add_to_diffuse_</a> <a id="12822" class="Symbol">:</a> <a id="12824" class="Symbol">(</a><a id="12825" href="Peras.SmallStep.html#2195" class="Datatype">Message</a> <a id="12833" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="12835" href="Peras.SmallStep.html#2376" class="Function">Delay</a> <a id="12841" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="12843" href="Peras.Block.html#1264" class="Function">PartyId</a><a id="12850" class="Symbol">)</a> <a id="12852" class="Symbol">→</a> <a id="12854" href="Peras.SmallStep.html#6597" class="Bound">T</a> <a id="12856" class="Symbol">→</a> <a id="12858" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="12864" class="Symbol">→</a> <a id="12866" href="Peras.SmallStep.html#9800" class="Record">State</a>
    <a id="12876" href="Peras.SmallStep.html#12806" class="Function Operator">add</a> <a id="12880" class="Symbol">(</a><a id="12881" href="Peras.SmallStep.html#12881" class="Bound">m</a><a id="12882" class="Symbol">@(</a><a id="12884" href="Peras.SmallStep.html#2220" class="InductiveConstructor">ChainMsg</a> <a id="12893" href="Peras.SmallStep.html#12893" class="Bound">x</a><a id="12894" class="Symbol">)</a> <a id="12896" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="12898" href="Peras.SmallStep.html#12898" class="Bound">d</a> <a id="12900" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="12902" href="Peras.SmallStep.html#12902" class="Bound">p</a><a id="12903" class="Symbol">)</a> <a id="12905" href="Peras.SmallStep.html#12806" class="Function Operator">to</a> <a id="12908" href="Peras.SmallStep.html#12908" class="Bound">t</a> <a id="12910" href="Peras.SmallStep.html#12806" class="Function Operator">diffuse</a> <a id="12918" href="Peras.SmallStep.html#12918" class="Bound">M</a> <a id="12920" class="Symbol">=</a> <a id="12922" href="Peras.SmallStep.html#12881" class="Bound">m</a> <a id="12924" href="Peras.SmallStep.html#12457" class="Function Operator">,</a> <a id="12926" href="Peras.SmallStep.html#12898" class="Bound">d</a> <a id="12928" href="Peras.SmallStep.html#12457" class="Function Operator">,</a> <a id="12930" href="Peras.SmallStep.html#12902" class="Bound">p</a> <a id="12932" href="Peras.SmallStep.html#12457" class="Function Operator">,</a> <a id="12934" href="Peras.SmallStep.html#5068" class="Function">addChain</a> <a id="12943" href="Peras.SmallStep.html#12908" class="Bound">t</a> <a id="12945" href="Peras.SmallStep.html#12893" class="Bound">x</a> <a id="12947" href="Peras.SmallStep.html#12457" class="Function Operator">⇑</a> <a id="12949" href="Peras.SmallStep.html#12918" class="Bound">M</a>
    <a id="12955" href="Peras.SmallStep.html#12806" class="Function Operator">add</a> <a id="12959" class="Symbol">(</a><a id="12960" href="Peras.SmallStep.html#12960" class="Bound">m</a><a id="12961" class="Symbol">@(</a><a id="12963" href="Peras.SmallStep.html#2272" class="InductiveConstructor">VoteMsg</a> <a id="12971" href="Peras.SmallStep.html#12971" class="Bound">x</a><a id="12972" class="Symbol">)</a> <a id="12974" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="12976" href="Peras.SmallStep.html#12976" class="Bound">d</a> <a id="12978" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="12980" href="Peras.SmallStep.html#12980" class="Bound">p</a><a id="12981" class="Symbol">)</a> <a id="12983" href="Peras.SmallStep.html#12806" class="Function Operator">to</a> <a id="12986" href="Peras.SmallStep.html#12986" class="Bound">t</a> <a id="12988" href="Peras.SmallStep.html#12806" class="Function Operator">diffuse</a> <a id="12996" href="Peras.SmallStep.html#12996" class="Bound">M</a> <a id="12998" class="Symbol">=</a> <a id="13000" href="Peras.SmallStep.html#12960" class="Bound">m</a> <a id="13002" href="Peras.SmallStep.html#12457" class="Function Operator">,</a> <a id="13004" href="Peras.SmallStep.html#12976" class="Bound">d</a> <a id="13006" href="Peras.SmallStep.html#12457" class="Function Operator">,</a> <a id="13008" href="Peras.SmallStep.html#12980" class="Bound">p</a> <a id="13010" href="Peras.SmallStep.html#12457" class="Function Operator">,</a> <a id="13012" href="Peras.SmallStep.html#5184" class="Function">addVote</a> <a id="13020" href="Peras.SmallStep.html#12986" class="Bound">t</a> <a id="13022" href="Peras.SmallStep.html#12971" class="Bound">x</a> <a id="13024" href="Peras.SmallStep.html#12457" class="Function Operator">⇑</a> <a id="13026" href="Peras.SmallStep.html#12996" class="Bound">M</a>
</pre>
<h2 id="fetching">Fetching</h2>
<p>A party receives messages from the global state by fetching messages
assigned to the party, updating the local block tree and putting the
local state back into the global state.</p>
<pre class="Agda">    <a id="13236" class="Keyword">data</a> <a id="13241" href="Peras.SmallStep.html#13241" class="Datatype Operator">_⊢_[_]⇀_</a> <a id="13250" class="Symbol">:</a> <a id="13252" class="Symbol">{</a><a id="13253" href="Peras.SmallStep.html#13253" class="Bound">p</a> <a id="13255" class="Symbol">:</a> <a id="13257" href="Peras.Block.html#1264" class="Function">PartyId</a><a id="13264" class="Symbol">}</a> <a id="13266" class="Symbol">→</a> <a id="13268" href="Peras.Block.html#1872" class="Datatype">Honesty</a> <a id="13276" href="Peras.SmallStep.html#13253" class="Bound">p</a> <a id="13278" class="Symbol">→</a> <a id="13280" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="13286" class="Symbol">→</a> <a id="13288" href="Peras.SmallStep.html#2195" class="Datatype">Message</a> <a id="13296" class="Symbol">→</a> <a id="13298" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="13304" class="Symbol">→</a> <a id="13306" href="Agda.Primitive.html#388" class="Primitive">Type</a>
      <a id="13317" class="Keyword">where</a>
</pre>
An honest party consumes a message from the global message buffer and
updates the local state
<pre class="Agda">      <a id="13435" href="Peras.SmallStep.html#13435" class="InductiveConstructor">honest</a> <a id="13442" class="Symbol">:</a> <a id="13444" class="Symbol">∀</a> <a id="13446" class="Symbol">{</a><a id="13447" href="Peras.SmallStep.html#13447" class="Bound">p</a><a id="13448" class="Symbol">}</a> <a id="13450" class="Symbol">{</a><a id="13451" href="Peras.SmallStep.html#13451" class="Bound">t</a> <a id="13453" href="Peras.SmallStep.html#13453" class="Bound">t′</a><a id="13455" class="Symbol">}</a> <a id="13457" class="Symbol">{</a><a id="13458" href="Peras.SmallStep.html#13458" class="Bound">m</a><a id="13459" class="Symbol">}</a> <a id="13461" class="Symbol">{</a><a id="13462" href="Peras.SmallStep.html#13462" class="Bound">N</a><a id="13463" class="Symbol">}</a> <a id="13465" class="Symbol">→</a> <a id="13467" class="Keyword">let</a> <a id="13471" class="Keyword">open</a> <a id="13476" href="Peras.SmallStep.html#9800" class="Module">State</a> <a id="13482" href="Peras.SmallStep.html#13462" class="Bound">N</a> <a id="13484" class="Keyword">in</a>
          <a id="13497" href="Peras.SmallStep.html#9896" class="Field">blockTrees</a> <a id="13508" href="Prelude.AssocList.html#847" class="Function Operator">⁉</a> <a id="13510" href="Peras.SmallStep.html#13447" class="Bound">p</a> <a id="13512" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="13514" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="13519" href="Peras.SmallStep.html#13451" class="Bound">t</a>
        <a id="13529" class="Symbol">→</a> <a id="13531" class="Symbol">(</a><a id="13532" href="Peras.SmallStep.html#13532" class="Bound">m∈ms</a> <a id="13537" class="Symbol">:</a> <a id="13539" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">⦅</a> <a id="13541" href="Peras.SmallStep.html#13447" class="Bound">p</a> <a id="13543" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">,</a> <a id="13545" href="Peras.Block.html#1905" class="InductiveConstructor">Honest</a> <a id="13552" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">,</a> <a id="13554" href="Peras.SmallStep.html#13458" class="Bound">m</a> <a id="13556" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">,</a> <a id="13558" href="Peras.SmallStep.html#2413" class="InductiveConstructor">𝟘</a> <a id="13560" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">⦆</a> <a id="13562" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="13564" href="Peras.SmallStep.html#9937" class="Field">messages</a><a id="13572" class="Symbol">)</a>
        <a id="13582" class="Symbol">→</a> <a id="13584" href="Peras.SmallStep.html#13451" class="Bound">t</a> <a id="13586" href="Peras.SmallStep.html#7130" class="Datatype Operator">[</a> <a id="13588" href="Peras.SmallStep.html#13458" class="Bound">m</a> <a id="13590" href="Peras.SmallStep.html#7130" class="Datatype Operator">]→</a> <a id="13593" href="Peras.SmallStep.html#13453" class="Bound">t′</a>
          <a id="13606" class="Comment">---------------------------------------------</a>
        <a id="13660" class="Symbol">→</a> <a id="13662" href="Peras.Block.html#1905" class="InductiveConstructor">Honest</a> <a id="13669" class="Symbol">{</a><a id="13670" href="Peras.SmallStep.html#13447" class="Bound">p</a><a id="13671" class="Symbol">}</a> <a id="13673" href="Peras.SmallStep.html#13241" class="Datatype Operator">⊢</a>
          <a id="13685" href="Peras.SmallStep.html#13462" class="Bound">N</a> <a id="13687" href="Peras.SmallStep.html#13241" class="Datatype Operator">[</a> <a id="13689" href="Peras.SmallStep.html#13458" class="Bound">m</a> <a id="13691" href="Peras.SmallStep.html#13241" class="Datatype Operator">]⇀</a> <a id="13694" class="Keyword">record</a> <a id="13701" href="Peras.SmallStep.html#13462" class="Bound">N</a>
            <a id="13715" class="Symbol">{</a> <a id="13717" href="Peras.SmallStep.html#9896" class="Field">blockTrees</a> <a id="13728" class="Symbol">=</a> <a id="13730" href="Prelude.AssocList.html#1398" class="Function">set</a> <a id="13734" href="Peras.SmallStep.html#13447" class="Bound">p</a> <a id="13736" href="Peras.SmallStep.html#13453" class="Bound">t′</a> <a id="13739" href="Peras.SmallStep.html#9896" class="Field">blockTrees</a>
            <a id="13762" class="Symbol">;</a> <a id="13764" href="Peras.SmallStep.html#9937" class="Field">messages</a> <a id="13773" class="Symbol">=</a> <a id="13775" href="Peras.SmallStep.html#9937" class="Field">messages</a> <a id="13784" href="Data.List.Relation.Unary.Any.html#2138" class="Function Operator">─</a> <a id="13786" href="Peras.SmallStep.html#13532" class="Bound">m∈ms</a>
            <a id="13803" class="Symbol">}</a>
</pre>
An adversarial party might delay a message
<pre class="Agda">      <a id="13866" href="Peras.SmallStep.html#13866" class="InductiveConstructor">corrupt</a> <a id="13874" class="Symbol">:</a> <a id="13876" class="Symbol">∀</a> <a id="13878" class="Symbol">{</a><a id="13879" href="Peras.SmallStep.html#13879" class="Bound">p</a><a id="13880" class="Symbol">}</a> <a id="13882" class="Symbol">{</a><a id="13883" href="Peras.SmallStep.html#13883" class="Bound">as</a><a id="13885" class="Symbol">}</a> <a id="13887" class="Symbol">{</a><a id="13888" href="Peras.SmallStep.html#13888" class="Bound">m</a><a id="13889" class="Symbol">}</a> <a id="13891" class="Symbol">{</a><a id="13892" href="Peras.SmallStep.html#13892" class="Bound">N</a><a id="13893" class="Symbol">}</a> <a id="13895" class="Symbol">→</a> <a id="13897" class="Keyword">let</a> <a id="13901" class="Keyword">open</a> <a id="13906" href="Peras.SmallStep.html#9800" class="Module">State</a> <a id="13912" href="Peras.SmallStep.html#13892" class="Bound">N</a> <a id="13914" class="Keyword">in</a>
          <a id="13927" class="Symbol">(</a><a id="13928" href="Peras.SmallStep.html#13928" class="Bound">m∈ms</a> <a id="13933" class="Symbol">:</a> <a id="13935" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">⦅</a> <a id="13937" href="Peras.SmallStep.html#13879" class="Bound">p</a> <a id="13939" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">,</a> <a id="13941" href="Peras.Block.html#1949" class="InductiveConstructor">Corrupt</a> <a id="13949" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">,</a> <a id="13951" href="Peras.SmallStep.html#13888" class="Bound">m</a> <a id="13953" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">,</a> <a id="13955" href="Peras.SmallStep.html#2413" class="InductiveConstructor">𝟘</a> <a id="13957" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">⦆</a> <a id="13959" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="13961" href="Peras.SmallStep.html#9937" class="Field">messages</a><a id="13969" class="Symbol">)</a>
          <a id="13981" class="Comment">----------------------------------------------</a>
        <a id="14036" class="Symbol">→</a> <a id="14038" href="Peras.Block.html#1949" class="InductiveConstructor">Corrupt</a> <a id="14046" class="Symbol">{</a><a id="14047" href="Peras.SmallStep.html#13879" class="Bound">p</a><a id="14048" class="Symbol">}</a> <a id="14050" href="Peras.SmallStep.html#13241" class="Datatype Operator">⊢</a>
          <a id="14062" href="Peras.SmallStep.html#13892" class="Bound">N</a> <a id="14064" href="Peras.SmallStep.html#13241" class="Datatype Operator">[</a> <a id="14066" href="Peras.SmallStep.html#13888" class="Bound">m</a> <a id="14068" href="Peras.SmallStep.html#13241" class="Datatype Operator">]⇀</a> <a id="14071" class="Keyword">record</a> <a id="14078" href="Peras.SmallStep.html#13892" class="Bound">N</a>
            <a id="14092" class="Symbol">{</a> <a id="14094" href="Peras.SmallStep.html#9937" class="Field">messages</a> <a id="14103" class="Symbol">=</a> <a id="14105" href="Peras.SmallStep.html#13928" class="Bound">m∈ms</a> <a id="14110" href="Peras.SmallStep.html#419" class="Function Operator">∷ˡ=</a> <a id="14114" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">⦅</a> <a id="14116" href="Peras.SmallStep.html#13879" class="Bound">p</a> <a id="14118" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">,</a> <a id="14120" href="Peras.Block.html#1949" class="InductiveConstructor">Corrupt</a> <a id="14128" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">,</a> <a id="14130" href="Peras.SmallStep.html#13888" class="Bound">m</a> <a id="14132" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">,</a> <a id="14134" href="Peras.SmallStep.html#2433" class="InductiveConstructor">𝟙</a> <a id="14136" href="Peras.SmallStep.html#2626" class="InductiveConstructor Operator">⦆</a>
            <a id="14150" class="Symbol">;</a> <a id="14152" href="Peras.SmallStep.html#10001" class="Field">adversarialState</a> <a id="14169" class="Symbol">=</a> <a id="14171" href="Peras.SmallStep.html#13883" class="Bound">as</a>
            <a id="14186" class="Symbol">}</a>
</pre>
<h2 id="voting">Voting</h2>
Helper function for creating a vote
<pre class="Agda">    <a id="14251" href="Peras.SmallStep.html#14251" class="Function">createVote</a> <a id="14262" class="Symbol">:</a> <a id="14264" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="14275" class="Symbol">→</a> <a id="14277" href="Peras.Block.html#1264" class="Function">PartyId</a> <a id="14285" class="Symbol">→</a> <a id="14287" href="Peras.Crypto.html#2161" class="Record">MembershipProof</a> <a id="14303" class="Symbol">→</a> <a id="14305" href="Peras.Crypto.html#3115" class="Record">Signature</a> <a id="14315" class="Symbol">→</a> <a id="14317" href="Peras.Crypto.html#1542" class="Record">Hash</a> <a id="14322" href="Peras.Block.html#2807" class="Record">Block</a> <a id="14328" class="Symbol">→</a> <a id="14330" href="Peras.Chain.html#1472" class="Record">Vote</a>
    <a id="14339" href="Peras.SmallStep.html#14251" class="Function">createVote</a> <a id="14350" href="Peras.SmallStep.html#14350" class="Bound">s</a> <a id="14352" href="Peras.SmallStep.html#14352" class="Bound">p</a> <a id="14354" href="Peras.SmallStep.html#14354" class="Bound">prf</a> <a id="14358" href="Peras.SmallStep.html#14358" class="Bound">sig</a> <a id="14362" href="Peras.SmallStep.html#14362" class="Bound">hb</a> <a id="14365" class="Symbol">=</a>
      <a id="14373" class="Keyword">record</a>
        <a id="14388" class="Symbol">{</a> <a id="14390" href="Peras.Chain.html#1518" class="Field">votingRound</a> <a id="14402" class="Symbol">=</a> <a id="14404" href="Peras.Chain.html#5472" class="Function">v-round</a> <a id="14412" href="Peras.SmallStep.html#14350" class="Bound">s</a>
        <a id="14422" class="Symbol">;</a> <a id="14424" href="Peras.Chain.html#1552" class="Field">creatorId</a> <a id="14434" class="Symbol">=</a> <a id="14436" href="Peras.SmallStep.html#14352" class="Bound">p</a>
        <a id="14446" class="Symbol">;</a> <a id="14448" href="Peras.Chain.html#1582" class="Field">proofM</a> <a id="14455" class="Symbol">=</a> <a id="14457" href="Peras.SmallStep.html#14354" class="Bound">prf</a>
        <a id="14469" class="Symbol">;</a> <a id="14471" href="Peras.Chain.html#1620" class="Field">blockHash</a> <a id="14481" class="Symbol">=</a> <a id="14483" href="Peras.SmallStep.html#14362" class="Bound">hb</a>
        <a id="14494" class="Symbol">;</a> <a id="14496" href="Peras.Chain.html#1653" class="Field">signature</a> <a id="14506" class="Symbol">=</a> <a id="14508" href="Peras.SmallStep.html#14358" class="Bound">sig</a>
        <a id="14520" class="Symbol">}</a>
</pre>
<p>A party can vote for a block, if * the current slot is the first slot
in a voting round * the party is a member of the voting committee * the
chain is not in a cool-down phase</p>
Voting updates the party’s local state and for all other parties a
message is added to be consumed immediately.
<pre class="Agda">    <a id="14833" class="Keyword">infix</a> <a id="14839" class="Number">2</a> <a id="14841" href="Peras.SmallStep.html#14857" class="Datatype Operator">_⊢_⇉_</a>

    <a id="14852" class="Keyword">data</a> <a id="14857" href="Peras.SmallStep.html#14857" class="Datatype Operator">_⊢_⇉_</a> <a id="14863" class="Symbol">:</a> <a id="14865" class="Symbol">{</a><a id="14866" href="Peras.SmallStep.html#14866" class="Bound">p</a> <a id="14868" class="Symbol">:</a> <a id="14870" href="Peras.Block.html#1264" class="Function">PartyId</a><a id="14877" class="Symbol">}</a> <a id="14879" class="Symbol">→</a> <a id="14881" href="Peras.Block.html#1872" class="Datatype">Honesty</a> <a id="14889" href="Peras.SmallStep.html#14866" class="Bound">p</a> <a id="14891" class="Symbol">→</a> <a id="14893" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="14899" class="Symbol">→</a> <a id="14901" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="14907" class="Symbol">→</a> <a id="14909" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="14914" class="Keyword">where</a>

      <a id="14927" href="Peras.SmallStep.html#14927" class="InductiveConstructor">honest</a> <a id="14934" class="Symbol">:</a> <a id="14936" class="Symbol">∀</a> <a id="14938" class="Symbol">{</a><a id="14939" href="Peras.SmallStep.html#14939" class="Bound">p</a><a id="14940" class="Symbol">}</a> <a id="14942" class="Symbol">{</a><a id="14943" href="Peras.SmallStep.html#14943" class="Bound">t</a><a id="14944" class="Symbol">}</a> <a id="14946" class="Symbol">{</a><a id="14947" href="Peras.SmallStep.html#14947" class="Bound">M</a><a id="14948" class="Symbol">}</a> <a id="14950" class="Symbol">{</a><a id="14951" href="Peras.SmallStep.html#14951" class="Bound">π</a><a id="14952" class="Symbol">}</a> <a id="14954" class="Symbol">{</a><a id="14955" href="Peras.SmallStep.html#14955" class="Bound">σ</a><a id="14956" class="Symbol">}</a> <a id="14958" class="Symbol">{</a><a id="14959" href="Peras.SmallStep.html#14959" class="Bound">b</a><a id="14960" class="Symbol">}</a>
        <a id="14970" class="Symbol">→</a> <a id="14972" class="Keyword">let</a>
            <a id="14988" class="Keyword">open</a> <a id="14993" href="Peras.SmallStep.html#9800" class="Module">State</a>
            <a id="15011" href="Peras.SmallStep.html#15011" class="Bound">s</a> <a id="15013" class="Symbol">=</a> <a id="15015" href="Peras.SmallStep.html#9869" class="Field">clock</a> <a id="15021" href="Peras.SmallStep.html#14947" class="Bound">M</a>
            <a id="15035" href="Peras.SmallStep.html#15035" class="Bound">r</a> <a id="15037" class="Symbol">=</a> <a id="15039" href="Peras.Chain.html#5472" class="Function">v-round</a> <a id="15047" href="Peras.SmallStep.html#15011" class="Bound">s</a>
            <a id="15061" href="Peras.SmallStep.html#15061" class="Bound">v</a> <a id="15063" class="Symbol">=</a> <a id="15065" href="Peras.SmallStep.html#14251" class="Function">createVote</a> <a id="15076" href="Peras.SmallStep.html#15011" class="Bound">s</a> <a id="15078" href="Peras.SmallStep.html#14939" class="Bound">p</a> <a id="15080" href="Peras.SmallStep.html#14951" class="Bound">π</a> <a id="15082" href="Peras.SmallStep.html#14955" class="Bound">σ</a> <a id="15084" href="Peras.SmallStep.html#14959" class="Bound">b</a>
          <a id="15096" class="Keyword">in</a>
          <a id="15109" href="Peras.SmallStep.html#7797" class="Function">BlockSelection</a> <a id="15124" href="Peras.SmallStep.html#15011" class="Bound">s</a> <a id="15126" href="Peras.SmallStep.html#14943" class="Bound">t</a> <a id="15128" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="15130" href="Peras.SmallStep.html#14959" class="Bound">b</a>
        <a id="15140" class="Symbol">→</a> <a id="15142" href="Peras.SmallStep.html#9896" class="Field">blockTrees</a> <a id="15153" href="Peras.SmallStep.html#14947" class="Bound">M</a> <a id="15155" href="Prelude.AssocList.html#847" class="Function Operator">⁉</a> <a id="15157" href="Peras.SmallStep.html#14939" class="Bound">p</a> <a id="15159" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="15161" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="15166" href="Peras.SmallStep.html#14943" class="Bound">t</a>
        <a id="15176" class="Symbol">→</a> <a id="15178" class="Symbol">(</a><a id="15179" href="Peras.SmallStep.html#15179" class="Bound">sig</a> <a id="15183" class="Symbol">:</a> <a id="15185" href="Peras.Chain.html#2477" class="Field">IsVoteSignature</a> <a id="15201" href="Peras.SmallStep.html#15061" class="Bound">v</a> <a id="15203" href="Peras.SmallStep.html#14955" class="Bound">σ</a><a id="15204" class="Symbol">)</a>
        <a id="15214" class="Symbol">→</a> <a id="15216" href="Peras.Chain.html#5127" class="Function">StartOfRound</a> <a id="15229" href="Peras.SmallStep.html#15011" class="Bound">s</a> <a id="15231" href="Peras.SmallStep.html#15035" class="Bound">r</a>
        <a id="15241" class="Symbol">→</a> <a id="15243" class="Symbol">(</a><a id="15244" href="Peras.SmallStep.html#15244" class="Bound">mem</a> <a id="15248" class="Symbol">:</a> <a id="15250" href="Peras.Chain.html#2360" class="Field">IsCommitteeMember</a> <a id="15268" href="Peras.SmallStep.html#14939" class="Bound">p</a> <a id="15270" href="Peras.SmallStep.html#15035" class="Bound">r</a> <a id="15272" href="Peras.SmallStep.html#14951" class="Bound">π</a><a id="15273" class="Symbol">)</a>
        <a id="15283" class="Symbol">→</a> <a id="15285" href="Peras.SmallStep.html#9372" class="Function">VotingRule</a> <a id="15296" href="Peras.SmallStep.html#15011" class="Bound">s</a> <a id="15298" href="Peras.SmallStep.html#14943" class="Bound">t</a>
          <a id="15310" class="Comment">----------------------------------------------</a>
        <a id="15365" class="Symbol">→</a> <a id="15367" href="Peras.Block.html#1905" class="InductiveConstructor">Honest</a> <a id="15374" class="Symbol">{</a><a id="15375" href="Peras.SmallStep.html#14939" class="Bound">p</a><a id="15376" class="Symbol">}</a> <a id="15378" href="Peras.SmallStep.html#14857" class="Datatype Operator">⊢</a>
            <a id="15392" href="Peras.SmallStep.html#14947" class="Bound">M</a> <a id="15394" href="Peras.SmallStep.html#14857" class="Datatype Operator">⇉</a> <a id="15396" href="Peras.SmallStep.html#12806" class="Function Operator">add</a> <a id="15400" class="Symbol">(</a><a id="15401" href="Peras.SmallStep.html#2272" class="InductiveConstructor">VoteMsg</a> <a id="15409" class="Symbol">(</a><a id="15410" href="Peras.SmallStep.html#15244" class="Bound">mem</a> <a id="15414" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="15416" href="Peras.SmallStep.html#15179" class="Bound">sig</a><a id="15419" class="Symbol">)</a> <a id="15421" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="15423" href="Peras.SmallStep.html#2413" class="InductiveConstructor">𝟘</a> <a id="15425" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="15427" href="Peras.SmallStep.html#14939" class="Bound">p</a><a id="15428" class="Symbol">)</a> <a id="15430" href="Peras.SmallStep.html#12806" class="Function Operator">to</a> <a id="15433" href="Peras.SmallStep.html#14943" class="Bound">t</a>
                <a id="15451" href="Peras.SmallStep.html#12806" class="Function Operator">diffuse</a> <a id="15459" href="Peras.SmallStep.html#14947" class="Bound">M</a>
</pre>
<p>Rather than creating a delayed vote, an adversary can honestly create
it and delay the message.</p>
<h2 id="block-creation">Block creation</h2>
<p>Certificates are conditionally added to a block. The following
function determines if there needs to be a certificate provided for a
given voting round and a local block-tree. The conditions are as
follows</p>
<ol type="a">
<li>There is no certificate from 2 rounds ago in certs</li>
<li>The last seen certificate is not expired</li>
<li>The last seen certificate is from a later round than the last
certificate on chain</li>
</ol>
<pre class="Agda">    <a id="15988" href="Peras.SmallStep.html#15988" class="Function">needCert</a> <a id="15997" class="Symbol">:</a> <a id="15999" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="16011" class="Symbol">→</a> <a id="16013" href="Peras.SmallStep.html#6597" class="Bound">T</a> <a id="16015" class="Symbol">→</a> <a id="16017" href="Agda.Builtin.Maybe.html#135" class="Datatype">Maybe</a> <a id="16023" href="Peras.Block.html#2849" class="Record">Certificate</a>
    <a id="16039" href="Peras.SmallStep.html#15988" class="Function">needCert</a> <a id="16048" class="Symbol">(</a><a id="16049" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="16063" href="Peras.SmallStep.html#16063" class="Bound">r</a><a id="16064" class="Symbol">)</a> <a id="16066" href="Peras.SmallStep.html#16066" class="Bound">t</a> <a id="16068" class="Symbol">=</a>
      <a id="16076" class="Keyword">let</a>
        <a id="16088" href="Peras.SmallStep.html#16088" class="Bound">cert⋆</a> <a id="16094" class="Symbol">=</a> <a id="16096" href="Peras.SmallStep.html#5531" class="Function">latestCertOnChain</a> <a id="16114" href="Peras.SmallStep.html#16066" class="Bound">t</a>
        <a id="16124" href="Peras.SmallStep.html#16124" class="Bound">cert′</a> <a id="16130" class="Symbol">=</a> <a id="16132" href="Peras.SmallStep.html#5661" class="Function">latestCertSeen</a> <a id="16147" href="Peras.SmallStep.html#16066" class="Bound">t</a>
      <a id="16155" class="Keyword">in</a>
        <a id="16166" href="Data.Bool.Base.html#1505" class="Function Operator">if</a> <a id="16169" href="Data.Bool.Base.html#941" class="Function">not</a> <a id="16173" class="Symbol">(</a><a id="16174" href="Data.List.Base.html#4896" class="Function">any</a> <a id="16178" class="Symbol">(λ</a> <a id="16181" class="Symbol">{</a><a id="16182" href="Peras.SmallStep.html#16182" class="Bound">c</a> <a id="16184" class="Symbol">→</a> <a id="16186" href="Relation.Nullary.Decidable.Core.html#3623" class="Function Operator">⌊</a> <a id="16188" href="Peras.Block.html#3001" class="Function">roundNumber</a> <a id="16200" href="Peras.SmallStep.html#16182" class="Bound">c</a> <a id="16202" href="Agda.Builtin.Nat.html#336" class="Primitive Operator">+</a> <a id="16204" class="Number">2</a> <a id="16206" href="Data.Nat.Properties.html#3311" class="Function Operator">≟</a> <a id="16208" href="Peras.SmallStep.html#16063" class="Bound">r</a> <a id="16210" href="Relation.Nullary.Decidable.Core.html#3623" class="Function Operator">⌋</a><a id="16211" class="Symbol">})</a> <a id="16214" class="Symbol">(</a><a id="16215" href="Peras.SmallStep.html#5262" class="Function">certs</a> <a id="16221" href="Peras.SmallStep.html#16066" class="Bound">t</a><a id="16222" class="Symbol">))</a> <a id="16225" class="Comment">-- (a)</a>
           <a id="16243" href="Data.Bool.Base.html#995" class="Function Operator">∧</a> <a id="16245" class="Symbol">(</a><a id="16246" href="Peras.SmallStep.html#16063" class="Bound">r</a> <a id="16248" href="Data.Nat.Base.html#1477" class="Function Operator">≤ᵇ</a> <a id="16251" href="Peras.Params.html#249" class="Field">A</a> <a id="16253" href="Agda.Builtin.Nat.html#336" class="Primitive Operator">+</a> <a id="16255" href="Peras.Block.html#3001" class="Function">roundNumber</a> <a id="16267" href="Peras.SmallStep.html#16124" class="Bound">cert′</a><a id="16272" class="Symbol">)</a>                          <a id="16299" class="Comment">-- (b)</a>
           <a id="16317" href="Data.Bool.Base.html#995" class="Function Operator">∧</a> <a id="16319" class="Symbol">(</a><a id="16320" href="Peras.Block.html#3001" class="Function">roundNumber</a> <a id="16332" href="Peras.SmallStep.html#16088" class="Bound">cert⋆</a> <a id="16338" href="Data.Nat.Base.html#1457" class="Primitive Operator">&lt;ᵇ</a> <a id="16341" href="Peras.Block.html#3001" class="Function">roundNumber</a> <a id="16353" href="Peras.SmallStep.html#16124" class="Bound">cert′</a><a id="16358" class="Symbol">)</a>              <a id="16373" class="Comment">-- (c)</a>
        <a id="16388" href="Data.Bool.Base.html#1505" class="Function Operator">then</a> <a id="16393" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="16398" href="Peras.SmallStep.html#16124" class="Bound">cert′</a>
        <a id="16412" href="Data.Bool.Base.html#1505" class="Function Operator">else</a> <a id="16417" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a>
</pre>
Helper function for creating a block
<pre class="Agda">    <a id="16478" href="Peras.SmallStep.html#16478" class="Function">createBlock</a> <a id="16490" class="Symbol">:</a> <a id="16492" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="16503" class="Symbol">→</a> <a id="16505" href="Peras.Block.html#1264" class="Function">PartyId</a> <a id="16513" class="Symbol">→</a> <a id="16515" href="Peras.Crypto.html#2593" class="Record">LeadershipProof</a> <a id="16531" class="Symbol">→</a> <a id="16533" href="Peras.Crypto.html#3115" class="Record">Signature</a> <a id="16543" class="Symbol">→</a> <a id="16545" href="Peras.SmallStep.html#6597" class="Bound">T</a> <a id="16547" class="Symbol">→</a> <a id="16549" href="Peras.Block.html#2807" class="Record">Block</a>
    <a id="16559" href="Peras.SmallStep.html#16478" class="Function">createBlock</a> <a id="16571" href="Peras.SmallStep.html#16571" class="Bound">s</a> <a id="16573" href="Peras.SmallStep.html#16573" class="Bound">p</a> <a id="16575" href="Peras.SmallStep.html#16575" class="Bound">π</a> <a id="16577" href="Peras.SmallStep.html#16577" class="Bound">σ</a> <a id="16579" href="Peras.SmallStep.html#16579" class="Bound">t</a> <a id="16581" class="Symbol">=</a>
      <a id="16589" class="Keyword">record</a>
        <a id="16604" class="Symbol">{</a> <a id="16606" href="Peras.Block.html#3233" class="Field">slotNumber</a> <a id="16617" class="Symbol">=</a> <a id="16619" href="Peras.SmallStep.html#16571" class="Bound">s</a>
        <a id="16629" class="Symbol">;</a> <a id="16631" href="Peras.Block.html#3265" class="Field">creatorId</a> <a id="16641" class="Symbol">=</a> <a id="16643" href="Peras.SmallStep.html#16573" class="Bound">p</a>
        <a id="16653" class="Symbol">;</a> <a id="16655" href="Peras.Block.html#3293" class="Field">parentBlock</a> <a id="16667" class="Symbol">=</a>
            <a id="16681" class="Keyword">let</a> <a id="16685" class="Keyword">open</a> <a id="16690" href="Peras.SmallStep.html#2927" class="Module">IsTreeType</a>
            <a id="16713" class="Keyword">in</a> <a id="16716" href="Peras.Block.html#5471" class="Function">tipHash</a> <a id="16724" class="Symbol">(</a><a id="16725" href="Peras.SmallStep.html#5150" class="Function">preferredChain</a> <a id="16740" href="Peras.SmallStep.html#16579" class="Bound">t</a><a id="16741" class="Symbol">)</a>
        <a id="16751" class="Symbol">;</a> <a id="16753" href="Peras.Block.html#3326" class="Field">certificate</a> <a id="16765" class="Symbol">=</a>
            <a id="16779" class="Keyword">let</a> <a id="16783" href="Peras.SmallStep.html#16783" class="Bound">r</a> <a id="16785" class="Symbol">=</a> <a id="16787" href="Peras.Chain.html#5472" class="Function">v-round</a> <a id="16795" href="Peras.SmallStep.html#16571" class="Bound">s</a>
            <a id="16809" class="Keyword">in</a> <a id="16812" href="Peras.SmallStep.html#15988" class="Function">needCert</a> <a id="16821" href="Peras.SmallStep.html#16783" class="Bound">r</a> <a id="16823" href="Peras.SmallStep.html#16579" class="Bound">t</a>
        <a id="16833" class="Symbol">;</a> <a id="16835" href="Peras.Block.html#3366" class="Field">leadershipProof</a> <a id="16851" class="Symbol">=</a> <a id="16853" href="Peras.SmallStep.html#16575" class="Bound">π</a>
        <a id="16863" class="Symbol">;</a> <a id="16865" href="Peras.Block.html#3438" class="Field">bodyHash</a> <a id="16874" class="Symbol">=</a>
            <a id="16888" class="Keyword">let</a> <a id="16892" href="Peras.SmallStep.html#16892" class="Bound">txs</a> <a id="16896" class="Symbol">=</a> <a id="16898" href="Peras.SmallStep.html#6690" class="Bound">txSelection</a> <a id="16910" href="Peras.SmallStep.html#16571" class="Bound">s</a> <a id="16912" href="Peras.SmallStep.html#16573" class="Bound">p</a>
            <a id="16926" class="Keyword">in</a> <a id="16929" href="Peras.Block.html#3773" class="Field">blockHash</a>
                 <a id="16956" class="Keyword">record</a>
                   <a id="16982" class="Symbol">{</a> <a id="16984" href="Peras.Block.html#3773" class="Field">blockHash</a> <a id="16994" class="Symbol">=</a> <a id="16996" href="Peras.Crypto.html#2033" class="Field">hash</a> <a id="17001" href="Peras.SmallStep.html#16892" class="Bound">txs</a>
                   <a id="17024" class="Symbol">;</a> <a id="17026" href="Peras.Block.html#3806" class="Field">payload</a> <a id="17034" class="Symbol">=</a> <a id="17036" href="Peras.SmallStep.html#16892" class="Bound">txs</a>
                   <a id="17059" class="Symbol">}</a>
        <a id="17069" class="Symbol">;</a> <a id="17071" href="Peras.Block.html#3408" class="Field">signature</a> <a id="17081" class="Symbol">=</a> <a id="17083" href="Peras.SmallStep.html#16577" class="Bound">σ</a>
        <a id="17093" class="Symbol">}</a>
</pre>
<p>A party can create a new block by adding it to the local block tree
and diffuse the block creation messages to the other parties. Block
creation is possible, if as in <em>Praos</em></p>
<ul>
<li>the block signature is correct</li>
<li>the party is the slot leader</li>
</ul>
Block creation updates the party’s local state and for all other parties
a message is added to the message buffer
<pre class="Agda">    <a id="17470" class="Keyword">infix</a> <a id="17476" class="Number">2</a> <a id="17478" href="Peras.SmallStep.html#17494" class="Datatype Operator">_⊢_↷_</a>

    <a id="17489" class="Keyword">data</a> <a id="17494" href="Peras.SmallStep.html#17494" class="Datatype Operator">_⊢_↷_</a> <a id="17500" class="Symbol">:</a> <a id="17502" class="Symbol">{</a><a id="17503" href="Peras.SmallStep.html#17503" class="Bound">p</a> <a id="17505" class="Symbol">:</a> <a id="17507" href="Peras.Block.html#1264" class="Function">PartyId</a><a id="17514" class="Symbol">}</a> <a id="17516" class="Symbol">→</a> <a id="17518" href="Peras.Block.html#1872" class="Datatype">Honesty</a> <a id="17526" href="Peras.SmallStep.html#17503" class="Bound">p</a> <a id="17528" class="Symbol">→</a> <a id="17530" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="17536" class="Symbol">→</a> <a id="17538" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="17544" class="Symbol">→</a> <a id="17546" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="17551" class="Keyword">where</a>

      <a id="17564" href="Peras.SmallStep.html#17564" class="InductiveConstructor">honest</a> <a id="17571" class="Symbol">:</a> <a id="17573" class="Symbol">∀</a> <a id="17575" class="Symbol">{</a><a id="17576" href="Peras.SmallStep.html#17576" class="Bound">p</a><a id="17577" class="Symbol">}</a> <a id="17579" class="Symbol">{</a><a id="17580" href="Peras.SmallStep.html#17580" class="Bound">t</a><a id="17581" class="Symbol">}</a> <a id="17583" class="Symbol">{</a><a id="17584" href="Peras.SmallStep.html#17584" class="Bound">M</a><a id="17585" class="Symbol">}</a> <a id="17587" class="Symbol">{</a><a id="17588" href="Peras.SmallStep.html#17588" class="Bound">π</a><a id="17589" class="Symbol">}</a> <a id="17591" class="Symbol">{</a><a id="17592" href="Peras.SmallStep.html#17592" class="Bound">σ</a><a id="17593" class="Symbol">}</a>
        <a id="17603" class="Symbol">→</a> <a id="17605" class="Keyword">let</a>
            <a id="17621" class="Keyword">open</a> <a id="17626" href="Peras.SmallStep.html#9800" class="Module">State</a>
            <a id="17644" href="Peras.SmallStep.html#17644" class="Bound">s</a> <a id="17646" class="Symbol">=</a> <a id="17648" href="Peras.SmallStep.html#9869" class="Field">clock</a> <a id="17654" href="Peras.SmallStep.html#17584" class="Bound">M</a>
            <a id="17668" href="Peras.SmallStep.html#17668" class="Bound">b</a> <a id="17670" class="Symbol">=</a> <a id="17672" href="Peras.SmallStep.html#16478" class="Function">createBlock</a> <a id="17684" href="Peras.SmallStep.html#17644" class="Bound">s</a> <a id="17686" href="Peras.SmallStep.html#17576" class="Bound">p</a> <a id="17688" href="Peras.SmallStep.html#17588" class="Bound">π</a> <a id="17690" href="Peras.SmallStep.html#17592" class="Bound">σ</a> <a id="17692" href="Peras.SmallStep.html#17580" class="Bound">t</a>
            <a id="17706" href="Peras.SmallStep.html#17706" class="Bound">pref</a> <a id="17711" class="Symbol">=</a> <a id="17713" href="Peras.SmallStep.html#5150" class="Function">preferredChain</a> <a id="17728" href="Peras.SmallStep.html#17580" class="Bound">t</a>
          <a id="17740" class="Keyword">in</a>
          <a id="17753" href="Peras.SmallStep.html#9896" class="Field">blockTrees</a> <a id="17764" href="Peras.SmallStep.html#17584" class="Bound">M</a> <a id="17766" href="Prelude.AssocList.html#847" class="Function Operator">⁉</a> <a id="17768" href="Peras.SmallStep.html#17576" class="Bound">p</a> <a id="17770" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="17772" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="17777" href="Peras.SmallStep.html#17580" class="Bound">t</a>
        <a id="17787" class="Symbol">→</a> <a id="17789" class="Symbol">(</a><a id="17790" href="Peras.SmallStep.html#17790" class="Bound">vc</a> <a id="17793" class="Symbol">:</a> <a id="17795" href="Peras.Chain.html#6113" class="Datatype">ValidChain</a> <a id="17806" class="Symbol">(</a><a id="17807" href="Peras.SmallStep.html#17668" class="Bound">b</a> <a id="17809" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="17811" href="Peras.SmallStep.html#17706" class="Bound">pref</a><a id="17815" class="Symbol">))</a>
          <a id="17828" class="Comment">----------------------------</a>
        <a id="17865" class="Symbol">→</a> <a id="17867" href="Peras.Block.html#1905" class="InductiveConstructor">Honest</a> <a id="17874" class="Symbol">{</a><a id="17875" href="Peras.SmallStep.html#17576" class="Bound">p</a><a id="17876" class="Symbol">}</a> <a id="17878" href="Peras.SmallStep.html#17494" class="Datatype Operator">⊢</a>
            <a id="17892" href="Peras.SmallStep.html#17584" class="Bound">M</a> <a id="17894" href="Peras.SmallStep.html#17494" class="Datatype Operator">↷</a> <a id="17896" href="Peras.SmallStep.html#12806" class="Function Operator">add</a> <a id="17900" class="Symbol">(</a>
                  <a id="17920" href="Peras.SmallStep.html#2220" class="InductiveConstructor">ChainMsg</a> <a id="17929" href="Peras.SmallStep.html#17790" class="Bound">vc</a>
                <a id="17948" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="17950" href="Peras.SmallStep.html#2413" class="InductiveConstructor">𝟘</a>
                <a id="17968" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="17970" href="Peras.SmallStep.html#17576" class="Bound">p</a><a id="17971" class="Symbol">)</a> <a id="17973" href="Peras.SmallStep.html#12806" class="Function Operator">to</a> <a id="17976" href="Peras.SmallStep.html#17580" class="Bound">t</a>
                <a id="17994" href="Peras.SmallStep.html#12806" class="Function Operator">diffuse</a> <a id="18002" href="Peras.SmallStep.html#17584" class="Bound">M</a>
</pre>
<h2 id="small-step-semantics-1">Small-step semantics</h2>
The small-step semantics describe the evolution of the global state.
<pre class="Agda">    <a id="18114" class="Keyword">variable</a>
      <a id="18129" href="Peras.SmallStep.html#18129" class="Generalizable">M</a> <a id="18131" href="Peras.SmallStep.html#18131" class="Generalizable">N</a> <a id="18133" href="Peras.SmallStep.html#18133" class="Generalizable">O</a> <a id="18135" class="Symbol">:</a> <a id="18137" href="Peras.SmallStep.html#9800" class="Record">State</a>
      <a id="18149" href="Peras.SmallStep.html#18149" class="Generalizable">p</a> <a id="18151" class="Symbol">:</a> <a id="18153" href="Peras.Block.html#1264" class="Function">PartyId</a>
      <a id="18167" href="Peras.SmallStep.html#18167" class="Generalizable">h</a> <a id="18169" class="Symbol">:</a> <a id="18171" href="Peras.Block.html#1872" class="Datatype">Honesty</a> <a id="18179" href="Peras.SmallStep.html#18149" class="Generalizable">p</a>
</pre>
<p>The relation allows</p>
<ul>
<li>Fetching messages at the beginning of each slot</li>
<li>Block creation</li>
<li>Voting</li>
<li>Transitioning to next slot in the same voting round</li>
<li>Transitioning to next slot in a new voting round</li>
</ul>
Note, when transitioning to the next slot we need to distinguish whether
the next slot is in the same or a new voting round. This is necessary in
order to detect adversarial behaviour with respect to voting
(adversarialy not voting in a voting round)
<pre class="Agda">    <a id="18651" class="Keyword">data</a> <a id="18656" href="Peras.SmallStep.html#18656" class="Datatype Operator">_↝_</a> <a id="18660" class="Symbol">:</a> <a id="18662" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="18668" class="Symbol">→</a> <a id="18670" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="18676" class="Symbol">→</a> <a id="18678" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="18683" class="Keyword">where</a>

      <a id="18696" href="Peras.SmallStep.html#18696" class="InductiveConstructor">Fetch</a> <a id="18702" class="Symbol">:</a> <a id="18704" class="Symbol">∀</a> <a id="18706" class="Symbol">{</a><a id="18707" href="Peras.SmallStep.html#18707" class="Bound">m</a><a id="18708" class="Symbol">}</a> <a id="18710" class="Symbol">→</a>
        <a id="18720" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="18722" href="Peras.SmallStep.html#18167" class="Generalizable">h</a> <a id="18724" href="Peras.SmallStep.html#13241" class="Datatype Operator">⊢</a> <a id="18726" href="Peras.SmallStep.html#18129" class="Generalizable">M</a> <a id="18728" href="Peras.SmallStep.html#13241" class="Datatype Operator">[</a> <a id="18730" href="Peras.SmallStep.html#18707" class="Bound">m</a> <a id="18732" href="Peras.SmallStep.html#13241" class="Datatype Operator">]⇀</a> <a id="18735" href="Peras.SmallStep.html#18131" class="Generalizable">N</a>
          <a id="18747" href="Prelude.InferenceRules.html#14206" class="Function Operator">──────────────</a>
          <a id="18772" href="Peras.SmallStep.html#18129" class="Generalizable">M</a> <a id="18774" href="Peras.SmallStep.html#18656" class="Datatype Operator">↝</a> <a id="18776" href="Peras.SmallStep.html#18131" class="Generalizable">N</a>

      <a id="18785" href="Peras.SmallStep.html#18785" class="InductiveConstructor">CreateVote</a> <a id="18796" class="Symbol">:</a>
        <a id="18806" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="18808" href="Peras.SmallStep.html#10440" class="Function">Fetched</a> <a id="18816" href="Peras.SmallStep.html#18129" class="Generalizable">M</a>
        <a id="18826" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="18828" href="Peras.SmallStep.html#18167" class="Generalizable">h</a> <a id="18830" href="Peras.SmallStep.html#14857" class="Datatype Operator">⊢</a> <a id="18832" href="Peras.SmallStep.html#18129" class="Generalizable">M</a> <a id="18834" href="Peras.SmallStep.html#14857" class="Datatype Operator">⇉</a> <a id="18836" href="Peras.SmallStep.html#18131" class="Generalizable">N</a>
          <a id="18848" href="Prelude.InferenceRules.html#14291" class="Function Operator">─────────</a>
          <a id="18868" href="Peras.SmallStep.html#18129" class="Generalizable">M</a> <a id="18870" href="Peras.SmallStep.html#18656" class="Datatype Operator">↝</a> <a id="18872" href="Peras.SmallStep.html#18131" class="Generalizable">N</a>

      <a id="18881" href="Peras.SmallStep.html#18881" class="InductiveConstructor">CreateBlock</a> <a id="18893" class="Symbol">:</a>
        <a id="18903" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="18905" href="Peras.SmallStep.html#10440" class="Function">Fetched</a> <a id="18913" href="Peras.SmallStep.html#18129" class="Generalizable">M</a>
        <a id="18923" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="18925" href="Peras.SmallStep.html#18167" class="Generalizable">h</a> <a id="18927" href="Peras.SmallStep.html#17494" class="Datatype Operator">⊢</a> <a id="18929" href="Peras.SmallStep.html#18129" class="Generalizable">M</a> <a id="18931" href="Peras.SmallStep.html#17494" class="Datatype Operator">↷</a> <a id="18933" href="Peras.SmallStep.html#18131" class="Generalizable">N</a>
          <a id="18945" href="Prelude.InferenceRules.html#14291" class="Function Operator">─────────</a>
          <a id="18965" href="Peras.SmallStep.html#18129" class="Generalizable">M</a> <a id="18967" href="Peras.SmallStep.html#18656" class="Datatype Operator">↝</a> <a id="18969" href="Peras.SmallStep.html#18131" class="Generalizable">N</a>

      <a id="18978" href="Peras.SmallStep.html#18978" class="InductiveConstructor">NextSlot</a> <a id="18987" class="Symbol">:</a>
        <a id="18997" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="18999" href="Peras.SmallStep.html#10440" class="Function">Fetched</a> <a id="19007" href="Peras.SmallStep.html#18129" class="Generalizable">M</a>
        <a id="19017" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="19019" href="Peras.SmallStep.html#11100" class="Function">NextSlotInSameRound</a> <a id="19039" href="Peras.SmallStep.html#18129" class="Generalizable">M</a>
          <a id="19051" href="Prelude.InferenceRules.html#14045" class="Function Operator">─────────────────────</a>
          <a id="19083" href="Peras.SmallStep.html#18129" class="Generalizable">M</a> <a id="19085" href="Peras.SmallStep.html#18656" class="Datatype Operator">↝</a> <a id="19087" href="Peras.SmallStep.html#12054" class="Function">tick</a> <a id="19092" href="Peras.SmallStep.html#18129" class="Generalizable">M</a>

      <a id="19101" href="Peras.SmallStep.html#19101" class="InductiveConstructor">NextSlotNewRound</a> <a id="19118" class="Symbol">:</a>
        <a id="19128" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="19130" href="Peras.SmallStep.html#10440" class="Function">Fetched</a> <a id="19138" href="Peras.SmallStep.html#18129" class="Generalizable">M</a>
        <a id="19148" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="19150" href="Peras.SmallStep.html#10650" class="Function">LastSlotInRound</a> <a id="19166" href="Peras.SmallStep.html#18129" class="Generalizable">M</a>
        <a id="19176" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="19178" href="Peras.SmallStep.html#11733" class="Function">RequiredVotes</a> <a id="19192" href="Peras.SmallStep.html#18129" class="Generalizable">M</a>
          <a id="19204" href="Prelude.InferenceRules.html#14143" class="Function Operator">─────────────────</a>
          <a id="19232" href="Peras.SmallStep.html#18129" class="Generalizable">M</a> <a id="19234" href="Peras.SmallStep.html#18656" class="Datatype Operator">↝</a> <a id="19236" href="Peras.SmallStep.html#12054" class="Function">tick</a> <a id="19241" href="Peras.SmallStep.html#18129" class="Generalizable">M</a>
</pre>
<h4 id="reflexive-transitive-closure">Reflexive, transitive closure</h4>
List-like structure for defining execution paths.
<pre class="Agda">    <a id="19344" class="Keyword">infix</a>  <a id="19351" class="Number">2</a> <a id="19353" href="Peras.SmallStep.html#19400" class="Datatype Operator">_↝⋆_</a>
    <a id="19362" class="Keyword">infixr</a> <a id="19369" class="Number">2</a> <a id="19371" href="Peras.SmallStep.html#19457" class="InductiveConstructor Operator">_↣_</a>
    <a id="19379" class="Keyword">infix</a>  <a id="19386" class="Number">3</a> <a id="19388" href="Peras.SmallStep.html#19440" class="InductiveConstructor">∎</a>

    <a id="19395" class="Keyword">data</a> <a id="19400" href="Peras.SmallStep.html#19400" class="Datatype Operator">_↝⋆_</a> <a id="19405" class="Symbol">:</a> <a id="19407" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="19413" class="Symbol">→</a> <a id="19415" href="Peras.SmallStep.html#9800" class="Record">State</a> <a id="19421" class="Symbol">→</a> <a id="19423" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="19428" class="Keyword">where</a>
      <a id="19440" href="Peras.SmallStep.html#19440" class="InductiveConstructor">∎</a> <a id="19442" class="Symbol">:</a> <a id="19444" href="Peras.SmallStep.html#18129" class="Generalizable">M</a> <a id="19446" href="Peras.SmallStep.html#19400" class="Datatype Operator">↝⋆</a> <a id="19449" href="Peras.SmallStep.html#18129" class="Generalizable">M</a>
      <a id="19457" href="Peras.SmallStep.html#19457" class="InductiveConstructor Operator">_↣_</a> <a id="19461" class="Symbol">:</a> <a id="19463" href="Peras.SmallStep.html#18129" class="Generalizable">M</a> <a id="19465" href="Peras.SmallStep.html#18656" class="Datatype Operator">↝</a> <a id="19467" href="Peras.SmallStep.html#18131" class="Generalizable">N</a> <a id="19469" class="Symbol">→</a> <a id="19471" href="Peras.SmallStep.html#18131" class="Generalizable">N</a> <a id="19473" href="Peras.SmallStep.html#19400" class="Datatype Operator">↝⋆</a> <a id="19476" href="Peras.SmallStep.html#18133" class="Generalizable">O</a> <a id="19478" class="Symbol">→</a> <a id="19480" href="Peras.SmallStep.html#18129" class="Generalizable">M</a> <a id="19482" href="Peras.SmallStep.html#19400" class="Datatype Operator">↝⋆</a> <a id="19485" href="Peras.SmallStep.html#18133" class="Generalizable">O</a>
</pre>
<pre class="Agda">  <a id="19501" class="Keyword">open</a> <a id="19506" href="Peras.SmallStep.html#6575" class="Module">Semantics</a> <a id="19516" class="Keyword">public</a>
</pre>
</body>
</html>
