<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Peras.SmallStep</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="Agda.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<pre class="Agda"><a id="9" class="Keyword">module</a> <a id="16" href="Peras.SmallStep.html" class="Module">Peras.SmallStep</a> <a id="32" class="Keyword">where</a>
</pre>
<!--
<pre class="Agda"><a id="55" class="Keyword">open</a> <a id="60" class="Keyword">import</a> <a id="67" href="Prelude.AssocList.html" class="Module">Prelude.AssocList</a>
<a id="85" class="Keyword">open</a> <a id="90" class="Keyword">import</a> <a id="97" href="Prelude.DecEq.html" class="Module">Prelude.DecEq</a> <a id="111" class="Keyword">using</a> <a id="117" class="Symbol">(</a><a id="118" href="Prelude.DecEq.html#62" class="Record">DecEq</a><a id="123" class="Symbol">)</a>
<a id="125" class="Keyword">open</a> <a id="130" class="Keyword">import</a> <a id="137" href="Prelude.Default.html" class="Module">Prelude.Default</a> <a id="153" class="Keyword">using</a> <a id="159" class="Symbol">(</a><a id="160" href="Prelude.Default.html#100" class="Record">Default</a><a id="167" class="Symbol">)</a>
<a id="169" class="Keyword">open</a> <a id="174" href="Prelude.Default.html#100" class="Module">Default</a> <a id="182" class="Symbol">⦃...⦄</a>

<a id="189" class="Keyword">open</a> <a id="194" class="Keyword">import</a> <a id="201" href="Prelude.InferenceRules.html" class="Module">Prelude.InferenceRules</a>
<a id="224" class="Keyword">open</a> <a id="229" class="Keyword">import</a> <a id="236" href="Prelude.Init.html" class="Module">Prelude.Init</a> <a id="249" class="Keyword">hiding</a> <a id="256" class="Symbol">(</a><a id="257" href="Data.List.Relation.Binary.Sublist.Setoid.html#1567" class="Function Operator">_⊆_</a><a id="260" class="Symbol">)</a>

<a id="263" class="Keyword">open</a> <a id="268" href="Prelude.Init.html#940" class="Module">Nat</a> <a id="272" class="Keyword">using</a> <a id="278" class="Symbol">(</a><a id="279" href="Data.Nat.Properties.html#3311" class="Function Operator">_≟_</a><a id="282" class="Symbol">;</a> <a id="284" href="Data.Nat.Properties.html#6146" class="Function Operator">_≤?_</a><a id="288" class="Symbol">;</a> <a id="290" href="Data.Nat.Base.html#1477" class="Function Operator">_≤ᵇ_</a><a id="294" class="Symbol">;</a> <a id="296" href="Data.Nat.Properties.html#6212" class="Function Operator">_≥?_</a><a id="300" class="Symbol">;</a> <a id="302" href="Data.Nat.Base.html#7279" class="Function Operator">_%_</a><a id="305" class="Symbol">;</a> <a id="307" href="Data.Nat.Properties.html#10900" class="Function Operator">_&gt;?_</a><a id="311" class="Symbol">;</a> <a id="313" href="Data.Nat.Base.html#3260" class="Record">NonZero</a><a id="320" class="Symbol">)</a>
<a id="322" class="Keyword">open</a> <a id="327" href="Prelude.Init.html#2456" class="Module">L</a> <a id="329" class="Keyword">using</a> <a id="335" class="Symbol">(</a><a id="336" href="Data.List.Base.html#4538" class="Function">concat</a><a id="342" class="Symbol">)</a>
<a id="344" class="Keyword">open</a> <a id="349" href="Prelude.Init.html#2546" class="Module">L.All</a> <a id="355" class="Keyword">using</a> <a id="361" class="Symbol">(</a><a id="362" href="Data.List.Relation.Unary.All.html#1627" class="Datatype">All</a><a id="365" class="Symbol">)</a>
<a id="367" class="Keyword">open</a> <a id="372" href="Prelude.Init.html#2680" class="Module">L.Any</a> <a id="378" class="Keyword">using</a> <a id="384" class="Symbol">(</a><a id="385" href="Data.List.Relation.Unary.Any.html#1163" class="Datatype">Any</a><a id="388" class="Symbol">;</a> <a id="390" href="Data.List.Relation.Unary.Any.html#2138" class="Function Operator">_─_</a><a id="393" class="Symbol">;</a> <a id="395" href="Data.List.Relation.Unary.Any.html#2694" class="Function">any?</a><a id="399" class="Symbol">)</a> <a id="401" class="Keyword">renaming</a> <a id="410" class="Symbol">(</a><a id="411" href="Data.List.Relation.Unary.Any.html#2027" class="Function Operator">_∷=_</a> <a id="416" class="Symbol">to</a> <a id="419" class="Function Operator">_∷ˡ=_</a><a id="424" class="Symbol">)</a>

<a id="427" class="Keyword">open</a> <a id="432" class="Keyword">import</a> <a id="439" href="Peras.Block.html" class="Module">Peras.Block</a>
<a id="451" class="Keyword">open</a> <a id="456" class="Keyword">import</a> <a id="463" href="Peras.Chain.html" class="Module">Peras.Chain</a>
<a id="475" class="Keyword">open</a> <a id="480" class="Keyword">import</a> <a id="487" href="Peras.Crypto.html" class="Module">Peras.Crypto</a>
<a id="500" class="Keyword">open</a> <a id="505" class="Keyword">import</a> <a id="512" href="Peras.Numbering.html" class="Module">Peras.Numbering</a>
<a id="528" class="Keyword">open</a> <a id="533" class="Keyword">import</a> <a id="540" href="Peras.Params.html" class="Module">Peras.Params</a>

<a id="554" class="Keyword">open</a> <a id="559" class="Keyword">import</a> <a id="566" href="Data.List.Relation.Binary.Subset.Propositional.html" class="Module">Data.List.Relation.Binary.Subset.Propositional</a> <a id="613" class="Symbol">{</a><a id="614" class="Argument">A</a> <a id="616" class="Symbol">=</a> <a id="618" href="Peras.Block.html#2965" class="Record">Block</a><a id="623" class="Symbol">}</a> <a id="625" class="Keyword">using</a> <a id="631" class="Symbol">(</a><a id="632" href="Data.List.Relation.Binary.Subset.Setoid.html#825" class="Function Operator">_⊆_</a><a id="635" class="Symbol">)</a>
<a id="637" class="Keyword">open</a> <a id="642" class="Keyword">import</a> <a id="649" href="Data.List.Relation.Binary.Subset.Propositional.html" class="Module">Data.List.Relation.Binary.Subset.Propositional</a> <a id="696" class="Symbol">{</a><a id="697" class="Argument">A</a> <a id="699" class="Symbol">=</a> <a id="701" href="Peras.Block.html#3007" class="Record">Certificate</a><a id="712" class="Symbol">}</a> <a id="714" class="Keyword">renaming</a> <a id="723" class="Symbol">(</a><a id="724" href="Data.List.Relation.Binary.Subset.Setoid.html#825" class="Function Operator">_⊆_</a> <a id="728" class="Symbol">to</a> <a id="731" class="Function Operator">_⊆ᶜ_</a><a id="735" class="Symbol">)</a>

<a id="738" class="Keyword">open</a> <a id="743" href="Peras.Block.html#2030" class="Module">Honesty</a> <a id="751" class="Keyword">public</a>
<a id="758" class="Keyword">open</a> <a id="763" href="Peras.Crypto.html#2161" class="Module">MembershipProof</a> <a id="779" class="Keyword">public</a>
<a id="786" class="Keyword">open</a> <a id="791" href="Peras.Crypto.html#3115" class="Module">Signature</a> <a id="801" class="Keyword">public</a>
<a id="808" class="Keyword">open</a> <a id="813" href="Peras.Numbering.html#1669" class="Module">RoundNumber</a> <a id="825" class="Keyword">public</a>
<a id="832" class="Keyword">open</a> <a id="837" href="Peras.Block.html#1606" class="Module">Party</a>
</pre>-->
<h1 id="small-step-semantics">Small-step semantics</h1>
<p>The small-step semantics of the <strong>Ouroboros Peras</strong>
protocol define the evolution of the global state of the system
modelling <em>honest</em> and <em>adversarial</em> parties. The number
of parties is fixed during the execution of the protocol and the list of
parties has to be provided as a module parameter. In addition the model
is parameterized by the lotteries (for slot leadership and voting
committee membership) as well as the type of the block tree. Furthermore
adversarial parties share generic, adversarial state.</p>
<p>References:</p>
<ul>
<li>Formalizing Nakamoto-Style Proof of Stake, Søren Eller Thomsen and
Bas Spitters</li>
</ul>
<h3 id="parameters">Parameters</h3>
<p>The parameters for the <em>Peras</em> protocol and hash functions are
defined as instance arguments of the module.</p>
<pre class="Agda"><a id="1617" class="Keyword">module</a> <a id="1624" href="Peras.SmallStep.html#1624" class="Module">_</a> <a id="1626" class="Symbol">⦃</a> <a id="1628" href="Peras.SmallStep.html#1628" class="Bound">_</a> <a id="1630" class="Symbol">:</a> <a id="1632" href="Peras.Crypto.html#1994" class="Record">Hashable</a> <a id="1641" href="Peras.Block.html#2965" class="Record">Block</a> <a id="1647" class="Symbol">⦄</a>
         <a id="1658" class="Symbol">⦃</a> <a id="1660" href="Peras.SmallStep.html#1660" class="Bound">_</a> <a id="1662" class="Symbol">:</a> <a id="1664" href="Peras.Crypto.html#1994" class="Record">Hashable</a> <a id="1673" class="Symbol">(</a><a id="1674" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="1679" href="Peras.Block.html#2487" class="Function">Tx</a><a id="1681" class="Symbol">)</a> <a id="1683" class="Symbol">⦄</a>
         <a id="1694" class="Symbol">⦃</a> <a id="1696" href="Peras.SmallStep.html#1696" class="Bound">_</a> <a id="1698" class="Symbol">:</a> <a id="1700" href="Peras.Params.html#166" class="Record">Params</a> <a id="1707" class="Symbol">⦄</a>
         <a id="1718" class="Symbol">⦃</a> <a id="1720" href="Peras.SmallStep.html#1720" class="Bound">_</a> <a id="1722" class="Symbol">:</a> <a id="1724" href="Peras.Chain.html#3042" class="Record">Network</a> <a id="1732" class="Symbol">⦄</a>
         <a id="1743" class="Symbol">⦃</a> <a id="1745" href="Peras.SmallStep.html#1745" class="Bound">_</a> <a id="1747" class="Symbol">:</a> <a id="1749" href="Peras.Chain.html#2776" class="Record">Postulates</a> <a id="1760" class="Symbol">⦄</a>

         <a id="1772" class="Keyword">where</a>
</pre>
The block tree, resp. the validity of the chain is defined with respect
of the parameters.
<pre class="Agda">  <a id="1887" class="Keyword">open</a> <a id="1892" href="Peras.Crypto.html#1994" class="Module">Hashable</a> <a id="1901" class="Symbol">⦃...⦄</a>
  <a id="1909" class="Keyword">open</a> <a id="1914" href="Peras.Params.html#166" class="Module">Params</a> <a id="1921" class="Symbol">⦃...⦄</a>
  <a id="1929" class="Keyword">open</a> <a id="1934" href="Peras.Chain.html#3042" class="Module">Network</a> <a id="1942" class="Symbol">⦃...⦄</a>
  <a id="1950" class="Keyword">open</a> <a id="1955" href="Peras.Chain.html#2776" class="Module">Postulates</a> <a id="1966" class="Symbol">⦃...⦄</a>
</pre>
<h4 id="messages">Messages</h4>
Messages for sending and receiving chains and votes. Note, in the
<em>Peras</em> protocol certificates are not diffused explicitly.
<pre class="Agda">  <a id="2126" class="Keyword">data</a> <a id="2131" href="Peras.SmallStep.html#2131" class="Datatype">Message</a> <a id="2139" class="Symbol">:</a> <a id="2141" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="2146" class="Keyword">where</a>
    <a id="2156" href="Peras.SmallStep.html#2156" class="InductiveConstructor">ChainMsg</a> <a id="2165" class="Symbol">:</a> <a id="2167" href="Peras.Chain.html#3845" class="Function">Chain</a> <a id="2173" class="Symbol">→</a> <a id="2175" href="Peras.SmallStep.html#2131" class="Datatype">Message</a>
    <a id="2187" href="Peras.SmallStep.html#2187" class="InductiveConstructor">VoteMsg</a> <a id="2195" class="Symbol">:</a> <a id="2197" href="Peras.Chain.html#1483" class="Record">Vote</a> <a id="2202" class="Symbol">→</a> <a id="2204" href="Peras.SmallStep.html#2131" class="Datatype">Message</a>
</pre>
<!--
<pre class="Agda"><a id="2229" class="Comment">{-
  Message-injective : ∀ {b₁ b₂}
    → ChainMsg b₁ ≡ ChainMsg b₂
    → b₁ ≡ b₂
  Message-injective refl = refl
-}</a>
</pre><pre class="Agda"><a id="2357" class="Comment">{-
  Message-injective′ : ∀ {b₁ b₂}
    → b₁ ≢ b₂
    → ChainMsg b₁ ≢ ChainMsg b₂
  Message-injective′ = contraposition Message-injective
-}</a>
</pre>Messages can be delayed by a number of slots
<pre class="Agda">  <a id="2557" href="Peras.SmallStep.html#2557" class="Function">Delay</a> <a id="2563" class="Symbol">=</a> <a id="2565" href="Data.Fin.Base.html#1154" class="Datatype">Fin</a> <a id="2569" class="Symbol">(</a><a id="2570" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="2574" class="Symbol">(</a><a id="2575" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="2579" href="Peras.Chain.html#3075" class="Field">Δ</a><a id="2580" class="Symbol">))</a>

  <a id="2586" class="Keyword">pattern</a> <a id="2594" href="Peras.SmallStep.html#2594" class="InductiveConstructor">𝟘</a> <a id="2596" class="Symbol">=</a> <a id="2598" href="Data.Fin.Base.html#1176" class="InductiveConstructor">fzero</a>
  <a id="2606" class="Keyword">pattern</a> <a id="2614" href="Peras.SmallStep.html#2614" class="InductiveConstructor">𝟙</a> <a id="2616" class="Symbol">=</a> <a id="2618" href="Data.Fin.Base.html#1197" class="InductiveConstructor">fsuc</a> <a id="2623" href="Data.Fin.Base.html#1176" class="InductiveConstructor">fzero</a>
  <a id="2631" class="Keyword">pattern</a> <a id="2639" href="Peras.SmallStep.html#2639" class="InductiveConstructor">𝟚</a> <a id="2641" class="Symbol">=</a> <a id="2643" href="Data.Fin.Base.html#1197" class="InductiveConstructor">fsuc</a> <a id="2648" class="Symbol">(</a><a id="2649" href="Data.Fin.Base.html#1197" class="InductiveConstructor">fsuc</a> <a id="2654" href="Data.Fin.Base.html#1176" class="InductiveConstructor">fzero</a><a id="2659" class="Symbol">)</a>
</pre>Messages are put into an envelope and assigned to a party. The message can be
delayed.
<pre class="Agda">  <a id="2762" class="Keyword">record</a> <a id="2769" href="Peras.SmallStep.html#2769" class="Record">Envelope</a> <a id="2778" class="Symbol">:</a> <a id="2780" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="2785" class="Keyword">where</a>
    <a id="2795" class="Keyword">constructor</a> <a id="2807" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">⦅_,_,_,_⦆</a>
    <a id="2821" class="Keyword">field</a>
      <a id="2833" href="Peras.SmallStep.html#2833" class="Field">partyId</a> <a id="2841" class="Symbol">:</a> <a id="2843" href="Peras.Block.html#1264" class="Function">PartyId</a>
      <a id="2857" href="Peras.SmallStep.html#2857" class="Field">honesty</a> <a id="2865" class="Symbol">:</a> <a id="2867" href="Peras.Block.html#2030" class="Datatype">Honesty</a> <a id="2875" href="Peras.SmallStep.html#2833" class="Field">partyId</a>
      <a id="2889" href="Peras.SmallStep.html#2889" class="Field">message</a> <a id="2897" class="Symbol">:</a> <a id="2899" href="Peras.SmallStep.html#2131" class="Datatype">Message</a>
      <a id="2913" href="Peras.SmallStep.html#2913" class="Field">delay</a> <a id="2919" class="Symbol">:</a> <a id="2921" href="Peras.SmallStep.html#2557" class="Function">Delay</a>

  <a id="2930" class="Keyword">open</a> <a id="2935" href="Peras.SmallStep.html#2769" class="Module">Envelope</a>
</pre><!--
<pre class="Agda">  <a id="2963" href="Peras.SmallStep.html#2963" class="Function">⦅⦆-injective</a> <a id="2976" class="Symbol">:</a> <a id="2978" class="Symbol">∀</a> <a id="2980" class="Symbol">{</a><a id="2981" href="Peras.SmallStep.html#2981" class="Bound">e₁</a> <a id="2984" href="Peras.SmallStep.html#2984" class="Bound">e₂</a><a id="2986" class="Symbol">}</a>
    <a id="2992" class="Symbol">→</a> <a id="2994" href="Peras.SmallStep.html#2981" class="Bound">e₁</a> <a id="2997" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="2999" href="Peras.SmallStep.html#2984" class="Bound">e₂</a>
    <a id="3006" class="Symbol">→</a> <a id="3008" href="Peras.SmallStep.html#2833" class="Field">partyId</a> <a id="3016" href="Peras.SmallStep.html#2981" class="Bound">e₁</a> <a id="3019" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="3021" href="Peras.SmallStep.html#2833" class="Field">partyId</a> <a id="3029" href="Peras.SmallStep.html#2984" class="Bound">e₂</a>
  <a id="3034" href="Peras.SmallStep.html#2963" class="Function">⦅⦆-injective</a> <a id="3047" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a> <a id="3052" class="Symbol">=</a> <a id="3054" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a>
</pre><pre class="Agda">  <a id="3073" href="Peras.SmallStep.html#3073" class="Function">⦅⦆-injective₃</a> <a id="3087" class="Symbol">:</a> <a id="3089" class="Symbol">∀</a> <a id="3091" class="Symbol">{</a><a id="3092" href="Peras.SmallStep.html#3092" class="Bound">e₁</a> <a id="3095" href="Peras.SmallStep.html#3095" class="Bound">e₂</a><a id="3097" class="Symbol">}</a>
    <a id="3103" class="Symbol">→</a> <a id="3105" href="Peras.SmallStep.html#3092" class="Bound">e₁</a> <a id="3108" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="3110" href="Peras.SmallStep.html#3095" class="Bound">e₂</a>
    <a id="3117" class="Symbol">→</a> <a id="3119" href="Peras.SmallStep.html#2889" class="Field">message</a> <a id="3127" href="Peras.SmallStep.html#3092" class="Bound">e₁</a> <a id="3130" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="3132" href="Peras.SmallStep.html#2889" class="Field">message</a> <a id="3140" href="Peras.SmallStep.html#3095" class="Bound">e₂</a>
  <a id="3145" href="Peras.SmallStep.html#3073" class="Function">⦅⦆-injective₃</a> <a id="3159" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a> <a id="3164" class="Symbol">=</a> <a id="3166" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a>
</pre><pre class="Agda">  <a id="3185" href="Peras.SmallStep.html#3185" class="Function">⦅⦆-injective′</a> <a id="3199" class="Symbol">:</a> <a id="3201" class="Symbol">∀</a> <a id="3203" class="Symbol">{</a><a id="3204" href="Peras.SmallStep.html#3204" class="Bound">e₁</a> <a id="3207" href="Peras.SmallStep.html#3207" class="Bound">e₂</a><a id="3209" class="Symbol">}</a>
    <a id="3215" class="Symbol">→</a> <a id="3217" href="Peras.SmallStep.html#2833" class="Field">partyId</a> <a id="3225" href="Peras.SmallStep.html#3204" class="Bound">e₁</a> <a id="3228" href="Relation.Binary.PropositionalEquality.Core.html#858" class="Function Operator">≢</a> <a id="3230" href="Peras.SmallStep.html#2833" class="Field">partyId</a> <a id="3238" href="Peras.SmallStep.html#3207" class="Bound">e₂</a>
    <a id="3245" class="Symbol">→</a> <a id="3247" href="Peras.SmallStep.html#3204" class="Bound">e₁</a> <a id="3250" href="Relation.Binary.PropositionalEquality.Core.html#858" class="Function Operator">≢</a> <a id="3252" href="Peras.SmallStep.html#3207" class="Bound">e₂</a>
  <a id="3257" href="Peras.SmallStep.html#3185" class="Function">⦅⦆-injective′</a> <a id="3271" class="Symbol">=</a> <a id="3273" href="Relation.Nullary.Negation.Core.html#1446" class="Function">contraposition</a> <a id="3288" href="Peras.SmallStep.html#2963" class="Function">⦅⦆-injective</a>
</pre><pre class="Agda">  <a id="3315" href="Peras.SmallStep.html#3315" class="Function">⦅⦆-injective₃′</a> <a id="3330" class="Symbol">:</a> <a id="3332" class="Symbol">∀</a> <a id="3334" class="Symbol">{</a><a id="3335" href="Peras.SmallStep.html#3335" class="Bound">e₁</a> <a id="3338" href="Peras.SmallStep.html#3338" class="Bound">e₂</a><a id="3340" class="Symbol">}</a>
    <a id="3346" class="Symbol">→</a> <a id="3348" href="Peras.SmallStep.html#2889" class="Field">message</a> <a id="3356" href="Peras.SmallStep.html#3335" class="Bound">e₁</a> <a id="3359" href="Relation.Binary.PropositionalEquality.Core.html#858" class="Function Operator">≢</a> <a id="3361" href="Peras.SmallStep.html#2889" class="Field">message</a> <a id="3369" href="Peras.SmallStep.html#3338" class="Bound">e₂</a>
    <a id="3376" class="Symbol">→</a> <a id="3378" href="Peras.SmallStep.html#3335" class="Bound">e₁</a> <a id="3381" href="Relation.Binary.PropositionalEquality.Core.html#858" class="Function Operator">≢</a> <a id="3383" href="Peras.SmallStep.html#3338" class="Bound">e₂</a>
  <a id="3388" href="Peras.SmallStep.html#3315" class="Function">⦅⦆-injective₃′</a> <a id="3403" class="Symbol">=</a> <a id="3405" href="Relation.Nullary.Negation.Core.html#1446" class="Function">contraposition</a> <a id="3420" href="Peras.SmallStep.html#3073" class="Function">⦅⦆-injective₃</a>
</pre>-->
<h4 id="block-tree">Block-tree</h4>
<p>A block-tree is defined by properties - an implementation of the
block-tree has to fulfil all the properties mentioned below:</p>
<pre class="Agda">  <a id="3596" class="Keyword">record</a> <a id="3603" href="Peras.SmallStep.html#3603" class="Record">IsTreeType</a> <a id="3614" class="Symbol">{</a><a id="3615" href="Peras.SmallStep.html#3615" class="Bound">T</a> <a id="3617" class="Symbol">:</a> <a id="3619" href="Agda.Primitive.html#388" class="Primitive">Type</a><a id="3623" class="Symbol">}</a>
                    <a id="3645" class="Symbol">(</a><a id="3646" href="Peras.SmallStep.html#3646" class="Bound">tree₀</a> <a id="3652" class="Symbol">:</a> <a id="3654" href="Peras.SmallStep.html#3615" class="Bound">T</a><a id="3655" class="Symbol">)</a>
                    <a id="3677" class="Symbol">(</a><a id="3678" href="Peras.SmallStep.html#3678" class="Bound">newChain</a> <a id="3687" class="Symbol">:</a> <a id="3689" href="Peras.SmallStep.html#3615" class="Bound">T</a> <a id="3691" class="Symbol">→</a> <a id="3693" href="Peras.Chain.html#3845" class="Function">Chain</a> <a id="3699" class="Symbol">→</a> <a id="3701" href="Peras.SmallStep.html#3615" class="Bound">T</a><a id="3702" class="Symbol">)</a>
                    <a id="3724" class="Symbol">(</a><a id="3725" href="Peras.SmallStep.html#3725" class="Bound">allChains</a> <a id="3735" class="Symbol">:</a> <a id="3737" href="Peras.SmallStep.html#3615" class="Bound">T</a> <a id="3739" class="Symbol">→</a> <a id="3741" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="3746" href="Peras.Chain.html#3845" class="Function">Chain</a><a id="3751" class="Symbol">)</a>
                    <a id="3773" class="Symbol">(</a><a id="3774" href="Peras.SmallStep.html#3774" class="Bound">preferredChain</a> <a id="3789" class="Symbol">:</a> <a id="3791" href="Peras.SmallStep.html#3615" class="Bound">T</a> <a id="3793" class="Symbol">→</a> <a id="3795" href="Peras.Chain.html#3845" class="Function">Chain</a><a id="3800" class="Symbol">)</a>
                    <a id="3822" class="Symbol">(</a><a id="3823" href="Peras.SmallStep.html#3823" class="Bound">addVote</a> <a id="3831" class="Symbol">:</a> <a id="3833" href="Peras.SmallStep.html#3615" class="Bound">T</a> <a id="3835" class="Symbol">→</a> <a id="3837" href="Peras.Chain.html#1483" class="Record">Vote</a> <a id="3842" class="Symbol">→</a> <a id="3844" href="Peras.SmallStep.html#3615" class="Bound">T</a><a id="3845" class="Symbol">)</a>
                    <a id="3867" class="Symbol">(</a><a id="3868" href="Peras.SmallStep.html#3868" class="Bound">votes</a> <a id="3874" class="Symbol">:</a> <a id="3876" href="Peras.SmallStep.html#3615" class="Bound">T</a> <a id="3878" class="Symbol">→</a> <a id="3880" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="3885" href="Peras.Chain.html#1483" class="Record">Vote</a><a id="3889" class="Symbol">)</a>
                    <a id="3911" class="Symbol">(</a><a id="3912" href="Peras.SmallStep.html#3912" class="Bound">certs</a> <a id="3918" class="Symbol">:</a> <a id="3920" href="Peras.SmallStep.html#3615" class="Bound">T</a> <a id="3922" class="Symbol">→</a> <a id="3924" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="3929" href="Peras.Block.html#3007" class="Record">Certificate</a><a id="3940" class="Symbol">)</a>
                    <a id="3962" class="Symbol">(</a><a id="3963" href="Peras.SmallStep.html#3963" class="Bound">cert₀</a> <a id="3969" class="Symbol">:</a> <a id="3971" href="Peras.Block.html#3007" class="Record">Certificate</a><a id="3982" class="Symbol">)</a>
         <a id="3993" class="Symbol">:</a> <a id="3995" href="Agda.Primitive.html#388" class="Primitive">Type₁</a> <a id="4001" class="Keyword">where</a>

    <a id="4012" class="Keyword">field</a>
</pre>
Properties that must hold with respect to chains, certificates and
votes.
<pre class="Agda">      <a id="4110" href="Peras.SmallStep.html#4110" class="Field">instantiated</a> <a id="4123" class="Symbol">:</a>
        <a id="4133" href="Peras.SmallStep.html#3774" class="Bound">preferredChain</a> <a id="4148" href="Peras.SmallStep.html#3646" class="Bound">tree₀</a> <a id="4154" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="4156" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>

      <a id="4166" href="Peras.SmallStep.html#4166" class="Field">instantiated-certs</a> <a id="4185" class="Symbol">:</a>
        <a id="4195" href="Peras.SmallStep.html#3912" class="Bound">certs</a> <a id="4201" href="Peras.SmallStep.html#3646" class="Bound">tree₀</a> <a id="4207" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="4209" href="Peras.SmallStep.html#3963" class="Bound">cert₀</a> <a id="4215" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="4217" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>

      <a id="4227" href="Peras.SmallStep.html#4227" class="Field">instantiated-votes</a> <a id="4246" class="Symbol">:</a>
        <a id="4256" href="Peras.SmallStep.html#3868" class="Bound">votes</a> <a id="4262" href="Peras.SmallStep.html#3646" class="Bound">tree₀</a> <a id="4268" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="4270" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>

      <a id="4280" href="Peras.SmallStep.html#4280" class="Field">extendable-chain</a> <a id="4297" class="Symbol">:</a> <a id="4299" class="Symbol">∀</a> <a id="4301" class="Symbol">(</a><a id="4302" href="Peras.SmallStep.html#4302" class="Bound">t</a> <a id="4304" class="Symbol">:</a> <a id="4306" href="Peras.SmallStep.html#3615" class="Bound">T</a><a id="4307" class="Symbol">)</a> <a id="4309" class="Symbol">(</a><a id="4310" href="Peras.SmallStep.html#4310" class="Bound">c</a> <a id="4312" class="Symbol">:</a> <a id="4314" href="Peras.Chain.html#3845" class="Function">Chain</a><a id="4319" class="Symbol">)</a>
        <a id="4329" class="Symbol">→</a> <a id="4331" href="Peras.SmallStep.html#3912" class="Bound">certs</a> <a id="4337" class="Symbol">(</a><a id="4338" href="Peras.SmallStep.html#3678" class="Bound">newChain</a> <a id="4347" href="Peras.SmallStep.html#4302" class="Bound">t</a> <a id="4349" href="Peras.SmallStep.html#4310" class="Bound">c</a><a id="4350" class="Symbol">)</a> <a id="4352" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="4354" href="Peras.Chain.html#3928" class="Function">certsFromChain</a> <a id="4369" href="Peras.SmallStep.html#4310" class="Bound">c</a> <a id="4371" href="Data.List.Base.html#1954" class="Function Operator">++</a> <a id="4374" href="Peras.SmallStep.html#3912" class="Bound">certs</a> <a id="4380" href="Peras.SmallStep.html#4302" class="Bound">t</a> <a id="4382" class="Comment">-- TODO: set union</a>

      <a id="4408" href="Peras.SmallStep.html#4408" class="Field">valid</a> <a id="4414" class="Symbol">:</a> <a id="4416" class="Symbol">∀</a> <a id="4418" class="Symbol">(</a><a id="4419" href="Peras.SmallStep.html#4419" class="Bound">t</a> <a id="4421" class="Symbol">:</a> <a id="4423" href="Peras.SmallStep.html#3615" class="Bound">T</a><a id="4424" class="Symbol">)</a>
        <a id="4434" class="Symbol">→</a> <a id="4436" href="Peras.Chain.html#6731" class="Datatype">ValidChain</a> <a id="4447" class="Symbol">(</a><a id="4448" href="Peras.SmallStep.html#3774" class="Bound">preferredChain</a> <a id="4463" href="Peras.SmallStep.html#4419" class="Bound">t</a><a id="4464" class="Symbol">)</a>

      <a id="4473" href="Peras.SmallStep.html#4473" class="Field">optimal</a> <a id="4481" class="Symbol">:</a> <a id="4483" class="Symbol">∀</a> <a id="4485" class="Symbol">(</a><a id="4486" href="Peras.SmallStep.html#4486" class="Bound">c</a> <a id="4488" class="Symbol">:</a> <a id="4490" href="Peras.Chain.html#3845" class="Function">Chain</a><a id="4495" class="Symbol">)</a> <a id="4497" class="Symbol">(</a><a id="4498" href="Peras.SmallStep.html#4498" class="Bound">t</a> <a id="4500" class="Symbol">:</a> <a id="4502" href="Peras.SmallStep.html#3615" class="Bound">T</a><a id="4503" class="Symbol">)</a>
        <a id="4513" class="Symbol">→</a> <a id="4515" class="Keyword">let</a>
            <a id="4531" href="Peras.SmallStep.html#4531" class="Bound">b</a> <a id="4533" class="Symbol">=</a> <a id="4535" href="Peras.SmallStep.html#3774" class="Bound">preferredChain</a> <a id="4550" href="Peras.SmallStep.html#4498" class="Bound">t</a>
            <a id="4564" href="Peras.SmallStep.html#4564" class="Bound">cts</a> <a id="4568" class="Symbol">=</a> <a id="4570" href="Peras.SmallStep.html#3912" class="Bound">certs</a> <a id="4576" href="Peras.SmallStep.html#4498" class="Bound">t</a>
          <a id="4588" class="Keyword">in</a>
          <a id="4601" href="Peras.Chain.html#6731" class="Datatype">ValidChain</a> <a id="4612" href="Peras.SmallStep.html#4486" class="Bound">c</a>
        <a id="4622" class="Symbol">→</a> <a id="4624" href="Peras.SmallStep.html#4486" class="Bound">c</a> <a id="4626" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="4628" href="Peras.SmallStep.html#3725" class="Bound">allChains</a> <a id="4638" href="Peras.SmallStep.html#4498" class="Bound">t</a>
        <a id="4648" class="Symbol">→</a> <a id="4650" href="Peras.Chain.html#6189" class="Function Operator">∥</a> <a id="4652" href="Peras.SmallStep.html#4486" class="Bound">c</a> <a id="4654" href="Peras.Chain.html#6189" class="Function Operator">∥</a> <a id="4656" href="Peras.SmallStep.html#4564" class="Bound">cts</a> <a id="4660" href="Data.Nat.Base.html#1691" class="Datatype Operator">≤</a> <a id="4662" href="Peras.Chain.html#6189" class="Function Operator">∥</a> <a id="4664" href="Peras.SmallStep.html#4531" class="Bound">b</a> <a id="4666" href="Peras.Chain.html#6189" class="Function Operator">∥</a> <a id="4668" href="Peras.SmallStep.html#4564" class="Bound">cts</a>

      <a id="4679" href="Peras.SmallStep.html#4679" class="Field">self-contained</a> <a id="4694" class="Symbol">:</a> <a id="4696" class="Symbol">∀</a> <a id="4698" class="Symbol">(</a><a id="4699" href="Peras.SmallStep.html#4699" class="Bound">t</a> <a id="4701" class="Symbol">:</a> <a id="4703" href="Peras.SmallStep.html#3615" class="Bound">T</a><a id="4704" class="Symbol">)</a>
        <a id="4714" class="Symbol">→</a> <a id="4716" href="Peras.SmallStep.html#3774" class="Bound">preferredChain</a> <a id="4731" href="Peras.SmallStep.html#4699" class="Bound">t</a> <a id="4733" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="4735" href="Peras.SmallStep.html#3725" class="Bound">allChains</a> <a id="4745" href="Peras.SmallStep.html#4699" class="Bound">t</a>

      <a id="4754" href="Peras.SmallStep.html#4754" class="Field">valid-votes</a> <a id="4766" class="Symbol">:</a> <a id="4768" class="Symbol">∀</a> <a id="4770" class="Symbol">(</a><a id="4771" href="Peras.SmallStep.html#4771" class="Bound">t</a> <a id="4773" class="Symbol">:</a> <a id="4775" href="Peras.SmallStep.html#3615" class="Bound">T</a><a id="4776" class="Symbol">)</a>
        <a id="4786" class="Symbol">→</a> <a id="4788" href="Data.List.Relation.Unary.All.html#1627" class="Datatype">All</a> <a id="4792" href="Peras.Chain.html#3165" class="Function">ValidVote</a> <a id="4802" class="Symbol">(</a><a id="4803" href="Peras.SmallStep.html#3868" class="Bound">votes</a> <a id="4809" href="Peras.SmallStep.html#4771" class="Bound">t</a><a id="4810" class="Symbol">)</a>

      <a id="4819" href="Peras.SmallStep.html#4819" class="Field">unique-votes</a> <a id="4832" class="Symbol">:</a> <a id="4834" class="Symbol">∀</a> <a id="4836" class="Symbol">(</a><a id="4837" href="Peras.SmallStep.html#4837" class="Bound">t</a> <a id="4839" class="Symbol">:</a> <a id="4841" href="Peras.SmallStep.html#3615" class="Bound">T</a><a id="4842" class="Symbol">)</a> <a id="4844" class="Symbol">(</a><a id="4845" href="Peras.SmallStep.html#4845" class="Bound">v</a> <a id="4847" class="Symbol">:</a> <a id="4849" href="Peras.Chain.html#1483" class="Record">Vote</a><a id="4853" class="Symbol">)</a>
        <a id="4863" class="Symbol">→</a> <a id="4865" class="Keyword">let</a> <a id="4869" href="Peras.SmallStep.html#4869" class="Bound">vs</a> <a id="4872" class="Symbol">=</a> <a id="4874" href="Peras.SmallStep.html#3868" class="Bound">votes</a> <a id="4880" href="Peras.SmallStep.html#4837" class="Bound">t</a>
          <a id="4892" class="Keyword">in</a>
          <a id="4905" href="Peras.SmallStep.html#4845" class="Bound">v</a> <a id="4907" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="4909" href="Peras.SmallStep.html#4869" class="Bound">vs</a>
        <a id="4920" class="Symbol">→</a> <a id="4922" href="Peras.SmallStep.html#4869" class="Bound">vs</a> <a id="4925" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="4927" href="Peras.SmallStep.html#3868" class="Bound">votes</a> <a id="4933" class="Symbol">(</a><a id="4934" href="Peras.SmallStep.html#3823" class="Bound">addVote</a> <a id="4942" href="Peras.SmallStep.html#4837" class="Bound">t</a> <a id="4944" href="Peras.SmallStep.html#4845" class="Bound">v</a><a id="4945" class="Symbol">)</a>

      <a id="4954" href="Peras.SmallStep.html#4954" class="Field">no-equivocations</a> <a id="4971" class="Symbol">:</a> <a id="4973" class="Symbol">∀</a> <a id="4975" class="Symbol">(</a><a id="4976" href="Peras.SmallStep.html#4976" class="Bound">t</a> <a id="4978" class="Symbol">:</a> <a id="4980" href="Peras.SmallStep.html#3615" class="Bound">T</a><a id="4981" class="Symbol">)</a> <a id="4983" class="Symbol">(</a><a id="4984" href="Peras.SmallStep.html#4984" class="Bound">v</a> <a id="4986" class="Symbol">:</a> <a id="4988" href="Peras.Chain.html#1483" class="Record">Vote</a><a id="4992" class="Symbol">)</a>
        <a id="5002" class="Symbol">→</a> <a id="5004" class="Keyword">let</a> <a id="5008" href="Peras.SmallStep.html#5008" class="Bound">vs</a> <a id="5011" class="Symbol">=</a> <a id="5013" href="Peras.SmallStep.html#3868" class="Bound">votes</a> <a id="5019" href="Peras.SmallStep.html#4976" class="Bound">t</a>
          <a id="5031" class="Keyword">in</a>
          <a id="5044" href="Data.List.Relation.Unary.Any.html#1163" class="Datatype">Any</a> <a id="5048" class="Symbol">(</a><a id="5049" href="Peras.SmallStep.html#4984" class="Bound">v</a> <a id="5051" href="Peras.Chain.html#3448" class="Datatype Operator">∻_</a><a id="5053" class="Symbol">)</a> <a id="5055" href="Peras.SmallStep.html#5008" class="Bound">vs</a>
        <a id="5066" class="Symbol">→</a> <a id="5068" href="Peras.SmallStep.html#5008" class="Bound">vs</a> <a id="5071" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="5073" href="Peras.SmallStep.html#3868" class="Bound">votes</a> <a id="5079" class="Symbol">(</a><a id="5080" href="Peras.SmallStep.html#3823" class="Bound">addVote</a> <a id="5088" href="Peras.SmallStep.html#4976" class="Bound">t</a> <a id="5090" href="Peras.SmallStep.html#4984" class="Bound">v</a><a id="5091" class="Symbol">)</a>

      <a id="5100" href="Peras.SmallStep.html#5100" class="Field">quorum-cert</a> <a id="5112" class="Symbol">:</a> <a id="5114" class="Symbol">∀</a> <a id="5116" class="Symbol">(</a><a id="5117" href="Peras.SmallStep.html#5117" class="Bound">t</a> <a id="5119" class="Symbol">:</a> <a id="5121" href="Peras.SmallStep.html#3615" class="Bound">T</a><a id="5122" class="Symbol">)</a> <a id="5124" class="Symbol">(</a><a id="5125" href="Peras.SmallStep.html#5125" class="Bound">b</a> <a id="5127" class="Symbol">:</a> <a id="5129" href="Peras.Block.html#2965" class="Record">Block</a><a id="5134" class="Symbol">)</a> <a id="5136" class="Symbol">(</a><a id="5137" href="Peras.SmallStep.html#5137" class="Bound">r</a> <a id="5139" class="Symbol">:</a> <a id="5141" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="5142" class="Symbol">)</a>
        <a id="5152" class="Symbol">→</a> <a id="5154" href="Data.List.Base.html#5083" class="Function">length</a> <a id="5161" class="Symbol">(</a><a id="5162" href="Data.List.Base.html#10878" class="Function">filter</a> <a id="5169" class="Symbol">(λ</a> <a id="5172" class="Symbol">{</a><a id="5173" href="Peras.SmallStep.html#5173" class="Bound">v</a> <a id="5175" class="Symbol">→</a>
                    <a id="5197" class="Symbol">(</a><a id="5198" href="Peras.Numbering.html#1729" class="Field">getRoundNumber</a> <a id="5213" class="Symbol">(</a><a id="5214" href="Peras.Chain.html#1529" class="Field">votingRound</a> <a id="5226" href="Peras.SmallStep.html#5173" class="Bound">v</a><a id="5227" class="Symbol">)</a> <a id="5229" href="Data.Nat.Properties.html#3311" class="Function Operator">≟</a> <a id="5231" href="Peras.SmallStep.html#5137" class="Bound">r</a><a id="5232" class="Symbol">)</a>
              <a id="5248" href="Relation.Nullary.Decidable.Core.html#2609" class="Function Operator">×-dec</a> <a id="5254" class="Symbol">(</a><a id="5255" href="Peras.Chain.html#1631" class="Field">blockHash</a> <a id="5265" href="Peras.SmallStep.html#5173" class="Bound">v</a> <a id="5267" href="Peras.Block.html#3700" class="Function Operator">≟-BlockHash</a> <a id="5279" href="Peras.Crypto.html#2033" class="Field">hash</a> <a id="5284" href="Peras.SmallStep.html#5125" class="Bound">b</a><a id="5285" class="Symbol">)}</a>
            <a id="5300" class="Symbol">)</a> <a id="5302" class="Symbol">(</a><a id="5303" href="Peras.SmallStep.html#3868" class="Bound">votes</a> <a id="5309" href="Peras.SmallStep.html#5117" class="Bound">t</a><a id="5310" class="Symbol">))</a> <a id="5313" href="Data.Nat.Base.html#2259" class="Function Operator">≥</a> <a id="5315" href="Peras.Params.html#263" class="Field">τ</a>
        <a id="5325" class="Symbol">→</a> <a id="5327" href="Data.List.Relation.Unary.Any.html#1163" class="Datatype">Any</a> <a id="5331" class="Symbol">(λ</a> <a id="5334" class="Symbol">{</a><a id="5335" href="Peras.SmallStep.html#5335" class="Bound">c</a> <a id="5337" class="Symbol">→</a>
            <a id="5351" class="Symbol">(</a><a id="5352" href="Peras.Numbering.html#1729" class="Field">getRoundNumber</a> <a id="5367" class="Symbol">(</a><a id="5368" href="Peras.Block.html#3106" class="Field">round</a> <a id="5374" href="Peras.SmallStep.html#5335" class="Bound">c</a><a id="5375" class="Symbol">)</a> <a id="5377" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="5379" href="Peras.SmallStep.html#5137" class="Bound">r</a><a id="5380" class="Symbol">)</a>
          <a id="5392" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="5394" class="Symbol">(</a><a id="5395" href="Peras.Block.html#3134" class="Field">blockRef</a> <a id="5404" href="Peras.SmallStep.html#5335" class="Bound">c</a> <a id="5406" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="5408" href="Peras.Crypto.html#2033" class="Field">hash</a> <a id="5413" href="Peras.SmallStep.html#5125" class="Bound">b</a><a id="5414" class="Symbol">)</a> <a id="5416" class="Symbol">})</a> <a id="5419" class="Symbol">(</a><a id="5420" href="Peras.SmallStep.html#3912" class="Bound">certs</a> <a id="5426" href="Peras.SmallStep.html#5117" class="Bound">t</a><a id="5427" class="Symbol">)</a>
</pre>
In addition to chains the block-tree manages votes and certificates as
well. The block-tree type is defined as follows:
<pre class="Agda">  <a id="5563" class="Keyword">record</a> <a id="5570" href="Peras.SmallStep.html#5570" class="Record">TreeType</a> <a id="5579" class="Symbol">(</a><a id="5580" href="Peras.SmallStep.html#5580" class="Bound">T</a> <a id="5582" class="Symbol">:</a> <a id="5584" href="Agda.Primitive.html#388" class="Primitive">Type</a><a id="5588" class="Symbol">)</a> <a id="5590" class="Symbol">:</a> <a id="5592" href="Agda.Primitive.html#388" class="Primitive">Type₁</a> <a id="5598" class="Keyword">where</a>

    <a id="5609" class="Keyword">field</a>
      <a id="5621" href="Peras.SmallStep.html#5621" class="Field">tree₀</a> <a id="5627" class="Symbol">:</a> <a id="5629" href="Peras.SmallStep.html#5580" class="Bound">T</a>
      <a id="5637" href="Peras.SmallStep.html#5637" class="Field">newChain</a> <a id="5646" class="Symbol">:</a> <a id="5648" href="Peras.SmallStep.html#5580" class="Bound">T</a> <a id="5650" class="Symbol">→</a> <a id="5652" href="Peras.Chain.html#3845" class="Function">Chain</a> <a id="5658" class="Symbol">→</a> <a id="5660" href="Peras.SmallStep.html#5580" class="Bound">T</a>
      <a id="5668" href="Peras.SmallStep.html#5668" class="Field">allChains</a> <a id="5678" class="Symbol">:</a> <a id="5680" href="Peras.SmallStep.html#5580" class="Bound">T</a> <a id="5682" class="Symbol">→</a> <a id="5684" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="5689" href="Peras.Chain.html#3845" class="Function">Chain</a>
      <a id="5701" href="Peras.SmallStep.html#5701" class="Field">preferredChain</a> <a id="5716" class="Symbol">:</a> <a id="5718" href="Peras.SmallStep.html#5580" class="Bound">T</a> <a id="5720" class="Symbol">→</a> <a id="5722" href="Peras.Chain.html#3845" class="Function">Chain</a>

      <a id="5735" href="Peras.SmallStep.html#5735" class="Field">addVote</a> <a id="5743" class="Symbol">:</a> <a id="5745" href="Peras.SmallStep.html#5580" class="Bound">T</a> <a id="5747" class="Symbol">→</a> <a id="5749" href="Peras.Chain.html#1483" class="Record">Vote</a> <a id="5754" class="Symbol">→</a> <a id="5756" href="Peras.SmallStep.html#5580" class="Bound">T</a>

      <a id="5765" href="Peras.SmallStep.html#5765" class="Field">votes</a> <a id="5771" class="Symbol">:</a> <a id="5773" href="Peras.SmallStep.html#5580" class="Bound">T</a> <a id="5775" class="Symbol">→</a> <a id="5777" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="5782" href="Peras.Chain.html#1483" class="Record">Vote</a>
      <a id="5793" href="Peras.SmallStep.html#5793" class="Field">certs</a> <a id="5799" class="Symbol">:</a> <a id="5801" href="Peras.SmallStep.html#5580" class="Bound">T</a> <a id="5803" class="Symbol">→</a> <a id="5805" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="5810" href="Peras.Block.html#3007" class="Record">Certificate</a>

    <a id="5827" href="Peras.SmallStep.html#5827" class="Function">cert₀</a> <a id="5833" class="Symbol">:</a> <a id="5835" href="Peras.Block.html#3007" class="Record">Certificate</a>
    <a id="5851" href="Peras.SmallStep.html#5827" class="Function">cert₀</a> <a id="5857" class="Symbol">=</a> <a id="5859" href="Peras.Block.html#3084" class="InductiveConstructor">MkCertificate</a> <a id="5873" class="Symbol">(</a><a id="5874" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="5888" class="Number">0</a><a id="5889" class="Symbol">)</a> <a id="5891" class="Symbol">(</a><a id="5892" href="Peras.Crypto.html#1583" class="InductiveConstructor">MkHash</a> <a id="5899" href="Peras.Crypto.html#676" class="Postulate">emptyBS</a><a id="5906" class="Symbol">)</a>

    <a id="5913" class="Keyword">field</a>
      <a id="5925" href="Peras.SmallStep.html#5925" class="Field">is-TreeType</a> <a id="5937" class="Symbol">:</a> <a id="5939" href="Peras.SmallStep.html#3603" class="Record">IsTreeType</a>
                      <a id="5972" href="Peras.SmallStep.html#5621" class="Field">tree₀</a> <a id="5978" href="Peras.SmallStep.html#5637" class="Field">newChain</a> <a id="5987" href="Peras.SmallStep.html#5668" class="Field">allChains</a> <a id="5997" href="Peras.SmallStep.html#5701" class="Field">preferredChain</a>
                      <a id="6034" href="Peras.SmallStep.html#5735" class="Field">addVote</a> <a id="6042" href="Peras.SmallStep.html#5765" class="Field">votes</a> <a id="6048" href="Peras.SmallStep.html#5793" class="Field">certs</a> <a id="6054" href="Peras.SmallStep.html#5827" class="Function">cert₀</a>

    <a id="6065" href="Peras.SmallStep.html#6065" class="Function">latestCertOnChain</a> <a id="6083" class="Symbol">:</a> <a id="6085" href="Peras.SmallStep.html#5580" class="Bound">T</a> <a id="6087" class="Symbol">→</a> <a id="6089" href="Peras.Block.html#3007" class="Record">Certificate</a>
    <a id="6105" href="Peras.SmallStep.html#6065" class="Function">latestCertOnChain</a> <a id="6123" class="Symbol">=</a>
      <a id="6131" href="Peras.Block.html#3238" class="Function">latestCert</a> <a id="6142" href="Peras.SmallStep.html#5827" class="Function">cert₀</a> <a id="6148" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6150" href="Data.List.Base.html#1716" class="Function">L.mapMaybe</a> <a id="6161" href="Peras.Block.html#3484" class="Field">certificate</a> <a id="6173" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6175" href="Peras.SmallStep.html#5701" class="Field">preferredChain</a>

    <a id="6195" href="Peras.SmallStep.html#6195" class="Function">latestCertSeen</a> <a id="6210" class="Symbol">:</a> <a id="6212" href="Peras.SmallStep.html#5580" class="Bound">T</a> <a id="6214" class="Symbol">→</a> <a id="6216" href="Peras.Block.html#3007" class="Record">Certificate</a>
    <a id="6232" href="Peras.SmallStep.html#6195" class="Function">latestCertSeen</a> <a id="6247" class="Symbol">=</a> <a id="6249" href="Peras.Block.html#3238" class="Function">latestCert</a> <a id="6260" href="Peras.SmallStep.html#5827" class="Function">cert₀</a> <a id="6266" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6268" href="Peras.SmallStep.html#5793" class="Field">certs</a>

    <a id="6279" href="Peras.SmallStep.html#6279" class="Function">hasCert</a> <a id="6287" class="Symbol">:</a> <a id="6289" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="6301" class="Symbol">→</a> <a id="6303" href="Peras.SmallStep.html#5580" class="Bound">T</a> <a id="6305" class="Symbol">→</a> <a id="6307" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="6316" href="Peras.SmallStep.html#6279" class="Function">hasCert</a> <a id="6324" class="Symbol">(</a><a id="6325" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="6339" href="Peras.SmallStep.html#6339" class="Bound">r</a><a id="6340" class="Symbol">)</a> <a id="6342" class="Symbol">=</a> <a id="6344" href="Data.List.Relation.Unary.Any.html#1163" class="Datatype">Any</a> <a id="6348" class="Symbol">((</a><a id="6350" href="Peras.SmallStep.html#6339" class="Bound">r</a> <a id="6352" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡_</a><a id="6354" class="Symbol">)</a> <a id="6356" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6358" href="Peras.Block.html#3159" class="Function">roundNumber</a><a id="6369" class="Symbol">)</a> <a id="6371" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6373" href="Peras.SmallStep.html#5793" class="Field">certs</a>

    <a id="6384" href="Peras.SmallStep.html#6384" class="Function">hasCert?</a> <a id="6393" class="Symbol">:</a> <a id="6395" class="Symbol">(</a><a id="6396" href="Peras.SmallStep.html#6396" class="Bound">r</a> <a id="6398" class="Symbol">:</a> <a id="6400" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a><a id="6411" class="Symbol">)</a> <a id="6413" class="Symbol">(</a><a id="6414" href="Peras.SmallStep.html#6414" class="Bound">t</a> <a id="6416" class="Symbol">:</a> <a id="6418" href="Peras.SmallStep.html#5580" class="Bound">T</a><a id="6419" class="Symbol">)</a> <a id="6421" class="Symbol">→</a> <a id="6423" href="Relation.Nullary.Decidable.Core.html#1485" class="Record">Dec</a> <a id="6427" class="Symbol">(</a><a id="6428" href="Peras.SmallStep.html#6279" class="Function">hasCert</a> <a id="6436" href="Peras.SmallStep.html#6396" class="Bound">r</a> <a id="6438" href="Peras.SmallStep.html#6414" class="Bound">t</a><a id="6439" class="Symbol">)</a>
    <a id="6445" href="Peras.SmallStep.html#6384" class="Function">hasCert?</a> <a id="6454" class="Symbol">(</a><a id="6455" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="6469" href="Peras.SmallStep.html#6469" class="Bound">r</a><a id="6470" class="Symbol">)</a> <a id="6472" class="Symbol">=</a> <a id="6474" href="Data.List.Relation.Unary.Any.html#2694" class="Function">any?</a> <a id="6479" class="Symbol">((</a><a id="6481" href="Peras.SmallStep.html#6469" class="Bound">r</a> <a id="6483" href="Data.Nat.Properties.html#3311" class="Function Operator">≟_</a><a id="6485" class="Symbol">)</a> <a id="6487" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6489" href="Peras.Block.html#3159" class="Function">roundNumber</a><a id="6500" class="Symbol">)</a> <a id="6502" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6504" href="Peras.SmallStep.html#5793" class="Field">certs</a>

    <a id="6515" href="Peras.SmallStep.html#6515" class="Function">hasVote</a> <a id="6523" class="Symbol">:</a> <a id="6525" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="6537" class="Symbol">→</a> <a id="6539" href="Peras.SmallStep.html#5580" class="Bound">T</a> <a id="6541" class="Symbol">→</a> <a id="6543" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="6552" href="Peras.SmallStep.html#6515" class="Function">hasVote</a> <a id="6560" class="Symbol">(</a><a id="6561" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="6575" href="Peras.SmallStep.html#6575" class="Bound">r</a><a id="6576" class="Symbol">)</a> <a id="6578" class="Symbol">=</a> <a id="6580" href="Data.List.Relation.Unary.Any.html#1163" class="Datatype">Any</a> <a id="6584" class="Symbol">((</a><a id="6586" href="Peras.SmallStep.html#6575" class="Bound">r</a> <a id="6588" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡_</a><a id="6590" class="Symbol">)</a> <a id="6592" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6594" href="Peras.Chain.html#1691" class="Function">votingRound&#39;</a><a id="6606" class="Symbol">)</a> <a id="6608" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6610" href="Peras.SmallStep.html#5765" class="Field">votes</a>

    <a id="6621" href="Peras.SmallStep.html#6621" class="Function">hasVote?</a> <a id="6630" class="Symbol">:</a> <a id="6632" class="Symbol">(</a><a id="6633" href="Peras.SmallStep.html#6633" class="Bound">r</a> <a id="6635" class="Symbol">:</a> <a id="6637" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a><a id="6648" class="Symbol">)</a> <a id="6650" class="Symbol">(</a><a id="6651" href="Peras.SmallStep.html#6651" class="Bound">t</a> <a id="6653" class="Symbol">:</a> <a id="6655" href="Peras.SmallStep.html#5580" class="Bound">T</a><a id="6656" class="Symbol">)</a> <a id="6658" class="Symbol">→</a> <a id="6660" href="Relation.Nullary.Decidable.Core.html#1485" class="Record">Dec</a> <a id="6664" class="Symbol">(</a><a id="6665" href="Peras.SmallStep.html#6515" class="Function">hasVote</a> <a id="6673" href="Peras.SmallStep.html#6633" class="Bound">r</a> <a id="6675" href="Peras.SmallStep.html#6651" class="Bound">t</a><a id="6676" class="Symbol">)</a>
    <a id="6682" href="Peras.SmallStep.html#6621" class="Function">hasVote?</a> <a id="6691" class="Symbol">(</a><a id="6692" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="6706" href="Peras.SmallStep.html#6706" class="Bound">r</a><a id="6707" class="Symbol">)</a> <a id="6709" class="Symbol">=</a> <a id="6711" href="Data.List.Relation.Unary.Any.html#2694" class="Function">any?</a> <a id="6716" class="Symbol">((</a><a id="6718" href="Peras.SmallStep.html#6706" class="Bound">r</a> <a id="6720" href="Data.Nat.Properties.html#3311" class="Function Operator">≟_</a><a id="6722" class="Symbol">)</a> <a id="6724" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6726" href="Peras.Chain.html#1691" class="Function">votingRound&#39;</a><a id="6738" class="Symbol">)</a> <a id="6740" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6742" href="Peras.SmallStep.html#5765" class="Field">votes</a>

    <a id="6753" href="Peras.SmallStep.html#6753" class="Function">preferredChain′</a> <a id="6769" class="Symbol">:</a> <a id="6771" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="6782" class="Symbol">→</a> <a id="6784" href="Peras.SmallStep.html#5580" class="Bound">T</a> <a id="6786" class="Symbol">→</a> <a id="6788" href="Peras.Chain.html#3845" class="Function">Chain</a>
    <a id="6798" href="Peras.SmallStep.html#6753" class="Function">preferredChain′</a> <a id="6814" class="Symbol">(</a><a id="6815" href="Peras.Numbering.html#779" class="InductiveConstructor">MkSlotNumber</a> <a id="6828" href="Peras.SmallStep.html#6828" class="Bound">sl</a><a id="6830" class="Symbol">)</a> <a id="6832" class="Symbol">=</a>
      <a id="6840" class="Keyword">let</a> <a id="6844" href="Peras.SmallStep.html#6844" class="Bound">cond</a> <a id="6849" class="Symbol">=</a> <a id="6851" class="Symbol">(</a><a id="6852" href="Data.Nat.Properties.html#6146" class="Function Operator">_≤?</a> <a id="6856" href="Peras.SmallStep.html#6828" class="Bound">sl</a><a id="6858" class="Symbol">)</a> <a id="6860" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6862" href="Peras.Block.html#3623" class="Function">slotNumber&#39;</a>
      <a id="6880" class="Keyword">in</a> <a id="6883" href="Data.List.Base.html#10878" class="Function">filter</a> <a id="6890" href="Peras.SmallStep.html#6844" class="Bound">cond</a> <a id="6895" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6897" href="Peras.SmallStep.html#5701" class="Field">preferredChain</a>

    <a id="6917" href="Peras.SmallStep.html#6917" class="Function">allBlocks</a> <a id="6927" class="Symbol">:</a> <a id="6929" href="Peras.SmallStep.html#5580" class="Bound">T</a> <a id="6931" class="Symbol">→</a> <a id="6933" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="6938" href="Peras.Block.html#2965" class="Record">Block</a>
    <a id="6948" href="Peras.SmallStep.html#6917" class="Function">allBlocks</a> <a id="6958" class="Symbol">=</a> <a id="6960" href="Data.List.Base.html#4538" class="Function">concat</a> <a id="6967" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="6969" href="Peras.SmallStep.html#5668" class="Field">allChains</a>
</pre>
<h3 id="additional-parameters">Additional parameters</h3>
<p>In order to define the semantics the following parameters are
required additionally:</p>
<ul>
<li>The type of the block-tree</li>
<li>adversarialState₀ is the initial adversarial state</li>
<li>Tx selection function per party and slot number</li>
<li>The list of parties</li>
</ul>
<pre class="Agda">  <a id="7269" class="Keyword">module</a> <a id="7276" href="Peras.SmallStep.html#7276" class="Module">Semantics</a>
           <a id="7297" class="Symbol">{</a><a id="7298" href="Peras.SmallStep.html#7298" class="Bound">T</a> <a id="7300" class="Symbol">:</a> <a id="7302" href="Agda.Primitive.html#388" class="Primitive">Type</a><a id="7306" class="Symbol">}</a> <a id="7308" class="Symbol">{</a><a id="7309" href="Peras.SmallStep.html#7309" class="Bound">blockTree</a> <a id="7319" class="Symbol">:</a> <a id="7321" href="Peras.SmallStep.html#5570" class="Record">TreeType</a> <a id="7330" href="Peras.SmallStep.html#7298" class="Bound">T</a><a id="7331" class="Symbol">}</a>
           <a id="7344" class="Symbol">{</a><a id="7345" href="Peras.SmallStep.html#7345" class="Bound">S</a> <a id="7347" class="Symbol">:</a> <a id="7349" href="Agda.Primitive.html#388" class="Primitive">Type</a><a id="7353" class="Symbol">}</a> <a id="7355" class="Symbol">{</a><a id="7356" href="Peras.SmallStep.html#7356" class="Bound">adversarialState₀</a> <a id="7374" class="Symbol">:</a> <a id="7376" href="Peras.SmallStep.html#7345" class="Bound">S</a><a id="7377" class="Symbol">}</a>
           <a id="7390" class="Symbol">{</a><a id="7391" href="Peras.SmallStep.html#7391" class="Bound">txSelection</a> <a id="7403" class="Symbol">:</a> <a id="7405" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="7416" class="Symbol">→</a> <a id="7418" href="Peras.Block.html#1264" class="Function">PartyId</a> <a id="7426" class="Symbol">→</a> <a id="7428" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="7433" href="Peras.Block.html#2487" class="Function">Tx</a><a id="7435" class="Symbol">}</a>
           <a id="7448" class="Symbol">{</a><a id="7449" href="Peras.SmallStep.html#7449" class="Bound">parties</a> <a id="7457" class="Symbol">:</a> <a id="7459" href="Peras.Block.html#2191" class="Function">Parties</a><a id="7466" class="Symbol">}</a> <a id="7468" class="Comment">-- TODO: use parties from blockTrees</a>
                               <a id="7536" class="Comment">-- i.e. allow dynamic participation</a>

           <a id="7584" class="Keyword">where</a>

    <a id="7595" class="Keyword">open</a> <a id="7600" href="Peras.SmallStep.html#5570" class="Module">TreeType</a> <a id="7609" href="Peras.SmallStep.html#7309" class="Bound">blockTree</a>

    <a id="7624" class="Keyword">private</a>
      <a id="7638" class="Keyword">instance</a>
        <a id="7655" href="Peras.SmallStep.html#7655" class="Function">Default-T</a> <a id="7665" class="Symbol">:</a> <a id="7667" href="Prelude.Default.html#100" class="Record">Default</a> <a id="7675" href="Peras.SmallStep.html#7298" class="Bound">T</a>
        <a id="7685" href="Peras.SmallStep.html#7655" class="Function">Default-T</a> <a id="7695" class="Symbol">.</a><a id="7696" href="Prelude.Default.html#140" class="Field">def</a> <a id="7700" class="Symbol">=</a> <a id="7702" href="Peras.SmallStep.html#5621" class="Function">tree₀</a>
</pre>
<h4 id="block-tree-update">Block-tree update</h4>
<p>Updating the block-tree upon receiving a message for vote and block
messages.</p>
<pre class="Agda">    <a id="7827" class="Keyword">data</a> <a id="7832" href="Peras.SmallStep.html#7832" class="Datatype Operator">_[_]→_</a> <a id="7839" class="Symbol">:</a> <a id="7841" href="Peras.SmallStep.html#7298" class="Bound">T</a> <a id="7843" class="Symbol">→</a> <a id="7845" href="Peras.SmallStep.html#2131" class="Datatype">Message</a> <a id="7853" class="Symbol">→</a> <a id="7855" href="Peras.SmallStep.html#7298" class="Bound">T</a> <a id="7857" class="Symbol">→</a> <a id="7859" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="7864" class="Keyword">where</a>

      <a id="7877" href="Peras.SmallStep.html#7877" class="InductiveConstructor">VoteReceived</a> <a id="7890" class="Symbol">:</a> <a id="7892" class="Symbol">∀</a> <a id="7894" class="Symbol">{</a><a id="7895" href="Peras.SmallStep.html#7895" class="Bound">v</a> <a id="7897" href="Peras.SmallStep.html#7897" class="Bound">t</a><a id="7898" class="Symbol">}</a> <a id="7900" class="Symbol">→</a>
          <a id="7912" href="Prelude.InferenceRules.html#45702" class="Function Operator">────────────────────────────</a>
          <a id="7951" href="Peras.SmallStep.html#7897" class="Bound">t</a> <a id="7953" href="Peras.SmallStep.html#7832" class="Datatype Operator">[</a> <a id="7955" href="Peras.SmallStep.html#2187" class="InductiveConstructor">VoteMsg</a> <a id="7963" href="Peras.SmallStep.html#7895" class="Bound">v</a> <a id="7965" href="Peras.SmallStep.html#7832" class="Datatype Operator">]→</a> <a id="7968" href="Peras.SmallStep.html#5735" class="Function">addVote</a> <a id="7976" href="Peras.SmallStep.html#7897" class="Bound">t</a> <a id="7978" href="Peras.SmallStep.html#7895" class="Bound">v</a>

      <a id="7987" href="Peras.SmallStep.html#7987" class="InductiveConstructor">ChainReceived</a> <a id="8001" class="Symbol">:</a> <a id="8003" class="Symbol">∀</a> <a id="8005" class="Symbol">{</a><a id="8006" href="Peras.SmallStep.html#8006" class="Bound">c</a> <a id="8008" href="Peras.SmallStep.html#8008" class="Bound">t</a><a id="8009" class="Symbol">}</a> <a id="8011" class="Symbol">→</a>
          <a id="8023" href="Prelude.InferenceRules.html#45468" class="Function Operator">──────────────────────────────</a>
          <a id="8064" href="Peras.SmallStep.html#8008" class="Bound">t</a> <a id="8066" href="Peras.SmallStep.html#7832" class="Datatype Operator">[</a> <a id="8068" href="Peras.SmallStep.html#2156" class="InductiveConstructor">ChainMsg</a> <a id="8077" href="Peras.SmallStep.html#8006" class="Bound">c</a> <a id="8079" href="Peras.SmallStep.html#7832" class="Datatype Operator">]→</a> <a id="8082" href="Peras.SmallStep.html#5637" class="Function">newChain</a> <a id="8091" href="Peras.SmallStep.html#8008" class="Bound">t</a> <a id="8093" href="Peras.SmallStep.html#8006" class="Bound">c</a>
</pre>
<h4 id="vote-in-round">Vote in round</h4>
<p>When does a party vote in a round? The protocol expects regular
voting, i.e. if in the previous round a quorum has been achieved or that
voting resumes after a cool-down phase.</p>
<h4 id="blockselection">BlockSelection</h4>
<pre class="Agda">    <a id="8329" href="Peras.SmallStep.html#8329" class="Function">BlockSelection&#39;</a> <a id="8345" class="Symbol">:</a> <a id="8347" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="8358" class="Symbol">→</a> <a id="8360" href="Peras.Chain.html#3845" class="Function">Chain</a> <a id="8366" class="Symbol">→</a> <a id="8368" href="Peras.Crypto.html#1542" class="Record">Hash</a> <a id="8373" href="Peras.Block.html#2965" class="Record">Block</a>
    <a id="8383" href="Peras.SmallStep.html#8329" class="Function">BlockSelection&#39;</a> <a id="8399" class="Symbol">(</a><a id="8400" href="Peras.Numbering.html#779" class="InductiveConstructor">MkSlotNumber</a> <a id="8413" href="Peras.SmallStep.html#8413" class="Bound">s</a><a id="8414" class="Symbol">)</a> <a id="8416" class="Symbol">=</a>
      <a id="8424" href="Peras.Block.html#5629" class="Function">hashHead</a> <a id="8433" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="8435" href="Data.List.Base.html#10878" class="Function">filter</a> <a id="8442" class="Symbol">(λ</a> <a id="8445" class="Symbol">{</a><a id="8446" href="Peras.SmallStep.html#8446" class="Bound">b</a> <a id="8448" class="Symbol">→</a> <a id="8450" class="Symbol">(</a><a id="8451" href="Peras.Block.html#3623" class="Function">slotNumber&#39;</a> <a id="8463" href="Peras.SmallStep.html#8446" class="Bound">b</a><a id="8464" class="Symbol">)</a> <a id="8466" href="Agda.Builtin.Nat.html#336" class="Primitive Operator">+</a> <a id="8468" href="Peras.Params.html#235" class="Field">L</a> <a id="8470" href="Data.Nat.Properties.html#6146" class="Function Operator">≤?</a> <a id="8473" href="Peras.SmallStep.html#8413" class="Bound">s</a><a id="8474" class="Symbol">})</a>

    <a id="8482" href="Peras.SmallStep.html#8482" class="Function">BlockSelection</a> <a id="8497" class="Symbol">:</a> <a id="8499" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="8510" class="Symbol">→</a> <a id="8512" href="Peras.SmallStep.html#7298" class="Bound">T</a> <a id="8514" class="Symbol">→</a> <a id="8516" href="Peras.Crypto.html#1542" class="Record">Hash</a> <a id="8521" href="Peras.Block.html#2965" class="Record">Block</a>
    <a id="8531" href="Peras.SmallStep.html#8482" class="Function">BlockSelection</a> <a id="8546" href="Peras.SmallStep.html#8546" class="Bound">s</a> <a id="8548" class="Symbol">=</a> <a id="8550" href="Peras.SmallStep.html#8329" class="Function">BlockSelection&#39;</a> <a id="8566" href="Peras.SmallStep.html#8546" class="Bound">s</a> <a id="8568" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="8570" href="Peras.SmallStep.html#5701" class="Function">preferredChain</a>
</pre>
<h4 id="voting-rules">Voting rules</h4>
VR-1A: A party has seen a certificate cert-r−1 for round r−1
<pre class="Agda">    <a id="8681" href="Peras.SmallStep.html#8681" class="Function">VotingRule-1A</a> <a id="8695" class="Symbol">:</a> <a id="8697" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="8709" class="Symbol">→</a> <a id="8711" href="Peras.SmallStep.html#7298" class="Bound">T</a> <a id="8713" class="Symbol">→</a> <a id="8715" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="8724" href="Peras.SmallStep.html#8681" class="Function">VotingRule-1A</a> <a id="8738" class="Symbol">(</a><a id="8739" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="8753" href="Peras.SmallStep.html#8753" class="Bound">r</a><a id="8754" class="Symbol">)</a> <a id="8756" href="Peras.SmallStep.html#8756" class="Bound">t</a> <a id="8758" class="Symbol">=</a> <a id="8760" href="Peras.SmallStep.html#8753" class="Bound">r</a> <a id="8762" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="8764" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="8768" class="Symbol">(</a><a id="8769" href="Peras.Block.html#3159" class="Function">roundNumber</a> <a id="8781" class="Symbol">(</a><a id="8782" href="Peras.SmallStep.html#6195" class="Function">latestCertSeen</a> <a id="8797" href="Peras.SmallStep.html#8756" class="Bound">t</a><a id="8798" class="Symbol">))</a>
</pre>
VR-1B: The extends the block certified by cert-r−1,
<pre class="Agda">    <a id="8870" href="Peras.SmallStep.html#8870" class="Function">VotingRule-1B</a> <a id="8884" class="Symbol">:</a> <a id="8886" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="8897" class="Symbol">→</a> <a id="8899" href="Peras.SmallStep.html#7298" class="Bound">T</a> <a id="8901" class="Symbol">→</a> <a id="8903" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="8912" href="Peras.SmallStep.html#8870" class="Function">VotingRule-1B</a> <a id="8926" href="Peras.SmallStep.html#8926" class="Bound">s</a> <a id="8928" href="Peras.SmallStep.html#8928" class="Bound">t</a> <a id="8930" class="Symbol">=</a> <a id="8932" href="Peras.Chain.html#4923" class="Function">Extends</a> <a id="8940" class="Symbol">(</a><a id="8941" href="Peras.SmallStep.html#8482" class="Function">BlockSelection</a> <a id="8956" href="Peras.SmallStep.html#8926" class="Bound">s</a> <a id="8958" href="Peras.SmallStep.html#8928" class="Bound">t</a><a id="8959" class="Symbol">)</a> <a id="8961" class="Symbol">(</a><a id="8962" href="Peras.SmallStep.html#6195" class="Function">latestCertSeen</a> <a id="8977" href="Peras.SmallStep.html#8928" class="Bound">t</a><a id="8978" class="Symbol">)</a> <a id="8980" class="Symbol">(</a><a id="8981" href="Peras.SmallStep.html#5668" class="Function">allChains</a> <a id="8991" href="Peras.SmallStep.html#8928" class="Bound">t</a><a id="8992" class="Symbol">)</a>
</pre>
VR-1: Both VR-1A and VR-1B hold
<pre class="Agda">    <a id="9042" href="Peras.SmallStep.html#9042" class="Function">VotingRule-1</a> <a id="9055" class="Symbol">:</a> <a id="9057" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="9068" class="Symbol">→</a> <a id="9070" href="Peras.SmallStep.html#7298" class="Bound">T</a> <a id="9072" class="Symbol">→</a> <a id="9074" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="9083" href="Peras.SmallStep.html#9042" class="Function">VotingRule-1</a> <a id="9096" href="Peras.SmallStep.html#9096" class="Bound">s</a> <a id="9098" href="Peras.SmallStep.html#9098" class="Bound">t</a> <a id="9100" class="Symbol">=</a>
        <a id="9110" href="Peras.SmallStep.html#8681" class="Function">VotingRule-1A</a> <a id="9124" class="Symbol">(</a><a id="9125" href="Peras.Chain.html#6071" class="Function">v-round</a> <a id="9133" href="Peras.SmallStep.html#9096" class="Bound">s</a><a id="9134" class="Symbol">)</a> <a id="9136" href="Peras.SmallStep.html#9098" class="Bound">t</a>
      <a id="9144" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="9146" href="Peras.SmallStep.html#8870" class="Function">VotingRule-1B</a> <a id="9160" href="Peras.SmallStep.html#9096" class="Bound">s</a> <a id="9162" href="Peras.SmallStep.html#9098" class="Bound">t</a>
</pre>
VR-2A: The last certificate a party has seen is from a round at least R
rounds back
<pre class="Agda">    <a id="9264" href="Peras.SmallStep.html#9264" class="Function">VotingRule-2A</a> <a id="9278" class="Symbol">:</a> <a id="9280" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="9292" class="Symbol">→</a> <a id="9294" href="Peras.SmallStep.html#7298" class="Bound">T</a> <a id="9296" class="Symbol">→</a> <a id="9298" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="9307" href="Peras.SmallStep.html#9264" class="Function">VotingRule-2A</a> <a id="9321" class="Symbol">(</a><a id="9322" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="9336" href="Peras.SmallStep.html#9336" class="Bound">r</a><a id="9337" class="Symbol">)</a> <a id="9339" href="Peras.SmallStep.html#9339" class="Bound">t</a> <a id="9341" class="Symbol">=</a> <a id="9343" href="Peras.SmallStep.html#9336" class="Bound">r</a> <a id="9345" href="Data.Nat.Base.html#2259" class="Function Operator">≥</a> <a id="9347" href="Peras.Block.html#3159" class="Function">roundNumber</a> <a id="9359" class="Symbol">(</a><a id="9360" href="Peras.SmallStep.html#6195" class="Function">latestCertSeen</a> <a id="9375" href="Peras.SmallStep.html#9339" class="Bound">t</a><a id="9376" class="Symbol">)</a> <a id="9378" href="Agda.Builtin.Nat.html#336" class="Primitive Operator">+</a> <a id="9380" href="Peras.Params.html#221" class="Field">R</a>
</pre>
VR-2B: The last certificate included in a party’s current chain is from
a round exactly c⋆K rounds ago for some c : ℕ, c ≥ 0 <!--
<pre class="Agda">    <a id="9528" href="Peras.SmallStep.html#9528" class="Function Operator">_mod_</a> <a id="9534" class="Symbol">:</a> <a id="9536" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="9538" class="Symbol">→</a> <a id="9540" class="Symbol">(</a><a id="9541" href="Peras.SmallStep.html#9541" class="Bound">n</a> <a id="9543" class="Symbol">:</a> <a id="9545" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="9546" class="Symbol">)</a> <a id="9548" class="Symbol">→</a> <a id="9550" class="Symbol">⦃</a> <a id="9552" href="Data.Nat.Base.html#3260" class="Record">NonZero</a> <a id="9560" href="Peras.SmallStep.html#9541" class="Bound">n</a> <a id="9562" class="Symbol">⦄</a> <a id="9564" class="Symbol">→</a> <a id="9566" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
    <a id="9572" href="Peras.SmallStep.html#9528" class="Function Operator">_mod_</a> <a id="9578" href="Peras.SmallStep.html#9578" class="Bound">a</a> <a id="9580" href="Peras.SmallStep.html#9580" class="Bound">b</a> <a id="9582" class="Symbol">⦃</a> <a id="9584" href="Peras.SmallStep.html#9584" class="Bound">prf</a> <a id="9588" class="Symbol">⦄</a> <a id="9590" class="Symbol">=</a> <a id="9592" href="Data.Nat.Base.html#7279" class="Function Operator">_%_</a> <a id="9596" href="Peras.SmallStep.html#9578" class="Bound">a</a> <a id="9598" href="Peras.SmallStep.html#9580" class="Bound">b</a> <a id="9600" class="Symbol">⦃</a> <a id="9602" href="Peras.SmallStep.html#9584" class="Bound">prf</a> <a id="9606" class="Symbol">⦄</a>
</pre>-->
<pre class="Agda">    <a id="9628" href="Peras.SmallStep.html#9628" class="Function">VotingRule-2B</a> <a id="9642" class="Symbol">:</a> <a id="9644" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="9656" class="Symbol">→</a> <a id="9658" href="Peras.SmallStep.html#7298" class="Bound">T</a> <a id="9660" class="Symbol">→</a> <a id="9662" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="9671" href="Peras.SmallStep.html#9628" class="Function">VotingRule-2B</a> <a id="9685" class="Symbol">(</a><a id="9686" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="9700" href="Peras.SmallStep.html#9700" class="Bound">r</a><a id="9701" class="Symbol">)</a> <a id="9703" href="Peras.SmallStep.html#9703" class="Bound">t</a> <a id="9705" class="Symbol">=</a>
        <a id="9715" href="Peras.SmallStep.html#9700" class="Bound">r</a> <a id="9717" href="Data.Nat.Base.html#2289" class="Function Operator">&gt;</a> <a id="9719" href="Peras.Block.html#3159" class="Function">roundNumber</a> <a id="9731" class="Symbol">(</a><a id="9732" href="Peras.SmallStep.html#6065" class="Function">latestCertOnChain</a> <a id="9750" href="Peras.SmallStep.html#9703" class="Bound">t</a><a id="9751" class="Symbol">)</a>
      <a id="9759" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="9761" href="Peras.SmallStep.html#9700" class="Bound">r</a> <a id="9763" href="Peras.SmallStep.html#9528" class="Function Operator">mod</a> <a id="9767" href="Peras.Params.html#207" class="Field">K</a> <a id="9769" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="9771" class="Symbol">(</a><a id="9772" href="Peras.Block.html#3159" class="Function">roundNumber</a> <a id="9784" class="Symbol">(</a><a id="9785" href="Peras.SmallStep.html#6065" class="Function">latestCertOnChain</a> <a id="9803" href="Peras.SmallStep.html#9703" class="Bound">t</a><a id="9804" class="Symbol">))</a> <a id="9807" href="Peras.SmallStep.html#9528" class="Function Operator">mod</a> <a id="9811" href="Peras.Params.html#207" class="Field">K</a>
</pre>
VR-2: Both VR-2A and VR-2B hold
<pre class="Agda">    <a id="9861" href="Peras.SmallStep.html#9861" class="Function">VotingRule-2</a> <a id="9874" class="Symbol">:</a> <a id="9876" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="9888" class="Symbol">→</a> <a id="9890" href="Peras.SmallStep.html#7298" class="Bound">T</a> <a id="9892" class="Symbol">→</a> <a id="9894" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="9903" href="Peras.SmallStep.html#9861" class="Function">VotingRule-2</a> <a id="9916" href="Peras.SmallStep.html#9916" class="Bound">r</a> <a id="9918" href="Peras.SmallStep.html#9918" class="Bound">t</a> <a id="9920" class="Symbol">=</a>
        <a id="9930" href="Peras.SmallStep.html#9264" class="Function">VotingRule-2A</a> <a id="9944" href="Peras.SmallStep.html#9916" class="Bound">r</a> <a id="9946" href="Peras.SmallStep.html#9918" class="Bound">t</a>
      <a id="9954" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="9956" href="Peras.SmallStep.html#9628" class="Function">VotingRule-2B</a> <a id="9970" href="Peras.SmallStep.html#9916" class="Bound">r</a> <a id="9972" href="Peras.SmallStep.html#9918" class="Bound">t</a>
</pre>
If either VR-1A and VR-1B or VR-2A and VR-2B hold, voting is expected
<pre class="Agda">    <a id="10060" href="Peras.SmallStep.html#10060" class="Function">VotingRule</a> <a id="10071" class="Symbol">:</a> <a id="10073" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="10084" class="Symbol">→</a> <a id="10086" href="Peras.SmallStep.html#7298" class="Bound">T</a> <a id="10088" class="Symbol">→</a> <a id="10090" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="10099" href="Peras.SmallStep.html#10060" class="Function">VotingRule</a> <a id="10110" href="Peras.SmallStep.html#10110" class="Bound">s</a> <a id="10112" href="Peras.SmallStep.html#10112" class="Bound">t</a> <a id="10114" class="Symbol">=</a>
        <a id="10124" href="Peras.SmallStep.html#9042" class="Function">VotingRule-1</a> <a id="10137" href="Peras.SmallStep.html#10110" class="Bound">s</a> <a id="10139" href="Peras.SmallStep.html#10112" class="Bound">t</a>
      <a id="10147" href="Data.Sum.Base.html#625" class="Datatype Operator">⊎</a> <a id="10149" href="Peras.SmallStep.html#9861" class="Function">VotingRule-2</a> <a id="10162" class="Symbol">(</a><a id="10163" href="Peras.Chain.html#6071" class="Function">v-round</a> <a id="10171" href="Peras.SmallStep.html#10110" class="Bound">s</a><a id="10172" class="Symbol">)</a> <a id="10174" href="Peras.SmallStep.html#10112" class="Bound">t</a>
</pre>
<h3 id="state">State</h3>
<p>The small-step semantics rely on a global state, which consists of
the following fields:</p>
<ul>
<li>Current slot of the system</li>
<li>Map with local state per party</li>
<li>All the messages that have been sent but not yet been delivered</li>
<li>All the messages that have been sent</li>
<li>Adversarial state</li>
</ul>
<pre class="Agda">    <a id="10481" class="Keyword">record</a> <a id="10488" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="10494" class="Symbol">:</a> <a id="10496" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="10501" class="Keyword">where</a>
      <a id="10513" class="Keyword">constructor</a> <a id="10525" href="Peras.SmallStep.html#10525" class="InductiveConstructor Operator">⟦_,_,_,_,_⟧</a>
      <a id="10543" class="Keyword">field</a>
        <a id="10557" href="Peras.SmallStep.html#10557" class="Field">clock</a> <a id="10563" class="Symbol">:</a> <a id="10565" href="Peras.Numbering.html#742" class="Record">SlotNumber</a>
        <a id="10584" href="Peras.SmallStep.html#10584" class="Field">blockTrees</a> <a id="10595" class="Symbol">:</a> <a id="10597" href="Prelude.AssocList.html#211" class="Function">AssocList</a> <a id="10607" href="Peras.Block.html#1264" class="Function">PartyId</a> <a id="10615" href="Peras.SmallStep.html#7298" class="Bound">T</a>
        <a id="10625" href="Peras.SmallStep.html#10625" class="Field">messages</a> <a id="10634" class="Symbol">:</a> <a id="10636" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="10641" href="Peras.SmallStep.html#2769" class="Record">Envelope</a>
        <a id="10658" href="Peras.SmallStep.html#10658" class="Field">history</a> <a id="10666" class="Symbol">:</a> <a id="10668" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="10673" href="Peras.SmallStep.html#2131" class="Datatype">Message</a>
        <a id="10689" href="Peras.SmallStep.html#10689" class="Field">adversarialState</a> <a id="10706" class="Symbol">:</a> <a id="10708" href="Peras.SmallStep.html#7345" class="Bound">S</a>

      <a id="10717" href="Peras.SmallStep.html#10717" class="Function">blockTrees&#39;</a> <a id="10729" class="Symbol">:</a> <a id="10731" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="10736" href="Peras.SmallStep.html#7298" class="Bound">T</a>
      <a id="10744" href="Peras.SmallStep.html#10717" class="Function">blockTrees&#39;</a> <a id="10756" class="Symbol">=</a> <a id="10758" href="Data.List.Base.html#1631" class="Function">map</a> <a id="10762" href="Data.Product.Base.html#650" class="Field">proj₂</a> <a id="10768" href="Peras.SmallStep.html#10584" class="Field">blockTrees</a>

      <a id="10786" href="Peras.SmallStep.html#10786" class="Function">v-rnd</a> <a id="10792" class="Symbol">:</a> <a id="10794" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a>
      <a id="10812" href="Peras.SmallStep.html#10786" class="Function">v-rnd</a> <a id="10818" class="Symbol">=</a> <a id="10820" href="Peras.Chain.html#6071" class="Function">v-round</a> <a id="10828" href="Peras.SmallStep.html#10557" class="Field">clock</a>

      <a id="10841" href="Peras.SmallStep.html#10841" class="Function">v-rnd&#39;</a> <a id="10848" class="Symbol">:</a> <a id="10850" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
      <a id="10858" href="Peras.SmallStep.html#10841" class="Function">v-rnd&#39;</a> <a id="10865" class="Symbol">=</a> <a id="10867" href="Peras.Numbering.html#1729" class="Field">getRoundNumber</a> <a id="10882" href="Peras.SmallStep.html#10786" class="Function">v-rnd</a>
</pre>
<h4 id="progress">Progress</h4>
Rather than keeping track of progress, we introduce a predicate stating
that all messages that are not delayed have been delivered. This is a
precondition that must hold before transitioning to the next slot.
<pre class="Agda">    <a id="11128" href="Peras.SmallStep.html#11128" class="Function">Fetched</a> <a id="11136" class="Symbol">:</a> <a id="11138" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="11144" class="Symbol">→</a> <a id="11146" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="11155" href="Peras.SmallStep.html#11128" class="Function">Fetched</a> <a id="11163" class="Symbol">=</a> <a id="11165" href="Data.List.Relation.Unary.All.html#1627" class="Datatype">All</a> <a id="11169" class="Symbol">(λ</a> <a id="11172" class="Symbol">{</a> <a id="11174" href="Peras.SmallStep.html#11174" class="Bound">z</a> <a id="11176" class="Symbol">→</a> <a id="11178" href="Peras.SmallStep.html#2913" class="Field">delay</a> <a id="11184" href="Peras.SmallStep.html#11174" class="Bound">z</a> <a id="11186" href="Relation.Binary.PropositionalEquality.Core.html#858" class="Function Operator">≢</a> <a id="11188" href="Peras.SmallStep.html#2594" class="InductiveConstructor">𝟘</a> <a id="11190" class="Symbol">})</a> <a id="11193" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="11195" href="Peras.SmallStep.html#10625" class="Field">messages</a>
      <a id="11210" class="Keyword">where</a> <a id="11216" class="Keyword">open</a> <a id="11221" href="Peras.SmallStep.html#10488" class="Module">State</a>
</pre>
Predicate for a global state stating that the current slot is the last
slot of a voting round.
<pre class="Agda">    <a id="11338" href="Peras.SmallStep.html#11338" class="Function">LastSlotInRound</a> <a id="11354" class="Symbol">:</a> <a id="11356" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="11362" class="Symbol">→</a> <a id="11364" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="11373" href="Peras.SmallStep.html#11338" class="Function">LastSlotInRound</a> <a id="11389" href="Peras.SmallStep.html#11389" class="Bound">M</a> <a id="11391" class="Symbol">=</a>
      <a id="11399" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="11403" class="Symbol">(</a><a id="11404" href="Peras.Chain.html#6009" class="Function">rnd</a> <a id="11408" class="Symbol">(</a><a id="11409" href="Peras.Numbering.html#800" class="Field">getSlotNumber</a> <a id="11423" href="Peras.SmallStep.html#10557" class="Field">clock</a><a id="11428" class="Symbol">))</a> <a id="11431" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="11433" href="Peras.Chain.html#6009" class="Function">rnd</a> <a id="11437" class="Symbol">(</a><a id="11438" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="11442" class="Symbol">(</a><a id="11443" href="Peras.Numbering.html#800" class="Field">getSlotNumber</a> <a id="11457" href="Peras.SmallStep.html#10557" class="Field">clock</a><a id="11462" class="Symbol">))</a>
      <a id="11471" class="Keyword">where</a> <a id="11477" class="Keyword">open</a> <a id="11482" href="Peras.SmallStep.html#10488" class="Module">State</a> <a id="11488" href="Peras.SmallStep.html#11389" class="Bound">M</a>
</pre>
<pre class="Agda">    <a id="11506" href="Peras.SmallStep.html#11506" class="Function">LastSlotInRound?</a> <a id="11523" class="Symbol">:</a> <a id="11525" class="Symbol">(</a><a id="11526" href="Peras.SmallStep.html#11526" class="Bound">s</a> <a id="11528" class="Symbol">:</a> <a id="11530" href="Peras.SmallStep.html#10488" class="Record">State</a><a id="11535" class="Symbol">)</a> <a id="11537" class="Symbol">→</a> <a id="11539" href="Relation.Nullary.Decidable.Core.html#1485" class="Record">Dec</a> <a id="11543" class="Symbol">(</a><a id="11544" href="Peras.SmallStep.html#11338" class="Function">LastSlotInRound</a> <a id="11560" href="Peras.SmallStep.html#11526" class="Bound">s</a><a id="11561" class="Symbol">)</a>
    <a id="11567" href="Peras.SmallStep.html#11506" class="Function">LastSlotInRound?</a> <a id="11584" href="Peras.SmallStep.html#11584" class="Bound">M</a> <a id="11586" class="Symbol">=</a>
      <a id="11594" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="11598" class="Symbol">(</a><a id="11599" href="Peras.Chain.html#6009" class="Function">rnd</a> <a id="11603" class="Symbol">(</a><a id="11604" href="Peras.Numbering.html#800" class="Field">getSlotNumber</a> <a id="11618" href="Peras.SmallStep.html#10557" class="Field">clock</a><a id="11623" class="Symbol">))</a> <a id="11626" href="Data.Nat.Properties.html#3311" class="Function Operator">≟</a> <a id="11628" href="Peras.Chain.html#6009" class="Function">rnd</a> <a id="11632" class="Symbol">(</a><a id="11633" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="11637" class="Symbol">(</a><a id="11638" href="Peras.Numbering.html#800" class="Field">getSlotNumber</a> <a id="11652" href="Peras.SmallStep.html#10557" class="Field">clock</a><a id="11657" class="Symbol">))</a>
      <a id="11666" class="Keyword">where</a> <a id="11672" class="Keyword">open</a> <a id="11677" href="Peras.SmallStep.html#10488" class="Module">State</a> <a id="11683" href="Peras.SmallStep.html#11584" class="Bound">M</a>
</pre>
Predicate for a global state stating that the next slot will be in a new
voting round.
<pre class="Agda">    <a id="11788" href="Peras.SmallStep.html#11788" class="Function">NextSlotInSameRound</a> <a id="11808" class="Symbol">:</a> <a id="11810" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="11816" class="Symbol">→</a> <a id="11818" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="11827" href="Peras.SmallStep.html#11788" class="Function">NextSlotInSameRound</a> <a id="11847" href="Peras.SmallStep.html#11847" class="Bound">M</a> <a id="11849" class="Symbol">=</a>
      <a id="11857" href="Peras.Chain.html#6009" class="Function">rnd</a> <a id="11861" class="Symbol">(</a><a id="11862" href="Peras.Numbering.html#800" class="Field">getSlotNumber</a> <a id="11876" href="Peras.SmallStep.html#10557" class="Field">clock</a><a id="11881" class="Symbol">)</a> <a id="11883" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="11885" href="Peras.Chain.html#6009" class="Function">rnd</a> <a id="11889" class="Symbol">(</a><a id="11890" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="11894" class="Symbol">(</a><a id="11895" href="Peras.Numbering.html#800" class="Field">getSlotNumber</a> <a id="11909" href="Peras.SmallStep.html#10557" class="Field">clock</a><a id="11914" class="Symbol">))</a>
      <a id="11923" class="Keyword">where</a> <a id="11929" class="Keyword">open</a> <a id="11934" href="Peras.SmallStep.html#10488" class="Module">State</a> <a id="11940" href="Peras.SmallStep.html#11847" class="Bound">M</a>
</pre>
<pre class="Agda">    <a id="11958" href="Peras.SmallStep.html#11958" class="Function">NextSlotInSameRound?</a> <a id="11979" class="Symbol">:</a> <a id="11981" class="Symbol">(</a><a id="11982" href="Peras.SmallStep.html#11982" class="Bound">s</a> <a id="11984" class="Symbol">:</a> <a id="11986" href="Peras.SmallStep.html#10488" class="Record">State</a><a id="11991" class="Symbol">)</a> <a id="11993" class="Symbol">→</a> <a id="11995" href="Relation.Nullary.Decidable.Core.html#1485" class="Record">Dec</a> <a id="11999" class="Symbol">(</a><a id="12000" href="Peras.SmallStep.html#11788" class="Function">NextSlotInSameRound</a> <a id="12020" href="Peras.SmallStep.html#11982" class="Bound">s</a><a id="12021" class="Symbol">)</a>
    <a id="12027" href="Peras.SmallStep.html#11958" class="Function">NextSlotInSameRound?</a> <a id="12048" href="Peras.SmallStep.html#12048" class="Bound">M</a> <a id="12050" class="Symbol">=</a>
      <a id="12058" href="Peras.Chain.html#6009" class="Function">rnd</a> <a id="12062" class="Symbol">(</a><a id="12063" href="Peras.Numbering.html#800" class="Field">getSlotNumber</a> <a id="12077" href="Peras.SmallStep.html#10557" class="Field">clock</a><a id="12082" class="Symbol">)</a> <a id="12084" href="Data.Nat.Properties.html#3311" class="Function Operator">≟</a> <a id="12086" href="Peras.Chain.html#6009" class="Function">rnd</a> <a id="12090" class="Symbol">(</a><a id="12091" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="12095" class="Symbol">(</a><a id="12096" href="Peras.Numbering.html#800" class="Field">getSlotNumber</a> <a id="12110" href="Peras.SmallStep.html#10557" class="Field">clock</a><a id="12115" class="Symbol">))</a>
      <a id="12124" class="Keyword">where</a> <a id="12130" class="Keyword">open</a> <a id="12135" href="Peras.SmallStep.html#10488" class="Module">State</a> <a id="12141" href="Peras.SmallStep.html#12048" class="Bound">M</a>
</pre>
<p>Predicate for a global state asserting that parties of the voting
committee for a the current voting round have voted. This is needed as a
condition when transitioning from one voting round to another.</p>
<strong>TODO</strong>: Properly define the condition for required votes
<pre class="Agda">    <a id="12421" href="Peras.SmallStep.html#12421" class="Function">RequiredVotes</a> <a id="12435" class="Symbol">:</a> <a id="12437" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="12443" class="Symbol">→</a> <a id="12445" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="12454" href="Peras.SmallStep.html#12421" class="Function">RequiredVotes</a> <a id="12468" href="Peras.SmallStep.html#12468" class="Bound">M</a> <a id="12470" class="Symbol">=</a>
         <a id="12481" href="Data.List.Relation.Unary.Any.html#1163" class="Datatype">Any</a> <a id="12485" class="Symbol">(</a><a id="12486" href="Peras.SmallStep.html#10060" class="Function">VotingRule</a> <a id="12497" href="Peras.SmallStep.html#10557" class="Field">clock</a> <a id="12503" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="12505" href="Data.Product.Base.html#650" class="Field">proj₂</a><a id="12510" class="Symbol">)</a> <a id="12512" href="Peras.SmallStep.html#10584" class="Field">blockTrees</a>
       <a id="12530" class="Symbol">→</a> <a id="12532" href="Data.List.Relation.Unary.Any.html#1163" class="Datatype">Any</a> <a id="12536" class="Symbol">(</a><a id="12537" href="Peras.SmallStep.html#6515" class="Function">hasVote</a> <a id="12545" class="Symbol">(</a><a id="12546" href="Peras.Chain.html#6071" class="Function">v-round</a> <a id="12554" href="Peras.SmallStep.html#10557" class="Field">clock</a><a id="12559" class="Symbol">)</a> <a id="12561" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="12563" href="Data.Product.Base.html#650" class="Field">proj₂</a><a id="12568" class="Symbol">)</a> <a id="12570" href="Peras.SmallStep.html#10584" class="Field">blockTrees</a>
      <a id="12587" class="Keyword">where</a> <a id="12593" class="Keyword">open</a> <a id="12598" href="Peras.SmallStep.html#10488" class="Module">State</a> <a id="12604" href="Peras.SmallStep.html#12468" class="Bound">M</a>
</pre>
Ticking the global clock increments the slot number and decrements the
delay of all the messages in the message buffer.
<pre class="Agda">    <a id="12742" href="Peras.SmallStep.html#12742" class="Function">tick</a> <a id="12747" class="Symbol">:</a> <a id="12749" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="12755" class="Symbol">→</a> <a id="12757" href="Peras.SmallStep.html#10488" class="Record">State</a>
    <a id="12767" href="Peras.SmallStep.html#12742" class="Function">tick</a> <a id="12772" href="Peras.SmallStep.html#12772" class="Bound">M</a> <a id="12774" class="Symbol">=</a>
      <a id="12782" class="Keyword">record</a> <a id="12789" href="Peras.SmallStep.html#12772" class="Bound">M</a>
        <a id="12799" class="Symbol">{</a> <a id="12801" href="Peras.SmallStep.html#10557" class="Field">clock</a> <a id="12807" class="Symbol">=</a> <a id="12809" href="Peras.Numbering.html#821" class="Function">next</a> <a id="12814" href="Peras.SmallStep.html#10557" class="Field">clock</a>
        <a id="12828" class="Symbol">;</a> <a id="12830" href="Peras.SmallStep.html#10625" class="Field">messages</a> <a id="12839" class="Symbol">=</a>
            <a id="12853" href="Data.List.Base.html#1631" class="Function">map</a> <a id="12857" class="Symbol">(λ</a> <a id="12860" class="Keyword">where</a> <a id="12866" href="Peras.SmallStep.html#12866" class="Bound">e</a> <a id="12868" class="Symbol">→</a> <a id="12870" class="Keyword">record</a> <a id="12877" href="Peras.SmallStep.html#12866" class="Bound">e</a> <a id="12879" class="Symbol">{</a> <a id="12881" href="Peras.SmallStep.html#2913" class="Field">delay</a> <a id="12887" class="Symbol">=</a> <a id="12889" href="Data.Fin.Base.html#6461" class="Function">pred</a> <a id="12894" class="Symbol">(</a><a id="12895" href="Peras.SmallStep.html#2913" class="Field">delay</a> <a id="12901" href="Peras.SmallStep.html#12866" class="Bound">e</a><a id="12902" class="Symbol">)</a> <a id="12904" class="Symbol">})</a>
              <a id="12921" href="Peras.SmallStep.html#10625" class="Field">messages</a>
        <a id="12938" class="Symbol">}</a>
      <a id="12946" class="Keyword">where</a> <a id="12952" class="Keyword">open</a> <a id="12957" href="Peras.SmallStep.html#10488" class="Module">State</a> <a id="12963" href="Peras.SmallStep.html#12772" class="Bound">M</a>
</pre>
Updating the global state inserting the updated block-tree for a given
party, adding messages to the message buffer for the other parties and
appending the history
<pre class="Agda">    <a id="13145" href="Peras.SmallStep.html#13145" class="Function Operator">_,_,_,_⇑_</a> <a id="13155" class="Symbol">:</a> <a id="13157" href="Peras.SmallStep.html#2131" class="Datatype">Message</a> <a id="13165" class="Symbol">→</a> <a id="13167" href="Peras.SmallStep.html#2557" class="Function">Delay</a> <a id="13173" class="Symbol">→</a> <a id="13175" href="Peras.Block.html#1264" class="Function">PartyId</a> <a id="13183" class="Symbol">→</a> <a id="13185" href="Peras.SmallStep.html#7298" class="Bound">T</a> <a id="13187" class="Symbol">→</a> <a id="13189" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="13195" class="Symbol">→</a> <a id="13197" href="Peras.SmallStep.html#10488" class="Record">State</a>
    <a id="13207" href="Peras.SmallStep.html#13207" class="Bound">m</a> <a id="13209" href="Peras.SmallStep.html#13145" class="Function Operator">,</a> <a id="13211" href="Peras.SmallStep.html#13211" class="Bound">d</a> <a id="13213" href="Peras.SmallStep.html#13145" class="Function Operator">,</a> <a id="13215" href="Peras.SmallStep.html#13215" class="Bound">p</a> <a id="13217" href="Peras.SmallStep.html#13145" class="Function Operator">,</a> <a id="13219" href="Peras.SmallStep.html#13219" class="Bound">l</a> <a id="13221" href="Peras.SmallStep.html#13145" class="Function Operator">⇑</a> <a id="13223" href="Peras.SmallStep.html#13223" class="Bound">M</a> <a id="13225" class="Symbol">=</a>
      <a id="13233" class="Keyword">record</a> <a id="13240" href="Peras.SmallStep.html#13223" class="Bound">M</a>
        <a id="13250" class="Symbol">{</a> <a id="13252" href="Peras.SmallStep.html#10584" class="Field">blockTrees</a> <a id="13263" class="Symbol">=</a> <a id="13265" href="Prelude.AssocList.html#1398" class="Function">set</a> <a id="13269" href="Peras.SmallStep.html#13215" class="Bound">p</a> <a id="13271" href="Peras.SmallStep.html#13219" class="Bound">l</a> <a id="13273" href="Peras.SmallStep.html#10584" class="Field">blockTrees</a>
        <a id="13292" class="Symbol">;</a> <a id="13294" href="Peras.SmallStep.html#10625" class="Field">messages</a> <a id="13303" class="Symbol">=</a>
            <a id="13317" href="Data.List.Base.html#1631" class="Function">map</a> <a id="13321" class="Symbol">(</a><a id="13322" href="Data.Product.Base.html#3109" class="Function">uncurry</a> <a id="13330" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">⦅_,_,</a> <a id="13336" href="Peras.SmallStep.html#13207" class="Bound">m</a> <a id="13338" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">,</a> <a id="13340" href="Peras.SmallStep.html#13211" class="Bound">d</a> <a id="13342" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">⦆</a><a id="13343" class="Symbol">)</a>
              <a id="13359" class="Symbol">(</a><a id="13360" href="Data.List.Base.html#10878" class="Function">filter</a> <a id="13367" class="Symbol">(</a><a id="13368" href="Relation.Nullary.Decidable.Core.html#2517" class="Function">¬?</a> <a id="13371" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="13373" class="Symbol">(</a><a id="13374" href="Peras.SmallStep.html#13215" class="Bound">p</a> <a id="13376" href="Data.Nat.Properties.html#3311" class="Function Operator">≟_</a><a id="13378" class="Symbol">)</a> <a id="13380" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="13382" href="Data.Product.Base.html#636" class="Field">proj₁</a><a id="13387" class="Symbol">)</a> <a id="13389" href="Peras.SmallStep.html#7449" class="Bound">parties</a><a id="13396" class="Symbol">)</a>
            <a id="13410" href="Data.List.Base.html#1954" class="Function Operator">++</a> <a id="13413" href="Peras.SmallStep.html#10625" class="Field">messages</a>
        <a id="13430" class="Symbol">;</a> <a id="13432" href="Peras.SmallStep.html#10658" class="Field">history</a> <a id="13440" class="Symbol">=</a> <a id="13442" href="Peras.SmallStep.html#13207" class="Bound">m</a> <a id="13444" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="13446" href="Peras.SmallStep.html#10658" class="Field">history</a>
        <a id="13462" class="Symbol">}</a>
      <a id="13470" class="Keyword">where</a> <a id="13476" class="Keyword">open</a> <a id="13481" href="Peras.SmallStep.html#10488" class="Module">State</a> <a id="13487" href="Peras.SmallStep.html#13223" class="Bound">M</a>

    <a id="13494" href="Peras.SmallStep.html#13494" class="Function Operator">add_to_diffuse_</a> <a id="13510" class="Symbol">:</a> <a id="13512" class="Symbol">(</a><a id="13513" href="Peras.SmallStep.html#2131" class="Datatype">Message</a> <a id="13521" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="13523" href="Peras.SmallStep.html#2557" class="Function">Delay</a> <a id="13529" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="13531" href="Peras.Block.html#1264" class="Function">PartyId</a><a id="13538" class="Symbol">)</a> <a id="13540" class="Symbol">→</a> <a id="13542" href="Peras.SmallStep.html#7298" class="Bound">T</a> <a id="13544" class="Symbol">→</a> <a id="13546" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="13552" class="Symbol">→</a> <a id="13554" href="Peras.SmallStep.html#10488" class="Record">State</a>
    <a id="13564" href="Peras.SmallStep.html#13494" class="Function Operator">add</a> <a id="13568" class="Symbol">(</a><a id="13569" href="Peras.SmallStep.html#13569" class="Bound">m</a><a id="13570" class="Symbol">@(</a><a id="13572" href="Peras.SmallStep.html#2156" class="InductiveConstructor">ChainMsg</a> <a id="13581" href="Peras.SmallStep.html#13581" class="Bound">x</a><a id="13582" class="Symbol">)</a> <a id="13584" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="13586" href="Peras.SmallStep.html#13586" class="Bound">d</a> <a id="13588" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="13590" href="Peras.SmallStep.html#13590" class="Bound">p</a><a id="13591" class="Symbol">)</a> <a id="13593" href="Peras.SmallStep.html#13494" class="Function Operator">to</a> <a id="13596" href="Peras.SmallStep.html#13596" class="Bound">t</a> <a id="13598" href="Peras.SmallStep.html#13494" class="Function Operator">diffuse</a> <a id="13606" href="Peras.SmallStep.html#13606" class="Bound">M</a> <a id="13608" class="Symbol">=</a> <a id="13610" href="Peras.SmallStep.html#13569" class="Bound">m</a> <a id="13612" href="Peras.SmallStep.html#13145" class="Function Operator">,</a> <a id="13614" href="Peras.SmallStep.html#13586" class="Bound">d</a> <a id="13616" href="Peras.SmallStep.html#13145" class="Function Operator">,</a> <a id="13618" href="Peras.SmallStep.html#13590" class="Bound">p</a> <a id="13620" href="Peras.SmallStep.html#13145" class="Function Operator">,</a> <a id="13622" href="Peras.SmallStep.html#5637" class="Function">newChain</a> <a id="13631" href="Peras.SmallStep.html#13596" class="Bound">t</a> <a id="13633" href="Peras.SmallStep.html#13581" class="Bound">x</a> <a id="13635" href="Peras.SmallStep.html#13145" class="Function Operator">⇑</a> <a id="13637" href="Peras.SmallStep.html#13606" class="Bound">M</a>
    <a id="13643" href="Peras.SmallStep.html#13494" class="Function Operator">add</a> <a id="13647" class="Symbol">(</a><a id="13648" href="Peras.SmallStep.html#13648" class="Bound">m</a><a id="13649" class="Symbol">@(</a><a id="13651" href="Peras.SmallStep.html#2187" class="InductiveConstructor">VoteMsg</a> <a id="13659" href="Peras.SmallStep.html#13659" class="Bound">x</a><a id="13660" class="Symbol">)</a> <a id="13662" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="13664" href="Peras.SmallStep.html#13664" class="Bound">d</a> <a id="13666" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="13668" href="Peras.SmallStep.html#13668" class="Bound">p</a><a id="13669" class="Symbol">)</a> <a id="13671" href="Peras.SmallStep.html#13494" class="Function Operator">to</a> <a id="13674" href="Peras.SmallStep.html#13674" class="Bound">t</a> <a id="13676" href="Peras.SmallStep.html#13494" class="Function Operator">diffuse</a> <a id="13684" href="Peras.SmallStep.html#13684" class="Bound">M</a> <a id="13686" class="Symbol">=</a> <a id="13688" href="Peras.SmallStep.html#13648" class="Bound">m</a> <a id="13690" href="Peras.SmallStep.html#13145" class="Function Operator">,</a> <a id="13692" href="Peras.SmallStep.html#13664" class="Bound">d</a> <a id="13694" href="Peras.SmallStep.html#13145" class="Function Operator">,</a> <a id="13696" href="Peras.SmallStep.html#13668" class="Bound">p</a> <a id="13698" href="Peras.SmallStep.html#13145" class="Function Operator">,</a> <a id="13700" href="Peras.SmallStep.html#5735" class="Function">addVote</a> <a id="13708" href="Peras.SmallStep.html#13674" class="Bound">t</a> <a id="13710" href="Peras.SmallStep.html#13659" class="Bound">x</a> <a id="13712" href="Peras.SmallStep.html#13145" class="Function Operator">⇑</a> <a id="13714" href="Peras.SmallStep.html#13684" class="Bound">M</a>
</pre>
<h2 id="fetching">Fetching</h2>
<p>A party receives messages from the global state by fetching messages
assigned to the party, updating the local block tree and putting the
local state back into the global state.</p>
<pre class="Agda">    <a id="13924" class="Keyword">data</a> <a id="13929" href="Peras.SmallStep.html#13929" class="Datatype Operator">_⊢_[_]⇀_</a> <a id="13938" class="Symbol">:</a> <a id="13940" class="Symbol">{</a><a id="13941" href="Peras.SmallStep.html#13941" class="Bound">p</a> <a id="13943" class="Symbol">:</a> <a id="13945" href="Peras.Block.html#1264" class="Function">PartyId</a><a id="13952" class="Symbol">}</a> <a id="13954" class="Symbol">→</a> <a id="13956" href="Peras.Block.html#2030" class="Datatype">Honesty</a> <a id="13964" href="Peras.SmallStep.html#13941" class="Bound">p</a> <a id="13966" class="Symbol">→</a> <a id="13968" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="13974" class="Symbol">→</a> <a id="13976" href="Peras.SmallStep.html#2131" class="Datatype">Message</a> <a id="13984" class="Symbol">→</a> <a id="13986" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="13992" class="Symbol">→</a> <a id="13994" href="Agda.Primitive.html#388" class="Primitive">Type</a>
      <a id="14005" class="Keyword">where</a>
</pre>
An honest party consumes a message from the global message buffer and
updates the local state
<pre class="Agda">      <a id="14123" href="Peras.SmallStep.html#14123" class="InductiveConstructor">honest</a> <a id="14130" class="Symbol">:</a> <a id="14132" class="Symbol">∀</a> <a id="14134" class="Symbol">{</a><a id="14135" href="Peras.SmallStep.html#14135" class="Bound">p</a><a id="14136" class="Symbol">}</a> <a id="14138" class="Symbol">{</a><a id="14139" href="Peras.SmallStep.html#14139" class="Bound">t</a> <a id="14141" href="Peras.SmallStep.html#14141" class="Bound">t′</a><a id="14143" class="Symbol">}</a> <a id="14145" class="Symbol">{</a><a id="14146" href="Peras.SmallStep.html#14146" class="Bound">m</a><a id="14147" class="Symbol">}</a> <a id="14149" class="Symbol">{</a><a id="14150" href="Peras.SmallStep.html#14150" class="Bound">N</a><a id="14151" class="Symbol">}</a> <a id="14153" class="Symbol">→</a> <a id="14155" class="Keyword">let</a> <a id="14159" class="Keyword">open</a> <a id="14164" href="Peras.SmallStep.html#10488" class="Module">State</a> <a id="14170" href="Peras.SmallStep.html#14150" class="Bound">N</a> <a id="14172" class="Keyword">in</a>
          <a id="14185" href="Peras.SmallStep.html#10584" class="Field">blockTrees</a> <a id="14196" href="Prelude.AssocList.html#847" class="Function Operator">⁉</a> <a id="14198" href="Peras.SmallStep.html#14135" class="Bound">p</a> <a id="14200" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="14202" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="14207" href="Peras.SmallStep.html#14139" class="Bound">t</a>
        <a id="14217" class="Symbol">→</a> <a id="14219" class="Symbol">(</a><a id="14220" href="Peras.SmallStep.html#14220" class="Bound">m∈ms</a> <a id="14225" class="Symbol">:</a> <a id="14227" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">⦅</a> <a id="14229" href="Peras.SmallStep.html#14135" class="Bound">p</a> <a id="14231" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">,</a> <a id="14233" href="Peras.Block.html#2063" class="InductiveConstructor">Honest</a> <a id="14240" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">,</a> <a id="14242" href="Peras.SmallStep.html#14146" class="Bound">m</a> <a id="14244" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">,</a> <a id="14246" href="Peras.SmallStep.html#2594" class="InductiveConstructor">𝟘</a> <a id="14248" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">⦆</a> <a id="14250" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="14252" href="Peras.SmallStep.html#10625" class="Field">messages</a><a id="14260" class="Symbol">)</a>
        <a id="14270" class="Symbol">→</a> <a id="14272" href="Peras.SmallStep.html#14139" class="Bound">t</a> <a id="14274" href="Peras.SmallStep.html#7832" class="Datatype Operator">[</a> <a id="14276" href="Peras.SmallStep.html#14146" class="Bound">m</a> <a id="14278" href="Peras.SmallStep.html#7832" class="Datatype Operator">]→</a> <a id="14281" href="Peras.SmallStep.html#14141" class="Bound">t′</a>
          <a id="14294" class="Comment">---------------------------------------------</a>
        <a id="14348" class="Symbol">→</a> <a id="14350" href="Peras.Block.html#2063" class="InductiveConstructor">Honest</a> <a id="14357" class="Symbol">{</a><a id="14358" href="Peras.SmallStep.html#14135" class="Bound">p</a><a id="14359" class="Symbol">}</a> <a id="14361" href="Peras.SmallStep.html#13929" class="Datatype Operator">⊢</a>
          <a id="14373" href="Peras.SmallStep.html#14150" class="Bound">N</a> <a id="14375" href="Peras.SmallStep.html#13929" class="Datatype Operator">[</a> <a id="14377" href="Peras.SmallStep.html#14146" class="Bound">m</a> <a id="14379" href="Peras.SmallStep.html#13929" class="Datatype Operator">]⇀</a> <a id="14382" class="Keyword">record</a> <a id="14389" href="Peras.SmallStep.html#14150" class="Bound">N</a>
            <a id="14403" class="Symbol">{</a> <a id="14405" href="Peras.SmallStep.html#10584" class="Field">blockTrees</a> <a id="14416" class="Symbol">=</a> <a id="14418" href="Prelude.AssocList.html#1398" class="Function">set</a> <a id="14422" href="Peras.SmallStep.html#14135" class="Bound">p</a> <a id="14424" href="Peras.SmallStep.html#14141" class="Bound">t′</a> <a id="14427" href="Peras.SmallStep.html#10584" class="Field">blockTrees</a>
            <a id="14450" class="Symbol">;</a> <a id="14452" href="Peras.SmallStep.html#10625" class="Field">messages</a> <a id="14461" class="Symbol">=</a> <a id="14463" href="Peras.SmallStep.html#10625" class="Field">messages</a> <a id="14472" href="Data.List.Relation.Unary.Any.html#2138" class="Function Operator">─</a> <a id="14474" href="Peras.SmallStep.html#14220" class="Bound">m∈ms</a>
            <a id="14491" class="Symbol">}</a>
</pre>
An adversarial party might delay a message
<pre class="Agda">      <a id="14554" href="Peras.SmallStep.html#14554" class="InductiveConstructor">corrupt</a> <a id="14562" class="Symbol">:</a> <a id="14564" class="Symbol">∀</a> <a id="14566" class="Symbol">{</a><a id="14567" href="Peras.SmallStep.html#14567" class="Bound">p</a><a id="14568" class="Symbol">}</a> <a id="14570" class="Symbol">{</a><a id="14571" href="Peras.SmallStep.html#14571" class="Bound">as</a><a id="14573" class="Symbol">}</a> <a id="14575" class="Symbol">{</a><a id="14576" href="Peras.SmallStep.html#14576" class="Bound">m</a><a id="14577" class="Symbol">}</a> <a id="14579" class="Symbol">{</a><a id="14580" href="Peras.SmallStep.html#14580" class="Bound">N</a><a id="14581" class="Symbol">}</a> <a id="14583" class="Symbol">→</a> <a id="14585" class="Keyword">let</a> <a id="14589" class="Keyword">open</a> <a id="14594" href="Peras.SmallStep.html#10488" class="Module">State</a> <a id="14600" href="Peras.SmallStep.html#14580" class="Bound">N</a> <a id="14602" class="Keyword">in</a>
          <a id="14615" class="Symbol">(</a><a id="14616" href="Peras.SmallStep.html#14616" class="Bound">m∈ms</a> <a id="14621" class="Symbol">:</a> <a id="14623" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">⦅</a> <a id="14625" href="Peras.SmallStep.html#14567" class="Bound">p</a> <a id="14627" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">,</a> <a id="14629" href="Peras.Block.html#2107" class="InductiveConstructor">Corrupt</a> <a id="14637" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">,</a> <a id="14639" href="Peras.SmallStep.html#14576" class="Bound">m</a> <a id="14641" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">,</a> <a id="14643" href="Peras.SmallStep.html#2594" class="InductiveConstructor">𝟘</a> <a id="14645" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">⦆</a> <a id="14647" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="14649" href="Peras.SmallStep.html#10625" class="Field">messages</a><a id="14657" class="Symbol">)</a>
          <a id="14669" class="Comment">----------------------------------------------</a>
        <a id="14724" class="Symbol">→</a>  <a id="14727" href="Peras.Block.html#2107" class="InductiveConstructor">Corrupt</a> <a id="14735" class="Symbol">{</a><a id="14736" href="Peras.SmallStep.html#14567" class="Bound">p</a><a id="14737" class="Symbol">}</a> <a id="14739" href="Peras.SmallStep.html#13929" class="Datatype Operator">⊢</a>
          <a id="14751" href="Peras.SmallStep.html#14580" class="Bound">N</a> <a id="14753" href="Peras.SmallStep.html#13929" class="Datatype Operator">[</a> <a id="14755" href="Peras.SmallStep.html#14576" class="Bound">m</a> <a id="14757" href="Peras.SmallStep.html#13929" class="Datatype Operator">]⇀</a> <a id="14760" class="Keyword">record</a> <a id="14767" href="Peras.SmallStep.html#14580" class="Bound">N</a>
            <a id="14781" class="Symbol">{</a> <a id="14783" href="Peras.SmallStep.html#10625" class="Field">messages</a> <a id="14792" class="Symbol">=</a> <a id="14794" href="Peras.SmallStep.html#14616" class="Bound">m∈ms</a> <a id="14799" href="Peras.SmallStep.html#419" class="Function Operator">∷ˡ=</a> <a id="14803" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">⦅</a> <a id="14805" href="Peras.SmallStep.html#14567" class="Bound">p</a> <a id="14807" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">,</a> <a id="14809" href="Peras.Block.html#2107" class="InductiveConstructor">Corrupt</a> <a id="14817" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">,</a> <a id="14819" href="Peras.SmallStep.html#14576" class="Bound">m</a> <a id="14821" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">,</a> <a id="14823" href="Peras.SmallStep.html#2614" class="InductiveConstructor">𝟙</a> <a id="14825" href="Peras.SmallStep.html#2807" class="InductiveConstructor Operator">⦆</a>
            <a id="14839" class="Symbol">;</a> <a id="14841" href="Peras.SmallStep.html#10689" class="Field">adversarialState</a> <a id="14858" class="Symbol">=</a> <a id="14860" href="Peras.SmallStep.html#14571" class="Bound">as</a>
            <a id="14875" class="Symbol">}</a>
</pre>
<h2 id="voting">Voting</h2>
Helper function for creating a vote
<pre class="Agda">    <a id="14940" href="Peras.SmallStep.html#14940" class="Function">createVote</a> <a id="14951" class="Symbol">:</a> <a id="14953" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="14964" class="Symbol">→</a> <a id="14966" href="Peras.Block.html#1264" class="Function">PartyId</a> <a id="14974" class="Symbol">→</a> <a id="14976" href="Peras.Crypto.html#2161" class="Record">MembershipProof</a> <a id="14992" class="Symbol">→</a> <a id="14994" href="Peras.Crypto.html#3115" class="Record">Signature</a> <a id="15004" class="Symbol">→</a> <a id="15006" href="Peras.Crypto.html#1542" class="Record">Hash</a> <a id="15011" href="Peras.Block.html#2965" class="Record">Block</a> <a id="15017" class="Symbol">→</a> <a id="15019" href="Peras.Chain.html#1483" class="Record">Vote</a>
    <a id="15028" href="Peras.SmallStep.html#14940" class="Function">createVote</a> <a id="15039" href="Peras.SmallStep.html#15039" class="Bound">s</a> <a id="15041" href="Peras.SmallStep.html#15041" class="Bound">p</a> <a id="15043" href="Peras.SmallStep.html#15043" class="Bound">prf</a> <a id="15047" href="Peras.SmallStep.html#15047" class="Bound">sig</a> <a id="15051" href="Peras.SmallStep.html#15051" class="Bound">hb</a> <a id="15054" class="Symbol">=</a>
      <a id="15062" class="Keyword">record</a>
        <a id="15077" class="Symbol">{</a> <a id="15079" href="Peras.Chain.html#1529" class="Field">votingRound</a> <a id="15091" class="Symbol">=</a> <a id="15093" href="Peras.Chain.html#6071" class="Function">v-round</a> <a id="15101" href="Peras.SmallStep.html#15039" class="Bound">s</a>
        <a id="15111" class="Symbol">;</a> <a id="15113" href="Peras.Chain.html#1563" class="Field">creatorId</a> <a id="15123" class="Symbol">=</a> <a id="15125" href="Peras.SmallStep.html#15041" class="Bound">p</a>
        <a id="15135" class="Symbol">;</a> <a id="15137" href="Peras.Chain.html#1593" class="Field">proofM</a> <a id="15144" class="Symbol">=</a> <a id="15146" href="Peras.SmallStep.html#15043" class="Bound">prf</a>
        <a id="15158" class="Symbol">;</a> <a id="15160" href="Peras.Chain.html#1631" class="Field">blockHash</a> <a id="15170" class="Symbol">=</a> <a id="15172" href="Peras.SmallStep.html#15051" class="Bound">hb</a>
        <a id="15183" class="Symbol">;</a> <a id="15185" href="Peras.Chain.html#1664" class="Field">signature</a> <a id="15195" class="Symbol">=</a> <a id="15197" href="Peras.SmallStep.html#15047" class="Bound">sig</a>
        <a id="15209" class="Symbol">}</a>
</pre>
<p>A party can vote for a block, if * the current slot is the first slot
in a voting round * the party is a member of the voting committee * the
chain is not in a cool-down phase</p>
Voting updates the party’s local state and for all other parties a
message is added to be consumed immediately.
<pre class="Agda">    <a id="15522" class="Keyword">infix</a> <a id="15528" class="Number">2</a> <a id="15530" href="Peras.SmallStep.html#15546" class="Datatype Operator">_⊢_⇉_</a>

    <a id="15541" class="Keyword">data</a> <a id="15546" href="Peras.SmallStep.html#15546" class="Datatype Operator">_⊢_⇉_</a> <a id="15552" class="Symbol">:</a> <a id="15554" class="Symbol">{</a><a id="15555" href="Peras.SmallStep.html#15555" class="Bound">p</a> <a id="15557" class="Symbol">:</a> <a id="15559" href="Peras.Block.html#1264" class="Function">PartyId</a><a id="15566" class="Symbol">}</a> <a id="15568" class="Symbol">→</a> <a id="15570" href="Peras.Block.html#2030" class="Datatype">Honesty</a> <a id="15578" href="Peras.SmallStep.html#15555" class="Bound">p</a> <a id="15580" class="Symbol">→</a> <a id="15582" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="15588" class="Symbol">→</a> <a id="15590" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="15596" class="Symbol">→</a> <a id="15598" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="15603" class="Keyword">where</a>

      <a id="15616" href="Peras.SmallStep.html#15616" class="InductiveConstructor">honest</a> <a id="15623" class="Symbol">:</a> <a id="15625" class="Symbol">∀</a> <a id="15627" class="Symbol">{</a><a id="15628" href="Peras.SmallStep.html#15628" class="Bound">p</a><a id="15629" class="Symbol">}</a> <a id="15631" class="Symbol">{</a><a id="15632" href="Peras.SmallStep.html#15632" class="Bound">t</a><a id="15633" class="Symbol">}</a> <a id="15635" class="Symbol">{</a><a id="15636" href="Peras.SmallStep.html#15636" class="Bound">M</a><a id="15637" class="Symbol">}</a> <a id="15639" class="Symbol">{</a><a id="15640" href="Peras.SmallStep.html#15640" class="Bound">π</a><a id="15641" class="Symbol">}</a> <a id="15643" class="Symbol">{</a><a id="15644" href="Peras.SmallStep.html#15644" class="Bound">σ</a><a id="15645" class="Symbol">}</a> <a id="15647" class="Symbol">{</a><a id="15648" href="Peras.SmallStep.html#15648" class="Bound">b</a><a id="15649" class="Symbol">}</a>
        <a id="15659" class="Symbol">→</a> <a id="15661" class="Keyword">let</a>
            <a id="15677" class="Keyword">open</a> <a id="15682" href="Peras.SmallStep.html#10488" class="Module">State</a>
            <a id="15700" href="Peras.SmallStep.html#15700" class="Bound">s</a> <a id="15702" class="Symbol">=</a> <a id="15704" href="Peras.SmallStep.html#10557" class="Field">clock</a> <a id="15710" href="Peras.SmallStep.html#15636" class="Bound">M</a>
            <a id="15724" href="Peras.SmallStep.html#15724" class="Bound">r</a> <a id="15726" class="Symbol">=</a> <a id="15728" href="Peras.Chain.html#6071" class="Function">v-round</a> <a id="15736" href="Peras.SmallStep.html#15700" class="Bound">s</a>
            <a id="15750" href="Peras.SmallStep.html#15750" class="Bound">v</a> <a id="15752" class="Symbol">=</a> <a id="15754" href="Peras.SmallStep.html#14940" class="Function">createVote</a> <a id="15765" href="Peras.SmallStep.html#15700" class="Bound">s</a> <a id="15767" href="Peras.SmallStep.html#15628" class="Bound">p</a> <a id="15769" href="Peras.SmallStep.html#15640" class="Bound">π</a> <a id="15771" href="Peras.SmallStep.html#15644" class="Bound">σ</a> <a id="15773" href="Peras.SmallStep.html#15648" class="Bound">b</a>
          <a id="15785" class="Keyword">in</a>
        <a id="15796" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="15798" href="Peras.SmallStep.html#8482" class="Function">BlockSelection</a> <a id="15813" href="Peras.SmallStep.html#15700" class="Bound">s</a> <a id="15815" href="Peras.SmallStep.html#15632" class="Bound">t</a> <a id="15817" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="15819" href="Peras.SmallStep.html#15648" class="Bound">b</a>
        <a id="15829" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="15831" href="Peras.SmallStep.html#10584" class="Field">blockTrees</a> <a id="15842" href="Peras.SmallStep.html#15636" class="Bound">M</a> <a id="15844" href="Prelude.AssocList.html#847" class="Function Operator">⁉</a> <a id="15846" href="Peras.SmallStep.html#15628" class="Bound">p</a> <a id="15848" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="15850" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="15855" href="Peras.SmallStep.html#15632" class="Bound">t</a>
        <a id="15865" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="15867" href="Peras.Chain.html#2993" class="Field">IsVoteSignature</a> <a id="15883" href="Peras.SmallStep.html#15750" class="Bound">v</a> <a id="15885" href="Peras.SmallStep.html#15644" class="Bound">σ</a>
        <a id="15895" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="15897" href="Peras.Chain.html#5726" class="Function">StartOfRound</a> <a id="15910" href="Peras.SmallStep.html#15700" class="Bound">s</a> <a id="15912" href="Peras.SmallStep.html#15724" class="Bound">r</a>
        <a id="15922" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="15924" href="Peras.Chain.html#2876" class="Field">IsCommitteeMember</a> <a id="15942" href="Peras.SmallStep.html#15628" class="Bound">p</a> <a id="15944" href="Peras.SmallStep.html#15724" class="Bound">r</a> <a id="15946" href="Peras.SmallStep.html#15640" class="Bound">π</a>
        <a id="15956" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="15958" href="Peras.SmallStep.html#10060" class="Function">VotingRule</a> <a id="15969" href="Peras.SmallStep.html#15700" class="Bound">s</a> <a id="15971" href="Peras.SmallStep.html#15632" class="Bound">t</a>
          <a id="15983" href="Prelude.InferenceRules.html#13576" class="Function Operator">───────────────────────────────────</a>
          <a id="16029" href="Peras.Block.html#2063" class="InductiveConstructor">Honest</a> <a id="16036" class="Symbol">{</a><a id="16037" href="Peras.SmallStep.html#15628" class="Bound">p</a><a id="16038" class="Symbol">}</a> <a id="16040" href="Peras.SmallStep.html#15546" class="Datatype Operator">⊢</a>
            <a id="16054" href="Peras.SmallStep.html#15636" class="Bound">M</a> <a id="16056" href="Peras.SmallStep.html#15546" class="Datatype Operator">⇉</a> <a id="16058" href="Peras.SmallStep.html#13494" class="Function Operator">add</a> <a id="16062" class="Symbol">(</a><a id="16063" href="Peras.SmallStep.html#2187" class="InductiveConstructor">VoteMsg</a> <a id="16071" href="Peras.SmallStep.html#15750" class="Bound">v</a> <a id="16073" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="16075" href="Peras.SmallStep.html#2594" class="InductiveConstructor">𝟘</a> <a id="16077" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="16079" href="Peras.SmallStep.html#15628" class="Bound">p</a><a id="16080" class="Symbol">)</a> <a id="16082" href="Peras.SmallStep.html#13494" class="Function Operator">to</a> <a id="16085" href="Peras.SmallStep.html#15632" class="Bound">t</a>
                <a id="16103" href="Peras.SmallStep.html#13494" class="Function Operator">diffuse</a> <a id="16111" href="Peras.SmallStep.html#15636" class="Bound">M</a>
</pre>
<p>Rather than creating a delayed vote, an adversary can honestly create
it and delay the message.</p>
<h2 id="block-creation">Block creation</h2>
<p>Certificates are conditionally added to a block. The following
function determines if there needs to be a certificate provided for a
given voting round and a local block-tree. The conditions are as
follows</p>
<ol type="a">
<li>There is no certificate from 2 rounds ago in certs</li>
<li>The last seen certificate is not expired</li>
<li>The last seen certificate is from a later round than the last
certificate on chain</li>
</ol>
<pre class="Agda">    <a id="16640" href="Peras.SmallStep.html#16640" class="Function">needCert</a> <a id="16649" class="Symbol">:</a> <a id="16651" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="16663" class="Symbol">→</a> <a id="16665" href="Peras.SmallStep.html#7298" class="Bound">T</a> <a id="16667" class="Symbol">→</a> <a id="16669" href="Agda.Builtin.Maybe.html#135" class="Datatype">Maybe</a> <a id="16675" href="Peras.Block.html#3007" class="Record">Certificate</a>
    <a id="16691" href="Peras.SmallStep.html#16640" class="Function">needCert</a> <a id="16700" class="Symbol">(</a><a id="16701" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="16715" href="Peras.SmallStep.html#16715" class="Bound">r</a><a id="16716" class="Symbol">)</a> <a id="16718" href="Peras.SmallStep.html#16718" class="Bound">t</a> <a id="16720" class="Symbol">=</a>
      <a id="16728" class="Keyword">let</a>
        <a id="16740" href="Peras.SmallStep.html#16740" class="Bound">cert⋆</a> <a id="16746" class="Symbol">=</a> <a id="16748" href="Peras.SmallStep.html#6065" class="Function">latestCertOnChain</a> <a id="16766" href="Peras.SmallStep.html#16718" class="Bound">t</a>
        <a id="16776" href="Peras.SmallStep.html#16776" class="Bound">cert′</a> <a id="16782" class="Symbol">=</a> <a id="16784" href="Peras.SmallStep.html#6195" class="Function">latestCertSeen</a> <a id="16799" href="Peras.SmallStep.html#16718" class="Bound">t</a>
      <a id="16807" class="Keyword">in</a>
        <a id="16818" href="Data.Bool.Base.html#1505" class="Function Operator">if</a> <a id="16821" href="Data.Bool.Base.html#941" class="Function">not</a> <a id="16825" class="Symbol">(</a><a id="16826" href="Data.List.Base.html#4896" class="Function">any</a> <a id="16830" class="Symbol">(λ</a> <a id="16833" class="Symbol">{</a><a id="16834" href="Peras.SmallStep.html#16834" class="Bound">c</a> <a id="16836" class="Symbol">→</a> <a id="16838" href="Relation.Nullary.Decidable.Core.html#3623" class="Function Operator">⌊</a> <a id="16840" href="Peras.Block.html#3159" class="Function">roundNumber</a> <a id="16852" href="Peras.SmallStep.html#16834" class="Bound">c</a> <a id="16854" href="Agda.Builtin.Nat.html#336" class="Primitive Operator">+</a> <a id="16856" class="Number">2</a> <a id="16858" href="Data.Nat.Properties.html#3311" class="Function Operator">≟</a> <a id="16860" href="Peras.SmallStep.html#16715" class="Bound">r</a> <a id="16862" href="Relation.Nullary.Decidable.Core.html#3623" class="Function Operator">⌋</a><a id="16863" class="Symbol">})</a> <a id="16866" class="Symbol">(</a><a id="16867" href="Peras.SmallStep.html#5793" class="Function">certs</a> <a id="16873" href="Peras.SmallStep.html#16718" class="Bound">t</a><a id="16874" class="Symbol">))</a> <a id="16877" class="Comment">-- (a)</a>
           <a id="16895" href="Data.Bool.Base.html#995" class="Function Operator">∧</a> <a id="16897" class="Symbol">(</a><a id="16898" href="Peras.SmallStep.html#16715" class="Bound">r</a> <a id="16900" href="Data.Nat.Base.html#1477" class="Function Operator">≤ᵇ</a> <a id="16903" href="Peras.Params.html#249" class="Field">A</a> <a id="16905" href="Agda.Builtin.Nat.html#336" class="Primitive Operator">+</a> <a id="16907" href="Peras.Block.html#3159" class="Function">roundNumber</a> <a id="16919" href="Peras.SmallStep.html#16776" class="Bound">cert′</a><a id="16924" class="Symbol">)</a>                          <a id="16951" class="Comment">-- (b)</a>
           <a id="16969" href="Data.Bool.Base.html#995" class="Function Operator">∧</a> <a id="16971" class="Symbol">(</a><a id="16972" href="Peras.Block.html#3159" class="Function">roundNumber</a> <a id="16984" href="Peras.SmallStep.html#16740" class="Bound">cert⋆</a> <a id="16990" href="Data.Nat.Base.html#1457" class="Primitive Operator">&lt;ᵇ</a> <a id="16993" href="Peras.Block.html#3159" class="Function">roundNumber</a> <a id="17005" href="Peras.SmallStep.html#16776" class="Bound">cert′</a><a id="17010" class="Symbol">)</a>              <a id="17025" class="Comment">-- (c)</a>
        <a id="17040" href="Data.Bool.Base.html#1505" class="Function Operator">then</a> <a id="17045" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="17050" href="Peras.SmallStep.html#16776" class="Bound">cert′</a>
        <a id="17064" href="Data.Bool.Base.html#1505" class="Function Operator">else</a> <a id="17069" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a>
</pre>
Helper function for creating a block
<pre class="Agda">    <a id="17130" href="Peras.SmallStep.html#17130" class="Function">createBlock</a> <a id="17142" class="Symbol">:</a> <a id="17144" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="17155" class="Symbol">→</a> <a id="17157" href="Peras.Block.html#1264" class="Function">PartyId</a> <a id="17165" class="Symbol">→</a> <a id="17167" href="Peras.Crypto.html#2593" class="Record">LeadershipProof</a> <a id="17183" class="Symbol">→</a> <a id="17185" href="Peras.Crypto.html#3115" class="Record">Signature</a> <a id="17195" class="Symbol">→</a> <a id="17197" href="Peras.SmallStep.html#7298" class="Bound">T</a> <a id="17199" class="Symbol">→</a> <a id="17201" href="Peras.Block.html#2965" class="Record">Block</a>
    <a id="17211" href="Peras.SmallStep.html#17130" class="Function">createBlock</a> <a id="17223" href="Peras.SmallStep.html#17223" class="Bound">s</a> <a id="17225" href="Peras.SmallStep.html#17225" class="Bound">p</a> <a id="17227" href="Peras.SmallStep.html#17227" class="Bound">π</a> <a id="17229" href="Peras.SmallStep.html#17229" class="Bound">σ</a> <a id="17231" href="Peras.SmallStep.html#17231" class="Bound">t</a> <a id="17233" class="Symbol">=</a>
      <a id="17241" class="Keyword">record</a>
        <a id="17256" class="Symbol">{</a> <a id="17258" href="Peras.Block.html#3391" class="Field">slotNumber</a> <a id="17269" class="Symbol">=</a> <a id="17271" href="Peras.SmallStep.html#17223" class="Bound">s</a>
        <a id="17281" class="Symbol">;</a> <a id="17283" href="Peras.Block.html#3423" class="Field">creatorId</a> <a id="17293" class="Symbol">=</a> <a id="17295" href="Peras.SmallStep.html#17225" class="Bound">p</a>
        <a id="17305" class="Symbol">;</a> <a id="17307" href="Peras.Block.html#3451" class="Field">parentBlock</a> <a id="17319" class="Symbol">=</a>
            <a id="17333" class="Keyword">let</a> <a id="17337" class="Keyword">open</a> <a id="17342" href="Peras.SmallStep.html#3603" class="Module">IsTreeType</a>
            <a id="17365" class="Keyword">in</a> <a id="17368" href="Peras.Chain.html#5175" class="Function">tipHash</a> <a id="17376" class="Symbol">(</a><a id="17377" href="Peras.SmallStep.html#5701" class="Function">preferredChain</a> <a id="17392" href="Peras.SmallStep.html#17231" class="Bound">t</a><a id="17393" class="Symbol">)</a>
        <a id="17403" class="Symbol">;</a> <a id="17405" href="Peras.Block.html#3484" class="Field">certificate</a> <a id="17417" class="Symbol">=</a>
            <a id="17431" class="Keyword">let</a> <a id="17435" href="Peras.SmallStep.html#17435" class="Bound">r</a> <a id="17437" class="Symbol">=</a> <a id="17439" href="Peras.Chain.html#6071" class="Function">v-round</a> <a id="17447" href="Peras.SmallStep.html#17223" class="Bound">s</a>
            <a id="17461" class="Keyword">in</a> <a id="17464" href="Peras.SmallStep.html#16640" class="Function">needCert</a> <a id="17473" href="Peras.SmallStep.html#17435" class="Bound">r</a> <a id="17475" href="Peras.SmallStep.html#17231" class="Bound">t</a>
        <a id="17485" class="Symbol">;</a> <a id="17487" href="Peras.Block.html#3524" class="Field">leadershipProof</a> <a id="17503" class="Symbol">=</a> <a id="17505" href="Peras.SmallStep.html#17227" class="Bound">π</a>
        <a id="17515" class="Symbol">;</a> <a id="17517" href="Peras.Block.html#3596" class="Field">bodyHash</a> <a id="17526" class="Symbol">=</a>
            <a id="17540" class="Keyword">let</a> <a id="17544" href="Peras.SmallStep.html#17544" class="Bound">txs</a> <a id="17548" class="Symbol">=</a> <a id="17550" href="Peras.SmallStep.html#7391" class="Bound">txSelection</a> <a id="17562" href="Peras.SmallStep.html#17223" class="Bound">s</a> <a id="17564" href="Peras.SmallStep.html#17225" class="Bound">p</a>
            <a id="17578" class="Keyword">in</a> <a id="17581" href="Peras.Block.html#3931" class="Field">blockHash</a>
                 <a id="17608" class="Keyword">record</a>
                   <a id="17634" class="Symbol">{</a> <a id="17636" href="Peras.Block.html#3931" class="Field">blockHash</a> <a id="17646" class="Symbol">=</a> <a id="17648" href="Peras.Crypto.html#2033" class="Field">hash</a> <a id="17653" href="Peras.SmallStep.html#17544" class="Bound">txs</a>
                   <a id="17676" class="Symbol">;</a> <a id="17678" href="Peras.Block.html#3964" class="Field">payload</a> <a id="17686" class="Symbol">=</a> <a id="17688" href="Peras.SmallStep.html#17544" class="Bound">txs</a>
                   <a id="17711" class="Symbol">}</a>
        <a id="17721" class="Symbol">;</a> <a id="17723" href="Peras.Block.html#3566" class="Field">signature</a> <a id="17733" class="Symbol">=</a> <a id="17735" href="Peras.SmallStep.html#17229" class="Bound">σ</a>
        <a id="17745" class="Symbol">}</a>
</pre>
<p>A party can create a new block by adding it to the local block tree
and diffuse the block creation messages to the other parties. Block
creation is possible, if as in <em>Praos</em></p>
<ul>
<li>the block signature is correct</li>
<li>the party is the slot leader</li>
</ul>
Block creation updates the party’s local state and for all other parties
a message is added to the message buffer
<pre class="Agda">    <a id="18122" class="Keyword">infix</a> <a id="18128" class="Number">2</a> <a id="18130" href="Peras.SmallStep.html#18146" class="Datatype Operator">_⊢_↷_</a>

    <a id="18141" class="Keyword">data</a> <a id="18146" href="Peras.SmallStep.html#18146" class="Datatype Operator">_⊢_↷_</a> <a id="18152" class="Symbol">:</a> <a id="18154" class="Symbol">{</a><a id="18155" href="Peras.SmallStep.html#18155" class="Bound">p</a> <a id="18157" class="Symbol">:</a> <a id="18159" href="Peras.Block.html#1264" class="Function">PartyId</a><a id="18166" class="Symbol">}</a> <a id="18168" class="Symbol">→</a> <a id="18170" href="Peras.Block.html#2030" class="Datatype">Honesty</a> <a id="18178" href="Peras.SmallStep.html#18155" class="Bound">p</a> <a id="18180" class="Symbol">→</a> <a id="18182" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="18188" class="Symbol">→</a> <a id="18190" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="18196" class="Symbol">→</a> <a id="18198" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="18203" class="Keyword">where</a>

      <a id="18216" href="Peras.SmallStep.html#18216" class="InductiveConstructor">honest</a> <a id="18223" class="Symbol">:</a> <a id="18225" class="Symbol">∀</a> <a id="18227" class="Symbol">{</a><a id="18228" href="Peras.SmallStep.html#18228" class="Bound">p</a><a id="18229" class="Symbol">}</a> <a id="18231" class="Symbol">{</a><a id="18232" href="Peras.SmallStep.html#18232" class="Bound">t</a><a id="18233" class="Symbol">}</a> <a id="18235" class="Symbol">{</a><a id="18236" href="Peras.SmallStep.html#18236" class="Bound">M</a><a id="18237" class="Symbol">}</a> <a id="18239" class="Symbol">{</a><a id="18240" href="Peras.SmallStep.html#18240" class="Bound">π</a><a id="18241" class="Symbol">}</a> <a id="18243" class="Symbol">{</a><a id="18244" href="Peras.SmallStep.html#18244" class="Bound">σ</a><a id="18245" class="Symbol">}</a>
        <a id="18255" class="Symbol">→</a> <a id="18257" class="Keyword">let</a>
            <a id="18273" class="Keyword">open</a> <a id="18278" href="Peras.SmallStep.html#10488" class="Module">State</a>
            <a id="18296" href="Peras.SmallStep.html#18296" class="Bound">s</a> <a id="18298" class="Symbol">=</a> <a id="18300" href="Peras.SmallStep.html#10557" class="Field">clock</a> <a id="18306" href="Peras.SmallStep.html#18236" class="Bound">M</a>
            <a id="18320" href="Peras.SmallStep.html#18320" class="Bound">b</a> <a id="18322" class="Symbol">=</a> <a id="18324" href="Peras.SmallStep.html#17130" class="Function">createBlock</a> <a id="18336" href="Peras.SmallStep.html#18296" class="Bound">s</a> <a id="18338" href="Peras.SmallStep.html#18228" class="Bound">p</a> <a id="18340" href="Peras.SmallStep.html#18240" class="Bound">π</a> <a id="18342" href="Peras.SmallStep.html#18244" class="Bound">σ</a> <a id="18344" href="Peras.SmallStep.html#18232" class="Bound">t</a>
            <a id="18358" href="Peras.SmallStep.html#18358" class="Bound">pref</a> <a id="18363" class="Symbol">=</a> <a id="18365" href="Peras.SmallStep.html#5701" class="Function">preferredChain</a> <a id="18380" href="Peras.SmallStep.html#18232" class="Bound">t</a>
          <a id="18392" class="Keyword">in</a>
        <a id="18403" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="18405" href="Peras.SmallStep.html#10584" class="Field">blockTrees</a> <a id="18416" href="Peras.SmallStep.html#18236" class="Bound">M</a> <a id="18418" href="Prelude.AssocList.html#847" class="Function Operator">⁉</a> <a id="18420" href="Peras.SmallStep.html#18228" class="Bound">p</a> <a id="18422" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="18424" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="18429" href="Peras.SmallStep.html#18232" class="Bound">t</a>
        <a id="18439" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="18441" href="Peras.Chain.html#6731" class="Datatype">ValidChain</a> <a id="18452" class="Symbol">(</a><a id="18453" href="Peras.SmallStep.html#18320" class="Bound">b</a> <a id="18455" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="18457" href="Peras.SmallStep.html#18358" class="Bound">pref</a><a id="18461" class="Symbol">)</a>
          <a id="18473" href="Prelude.InferenceRules.html#13868" class="Function Operator">───────────────────────────</a>
          <a id="18511" href="Peras.Block.html#2063" class="InductiveConstructor">Honest</a> <a id="18518" class="Symbol">{</a><a id="18519" href="Peras.SmallStep.html#18228" class="Bound">p</a><a id="18520" class="Symbol">}</a> <a id="18522" href="Peras.SmallStep.html#18146" class="Datatype Operator">⊢</a>
            <a id="18536" href="Peras.SmallStep.html#18236" class="Bound">M</a> <a id="18538" href="Peras.SmallStep.html#18146" class="Datatype Operator">↷</a> <a id="18540" href="Peras.SmallStep.html#13494" class="Function Operator">add</a> <a id="18544" class="Symbol">(</a>
                  <a id="18564" href="Peras.SmallStep.html#2156" class="InductiveConstructor">ChainMsg</a> <a id="18573" class="Symbol">(</a><a id="18574" href="Peras.SmallStep.html#18320" class="Bound">b</a> <a id="18576" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="18578" href="Peras.SmallStep.html#18358" class="Bound">pref</a><a id="18582" class="Symbol">)</a>
                <a id="18600" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="18602" href="Peras.SmallStep.html#2594" class="InductiveConstructor">𝟘</a>
                <a id="18620" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="18622" href="Peras.SmallStep.html#18228" class="Bound">p</a><a id="18623" class="Symbol">)</a> <a id="18625" href="Peras.SmallStep.html#13494" class="Function Operator">to</a> <a id="18628" href="Peras.SmallStep.html#18232" class="Bound">t</a>
                <a id="18646" href="Peras.SmallStep.html#13494" class="Function Operator">diffuse</a> <a id="18654" href="Peras.SmallStep.html#18236" class="Bound">M</a>
</pre>
<h2 id="small-step-semantics-1">Small-step semantics</h2>
The small-step semantics describe the evolution of the global state.
<pre class="Agda">    <a id="18766" class="Keyword">variable</a>
      <a id="18781" href="Peras.SmallStep.html#18781" class="Generalizable">M</a> <a id="18783" href="Peras.SmallStep.html#18783" class="Generalizable">N</a> <a id="18785" href="Peras.SmallStep.html#18785" class="Generalizable">O</a> <a id="18787" class="Symbol">:</a> <a id="18789" href="Peras.SmallStep.html#10488" class="Record">State</a>
      <a id="18801" href="Peras.SmallStep.html#18801" class="Generalizable">p</a> <a id="18803" class="Symbol">:</a> <a id="18805" href="Peras.Block.html#1264" class="Function">PartyId</a>
      <a id="18819" href="Peras.SmallStep.html#18819" class="Generalizable">h</a> <a id="18821" class="Symbol">:</a> <a id="18823" href="Peras.Block.html#2030" class="Datatype">Honesty</a> <a id="18831" href="Peras.SmallStep.html#18801" class="Generalizable">p</a>
</pre>
<p>The relation allows</p>
<ul>
<li>Fetching messages at the beginning of each slot</li>
<li>Block creation</li>
<li>Voting</li>
<li>Transitioning to next slot in the same voting round</li>
<li>Transitioning to next slot in a new voting round</li>
</ul>
Note, when transitioning to the next slot we need to distinguish whether
the next slot is in the same or a new voting round. This is necessary in
order to detect adversarial behaviour with respect to voting
(adversarialy not voting in a voting round)
<pre class="Agda">    <a id="19303" class="Keyword">data</a> <a id="19308" href="Peras.SmallStep.html#19308" class="Datatype Operator">_↝_</a> <a id="19312" class="Symbol">:</a> <a id="19314" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="19320" class="Symbol">→</a> <a id="19322" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="19328" class="Symbol">→</a> <a id="19330" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="19335" class="Keyword">where</a>

      <a id="19348" href="Peras.SmallStep.html#19348" class="InductiveConstructor">Fetch</a> <a id="19354" class="Symbol">:</a> <a id="19356" class="Symbol">∀</a> <a id="19358" class="Symbol">{</a><a id="19359" href="Peras.SmallStep.html#19359" class="Bound">m</a><a id="19360" class="Symbol">}</a> <a id="19362" class="Symbol">→</a>
        <a id="19372" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="19374" href="Peras.SmallStep.html#18819" class="Generalizable">h</a> <a id="19376" href="Peras.SmallStep.html#13929" class="Datatype Operator">⊢</a> <a id="19378" href="Peras.SmallStep.html#18781" class="Generalizable">M</a> <a id="19380" href="Peras.SmallStep.html#13929" class="Datatype Operator">[</a> <a id="19382" href="Peras.SmallStep.html#19359" class="Bound">m</a> <a id="19384" href="Peras.SmallStep.html#13929" class="Datatype Operator">]⇀</a> <a id="19387" href="Peras.SmallStep.html#18783" class="Generalizable">N</a>
          <a id="19399" href="Prelude.InferenceRules.html#14206" class="Function Operator">──────────────</a>
          <a id="19424" href="Peras.SmallStep.html#18781" class="Generalizable">M</a> <a id="19426" href="Peras.SmallStep.html#19308" class="Datatype Operator">↝</a> <a id="19428" href="Peras.SmallStep.html#18783" class="Generalizable">N</a>

      <a id="19437" href="Peras.SmallStep.html#19437" class="InductiveConstructor">CreateVote</a> <a id="19448" class="Symbol">:</a>
        <a id="19458" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="19460" href="Peras.SmallStep.html#11128" class="Function">Fetched</a> <a id="19468" href="Peras.SmallStep.html#18781" class="Generalizable">M</a>
        <a id="19478" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="19480" href="Peras.SmallStep.html#18819" class="Generalizable">h</a> <a id="19482" href="Peras.SmallStep.html#15546" class="Datatype Operator">⊢</a> <a id="19484" href="Peras.SmallStep.html#18781" class="Generalizable">M</a> <a id="19486" href="Peras.SmallStep.html#15546" class="Datatype Operator">⇉</a> <a id="19488" href="Peras.SmallStep.html#18783" class="Generalizable">N</a>
          <a id="19500" href="Prelude.InferenceRules.html#14291" class="Function Operator">─────────</a>
          <a id="19520" href="Peras.SmallStep.html#18781" class="Generalizable">M</a> <a id="19522" href="Peras.SmallStep.html#19308" class="Datatype Operator">↝</a> <a id="19524" href="Peras.SmallStep.html#18783" class="Generalizable">N</a>

      <a id="19533" href="Peras.SmallStep.html#19533" class="InductiveConstructor">CreateBlock</a> <a id="19545" class="Symbol">:</a>
        <a id="19555" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="19557" href="Peras.SmallStep.html#11128" class="Function">Fetched</a> <a id="19565" href="Peras.SmallStep.html#18781" class="Generalizable">M</a>
        <a id="19575" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="19577" href="Peras.SmallStep.html#18819" class="Generalizable">h</a> <a id="19579" href="Peras.SmallStep.html#18146" class="Datatype Operator">⊢</a> <a id="19581" href="Peras.SmallStep.html#18781" class="Generalizable">M</a> <a id="19583" href="Peras.SmallStep.html#18146" class="Datatype Operator">↷</a> <a id="19585" href="Peras.SmallStep.html#18783" class="Generalizable">N</a>
          <a id="19597" href="Prelude.InferenceRules.html#14291" class="Function Operator">─────────</a>
          <a id="19617" href="Peras.SmallStep.html#18781" class="Generalizable">M</a> <a id="19619" href="Peras.SmallStep.html#19308" class="Datatype Operator">↝</a> <a id="19621" href="Peras.SmallStep.html#18783" class="Generalizable">N</a>

      <a id="19630" href="Peras.SmallStep.html#19630" class="InductiveConstructor">NextSlot</a> <a id="19639" class="Symbol">:</a>
        <a id="19649" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="19651" href="Peras.SmallStep.html#11128" class="Function">Fetched</a> <a id="19659" href="Peras.SmallStep.html#18781" class="Generalizable">M</a>
        <a id="19669" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="19671" href="Peras.SmallStep.html#11788" class="Function">NextSlotInSameRound</a> <a id="19691" href="Peras.SmallStep.html#18781" class="Generalizable">M</a>
          <a id="19703" href="Prelude.InferenceRules.html#14045" class="Function Operator">─────────────────────</a>
          <a id="19735" href="Peras.SmallStep.html#18781" class="Generalizable">M</a> <a id="19737" href="Peras.SmallStep.html#19308" class="Datatype Operator">↝</a> <a id="19739" href="Peras.SmallStep.html#12742" class="Function">tick</a> <a id="19744" href="Peras.SmallStep.html#18781" class="Generalizable">M</a>

      <a id="19753" href="Peras.SmallStep.html#19753" class="InductiveConstructor">NextSlotNewRound</a> <a id="19770" class="Symbol">:</a>
        <a id="19780" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="19782" href="Peras.SmallStep.html#11128" class="Function">Fetched</a> <a id="19790" href="Peras.SmallStep.html#18781" class="Generalizable">M</a>
        <a id="19800" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="19802" href="Peras.SmallStep.html#11338" class="Function">LastSlotInRound</a> <a id="19818" href="Peras.SmallStep.html#18781" class="Generalizable">M</a>
        <a id="19828" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="19830" href="Peras.SmallStep.html#12421" class="Function">RequiredVotes</a> <a id="19844" href="Peras.SmallStep.html#18781" class="Generalizable">M</a>
          <a id="19856" href="Prelude.InferenceRules.html#14143" class="Function Operator">─────────────────</a>
          <a id="19884" href="Peras.SmallStep.html#18781" class="Generalizable">M</a> <a id="19886" href="Peras.SmallStep.html#19308" class="Datatype Operator">↝</a> <a id="19888" href="Peras.SmallStep.html#12742" class="Function">tick</a> <a id="19893" href="Peras.SmallStep.html#18781" class="Generalizable">M</a>
</pre>
<h4 id="reflexive-transitive-closure">Reflexive, transitive closure</h4>
List-like structure for defining execution paths.
<pre class="Agda">    <a id="19996" class="Keyword">infix</a>  <a id="20003" class="Number">2</a> <a id="20005" href="Peras.SmallStep.html#20052" class="Datatype Operator">_↝⋆_</a>
    <a id="20014" class="Keyword">infixr</a> <a id="20021" class="Number">2</a> <a id="20023" href="Peras.SmallStep.html#20109" class="InductiveConstructor Operator">_↣_</a>
    <a id="20031" class="Keyword">infix</a>  <a id="20038" class="Number">3</a> <a id="20040" href="Peras.SmallStep.html#20092" class="InductiveConstructor">∎</a>

    <a id="20047" class="Keyword">data</a> <a id="20052" href="Peras.SmallStep.html#20052" class="Datatype Operator">_↝⋆_</a> <a id="20057" class="Symbol">:</a> <a id="20059" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="20065" class="Symbol">→</a> <a id="20067" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="20073" class="Symbol">→</a> <a id="20075" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="20080" class="Keyword">where</a>
      <a id="20092" href="Peras.SmallStep.html#20092" class="InductiveConstructor">∎</a> <a id="20094" class="Symbol">:</a> <a id="20096" href="Peras.SmallStep.html#18781" class="Generalizable">M</a> <a id="20098" href="Peras.SmallStep.html#20052" class="Datatype Operator">↝⋆</a> <a id="20101" href="Peras.SmallStep.html#18781" class="Generalizable">M</a>
      <a id="20109" href="Peras.SmallStep.html#20109" class="InductiveConstructor Operator">_↣_</a> <a id="20113" class="Symbol">:</a> <a id="20115" href="Peras.SmallStep.html#18781" class="Generalizable">M</a> <a id="20117" href="Peras.SmallStep.html#19308" class="Datatype Operator">↝</a> <a id="20119" href="Peras.SmallStep.html#18783" class="Generalizable">N</a> <a id="20121" class="Symbol">→</a> <a id="20123" href="Peras.SmallStep.html#18783" class="Generalizable">N</a> <a id="20125" href="Peras.SmallStep.html#20052" class="Datatype Operator">↝⋆</a> <a id="20128" href="Peras.SmallStep.html#18785" class="Generalizable">O</a> <a id="20130" class="Symbol">→</a> <a id="20132" href="Peras.SmallStep.html#18781" class="Generalizable">M</a> <a id="20134" href="Peras.SmallStep.html#20052" class="Datatype Operator">↝⋆</a> <a id="20137" href="Peras.SmallStep.html#18785" class="Generalizable">O</a>
</pre>
<!--
### Composition
<pre class="Agda"><a id="20172" class="Comment">{-
    ↝⋆∘↝⋆ :
        M ↝⋆ N
      → N ↝⋆ O
      → M ↝⋆ O
    ↝⋆∘↝⋆ ∎ M↝⋆O = M↝⋆O
    ↝⋆∘↝⋆ (M↝M₁ ↣ M₁↝⋆N) N↝⋆O = M↝M₁ ↣ ↝⋆∘↝⋆ M₁↝⋆N N↝⋆O
-}</a>
</pre>### Post-composition
<pre class="Agda"><a id="20348" class="Comment">{-
    ↝∘↝⋆ :
        M ↝⋆ N
      → N ↝ O
      → M ↝⋆ O
    ↝∘↝⋆ ∎ N↝O =  N↝O ↣ ∎
    ↝∘↝⋆ (M↝M₁ ↣ M₁↝⋆N) N↝O = M↝M₁ ↣ ↝∘↝⋆ M₁↝⋆N N↝O
-}</a>
</pre>-->
<h3 id="transitions-of-voting-rounds">Transitions of voting rounds</h3>
Transitioning of voting rounds can be described with respect of the
small-step semantics.
<pre class="Agda">    <a id="20630" class="Keyword">data</a> <a id="20635" href="Peras.SmallStep.html#20635" class="Datatype Operator">_↦_</a> <a id="20639" class="Symbol">:</a> <a id="20641" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="20647" class="Symbol">→</a> <a id="20649" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="20655" class="Symbol">→</a> <a id="20657" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="20662" class="Keyword">where</a>

      <a id="20675" href="Peras.SmallStep.html#20675" class="InductiveConstructor">NextRound</a> <a id="20685" class="Symbol">:</a> <a id="20687" class="Keyword">let</a> <a id="20691" class="Keyword">open</a> <a id="20696" href="Peras.SmallStep.html#10488" class="Module">State</a> <a id="20702" class="Keyword">in</a>
          <a id="20715" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="20719" class="Symbol">(</a><a id="20720" href="Peras.SmallStep.html#10841" class="Function">v-rnd&#39;</a> <a id="20727" href="Peras.SmallStep.html#18781" class="Generalizable">M</a><a id="20728" class="Symbol">)</a> <a id="20730" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="20732" href="Peras.SmallStep.html#10841" class="Function">v-rnd&#39;</a> <a id="20739" href="Peras.SmallStep.html#18783" class="Generalizable">N</a>
        <a id="20749" class="Symbol">→</a> <a id="20751" href="Peras.SmallStep.html#18781" class="Generalizable">M</a> <a id="20753" href="Peras.SmallStep.html#20052" class="Datatype Operator">↝⋆</a> <a id="20756" href="Peras.SmallStep.html#18783" class="Generalizable">N</a>
        <a id="20766" class="Symbol">→</a> <a id="20768" href="Peras.SmallStep.html#18781" class="Generalizable">M</a> <a id="20770" href="Peras.SmallStep.html#20635" class="Datatype Operator">↦</a> <a id="20772" href="Peras.SmallStep.html#18783" class="Generalizable">N</a>
</pre>
<h4 id="reflexive-transitive-closure-1">Reflexive, transitive
closure</h4>
List-like structure for executions for voting round transitions
<pre class="Agda">    <a id="20889" class="Keyword">infix</a>  <a id="20896" class="Number">2</a> <a id="20898" href="Peras.SmallStep.html#20945" class="Datatype Operator">_↦⋆_</a>
    <a id="20907" class="Keyword">infixr</a> <a id="20914" class="Number">2</a> <a id="20916" href="Peras.SmallStep.html#21002" class="InductiveConstructor Operator">_⨾_</a>
    <a id="20924" class="Keyword">infix</a>  <a id="20931" class="Number">3</a> <a id="20933" href="Peras.SmallStep.html#20985" class="InductiveConstructor">ρ</a>

    <a id="20940" class="Keyword">data</a> <a id="20945" href="Peras.SmallStep.html#20945" class="Datatype Operator">_↦⋆_</a> <a id="20950" class="Symbol">:</a> <a id="20952" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="20958" class="Symbol">→</a> <a id="20960" href="Peras.SmallStep.html#10488" class="Record">State</a> <a id="20966" class="Symbol">→</a> <a id="20968" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="20973" class="Keyword">where</a>
      <a id="20985" href="Peras.SmallStep.html#20985" class="InductiveConstructor">ρ</a> <a id="20987" class="Symbol">:</a> <a id="20989" href="Peras.SmallStep.html#18781" class="Generalizable">M</a> <a id="20991" href="Peras.SmallStep.html#20945" class="Datatype Operator">↦⋆</a> <a id="20994" href="Peras.SmallStep.html#18781" class="Generalizable">M</a>
      <a id="21002" href="Peras.SmallStep.html#21002" class="InductiveConstructor Operator">_⨾_</a> <a id="21006" class="Symbol">:</a> <a id="21008" href="Peras.SmallStep.html#18781" class="Generalizable">M</a> <a id="21010" href="Peras.SmallStep.html#20635" class="Datatype Operator">↦</a> <a id="21012" href="Peras.SmallStep.html#18783" class="Generalizable">N</a> <a id="21014" class="Symbol">→</a> <a id="21016" href="Peras.SmallStep.html#18783" class="Generalizable">N</a> <a id="21018" href="Peras.SmallStep.html#20945" class="Datatype Operator">↦⋆</a> <a id="21021" href="Peras.SmallStep.html#18785" class="Generalizable">O</a> <a id="21023" class="Symbol">→</a> <a id="21025" href="Peras.SmallStep.html#18781" class="Generalizable">M</a> <a id="21027" href="Peras.SmallStep.html#20945" class="Datatype Operator">↦⋆</a> <a id="21030" href="Peras.SmallStep.html#18785" class="Generalizable">O</a>
</pre>
<!--
## Collision free predicate

<pre class="Agda">    <a id="21082" class="Keyword">open</a> <a id="21087" href="Peras.SmallStep.html#10488" class="Module">State</a>
</pre>
Rather than assuming a global axiom on the injectivity of the hash function
or that any reachable state is collision-free, there is a predicate assuming
that there are no hash collisions during the execution of the protocol.

<pre class="Agda"><a id="21332" class="Comment">{-
    data CollisionFree (N : State) : Type where

      collision-free : ∀ {b₁ b₂ : Block}
        → All
          (λ { (m₁ , m₂) → m₁ ≡ BlockMsg b₁ → m₂ ≡ BlockMsg b₂ →
               (hash b₁ ≡ hash b₂ → b₁ ≡ b₂) })
          (cartesianProduct (history N) (history N))
        → CollisionFree N
-}</a>
</pre>-->
<!--
<pre class="Agda"><a id="21655" class="Comment">{-
    open import Data.List.Relation.Binary.Subset.Propositional.Properties
    open import Data.List.Relation.Binary.Subset.Propositional {A = Message} using (_⊇_) renaming (_⊆_ to _⊆ₘ_)
    open import Data.List.Relation.Binary.Subset.Propositional {A = Message × Message} renaming (_⊇_ to _⊇ₓ_ ; _⊆_ to _⊆ₘₓ_)

    open import Data.List.Membership.Propositional.Properties

    ⊆→⊆-cartesianProduct : ∀ {a b} → a ⊆ₘ b → cartesianProduct a a ⊆ₘₓ cartesianProduct b b
    ⊆→⊆-cartesianProduct {a} a⊆b x =
      let x₁ , x₂ = ∈-cartesianProduct⁻ a a x
       in ∈-cartesianProduct⁺ (a⊆b x₁) (a⊆b x₂)

    collision-free-resp-⊇ : ∀ {M N}
      → CollisionFree N
      → history N ⊇ history M
      → CollisionFree M
    collision-free-resp-⊇ (collision-free {b₁} {b₂} cf) x =
      collision-free {b₁ = b₁} {b₂ = b₂} (All-resp-⊇ (⊆→⊆-cartesianProduct x) cf)

    -- Receive

    []-hist-common-prefix : ∀ {M N p} {h : Honesty p} {m}
      → h ⊢ M [ m ]⇀ N
      → history M ⊆ₘ history N
    []-hist-common-prefix (honest _ _ _) x = x
    []-hist-common-prefix (corrupt _) x = x

    []⇀-collision-free : ∀ {M N p} {h : Honesty p} {m}
      → CollisionFree N
      → h ⊢ M [ m ]⇀ N
      → CollisionFree M
    []⇀-collision-free (collision-free {b₁} {b₂} x) (honest _ _ _) = collision-free {b₁ = b₁} {b₂ = b₂} x
    []⇀-collision-free (collision-free {b₁} {b₂} x) (corrupt _) = collision-free {b₁ = b₁} {b₂ = b₂} x

    -- Create

    []↷-hist-common-prefix : ∀ {M N p} {h : Honesty p}
      → h ⊢ M ↷ N
      → history M ⊆ₘ history N
    []↷-hist-common-prefix {M} (honest {block = b} refl _ _ _) = xs⊆x∷xs (history M) (BlockMsg b)
    []↷-hist-common-prefix {M} (honest-cooldown {block = b} refl _ _ _ _ _ _) = xs⊆x∷xs (history M) (BlockMsg b)

    []⇉-hist-common-prefix : ∀ {M N p} {h : Honesty p}
      → h ⊢ M ⇉ N
      → history M ⊆ₘ history N
    []⇉-hist-common-prefix {M} (honest {vote = v} refl _ _ _ _ _) = xs⊆x∷xs (history M) (VoteMsg v)

    []↷-collision-free : ∀ {M N p} {h : Honesty p}
      → CollisionFree N
      → h ⊢ M ↷ N
      → CollisionFree M
    []↷-collision-free cf-N M[]↷N = collision-free-resp-⊇ cf-N ([]↷-hist-common-prefix M[]↷N)

    []⇉-collision-free : ∀ {M N p} {h : Honesty p}
      → CollisionFree N
      → h ⊢ M ⇉ N
      → CollisionFree M
    []⇉-collision-free cf-N M[]⇉N = collision-free-resp-⊇ cf-N ([]⇉-hist-common-prefix M[]⇉N)
-}</a>
</pre>-->
<!--
### Properties

When the current state is collision free, the pervious state was so too

<pre class="Agda"><a id="24142" class="Comment">{-
    ↝-collision-free :
        M ↝ N
      → CollisionFree N
        ----------------
      → CollisionFree M
-}</a>
</pre>-->
<!--
<pre class="Agda"><a id="24279" class="Comment">{-
    ↝-collision-free (Fetch x) cf-N = []⇀-collision-free cf-N x
    ↝-collision-free (CreateVote _ x) cf-N = []⇉-collision-free cf-N x
    ↝-collision-free (CreateBlock _ x) cf-N =  []↷-collision-free cf-N x
    ↝-collision-free (NextSlot _ _) (collision-free x) = collision-free x
    ↝-collision-free (NextSlotNewRound _ _ _) (collision-free x) = collision-free x
-}</a>
</pre>-->
<!--
When the current state is collision free, previous states were so too

<pre class="Agda"><a id="24743" class="Comment">{-
    ↝⋆-collision-free :
        M ↝⋆ N
      → CollisionFree N
        ----------------
      → CollisionFree M
-}</a>
</pre>-->
<!--
<pre class="Agda"><a id="24882" class="Comment">{-
    ↝⋆-collision-free ∎ N = N
    ↝⋆-collision-free (M↝N ↣ N↝⋆O) O =
      ↝-collision-free M↝N (↝⋆-collision-free N↝⋆O O)
-}</a>
</pre>-->
<!--
## Forging free predicate

Signatures are not modelled explicitly. Instead we assume that the adversary
cannot send any block with the `creatorId` of an honest party that is not
already in the block history.

<pre class="Agda"><a id="25241" class="Comment">{-
    data ForgingFree (N : State) : Type where

      forging-free : ∀ {M : State} {b} {p}
        → Corrupt {p} ⊢ M ↷ N
        → All (λ { m → (m ≡ BlockMsg b × HonestBlock b)
            → m ∈ history M }) (history N)
        → ForgingFree N
-}</a>
</pre><pre class="Agda">  <a id="25504" class="Keyword">open</a> <a id="25509" href="Peras.SmallStep.html#7276" class="Module">Semantics</a> <a id="25519" class="Keyword">public</a>
</pre>-->
</body>
</html>
