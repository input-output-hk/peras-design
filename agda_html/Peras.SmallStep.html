<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Peras.SmallStep</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="Agda.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<pre class="Agda"><a id="9" class="Keyword">module</a> <a id="16" href="Peras.SmallStep.html" class="Module">Peras.SmallStep</a> <a id="32" class="Keyword">where</a>
</pre>
<!--
<pre class="Agda"><a id="55" class="Keyword">open</a> <a id="60" class="Keyword">import</a> <a id="67" href="Prelude.AssocList.html" class="Module">Prelude.AssocList</a>
<a id="85" class="Keyword">open</a> <a id="90" class="Keyword">import</a> <a id="97" href="Prelude.DecEq.html" class="Module">Prelude.DecEq</a> <a id="111" class="Keyword">using</a> <a id="117" class="Symbol">(</a><a id="118" href="Prelude.DecEq.html#62" class="Record">DecEq</a><a id="123" class="Symbol">)</a>
<a id="125" class="Keyword">open</a> <a id="130" class="Keyword">import</a> <a id="137" href="Prelude.Default.html" class="Module">Prelude.Default</a> <a id="153" class="Keyword">using</a> <a id="159" class="Symbol">(</a><a id="160" href="Prelude.Default.html#100" class="Record">Default</a><a id="167" class="Symbol">)</a>
<a id="169" class="Keyword">open</a> <a id="174" href="Prelude.Default.html#100" class="Module">Default</a> <a id="182" class="Symbol">⦃...⦄</a>
<a id="188" class="Keyword">open</a> <a id="193" class="Keyword">import</a> <a id="200" href="Prelude.InferenceRules.html" class="Module">Prelude.InferenceRules</a>

<a id="224" class="Keyword">open</a> <a id="229" class="Keyword">import</a> <a id="236" href="Data.Maybe.html" class="Module">Data.Maybe</a> <a id="247" class="Keyword">using</a> <a id="253" class="Symbol">(</a><a id="254" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a><a id="258" class="Symbol">;</a> <a id="260" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a><a id="267" class="Symbol">)</a>
<a id="269" class="Keyword">open</a> <a id="274" class="Keyword">import</a> <a id="281" href="Data.List.Relation.Unary.Any.html" class="Module">Data.List.Relation.Unary.Any</a> <a id="310" class="Keyword">using</a> <a id="316" class="Symbol">()</a> <a id="319" class="Keyword">renaming</a> <a id="328" class="Symbol">(</a><a id="329" href="Data.List.Relation.Unary.Any.html#2027" class="Function Operator">_∷=_</a> <a id="334" class="Symbol">to</a> <a id="337" class="Function Operator">_∷ˡ=_</a><a id="342" class="Symbol">)</a>
<a id="344" class="Keyword">open</a> <a id="349" class="Keyword">import</a> <a id="356" href="Data.Fin.html" class="Module">Data.Fin</a> <a id="365" class="Keyword">using</a> <a id="371" class="Symbol">(</a><a id="372" href="Data.Fin.Base.html#1154" class="Datatype">Fin</a><a id="375" class="Symbol">)</a> <a id="377" class="Keyword">renaming</a> <a id="386" class="Symbol">(</a><a id="387" href="Data.Fin.Base.html#1176" class="InductiveConstructor">zero</a> <a id="392" class="Symbol">to</a> <a id="395" class="InductiveConstructor">fzero</a><a id="400" class="Symbol">;</a> <a id="402" href="Data.Fin.Base.html#1197" class="InductiveConstructor">suc</a> <a id="406" class="Symbol">to</a> <a id="409" class="InductiveConstructor">fsuc</a><a id="413" class="Symbol">)</a>
<a id="415" class="Keyword">open</a> <a id="420" class="Keyword">import</a> <a id="427" href="Data.Nat.html" class="Module">Data.Nat</a> <a id="436" class="Keyword">using</a> <a id="442" class="Symbol">(</a><a id="443" href="Data.Nat.Base.html#7279" class="Function Operator">_%_</a><a id="446" class="Symbol">;</a> <a id="448" href="Data.Nat.Base.html#2259" class="Function Operator">_≥_</a><a id="451" class="Symbol">;</a> <a id="453" href="Data.Nat.Base.html#2289" class="Function Operator">_&gt;_</a><a id="456" class="Symbol">;</a> <a id="458" href="Data.Nat.Base.html#1691" class="Datatype Operator">_≤_</a><a id="461" class="Symbol">;</a> <a id="463" href="Data.Nat.Base.html#3260" class="Record">NonZero</a><a id="470" class="Symbol">)</a>
<a id="472" class="Keyword">open</a> <a id="477" class="Keyword">import</a> <a id="484" href="Data.List.Membership.Propositional.html" class="Module">Data.List.Membership.Propositional</a>
<a id="519" class="Keyword">open</a> <a id="524" class="Keyword">import</a> <a id="531" href="Relation.Binary.PropositionalEquality.html" class="Module">Relation.Binary.PropositionalEquality</a> <a id="569" class="Keyword">using</a> <a id="575" class="Symbol">(</a><a id="576" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">_≡_</a><a id="579" class="Symbol">;</a> <a id="581" href="Relation.Binary.PropositionalEquality.Core.html#858" class="Function Operator">_≢_</a><a id="584" class="Symbol">)</a>
<a id="586" class="Keyword">open</a> <a id="591" class="Keyword">import</a> <a id="598" href="Data.Product.html" class="Module">Data.Product</a> <a id="611" class="Keyword">using</a> <a id="617" class="Symbol">()</a> <a id="620" class="Keyword">renaming</a> <a id="629" class="Symbol">(</a><a id="630" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">_,_</a> <a id="634" class="Symbol">to</a> <a id="637" class="InductiveConstructor Operator">_,ᵖ_</a><a id="641" class="Symbol">)</a>

<a id="644" class="Keyword">open</a> <a id="649" class="Keyword">import</a> <a id="656" href="Haskell.Prelude.html" class="Module">Haskell.Prelude</a> <a id="672" class="Keyword">hiding</a> <a id="679" class="Symbol">(</a><a id="680" href="Haskell.Prim.Ord.html#1096" class="Field Operator">_&gt;_</a><a id="683" class="Symbol">)</a>
<a id="685" class="Keyword">open</a> <a id="690" class="Keyword">import</a> <a id="697" href="Haskell.Extra.Dec.html" class="Module">Haskell.Extra.Dec</a>

<a id="716" class="Keyword">open</a> <a id="721" class="Keyword">import</a> <a id="728" href="Peras.Block.html" class="Module">Peras.Block</a>
<a id="740" class="Keyword">open</a> <a id="745" class="Keyword">import</a> <a id="752" href="Peras.Chain.html" class="Module">Peras.Chain</a>
<a id="764" class="Keyword">open</a> <a id="769" class="Keyword">import</a> <a id="776" href="Peras.Crypto.html" class="Module">Peras.Crypto</a>
<a id="789" class="Keyword">open</a> <a id="794" class="Keyword">import</a> <a id="801" href="Peras.Numbering.html" class="Module">Peras.Numbering</a>
<a id="817" class="Keyword">open</a> <a id="822" class="Keyword">import</a> <a id="829" href="Peras.Params.html" class="Module">Peras.Params</a>
<a id="842" class="Keyword">open</a> <a id="847" class="Keyword">import</a> <a id="854" href="Peras.Util.html" class="Module">Peras.Util</a>

<a id="866" class="Keyword">open</a> <a id="871" href="Peras.Block.html#1014" class="Module">Honesty</a> <a id="879" class="Keyword">public</a>
<a id="886" class="Keyword">open</a> <a id="891" href="Peras.Crypto.html#2161" class="Module">MembershipProof</a> <a id="907" class="Keyword">public</a>
<a id="914" class="Keyword">open</a> <a id="919" href="Peras.Crypto.html#3115" class="Module">Signature</a> <a id="929" class="Keyword">public</a>
<a id="936" class="Keyword">open</a> <a id="941" href="Peras.Numbering.html#1669" class="Module">RoundNumber</a> <a id="953" class="Keyword">public</a>
<a id="960" class="Keyword">open</a> <a id="965" href="Peras.Block.html#614" class="Module">Party</a>
</pre>-->
<h1 id="small-step-semantics">Small-step semantics</h1>
<p>The small-step semantics of the <strong>Ouroboros Peras</strong>
protocol define the evolution of the global state of the system
modelling <em>honest</em> and <em>adversarial</em> parties. The number
of parties is fixed during the execution of the protocol and the list of
parties has to be provided as a module parameter. In addition the model
is parameterized by the lotteries (for slot leadership and voting
committee membership) as well as the type of the block tree. Furthermore
adversarial parties share generic, adversarial state.</p>
<p>References:</p>
<ul>
<li>Formalizing Nakamoto-Style Proof of Stake, Søren Eller Thomsen and
Bas Spitters</li>
</ul>
<h3 id="parameters">Parameters</h3>
<p>The parameters for the <em>Peras</em> protocol and hash functions are
defined as instance arguments of the module.</p>
<pre class="Agda"><a id="1745" class="Keyword">module</a> <a id="1752" href="Peras.SmallStep.html#1752" class="Module">_</a> <a id="1754" class="Symbol">⦃</a> <a id="1756" href="Peras.SmallStep.html#1756" class="Bound">_</a> <a id="1758" class="Symbol">:</a> <a id="1760" href="Peras.Crypto.html#1994" class="Record">Hashable</a> <a id="1769" href="Peras.Block.html#1708" class="Record">Block</a> <a id="1775" class="Symbol">⦄</a>
         <a id="1786" class="Symbol">⦃</a> <a id="1788" href="Peras.SmallStep.html#1788" class="Bound">_</a> <a id="1790" class="Symbol">:</a> <a id="1792" href="Peras.Crypto.html#1994" class="Record">Hashable</a> <a id="1801" class="Symbol">(</a><a id="1802" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="1807" href="Peras.Block.html#1230" class="Function">Tx</a><a id="1809" class="Symbol">)</a> <a id="1811" class="Symbol">⦄</a>
         <a id="1822" class="Symbol">⦃</a> <a id="1824" href="Peras.SmallStep.html#1824" class="Bound">_</a> <a id="1826" class="Symbol">:</a> <a id="1828" href="Peras.Params.html#166" class="Record">Params</a> <a id="1835" class="Symbol">⦄</a>
         <a id="1846" class="Symbol">⦃</a> <a id="1848" href="Peras.SmallStep.html#1848" class="Bound">_</a> <a id="1850" class="Symbol">:</a> <a id="1852" href="Peras.Chain.html#1652" class="Record">Network</a> <a id="1860" class="Symbol">⦄</a>
         <a id="1871" class="Symbol">⦃</a> <a id="1873" href="Peras.SmallStep.html#1873" class="Bound">_</a> <a id="1875" class="Symbol">:</a> <a id="1877" href="Peras.Chain.html#1386" class="Record">Postulates</a> <a id="1888" class="Symbol">⦄</a>

         <a id="1900" class="Keyword">where</a>
</pre>
The block tree, resp. the validity of the chain is defined with respect
of the parameters.
<pre class="Agda">  <a id="2015" class="Keyword">open</a> <a id="2020" href="Peras.Crypto.html#1994" class="Module">Hashable</a> <a id="2029" class="Symbol">⦃...⦄</a>
  <a id="2037" class="Keyword">open</a> <a id="2042" href="Peras.Params.html#166" class="Module">Params</a> <a id="2049" class="Symbol">⦃...⦄</a>
  <a id="2057" class="Keyword">open</a> <a id="2062" href="Peras.Chain.html#1652" class="Module">Network</a> <a id="2070" class="Symbol">⦃...⦄</a>
  <a id="2078" class="Keyword">open</a> <a id="2083" href="Peras.Chain.html#1386" class="Module">Postulates</a> <a id="2094" class="Symbol">⦃...⦄</a>
</pre>
<h4 id="messages">Messages</h4>
Messages for sending and receiving chains and votes. Note, in the
<em>Peras</em> protocol certificates are not diffused explicitly.
<pre class="Agda">  <a id="2254" class="Keyword">data</a> <a id="2259" href="Peras.SmallStep.html#2259" class="Datatype">Message</a> <a id="2267" class="Symbol">:</a> <a id="2269" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="2273" class="Keyword">where</a>
    <a id="2283" href="Peras.SmallStep.html#2283" class="InductiveConstructor">ChainMsg</a> <a id="2292" class="Symbol">:</a> <a id="2294" class="Symbol">{</a><a id="2295" href="Peras.SmallStep.html#2295" class="Bound">c</a> <a id="2297" class="Symbol">:</a> <a id="2299" href="Peras.Chain.html#2239" class="Function">Chain</a><a id="2304" class="Symbol">}</a> <a id="2306" class="Symbol">→</a> <a id="2308" href="Peras.Chain.html#4237" class="Datatype">ValidChain</a> <a id="2319" href="Peras.SmallStep.html#2295" class="Bound">c</a> <a id="2321" class="Symbol">→</a> <a id="2323" href="Peras.SmallStep.html#2259" class="Datatype">Message</a>
    <a id="2335" href="Peras.SmallStep.html#2335" class="InductiveConstructor">VoteMsg</a> <a id="2343" class="Symbol">:</a> <a id="2345" class="Symbol">{</a><a id="2346" href="Peras.SmallStep.html#2346" class="Bound">v</a> <a id="2348" class="Symbol">:</a> <a id="2350" href="Peras.Chain.html#606" class="Record">Vote</a><a id="2354" class="Symbol">}</a> <a id="2356" class="Symbol">→</a> <a id="2358" href="Peras.Chain.html#1776" class="Function">ValidVote</a> <a id="2368" href="Peras.SmallStep.html#2346" class="Bound">v</a> <a id="2370" class="Symbol">→</a> <a id="2372" href="Peras.SmallStep.html#2259" class="Datatype">Message</a>
</pre>
Messages can be delayed by a number of slots
<pre class="Agda">  <a id="2439" href="Peras.SmallStep.html#2439" class="Function">Delay</a> <a id="2445" class="Symbol">=</a> <a id="2447" href="Data.Fin.Base.html#1154" class="Datatype">Fin</a> <a id="2451" class="Symbol">(</a><a id="2452" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="2456" class="Symbol">(</a><a id="2457" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="2461" href="Peras.Chain.html#1685" class="Field">Δ</a><a id="2462" class="Symbol">))</a>

  <a id="2468" class="Keyword">pattern</a> <a id="2476" href="Peras.SmallStep.html#2476" class="InductiveConstructor">𝟘</a> <a id="2478" class="Symbol">=</a> <a id="2480" href="Peras.SmallStep.html#395" class="InductiveConstructor">fzero</a>
  <a id="2488" class="Keyword">pattern</a> <a id="2496" href="Peras.SmallStep.html#2496" class="InductiveConstructor">𝟙</a> <a id="2498" class="Symbol">=</a> <a id="2500" href="Peras.SmallStep.html#409" class="InductiveConstructor">fsuc</a> <a id="2505" href="Peras.SmallStep.html#395" class="InductiveConstructor">fzero</a>
  <a id="2513" class="Keyword">pattern</a> <a id="2521" href="Peras.SmallStep.html#2521" class="InductiveConstructor">𝟚</a> <a id="2523" class="Symbol">=</a> <a id="2525" href="Peras.SmallStep.html#409" class="InductiveConstructor">fsuc</a> <a id="2530" class="Symbol">(</a><a id="2531" href="Peras.SmallStep.html#409" class="InductiveConstructor">fsuc</a> <a id="2536" href="Peras.SmallStep.html#395" class="InductiveConstructor">fzero</a><a id="2541" class="Symbol">)</a>
</pre>
Messages are put into an envelope and assigned to a party. The message
can be delayed.
<pre class="Agda">  <a id="2644" class="Keyword">record</a> <a id="2651" href="Peras.SmallStep.html#2651" class="Record">Envelope</a> <a id="2660" class="Symbol">:</a> <a id="2662" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="2666" class="Keyword">where</a>
    <a id="2676" class="Keyword">constructor</a> <a id="2688" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦅_,_,_,_⦆</a>
    <a id="2702" class="Keyword">field</a>
      <a id="2714" href="Peras.SmallStep.html#2714" class="Field">partyId</a> <a id="2722" class="Symbol">:</a> <a id="2724" href="Peras.Block.html#450" class="Function">PartyId</a>
      <a id="2738" href="Peras.SmallStep.html#2738" class="Field">honesty</a> <a id="2746" class="Symbol">:</a> <a id="2748" href="Peras.Block.html#1014" class="Datatype">Honesty</a> <a id="2756" href="Peras.SmallStep.html#2714" class="Field">partyId</a>
      <a id="2770" href="Peras.SmallStep.html#2770" class="Field">message</a> <a id="2778" class="Symbol">:</a> <a id="2780" href="Peras.SmallStep.html#2259" class="Datatype">Message</a>
      <a id="2794" href="Peras.SmallStep.html#2794" class="Field">delay</a> <a id="2800" class="Symbol">:</a> <a id="2802" href="Peras.SmallStep.html#2439" class="Function">Delay</a>

  <a id="2811" class="Keyword">open</a> <a id="2816" href="Peras.SmallStep.html#2651" class="Module">Envelope</a>
</pre>
<h4 id="block-tree">Block-tree</h4>
A block-tree is defined by properties - an implementation of the
block-tree has to fulfil all the properties mentioned below:
<pre class="Agda">  <a id="2982" class="Keyword">record</a> <a id="2989" href="Peras.SmallStep.html#2989" class="Record">IsTreeType</a> <a id="3000" class="Symbol">{</a><a id="3001" href="Peras.SmallStep.html#3001" class="Bound">T</a> <a id="3003" class="Symbol">:</a> <a id="3005" href="Agda.Primitive.html#388" class="Primitive">Set</a><a id="3008" class="Symbol">}</a>
                    <a id="3030" class="Symbol">(</a><a id="3031" href="Peras.SmallStep.html#3031" class="Bound">tree₀</a> <a id="3037" class="Symbol">:</a> <a id="3039" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="3040" class="Symbol">)</a>
                    <a id="3062" class="Symbol">(</a><a id="3063" href="Peras.SmallStep.html#3063" class="Bound">addChain</a> <a id="3072" class="Symbol">:</a> <a id="3074" href="Peras.SmallStep.html#3001" class="Bound">T</a> <a id="3076" class="Symbol">→</a> <a id="3078" class="Symbol">{</a><a id="3079" href="Peras.SmallStep.html#3079" class="Bound">c</a> <a id="3081" class="Symbol">:</a> <a id="3083" href="Peras.Chain.html#2239" class="Function">Chain</a><a id="3088" class="Symbol">}</a> <a id="3090" class="Symbol">→</a> <a id="3092" href="Peras.Chain.html#4237" class="Datatype">ValidChain</a> <a id="3103" href="Peras.SmallStep.html#3079" class="Bound">c</a> <a id="3105" class="Symbol">→</a> <a id="3107" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="3108" class="Symbol">)</a>
                    <a id="3130" class="Symbol">(</a><a id="3131" href="Peras.SmallStep.html#3131" class="Bound">chains</a> <a id="3138" class="Symbol">:</a> <a id="3140" href="Peras.SmallStep.html#3001" class="Bound">T</a> <a id="3142" class="Symbol">→</a> <a id="3144" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="3149" href="Peras.Chain.html#2239" class="Function">Chain</a><a id="3154" class="Symbol">)</a>
                    <a id="3176" class="Symbol">(</a><a id="3177" href="Peras.SmallStep.html#3177" class="Bound">preferredChain</a> <a id="3192" class="Symbol">:</a> <a id="3194" href="Peras.SmallStep.html#3001" class="Bound">T</a> <a id="3196" class="Symbol">→</a> <a id="3198" href="Peras.Chain.html#2239" class="Function">Chain</a><a id="3203" class="Symbol">)</a>
                    <a id="3225" class="Symbol">(</a><a id="3226" href="Peras.SmallStep.html#3226" class="Bound">addVote</a> <a id="3234" class="Symbol">:</a> <a id="3236" href="Peras.SmallStep.html#3001" class="Bound">T</a> <a id="3238" class="Symbol">→</a> <a id="3240" class="Symbol">{</a><a id="3241" href="Peras.SmallStep.html#3241" class="Bound">v</a> <a id="3243" class="Symbol">:</a> <a id="3245" href="Peras.Chain.html#606" class="Record">Vote</a><a id="3249" class="Symbol">}</a> <a id="3251" class="Symbol">→</a> <a id="3253" href="Peras.Chain.html#1776" class="Function">ValidVote</a> <a id="3263" href="Peras.SmallStep.html#3241" class="Bound">v</a> <a id="3265" class="Symbol">→</a> <a id="3267" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="3268" class="Symbol">)</a>
                    <a id="3290" class="Symbol">(</a><a id="3291" href="Peras.SmallStep.html#3291" class="Bound">votes</a> <a id="3297" class="Symbol">:</a> <a id="3299" href="Peras.SmallStep.html#3001" class="Bound">T</a> <a id="3301" class="Symbol">→</a> <a id="3303" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="3308" href="Peras.Chain.html#606" class="Record">Vote</a><a id="3312" class="Symbol">)</a>
                    <a id="3334" class="Symbol">(</a><a id="3335" href="Peras.SmallStep.html#3335" class="Bound">certs</a> <a id="3341" class="Symbol">:</a> <a id="3343" href="Peras.SmallStep.html#3001" class="Bound">T</a> <a id="3345" class="Symbol">→</a> <a id="3347" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="3352" href="Peras.Block.html#1750" class="Record">Certificate</a><a id="3363" class="Symbol">)</a>
                    <a id="3385" class="Symbol">(</a><a id="3386" href="Peras.SmallStep.html#3386" class="Bound">cert₀</a> <a id="3392" class="Symbol">:</a> <a id="3394" href="Peras.Block.html#1750" class="Record">Certificate</a><a id="3405" class="Symbol">)</a>
         <a id="3416" class="Symbol">:</a> <a id="3418" href="Agda.Primitive.html#388" class="Primitive">Set₁</a> <a id="3423" class="Keyword">where</a>

    <a id="3434" class="Keyword">field</a>
</pre>
Properties that must hold with respect to chains, certificates and
votes.
<pre class="Agda">      <a id="3532" href="Peras.SmallStep.html#3532" class="Field">instantiated</a> <a id="3545" class="Symbol">:</a>
        <a id="3555" href="Peras.SmallStep.html#3177" class="Bound">preferredChain</a> <a id="3570" href="Peras.SmallStep.html#3031" class="Bound">tree₀</a> <a id="3576" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="3578" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>

      <a id="3588" href="Peras.SmallStep.html#3588" class="Field">instantiated-certs</a> <a id="3607" class="Symbol">:</a>
        <a id="3617" href="Peras.SmallStep.html#3335" class="Bound">certs</a> <a id="3623" href="Peras.SmallStep.html#3031" class="Bound">tree₀</a> <a id="3629" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="3631" href="Peras.SmallStep.html#3386" class="Bound">cert₀</a> <a id="3637" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="3639" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>

      <a id="3649" href="Peras.SmallStep.html#3649" class="Field">instantiated-votes</a> <a id="3668" class="Symbol">:</a>
        <a id="3678" href="Peras.SmallStep.html#3291" class="Bound">votes</a> <a id="3684" href="Peras.SmallStep.html#3031" class="Bound">tree₀</a> <a id="3690" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="3692" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>

      <a id="3702" href="Peras.SmallStep.html#3702" class="Field">extendable-chain</a> <a id="3719" class="Symbol">:</a> <a id="3721" class="Symbol">∀</a> <a id="3723" class="Symbol">(</a><a id="3724" href="Peras.SmallStep.html#3724" class="Bound">t</a> <a id="3726" class="Symbol">:</a> <a id="3728" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="3729" class="Symbol">)</a> <a id="3731" class="Symbol">{</a><a id="3732" href="Peras.SmallStep.html#3732" class="Bound">c</a> <a id="3734" class="Symbol">:</a> <a id="3736" href="Peras.Chain.html#2239" class="Function">Chain</a><a id="3741" class="Symbol">}</a> <a id="3743" class="Symbol">(</a><a id="3744" href="Peras.SmallStep.html#3744" class="Bound">vc</a> <a id="3747" class="Symbol">:</a> <a id="3749" href="Peras.Chain.html#4237" class="Datatype">ValidChain</a> <a id="3760" href="Peras.SmallStep.html#3732" class="Bound">c</a><a id="3761" class="Symbol">)</a>
        <a id="3771" class="Symbol">→</a> <a id="3773" href="Peras.SmallStep.html#3335" class="Bound">certs</a> <a id="3779" class="Symbol">(</a><a id="3780" href="Peras.SmallStep.html#3063" class="Bound">addChain</a> <a id="3789" href="Peras.SmallStep.html#3724" class="Bound">t</a> <a id="3791" href="Peras.SmallStep.html#3744" class="Bound">vc</a><a id="3793" class="Symbol">)</a> <a id="3795" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="3797" href="Haskell.Prim.Foldable.html#528" class="Field">foldr</a> <a id="3803" href="Peras.Chain.html#2393" class="Function">insertCert</a> <a id="3814" class="Symbol">(</a><a id="3815" href="Peras.SmallStep.html#3335" class="Bound">certs</a> <a id="3821" href="Peras.SmallStep.html#3724" class="Bound">t</a><a id="3822" class="Symbol">)</a> <a id="3824" class="Symbol">(</a><a id="3825" href="Peras.Chain.html#2301" class="Function">certsFromChain</a> <a id="3840" href="Peras.SmallStep.html#3732" class="Bound">c</a><a id="3841" class="Symbol">)</a>

      <a id="3850" href="Peras.SmallStep.html#3850" class="Field">valid</a> <a id="3856" class="Symbol">:</a> <a id="3858" class="Symbol">∀</a> <a id="3860" class="Symbol">(</a><a id="3861" href="Peras.SmallStep.html#3861" class="Bound">t</a> <a id="3863" class="Symbol">:</a> <a id="3865" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="3866" class="Symbol">)</a>
        <a id="3876" class="Symbol">→</a> <a id="3878" href="Peras.Chain.html#4237" class="Datatype">ValidChain</a> <a id="3889" class="Symbol">(</a><a id="3890" href="Peras.SmallStep.html#3177" class="Bound">preferredChain</a> <a id="3905" href="Peras.SmallStep.html#3861" class="Bound">t</a><a id="3906" class="Symbol">)</a>

      <a id="3915" href="Peras.SmallStep.html#3915" class="Field">optimal</a> <a id="3923" class="Symbol">:</a> <a id="3925" class="Symbol">∀</a> <a id="3927" class="Symbol">(</a><a id="3928" href="Peras.SmallStep.html#3928" class="Bound">c</a> <a id="3930" class="Symbol">:</a> <a id="3932" href="Peras.Chain.html#2239" class="Function">Chain</a><a id="3937" class="Symbol">)</a> <a id="3939" class="Symbol">(</a><a id="3940" href="Peras.SmallStep.html#3940" class="Bound">t</a> <a id="3942" class="Symbol">:</a> <a id="3944" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="3945" class="Symbol">)</a>
        <a id="3955" class="Symbol">→</a> <a id="3957" class="Keyword">let</a>
            <a id="3973" href="Peras.SmallStep.html#3973" class="Bound">b</a> <a id="3975" class="Symbol">=</a> <a id="3977" href="Peras.SmallStep.html#3177" class="Bound">preferredChain</a> <a id="3992" href="Peras.SmallStep.html#3940" class="Bound">t</a>
            <a id="4006" href="Peras.SmallStep.html#4006" class="Bound">cts</a> <a id="4010" class="Symbol">=</a> <a id="4012" href="Peras.SmallStep.html#3335" class="Bound">certs</a> <a id="4018" href="Peras.SmallStep.html#3940" class="Bound">t</a>
          <a id="4030" class="Keyword">in</a>
          <a id="4043" href="Peras.Chain.html#4237" class="Datatype">ValidChain</a> <a id="4054" href="Peras.SmallStep.html#3928" class="Bound">c</a>
        <a id="4064" class="Symbol">→</a> <a id="4066" href="Peras.SmallStep.html#3928" class="Bound">c</a> <a id="4068" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="4070" href="Peras.SmallStep.html#3131" class="Bound">chains</a> <a id="4077" href="Peras.SmallStep.html#3940" class="Bound">t</a>
        <a id="4087" class="Symbol">→</a> <a id="4089" href="Peras.Chain.html#3826" class="Function">weight</a> <a id="4096" href="Peras.SmallStep.html#3928" class="Bound">c</a> <a id="4098" href="Peras.SmallStep.html#4006" class="Bound">cts</a> <a id="4102" href="Data.Nat.Base.html#1691" class="Datatype Operator">≤</a> <a id="4104" href="Peras.Chain.html#3826" class="Function">weight</a> <a id="4111" href="Peras.SmallStep.html#3973" class="Bound">b</a> <a id="4113" href="Peras.SmallStep.html#4006" class="Bound">cts</a>

      <a id="4124" href="Peras.SmallStep.html#4124" class="Field">self-contained</a> <a id="4139" class="Symbol">:</a> <a id="4141" class="Symbol">∀</a> <a id="4143" class="Symbol">(</a><a id="4144" href="Peras.SmallStep.html#4144" class="Bound">t</a> <a id="4146" class="Symbol">:</a> <a id="4148" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="4149" class="Symbol">)</a>
        <a id="4159" class="Symbol">→</a> <a id="4161" href="Peras.SmallStep.html#3177" class="Bound">preferredChain</a> <a id="4176" href="Peras.SmallStep.html#4144" class="Bound">t</a> <a id="4178" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="4180" href="Peras.SmallStep.html#3131" class="Bound">chains</a> <a id="4187" href="Peras.SmallStep.html#4144" class="Bound">t</a>

<a id="4190" class="Comment">{-
      valid-votes : ∀ (t : T)
        → All ValidVote (votes t)
-}</a>

      <a id="4267" href="Peras.SmallStep.html#4267" class="Field">unique-votes</a> <a id="4280" class="Symbol">:</a> <a id="4282" class="Symbol">∀</a> <a id="4284" class="Symbol">(</a><a id="4285" href="Peras.SmallStep.html#4285" class="Bound">t</a> <a id="4287" class="Symbol">:</a> <a id="4289" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="4290" class="Symbol">)</a> <a id="4292" class="Symbol">{</a><a id="4293" href="Peras.SmallStep.html#4293" class="Bound">v</a> <a id="4295" class="Symbol">:</a> <a id="4297" href="Peras.Chain.html#606" class="Record">Vote</a><a id="4301" class="Symbol">}</a> <a id="4303" class="Symbol">(</a><a id="4304" href="Peras.SmallStep.html#4304" class="Bound">vv</a> <a id="4307" class="Symbol">:</a> <a id="4309" href="Peras.Chain.html#1776" class="Function">ValidVote</a> <a id="4319" href="Peras.SmallStep.html#4293" class="Bound">v</a><a id="4320" class="Symbol">)</a>
        <a id="4330" class="Symbol">→</a> <a id="4332" class="Keyword">let</a> <a id="4336" href="Peras.SmallStep.html#4336" class="Bound">vs</a> <a id="4339" class="Symbol">=</a> <a id="4341" href="Peras.SmallStep.html#3291" class="Bound">votes</a> <a id="4347" href="Peras.SmallStep.html#4285" class="Bound">t</a>
          <a id="4359" class="Keyword">in</a>
          <a id="4372" href="Peras.SmallStep.html#4293" class="Bound">v</a> <a id="4374" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="4376" href="Peras.SmallStep.html#4336" class="Bound">vs</a>
        <a id="4387" class="Symbol">→</a> <a id="4389" href="Peras.SmallStep.html#4336" class="Bound">vs</a> <a id="4392" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="4394" href="Peras.SmallStep.html#3291" class="Bound">votes</a> <a id="4400" class="Symbol">(</a><a id="4401" href="Peras.SmallStep.html#3226" class="Bound">addVote</a> <a id="4409" href="Peras.SmallStep.html#4285" class="Bound">t</a> <a id="4411" href="Peras.SmallStep.html#4304" class="Bound">vv</a><a id="4413" class="Symbol">)</a>

      <a id="4422" href="Peras.SmallStep.html#4422" class="Field">no-equivocations</a> <a id="4439" class="Symbol">:</a> <a id="4441" class="Symbol">∀</a> <a id="4443" class="Symbol">(</a><a id="4444" href="Peras.SmallStep.html#4444" class="Bound">t</a> <a id="4446" class="Symbol">:</a> <a id="4448" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="4449" class="Symbol">)</a> <a id="4451" class="Symbol">{</a><a id="4452" href="Peras.SmallStep.html#4452" class="Bound">v</a> <a id="4454" class="Symbol">:</a> <a id="4456" href="Peras.Chain.html#606" class="Record">Vote</a><a id="4460" class="Symbol">}</a> <a id="4462" class="Symbol">(</a><a id="4463" href="Peras.SmallStep.html#4463" class="Bound">vv</a> <a id="4466" class="Symbol">:</a> <a id="4468" href="Peras.Chain.html#1776" class="Function">ValidVote</a> <a id="4478" href="Peras.SmallStep.html#4452" class="Bound">v</a><a id="4479" class="Symbol">)</a>
        <a id="4489" class="Symbol">→</a> <a id="4491" class="Keyword">let</a> <a id="4495" href="Peras.SmallStep.html#4495" class="Bound">vs</a> <a id="4498" class="Symbol">=</a> <a id="4500" href="Peras.SmallStep.html#3291" class="Bound">votes</a> <a id="4506" href="Peras.SmallStep.html#4444" class="Bound">t</a>
          <a id="4518" class="Keyword">in</a>
          <a id="4531" href="Haskell.Prim.html#2981" class="Datatype">Any</a> <a id="4535" class="Symbol">(</a><a id="4536" href="Peras.SmallStep.html#4452" class="Bound">v</a> <a id="4538" href="Peras.Chain.html#2059" class="Datatype Operator">∻_</a><a id="4540" class="Symbol">)</a> <a id="4542" href="Peras.SmallStep.html#4495" class="Bound">vs</a>
        <a id="4553" class="Symbol">→</a> <a id="4555" href="Peras.SmallStep.html#4495" class="Bound">vs</a> <a id="4558" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="4560" href="Peras.SmallStep.html#3291" class="Bound">votes</a> <a id="4566" class="Symbol">(</a><a id="4567" href="Peras.SmallStep.html#3226" class="Bound">addVote</a> <a id="4575" href="Peras.SmallStep.html#4444" class="Bound">t</a> <a id="4577" href="Peras.SmallStep.html#4463" class="Bound">vv</a><a id="4579" class="Symbol">)</a>

<a id="4582" class="Comment">{-
      quorum-cert : ∀ (t : T) (b : Block) (r : ℕ)
        → length (filter (λ {v →
                    (getRoundNumber (votingRound v) ≟ r)
              ×-dec (blockHash v ≟-BlockHash hash b)}
            ) (votes t)) ≥ τ
        → Any (λ {c →
            (getRoundNumber (round c) ≡ r)
          × (blockRef c ≡ hash b) }) (certs t)
-}</a>
</pre>
In addition to chains the block-tree manages votes and certificates as
well. The block-tree type is defined as follows:
<pre class="Agda">  <a id="5057" class="Keyword">record</a> <a id="5064" href="Peras.SmallStep.html#5064" class="Record">TreeType</a> <a id="5073" class="Symbol">(</a><a id="5074" href="Peras.SmallStep.html#5074" class="Bound">T</a> <a id="5076" class="Symbol">:</a> <a id="5078" href="Agda.Primitive.html#388" class="Primitive">Set</a><a id="5081" class="Symbol">)</a> <a id="5083" class="Symbol">:</a> <a id="5085" href="Agda.Primitive.html#388" class="Primitive">Set₁</a> <a id="5090" class="Keyword">where</a>

    <a id="5101" class="Keyword">field</a>
      <a id="5113" href="Peras.SmallStep.html#5113" class="Field">tree₀</a> <a id="5119" class="Symbol">:</a> <a id="5121" href="Peras.SmallStep.html#5074" class="Bound">T</a>

      <a id="5130" href="Peras.SmallStep.html#5130" class="Field">addChain</a> <a id="5139" class="Symbol">:</a> <a id="5141" href="Peras.SmallStep.html#5074" class="Bound">T</a> <a id="5143" class="Symbol">→</a> <a id="5145" class="Symbol">{</a><a id="5146" href="Peras.SmallStep.html#5146" class="Bound">c</a> <a id="5148" class="Symbol">:</a> <a id="5150" href="Peras.Chain.html#2239" class="Function">Chain</a><a id="5155" class="Symbol">}</a> <a id="5157" class="Symbol">→</a> <a id="5159" href="Peras.Chain.html#4237" class="Datatype">ValidChain</a> <a id="5170" href="Peras.SmallStep.html#5146" class="Bound">c</a> <a id="5172" class="Symbol">→</a> <a id="5174" href="Peras.SmallStep.html#5074" class="Bound">T</a>
      <a id="5182" href="Peras.SmallStep.html#5182" class="Field">chains</a> <a id="5189" class="Symbol">:</a> <a id="5191" href="Peras.SmallStep.html#5074" class="Bound">T</a> <a id="5193" class="Symbol">→</a> <a id="5195" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="5200" href="Peras.Chain.html#2239" class="Function">Chain</a>
      <a id="5212" href="Peras.SmallStep.html#5212" class="Field">preferredChain</a> <a id="5227" class="Symbol">:</a> <a id="5229" href="Peras.SmallStep.html#5074" class="Bound">T</a> <a id="5231" class="Symbol">→</a> <a id="5233" href="Peras.Chain.html#2239" class="Function">Chain</a>

      <a id="5246" href="Peras.SmallStep.html#5246" class="Field">addVote</a> <a id="5254" class="Symbol">:</a> <a id="5256" href="Peras.SmallStep.html#5074" class="Bound">T</a> <a id="5258" class="Symbol">→</a> <a id="5260" class="Symbol">{</a><a id="5261" href="Peras.SmallStep.html#5261" class="Bound">v</a> <a id="5263" class="Symbol">:</a> <a id="5265" href="Peras.Chain.html#606" class="Record">Vote</a><a id="5269" class="Symbol">}</a> <a id="5271" class="Symbol">→</a> <a id="5273" href="Peras.Chain.html#1776" class="Function">ValidVote</a> <a id="5283" href="Peras.SmallStep.html#5261" class="Bound">v</a> <a id="5285" class="Symbol">→</a> <a id="5287" href="Peras.SmallStep.html#5074" class="Bound">T</a>
      <a id="5295" href="Peras.SmallStep.html#5295" class="Field">votes</a> <a id="5301" class="Symbol">:</a> <a id="5303" href="Peras.SmallStep.html#5074" class="Bound">T</a> <a id="5305" class="Symbol">→</a> <a id="5307" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="5312" href="Peras.Chain.html#606" class="Record">Vote</a>

      <a id="5324" href="Peras.SmallStep.html#5324" class="Field">certs</a> <a id="5330" class="Symbol">:</a> <a id="5332" href="Peras.SmallStep.html#5074" class="Bound">T</a> <a id="5334" class="Symbol">→</a> <a id="5336" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="5341" href="Peras.Block.html#1750" class="Record">Certificate</a>

      <a id="5360" href="Peras.SmallStep.html#5360" class="Field">is-TreeType</a> <a id="5372" class="Symbol">:</a> <a id="5374" href="Peras.SmallStep.html#2989" class="Record">IsTreeType</a>
                      <a id="5407" href="Peras.SmallStep.html#5113" class="Field">tree₀</a> <a id="5413" href="Peras.SmallStep.html#5130" class="Field">addChain</a> <a id="5422" href="Peras.SmallStep.html#5182" class="Field">chains</a> <a id="5429" href="Peras.SmallStep.html#5212" class="Field">preferredChain</a>
                      <a id="5466" href="Peras.SmallStep.html#5246" class="Field">addVote</a> <a id="5474" href="Peras.SmallStep.html#5295" class="Field">votes</a> <a id="5480" href="Peras.SmallStep.html#5324" class="Field">certs</a> <a id="5486" href="Peras.Chain.html#2750" class="Function">cert₀</a>

    <a id="5497" href="Peras.SmallStep.html#5497" class="Function">latestCertOnChain</a> <a id="5515" class="Symbol">:</a> <a id="5517" href="Peras.SmallStep.html#5074" class="Bound">T</a> <a id="5519" class="Symbol">→</a> <a id="5521" href="Peras.Block.html#1750" class="Record">Certificate</a>
    <a id="5537" href="Peras.SmallStep.html#5497" class="Function">latestCertOnChain</a> <a id="5555" class="Symbol">=</a>
      <a id="5563" href="Peras.Block.html#1993" class="Function">latestCert</a> <a id="5574" href="Peras.Chain.html#2750" class="Function">cert₀</a> <a id="5580" href="Haskell.Prim.html#1330" class="Function Operator">∘</a> <a id="5582" href="Peras.Util.html#1111" class="Function">mapMaybe</a> <a id="5591" href="Peras.Block.html#2239" class="Field">certificate</a> <a id="5603" href="Haskell.Prim.html#1330" class="Function Operator">∘</a> <a id="5605" href="Peras.SmallStep.html#5212" class="Field">preferredChain</a>

    <a id="5625" href="Peras.SmallStep.html#5625" class="Function">latestCertSeen</a> <a id="5640" class="Symbol">:</a> <a id="5642" href="Peras.SmallStep.html#5074" class="Bound">T</a> <a id="5644" class="Symbol">→</a> <a id="5646" href="Peras.Block.html#1750" class="Record">Certificate</a>
    <a id="5662" href="Peras.SmallStep.html#5625" class="Function">latestCertSeen</a> <a id="5677" class="Symbol">=</a> <a id="5679" href="Peras.Block.html#1993" class="Function">latestCert</a> <a id="5690" href="Peras.Chain.html#2750" class="Function">cert₀</a> <a id="5696" href="Haskell.Prim.html#1330" class="Function Operator">∘</a> <a id="5698" href="Peras.SmallStep.html#5324" class="Field">certs</a>

    <a id="5709" href="Peras.SmallStep.html#5709" class="Function">hasCert</a> <a id="5717" class="Symbol">:</a> <a id="5719" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="5731" class="Symbol">→</a> <a id="5733" href="Peras.SmallStep.html#5074" class="Bound">T</a> <a id="5735" class="Symbol">→</a> <a id="5737" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="5745" href="Peras.SmallStep.html#5709" class="Function">hasCert</a> <a id="5753" class="Symbol">(</a><a id="5754" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="5768" href="Peras.SmallStep.html#5768" class="Bound">r</a><a id="5769" class="Symbol">)</a> <a id="5771" href="Peras.SmallStep.html#5771" class="Bound">t</a> <a id="5773" class="Symbol">=</a> <a id="5775" href="Haskell.Prim.html#2981" class="Datatype">Any</a> <a id="5779" class="Symbol">(λ</a> <a id="5782" href="Peras.SmallStep.html#5782" class="Bound">c</a> <a id="5784" class="Symbol">→</a> <a id="5786" href="Peras.SmallStep.html#5768" class="Bound">r</a> <a id="5788" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="5790" href="Peras.Block.html#1912" class="Function">roundNumber</a> <a id="5802" href="Peras.SmallStep.html#5782" class="Bound">c</a><a id="5803" class="Symbol">)</a> <a id="5805" class="Symbol">(</a><a id="5806" href="Peras.SmallStep.html#5324" class="Field">certs</a> <a id="5812" href="Peras.SmallStep.html#5771" class="Bound">t</a><a id="5813" class="Symbol">)</a>

    <a id="5820" href="Peras.SmallStep.html#5820" class="Function">hasVote</a> <a id="5828" class="Symbol">:</a> <a id="5830" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="5842" class="Symbol">→</a> <a id="5844" href="Peras.SmallStep.html#5074" class="Bound">T</a> <a id="5846" class="Symbol">→</a> <a id="5848" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="5856" href="Peras.SmallStep.html#5820" class="Function">hasVote</a> <a id="5864" class="Symbol">(</a><a id="5865" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="5879" href="Peras.SmallStep.html#5879" class="Bound">r</a><a id="5880" class="Symbol">)</a> <a id="5882" href="Peras.SmallStep.html#5882" class="Bound">t</a> <a id="5884" class="Symbol">=</a> <a id="5886" href="Haskell.Prim.html#2981" class="Datatype">Any</a> <a id="5890" class="Symbol">(λ</a> <a id="5893" href="Peras.SmallStep.html#5893" class="Bound">v</a> <a id="5895" class="Symbol">→</a> <a id="5897" href="Peras.SmallStep.html#5879" class="Bound">r</a> <a id="5899" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="5901" href="Peras.Chain.html#814" class="Function">votingRound&#39;</a> <a id="5914" href="Peras.SmallStep.html#5893" class="Bound">v</a><a id="5915" class="Symbol">)</a> <a id="5917" class="Symbol">(</a><a id="5918" href="Peras.SmallStep.html#5295" class="Field">votes</a> <a id="5924" href="Peras.SmallStep.html#5882" class="Bound">t</a><a id="5925" class="Symbol">)</a>

    <a id="5932" href="Peras.SmallStep.html#5932" class="Function">allBlocks</a> <a id="5942" class="Symbol">:</a> <a id="5944" href="Peras.SmallStep.html#5074" class="Bound">T</a> <a id="5946" class="Symbol">→</a> <a id="5948" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="5953" href="Peras.Block.html#1708" class="Record">Block</a>
    <a id="5963" href="Peras.SmallStep.html#5932" class="Function">allBlocks</a> <a id="5973" class="Symbol">=</a> <a id="5975" href="Haskell.Prim.Foldable.html#741" class="Field">concat</a> <a id="5982" href="Haskell.Prim.html#1330" class="Function Operator">∘</a> <a id="5984" href="Peras.SmallStep.html#5182" class="Field">chains</a>
</pre>
<h3 id="additional-parameters">Additional parameters</h3>
<p>In order to define the semantics the following parameters are
required additionally:</p>
<ul>
<li>The type of the block-tree</li>
<li>adversarialState₀ is the initial adversarial state</li>
<li>Tx selection function per party and slot number</li>
<li>The list of parties
<pre class="Agda">  <a id="6280" class="Keyword">module</a> <a id="6287" href="Peras.SmallStep.html#6287" class="Module">Semantics</a>
       <a id="6308" class="Symbol">{</a><a id="6309" href="Peras.SmallStep.html#6309" class="Bound">T</a> <a id="6311" class="Symbol">:</a> <a id="6313" href="Agda.Primitive.html#388" class="Primitive">Set</a><a id="6316" class="Symbol">}</a> <a id="6318" class="Symbol">{</a><a id="6319" href="Peras.SmallStep.html#6319" class="Bound">blockTree</a> <a id="6329" class="Symbol">:</a> <a id="6331" href="Peras.SmallStep.html#5064" class="Record">TreeType</a> <a id="6340" href="Peras.SmallStep.html#6309" class="Bound">T</a><a id="6341" class="Symbol">}</a>
       <a id="6354" class="Symbol">{</a><a id="6355" href="Peras.SmallStep.html#6355" class="Bound">S</a> <a id="6357" class="Symbol">:</a> <a id="6359" href="Agda.Primitive.html#388" class="Primitive">Set</a><a id="6362" class="Symbol">}</a> <a id="6364" class="Symbol">{</a><a id="6365" href="Peras.SmallStep.html#6365" class="Bound">adversarialState₀</a> <a id="6383" class="Symbol">:</a> <a id="6385" href="Peras.SmallStep.html#6355" class="Bound">S</a><a id="6386" class="Symbol">}</a>
       <a id="6399" class="Symbol">{</a><a id="6400" href="Peras.SmallStep.html#6400" class="Bound">txSelection</a> <a id="6412" class="Symbol">:</a> <a id="6414" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="6425" class="Symbol">→</a> <a id="6427" href="Peras.Block.html#450" class="Function">PartyId</a> <a id="6435" class="Symbol">→</a> <a id="6437" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="6442" href="Peras.Block.html#1230" class="Function">Tx</a><a id="6444" class="Symbol">}</a>
       <a id="6457" class="Symbol">{</a><a id="6458" href="Peras.SmallStep.html#6458" class="Bound">parties</a> <a id="6466" class="Symbol">:</a> <a id="6468" href="Peras.Block.html#1176" class="Function">Parties</a><a id="6475" class="Symbol">}</a> <a id="6477" class="Comment">-- TODO: use parties from blockTrees</a>
                           <a id="6545" class="Comment">-- i.e. allow dynamic participation</a>
       <a id="6592" class="Keyword">where</a>

<a id="6603" class="Keyword">open</a> <a id="6608" href="Peras.SmallStep.html#5064" class="Module">TreeType</a> <a id="6617" href="Peras.SmallStep.html#6319" class="Bound">blockTree</a>

<a id="6632" class="Keyword">private</a>
  <a id="6646" class="Keyword">instance</a>
    <a id="6663" href="Peras.SmallStep.html#6663" class="Function">Default-T</a> <a id="6673" class="Symbol">:</a> <a id="6675" href="Prelude.Default.html#100" class="Record">Default</a> <a id="6683" href="Peras.SmallStep.html#6309" class="Bound">T</a>
    <a id="6693" href="Peras.SmallStep.html#6663" class="Function">Default-T</a> <a id="6703" class="Symbol">.</a><a id="6704" href="Prelude.Default.html#140" class="Field">def</a> <a id="6708" class="Symbol">=</a> <a id="6710" href="Peras.SmallStep.html#5113" class="Function">tree₀</a>
</pre>
<h4 id="block-tree-update">Block-tree update</h4></li>
</ul>
<p>Updating the block-tree upon receiving a message for vote and block
messages.</p>
<pre class="Agda">    <a id="6835" class="Keyword">data</a> <a id="6840" href="Peras.SmallStep.html#6840" class="Datatype Operator">_[_]→_</a> <a id="6847" class="Symbol">:</a> <a id="6849" href="Peras.SmallStep.html#6309" class="Bound">T</a> <a id="6851" class="Symbol">→</a> <a id="6853" href="Peras.SmallStep.html#2259" class="Datatype">Message</a> <a id="6861" class="Symbol">→</a> <a id="6863" href="Peras.SmallStep.html#6309" class="Bound">T</a> <a id="6865" class="Symbol">→</a> <a id="6867" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="6871" class="Keyword">where</a>

      <a id="6884" href="Peras.SmallStep.html#6884" class="InductiveConstructor">VoteReceived</a> <a id="6897" class="Symbol">:</a> <a id="6899" class="Symbol">∀</a> <a id="6901" class="Symbol">{</a><a id="6902" href="Peras.SmallStep.html#6902" class="Bound">v</a> <a id="6904" href="Peras.SmallStep.html#6904" class="Bound">vv</a> <a id="6907" href="Peras.SmallStep.html#6907" class="Bound">t</a><a id="6908" class="Symbol">}</a> <a id="6910" class="Symbol">→</a>
          <a id="6922" href="Prelude.InferenceRules.html#45702" class="Function Operator">────────────────────────────</a>
          <a id="6961" href="Peras.SmallStep.html#6907" class="Bound">t</a> <a id="6963" href="Peras.SmallStep.html#6840" class="Datatype Operator">[</a> <a id="6965" href="Peras.SmallStep.html#2335" class="InductiveConstructor">VoteMsg</a> <a id="6973" class="Symbol">{</a><a id="6974" href="Peras.SmallStep.html#6902" class="Bound">v</a><a id="6975" class="Symbol">}</a> <a id="6977" href="Peras.SmallStep.html#6904" class="Bound">vv</a> <a id="6980" href="Peras.SmallStep.html#6840" class="Datatype Operator">]→</a> <a id="6983" href="Peras.SmallStep.html#5246" class="Function">addVote</a> <a id="6991" href="Peras.SmallStep.html#6907" class="Bound">t</a> <a id="6993" href="Peras.SmallStep.html#6904" class="Bound">vv</a>

      <a id="7003" href="Peras.SmallStep.html#7003" class="InductiveConstructor">ChainReceived</a> <a id="7017" class="Symbol">:</a> <a id="7019" class="Symbol">∀</a> <a id="7021" class="Symbol">{</a><a id="7022" href="Peras.SmallStep.html#7022" class="Bound">c</a> <a id="7024" href="Peras.SmallStep.html#7024" class="Bound">vc</a> <a id="7027" href="Peras.SmallStep.html#7027" class="Bound">t</a><a id="7028" class="Symbol">}</a> <a id="7030" class="Symbol">→</a>
          <a id="7042" href="Prelude.InferenceRules.html#45468" class="Function Operator">──────────────────────────────</a>
          <a id="7083" href="Peras.SmallStep.html#7027" class="Bound">t</a> <a id="7085" href="Peras.SmallStep.html#6840" class="Datatype Operator">[</a> <a id="7087" href="Peras.SmallStep.html#2283" class="InductiveConstructor">ChainMsg</a> <a id="7096" class="Symbol">{</a><a id="7097" href="Peras.SmallStep.html#7022" class="Bound">c</a><a id="7098" class="Symbol">}</a> <a id="7100" href="Peras.SmallStep.html#7024" class="Bound">vc</a> <a id="7103" href="Peras.SmallStep.html#6840" class="Datatype Operator">]→</a> <a id="7106" href="Peras.SmallStep.html#5130" class="Function">addChain</a> <a id="7115" href="Peras.SmallStep.html#7027" class="Bound">t</a> <a id="7117" href="Peras.SmallStep.html#7024" class="Bound">vc</a>
</pre>
<h4 id="vote-in-round">Vote in round</h4>
<p>When does a party vote in a round? The protocol expects regular
voting, i.e. if in the previous round a quorum has been achieved or that
voting resumes after a cool-down phase.</p>
<h4 id="blockselection">BlockSelection</h4>
<pre class="Agda">    <a id="7354" href="Peras.SmallStep.html#7354" class="Function">BlockSelection&#39;</a> <a id="7370" class="Symbol">:</a> <a id="7372" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="7383" class="Symbol">→</a> <a id="7385" href="Peras.Chain.html#2239" class="Function">Chain</a> <a id="7391" class="Symbol">→</a> <a id="7393" href="Peras.Crypto.html#1542" class="Record">Hash</a> <a id="7398" href="Peras.Block.html#1708" class="Record">Block</a>
    <a id="7408" href="Peras.SmallStep.html#7354" class="Function">BlockSelection&#39;</a> <a id="7424" class="Symbol">(</a><a id="7425" href="Peras.Numbering.html#779" class="InductiveConstructor">MkSlotNumber</a> <a id="7438" href="Peras.SmallStep.html#7438" class="Bound">s</a><a id="7439" class="Symbol">)</a> <a id="7441" class="Symbol">=</a> <a id="7443" href="Peras.Block.html#3843" class="Function">tipHash</a> <a id="7451" href="Haskell.Prim.html#1330" class="Function Operator">∘</a> <a id="7453" href="Haskell.Prim.List.html#419" class="Function">filter</a> <a id="7460" class="Symbol">(λ</a> <a id="7463" class="Symbol">{</a><a id="7464" href="Peras.SmallStep.html#7464" class="Bound">b</a> <a id="7466" class="Symbol">→</a> <a id="7468" class="Symbol">(</a><a id="7469" href="Peras.Block.html#2378" class="Function">slotNumber&#39;</a> <a id="7481" href="Peras.SmallStep.html#7464" class="Bound">b</a><a id="7482" class="Symbol">)</a> <a id="7484" href="Haskell.Prim.Num.html#547" class="Field Operator">+</a> <a id="7486" href="Peras.Params.html#235" class="Field">L</a> <a id="7488" href="Haskell.Prim.Ord.html#1144" class="Field Operator">&lt;=</a> <a id="7491" href="Peras.SmallStep.html#7438" class="Bound">s</a><a id="7492" class="Symbol">})</a>

    <a id="7500" href="Peras.SmallStep.html#7500" class="Function">BlockSelection</a> <a id="7515" class="Symbol">:</a> <a id="7517" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="7528" class="Symbol">→</a> <a id="7530" href="Peras.SmallStep.html#6309" class="Bound">T</a> <a id="7532" class="Symbol">→</a> <a id="7534" href="Peras.Crypto.html#1542" class="Record">Hash</a> <a id="7539" href="Peras.Block.html#1708" class="Record">Block</a>
    <a id="7549" href="Peras.SmallStep.html#7500" class="Function">BlockSelection</a> <a id="7564" href="Peras.SmallStep.html#7564" class="Bound">s</a> <a id="7566" class="Symbol">=</a> <a id="7568" href="Peras.SmallStep.html#7354" class="Function">BlockSelection&#39;</a> <a id="7584" href="Peras.SmallStep.html#7564" class="Bound">s</a> <a id="7586" href="Haskell.Prim.html#1330" class="Function Operator">∘</a> <a id="7588" href="Peras.SmallStep.html#5212" class="Function">preferredChain</a>
</pre>
<h4 id="voting-rules">Voting rules</h4>
VR-1A: A party has seen a certificate cert-r−1 for round r−1
<pre class="Agda">    <a id="7699" href="Peras.SmallStep.html#7699" class="Function">VotingRule-1A</a> <a id="7713" class="Symbol">:</a> <a id="7715" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="7727" class="Symbol">→</a> <a id="7729" href="Peras.SmallStep.html#6309" class="Bound">T</a> <a id="7731" class="Symbol">→</a> <a id="7733" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="7741" href="Peras.SmallStep.html#7699" class="Function">VotingRule-1A</a> <a id="7755" href="Peras.SmallStep.html#7755" class="Bound">r</a> <a id="7757" href="Peras.SmallStep.html#7757" class="Bound">t</a> <a id="7759" class="Symbol">=</a> <a id="7761" href="Peras.SmallStep.html#7755" class="Bound">r</a> <a id="7763" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="7765" href="Peras.Numbering.html#3391" class="Function">nextRound</a> <a id="7775" class="Symbol">(</a><a id="7776" href="Peras.Block.html#1859" class="Field">round</a> <a id="7782" class="Symbol">(</a><a id="7783" href="Peras.SmallStep.html#5625" class="Function">latestCertSeen</a> <a id="7798" href="Peras.SmallStep.html#7757" class="Bound">t</a><a id="7799" class="Symbol">))</a>
</pre>
VR-1B: The extends the block certified by cert-r−1,
<pre class="Agda">    <a id="7871" href="Peras.SmallStep.html#7871" class="Function">VotingRule-1B</a> <a id="7885" class="Symbol">:</a> <a id="7887" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="7898" class="Symbol">→</a> <a id="7900" href="Peras.SmallStep.html#6309" class="Bound">T</a> <a id="7902" class="Symbol">→</a> <a id="7904" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="7912" href="Peras.SmallStep.html#7871" class="Function">VotingRule-1B</a> <a id="7926" href="Peras.SmallStep.html#7926" class="Bound">s</a> <a id="7928" href="Peras.SmallStep.html#7928" class="Bound">t</a> <a id="7930" class="Symbol">=</a> <a id="7932" href="Peras.Chain.html#3012" class="Function">Extends</a> <a id="7940" class="Symbol">(</a><a id="7941" href="Peras.SmallStep.html#7500" class="Function">BlockSelection</a> <a id="7956" href="Peras.SmallStep.html#7926" class="Bound">s</a> <a id="7958" href="Peras.SmallStep.html#7928" class="Bound">t</a><a id="7959" class="Symbol">)</a> <a id="7961" class="Symbol">(</a><a id="7962" href="Peras.SmallStep.html#5625" class="Function">latestCertSeen</a> <a id="7977" href="Peras.SmallStep.html#7928" class="Bound">t</a><a id="7978" class="Symbol">)</a> <a id="7980" class="Symbol">(</a><a id="7981" href="Peras.SmallStep.html#5182" class="Function">chains</a> <a id="7988" href="Peras.SmallStep.html#7928" class="Bound">t</a><a id="7989" class="Symbol">)</a>
</pre>
VR-1: Both VR-1A and VR-1B hold
<pre class="Agda">    <a id="8039" href="Peras.SmallStep.html#8039" class="Function">VotingRule-1</a> <a id="8052" class="Symbol">:</a> <a id="8054" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="8065" class="Symbol">→</a> <a id="8067" href="Peras.SmallStep.html#6309" class="Bound">T</a> <a id="8069" class="Symbol">→</a> <a id="8071" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="8079" href="Peras.SmallStep.html#8039" class="Function">VotingRule-1</a> <a id="8092" href="Peras.SmallStep.html#8092" class="Bound">s</a> <a id="8094" href="Peras.SmallStep.html#8094" class="Bound">t</a> <a id="8096" class="Symbol">=</a>
        <a id="8106" href="Peras.SmallStep.html#7699" class="Function">VotingRule-1A</a> <a id="8120" class="Symbol">(</a><a id="8121" href="Peras.Chain.html#3637" class="Function">v-round</a> <a id="8129" href="Peras.SmallStep.html#8092" class="Bound">s</a><a id="8130" class="Symbol">)</a> <a id="8132" href="Peras.SmallStep.html#8094" class="Bound">t</a>
      <a id="8140" href="Haskell.Prim.Tuple.html#169" class="Record Operator">×</a> <a id="8142" href="Peras.SmallStep.html#7871" class="Function">VotingRule-1B</a> <a id="8156" href="Peras.SmallStep.html#8092" class="Bound">s</a> <a id="8158" href="Peras.SmallStep.html#8094" class="Bound">t</a>
</pre>
VR-2A: The last certificate a party has seen is from a round at least R
rounds back
<pre class="Agda">    <a id="8260" href="Peras.SmallStep.html#8260" class="Function">VotingRule-2A</a> <a id="8274" class="Symbol">:</a> <a id="8276" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="8288" class="Symbol">→</a> <a id="8290" href="Peras.SmallStep.html#6309" class="Bound">T</a> <a id="8292" class="Symbol">→</a> <a id="8294" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="8302" href="Peras.SmallStep.html#8260" class="Function">VotingRule-2A</a> <a id="8316" class="Symbol">(</a><a id="8317" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="8331" href="Peras.SmallStep.html#8331" class="Bound">r</a><a id="8332" class="Symbol">)</a> <a id="8334" href="Peras.SmallStep.html#8334" class="Bound">t</a> <a id="8336" class="Symbol">=</a> <a id="8338" href="Peras.SmallStep.html#8331" class="Bound">r</a> <a id="8340" href="Data.Nat.Base.html#2259" class="Function Operator">≥</a> <a id="8342" href="Peras.Block.html#1912" class="Function">roundNumber</a> <a id="8354" class="Symbol">(</a><a id="8355" href="Peras.SmallStep.html#5625" class="Function">latestCertSeen</a> <a id="8370" href="Peras.SmallStep.html#8334" class="Bound">t</a><a id="8371" class="Symbol">)</a> <a id="8373" href="Haskell.Prim.Num.html#547" class="Field Operator">+</a> <a id="8375" href="Peras.Params.html#221" class="Field">R</a>
</pre>
VR-2B: The last certificate included in a party’s current chain is from
a round exactly c⋆K rounds ago for some c : ℕ, c ≥ 0 <!--
<pre class="Agda">    <a id="8523" href="Peras.SmallStep.html#8523" class="Function Operator">_mod_</a> <a id="8529" class="Symbol">:</a> <a id="8531" href="Agda.Builtin.Nat.html#203" class="Datatype">Nat</a> <a id="8535" class="Symbol">→</a> <a id="8537" class="Symbol">(</a><a id="8538" href="Peras.SmallStep.html#8538" class="Bound">n</a> <a id="8540" class="Symbol">:</a> <a id="8542" href="Agda.Builtin.Nat.html#203" class="Datatype">Nat</a><a id="8545" class="Symbol">)</a> <a id="8547" class="Symbol">→</a> <a id="8549" class="Symbol">⦃</a> <a id="8551" href="Data.Nat.Base.html#3260" class="Record">NonZero</a> <a id="8559" href="Peras.SmallStep.html#8538" class="Bound">n</a> <a id="8561" class="Symbol">⦄</a> <a id="8563" class="Symbol">→</a> <a id="8565" href="Agda.Builtin.Nat.html#203" class="Datatype">Nat</a>
    <a id="8573" href="Peras.SmallStep.html#8523" class="Function Operator">_mod_</a> <a id="8579" href="Peras.SmallStep.html#8579" class="Bound">a</a> <a id="8581" href="Peras.SmallStep.html#8581" class="Bound">b</a> <a id="8583" class="Symbol">⦃</a> <a id="8585" href="Peras.SmallStep.html#8585" class="Bound">prf</a> <a id="8589" class="Symbol">⦄</a> <a id="8591" class="Symbol">=</a> <a id="8593" href="Data.Nat.Base.html#7279" class="Function Operator">_%_</a> <a id="8597" href="Peras.SmallStep.html#8579" class="Bound">a</a> <a id="8599" href="Peras.SmallStep.html#8581" class="Bound">b</a> <a id="8601" class="Symbol">⦃</a> <a id="8603" href="Peras.SmallStep.html#8585" class="Bound">prf</a> <a id="8607" class="Symbol">⦄</a>
</pre>-->
<pre class="Agda">    <a id="8629" href="Peras.SmallStep.html#8629" class="Function">VotingRule-2B</a> <a id="8643" class="Symbol">:</a> <a id="8645" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="8657" class="Symbol">→</a> <a id="8659" href="Peras.SmallStep.html#6309" class="Bound">T</a> <a id="8661" class="Symbol">→</a> <a id="8663" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="8671" href="Peras.SmallStep.html#8629" class="Function">VotingRule-2B</a> <a id="8685" class="Symbol">(</a><a id="8686" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="8700" href="Peras.SmallStep.html#8700" class="Bound">r</a><a id="8701" class="Symbol">)</a> <a id="8703" href="Peras.SmallStep.html#8703" class="Bound">t</a> <a id="8705" class="Symbol">=</a>
        <a id="8715" href="Peras.SmallStep.html#8700" class="Bound">r</a> <a id="8717" href="Data.Nat.Base.html#2289" class="Function Operator">&gt;</a> <a id="8719" href="Peras.Block.html#1912" class="Function">roundNumber</a> <a id="8731" class="Symbol">(</a><a id="8732" href="Peras.SmallStep.html#5497" class="Function">latestCertOnChain</a> <a id="8750" href="Peras.SmallStep.html#8703" class="Bound">t</a><a id="8751" class="Symbol">)</a>
      <a id="8759" href="Haskell.Prim.Tuple.html#169" class="Record Operator">×</a> <a id="8761" href="Peras.SmallStep.html#8700" class="Bound">r</a> <a id="8763" href="Peras.SmallStep.html#8523" class="Function Operator">mod</a> <a id="8767" href="Peras.Params.html#207" class="Field">K</a> <a id="8769" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="8771" class="Symbol">(</a><a id="8772" href="Peras.Block.html#1912" class="Function">roundNumber</a> <a id="8784" class="Symbol">(</a><a id="8785" href="Peras.SmallStep.html#5497" class="Function">latestCertOnChain</a> <a id="8803" href="Peras.SmallStep.html#8703" class="Bound">t</a><a id="8804" class="Symbol">))</a> <a id="8807" href="Peras.SmallStep.html#8523" class="Function Operator">mod</a> <a id="8811" href="Peras.Params.html#207" class="Field">K</a>
</pre>
VR-2: Both VR-2A and VR-2B hold
<pre class="Agda">    <a id="8861" href="Peras.SmallStep.html#8861" class="Function">VotingRule-2</a> <a id="8874" class="Symbol">:</a> <a id="8876" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="8888" class="Symbol">→</a> <a id="8890" href="Peras.SmallStep.html#6309" class="Bound">T</a> <a id="8892" class="Symbol">→</a> <a id="8894" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="8902" href="Peras.SmallStep.html#8861" class="Function">VotingRule-2</a> <a id="8915" href="Peras.SmallStep.html#8915" class="Bound">r</a> <a id="8917" href="Peras.SmallStep.html#8917" class="Bound">t</a> <a id="8919" class="Symbol">=</a>
        <a id="8929" href="Peras.SmallStep.html#8260" class="Function">VotingRule-2A</a> <a id="8943" href="Peras.SmallStep.html#8915" class="Bound">r</a> <a id="8945" href="Peras.SmallStep.html#8917" class="Bound">t</a>
      <a id="8953" href="Haskell.Prim.Tuple.html#169" class="Record Operator">×</a> <a id="8955" href="Peras.SmallStep.html#8629" class="Function">VotingRule-2B</a> <a id="8969" href="Peras.SmallStep.html#8915" class="Bound">r</a> <a id="8971" href="Peras.SmallStep.html#8917" class="Bound">t</a>
</pre>
If either VR-1A and VR-1B or VR-2A and VR-2B hold, voting is expected
<pre class="Agda">    <a id="9059" href="Peras.SmallStep.html#9059" class="Function">VotingRule</a> <a id="9070" class="Symbol">:</a> <a id="9072" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="9083" class="Symbol">→</a> <a id="9085" href="Peras.SmallStep.html#6309" class="Bound">T</a> <a id="9087" class="Symbol">→</a> <a id="9089" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="9097" href="Peras.SmallStep.html#9059" class="Function">VotingRule</a> <a id="9108" href="Peras.SmallStep.html#9108" class="Bound">s</a> <a id="9110" href="Peras.SmallStep.html#9110" class="Bound">t</a> <a id="9112" class="Symbol">=</a>
      <a id="9120" href="Haskell.Prim.Either.html#159" class="Datatype">Either</a>
        <a id="9135" class="Symbol">(</a><a id="9136" href="Peras.SmallStep.html#8039" class="Function">VotingRule-1</a> <a id="9149" href="Peras.SmallStep.html#9108" class="Bound">s</a> <a id="9151" href="Peras.SmallStep.html#9110" class="Bound">t</a><a id="9152" class="Symbol">)</a>
        <a id="9162" class="Symbol">(</a><a id="9163" href="Peras.SmallStep.html#8861" class="Function">VotingRule-2</a> <a id="9176" class="Symbol">(</a><a id="9177" href="Peras.Chain.html#3637" class="Function">v-round</a> <a id="9185" href="Peras.SmallStep.html#9108" class="Bound">s</a><a id="9186" class="Symbol">)</a> <a id="9188" href="Peras.SmallStep.html#9110" class="Bound">t</a><a id="9189" class="Symbol">)</a>
</pre>
<h3 id="state">State</h3>
<p>The small-step semantics rely on a global state, which consists of
the following fields:</p>
<ul>
<li>Current slot of the system</li>
<li>Map with local state per party</li>
<li>All the messages that have been sent but not yet been delivered</li>
<li>All the messages that have been sent</li>
<li>Adversarial state</li>
</ul>
<pre class="Agda">    <a id="9496" class="Keyword">record</a> <a id="9503" href="Peras.SmallStep.html#9503" class="Record">State</a> <a id="9509" class="Symbol">:</a> <a id="9511" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="9515" class="Keyword">where</a>
      <a id="9527" class="Keyword">constructor</a> <a id="9539" href="Peras.SmallStep.html#9539" class="InductiveConstructor Operator">⟦_,_,_,_,_⟧</a>
      <a id="9557" class="Keyword">field</a>
        <a id="9571" href="Peras.SmallStep.html#9571" class="Field">clock</a> <a id="9577" class="Symbol">:</a> <a id="9579" href="Peras.Numbering.html#742" class="Record">SlotNumber</a>
        <a id="9598" href="Peras.SmallStep.html#9598" class="Field">blockTrees</a> <a id="9609" class="Symbol">:</a> <a id="9611" href="Prelude.AssocList.html#211" class="Function">AssocList</a> <a id="9621" href="Peras.Block.html#450" class="Function">PartyId</a> <a id="9629" href="Peras.SmallStep.html#6309" class="Bound">T</a>
        <a id="9639" href="Peras.SmallStep.html#9639" class="Field">messages</a> <a id="9648" class="Symbol">:</a> <a id="9650" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="9655" href="Peras.SmallStep.html#2651" class="Record">Envelope</a>
        <a id="9672" href="Peras.SmallStep.html#9672" class="Field">history</a> <a id="9680" class="Symbol">:</a> <a id="9682" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="9687" href="Peras.SmallStep.html#2259" class="Datatype">Message</a>
        <a id="9703" href="Peras.SmallStep.html#9703" class="Field">adversarialState</a> <a id="9720" class="Symbol">:</a> <a id="9722" href="Peras.SmallStep.html#6355" class="Bound">S</a>

      <a id="9731" href="Peras.SmallStep.html#9731" class="Function">v-rnd</a> <a id="9737" class="Symbol">:</a> <a id="9739" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a>
      <a id="9757" href="Peras.SmallStep.html#9731" class="Function">v-rnd</a> <a id="9763" class="Symbol">=</a> <a id="9765" href="Peras.Chain.html#3637" class="Function">v-round</a> <a id="9773" href="Peras.SmallStep.html#9571" class="Field">clock</a>

      <a id="9786" href="Peras.SmallStep.html#9786" class="Function">v-rnd&#39;</a> <a id="9793" class="Symbol">:</a> <a id="9795" href="Agda.Builtin.Nat.html#203" class="Datatype">Nat</a>
      <a id="9805" href="Peras.SmallStep.html#9786" class="Function">v-rnd&#39;</a> <a id="9812" class="Symbol">=</a> <a id="9814" href="Peras.Numbering.html#1729" class="Field">getRoundNumber</a> <a id="9829" href="Peras.SmallStep.html#9731" class="Function">v-rnd</a>
</pre>
<h4 id="progress">Progress</h4>
Rather than keeping track of progress, we introduce a predicate stating
that all messages that are not delayed have been delivered. This is a
precondition that must hold before transitioning to the next slot.
<pre class="Agda">    <a id="10075" href="Peras.SmallStep.html#10075" class="Function">Fetched</a> <a id="10083" class="Symbol">:</a> <a id="10085" href="Peras.SmallStep.html#9503" class="Record">State</a> <a id="10091" class="Symbol">→</a> <a id="10093" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="10101" href="Peras.SmallStep.html#10075" class="Function">Fetched</a> <a id="10109" href="Peras.SmallStep.html#10109" class="Bound">s</a> <a id="10111" class="Symbol">=</a> <a id="10113" href="Haskell.Prim.html#2804" class="Datatype">All</a> <a id="10117" class="Symbol">(λ</a> <a id="10120" class="Symbol">{</a> <a id="10122" href="Peras.SmallStep.html#10122" class="Bound">z</a> <a id="10124" class="Symbol">→</a> <a id="10126" href="Peras.SmallStep.html#2794" class="Field">delay</a> <a id="10132" href="Peras.SmallStep.html#10122" class="Bound">z</a> <a id="10134" href="Relation.Binary.PropositionalEquality.Core.html#858" class="Function Operator">≢</a> <a id="10136" href="Peras.SmallStep.html#2476" class="InductiveConstructor">𝟘</a> <a id="10138" class="Symbol">})</a> <a id="10141" class="Symbol">(</a><a id="10142" href="Peras.SmallStep.html#9639" class="Field">messages</a> <a id="10151" href="Peras.SmallStep.html#10109" class="Bound">s</a><a id="10152" class="Symbol">)</a>
      <a id="10160" class="Keyword">where</a> <a id="10166" class="Keyword">open</a> <a id="10171" href="Peras.SmallStep.html#9503" class="Module">State</a>
</pre>
Ticking the global clock increments the slot number and decrements the
delay of all the messages in the message buffer.
<pre class="Agda">    <a id="10313" href="Peras.SmallStep.html#10313" class="Function">tick</a> <a id="10318" class="Symbol">:</a> <a id="10320" href="Peras.SmallStep.html#9503" class="Record">State</a> <a id="10326" class="Symbol">→</a> <a id="10328" href="Peras.SmallStep.html#9503" class="Record">State</a>
    <a id="10338" href="Peras.SmallStep.html#10313" class="Function">tick</a> <a id="10343" href="Peras.SmallStep.html#10343" class="Bound">M</a> <a id="10345" class="Symbol">=</a>
      <a id="10353" class="Keyword">record</a> <a id="10360" href="Peras.SmallStep.html#10343" class="Bound">M</a>
        <a id="10370" class="Symbol">{</a> <a id="10372" href="Peras.SmallStep.html#9571" class="Field">clock</a> <a id="10378" class="Symbol">=</a> <a id="10380" href="Peras.Numbering.html#821" class="Function">next</a> <a id="10385" href="Peras.SmallStep.html#9571" class="Field">clock</a>
        <a id="10399" class="Symbol">;</a> <a id="10401" href="Peras.SmallStep.html#9639" class="Field">messages</a> <a id="10410" class="Symbol">=</a>
            <a id="10424" href="Haskell.Prim.List.html#211" class="Function">map</a> <a id="10428" class="Symbol">(λ</a> <a id="10431" class="Keyword">where</a> <a id="10437" href="Peras.SmallStep.html#10437" class="Bound">e</a> <a id="10439" class="Symbol">→</a> <a id="10441" class="Keyword">record</a> <a id="10448" href="Peras.SmallStep.html#10437" class="Bound">e</a> <a id="10450" class="Symbol">{</a> <a id="10452" href="Peras.SmallStep.html#2794" class="Field">delay</a> <a id="10458" class="Symbol">=</a> <a id="10460" href="Data.Fin.Base.html#6461" class="Function">Data.Fin.pred</a> <a id="10474" class="Symbol">(</a><a id="10475" href="Peras.SmallStep.html#2794" class="Field">delay</a> <a id="10481" href="Peras.SmallStep.html#10437" class="Bound">e</a><a id="10482" class="Symbol">)</a> <a id="10484" class="Symbol">})</a>
              <a id="10501" href="Peras.SmallStep.html#9639" class="Field">messages</a>
        <a id="10518" class="Symbol">}</a>
      <a id="10526" class="Keyword">where</a> <a id="10532" class="Keyword">open</a> <a id="10537" href="Peras.SmallStep.html#9503" class="Module">State</a> <a id="10543" href="Peras.SmallStep.html#10343" class="Bound">M</a>
</pre>
Updating the global state inserting the updated block-tree for a given
party, adding messages to the message buffer for the other parties and
appending the history
<pre class="Agda">    <a id="10725" href="Peras.SmallStep.html#10725" class="Function Operator">_,_⇑_</a> <a id="10731" class="Symbol">:</a> <a id="10733" href="Peras.SmallStep.html#2259" class="Datatype">Message</a> <a id="10741" class="Symbol">→</a> <a id="10743" class="Symbol">(</a><a id="10744" href="Peras.Block.html#450" class="Function">PartyId</a> <a id="10752" class="Symbol">→</a> <a id="10754" href="Peras.SmallStep.html#2439" class="Function">Delay</a><a id="10759" class="Symbol">)</a> <a id="10761" class="Symbol">→</a> <a id="10763" href="Peras.SmallStep.html#9503" class="Record">State</a> <a id="10769" class="Symbol">→</a> <a id="10771" href="Peras.SmallStep.html#9503" class="Record">State</a>
    <a id="10781" href="Peras.SmallStep.html#10781" class="Bound">m</a> <a id="10783" href="Peras.SmallStep.html#10725" class="Function Operator">,</a> <a id="10785" href="Peras.SmallStep.html#10785" class="Bound">fᵈ</a> <a id="10788" href="Peras.SmallStep.html#10725" class="Function Operator">⇑</a> <a id="10790" href="Peras.SmallStep.html#10790" class="Bound">M</a> <a id="10792" class="Symbol">=</a>
      <a id="10800" class="Keyword">record</a> <a id="10807" href="Peras.SmallStep.html#10790" class="Bound">M</a>
        <a id="10817" class="Symbol">{</a> <a id="10819" href="Peras.SmallStep.html#9639" class="Field">messages</a> <a id="10828" class="Symbol">=</a>
            <a id="10842" href="Haskell.Prim.List.html#211" class="Function">map</a> <a id="10846" class="Symbol">(λ</a> <a id="10849" class="Symbol">(</a><a id="10850" href="Peras.SmallStep.html#10850" class="Bound">p</a> <a id="10852" href="Peras.SmallStep.html#637" class="InductiveConstructor Operator">,ᵖ</a> <a id="10855" href="Peras.SmallStep.html#10855" class="Bound">h</a><a id="10856" class="Symbol">)</a> <a id="10858" class="Symbol">→</a> <a id="10860" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦅</a> <a id="10862" href="Peras.SmallStep.html#10850" class="Bound">p</a> <a id="10864" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="10866" href="Peras.SmallStep.html#10855" class="Bound">h</a> <a id="10868" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="10870" href="Peras.SmallStep.html#10781" class="Bound">m</a> <a id="10872" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="10874" href="Peras.SmallStep.html#10785" class="Bound">fᵈ</a> <a id="10877" href="Peras.SmallStep.html#10850" class="Bound">p</a> <a id="10879" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦆</a><a id="10880" class="Symbol">)</a> <a id="10882" href="Peras.SmallStep.html#6458" class="Bound">parties</a>
              <a id="10904" href="Haskell.Prim.List.html#310" class="Function Operator">++</a> <a id="10907" href="Peras.SmallStep.html#9639" class="Field">messages</a>

        <a id="10925" class="Symbol">;</a> <a id="10927" href="Peras.SmallStep.html#9672" class="Field">history</a> <a id="10935" class="Symbol">=</a> <a id="10937" href="Peras.SmallStep.html#10781" class="Bound">m</a> <a id="10939" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="10941" href="Peras.SmallStep.html#9672" class="Field">history</a>
        <a id="10957" class="Symbol">}</a>
      <a id="10965" class="Keyword">where</a> <a id="10971" class="Keyword">open</a> <a id="10976" href="Peras.SmallStep.html#9503" class="Module">State</a> <a id="10982" href="Peras.SmallStep.html#10790" class="Bound">M</a>

    <a id="10989" href="Peras.SmallStep.html#10989" class="Function Operator">delay_by_update_</a> <a id="11006" class="Symbol">:</a> <a id="11008" href="Peras.SmallStep.html#2259" class="Datatype">Message</a> <a id="11016" class="Symbol">→</a> <a id="11018" class="Symbol">(</a><a id="11019" href="Peras.Block.html#450" class="Function">PartyId</a> <a id="11027" class="Symbol">→</a> <a id="11029" href="Peras.SmallStep.html#2439" class="Function">Delay</a><a id="11034" class="Symbol">)</a> <a id="11036" class="Symbol">→</a> <a id="11038" href="Peras.SmallStep.html#9503" class="Record">State</a> <a id="11044" class="Symbol">→</a> <a id="11046" href="Peras.SmallStep.html#9503" class="Record">State</a>
    <a id="11056" href="Peras.SmallStep.html#10989" class="Function Operator">delay</a> <a id="11062" href="Peras.SmallStep.html#11062" class="Bound">m</a><a id="11063" class="Symbol">@(</a><a id="11065" href="Peras.SmallStep.html#2283" class="InductiveConstructor">ChainMsg</a> <a id="11074" href="Peras.SmallStep.html#11074" class="Bound">x</a><a id="11075" class="Symbol">)</a> <a id="11077" href="Peras.SmallStep.html#10989" class="Function Operator">by</a> <a id="11080" href="Peras.SmallStep.html#11080" class="Bound">fᵈ</a> <a id="11083" href="Peras.SmallStep.html#10989" class="Function Operator">update</a> <a id="11090" href="Peras.SmallStep.html#11090" class="Bound">M</a> <a id="11092" class="Symbol">=</a> <a id="11094" href="Peras.SmallStep.html#11062" class="Bound">m</a> <a id="11096" href="Peras.SmallStep.html#10725" class="Function Operator">,</a> <a id="11098" href="Peras.SmallStep.html#11080" class="Bound">fᵈ</a> <a id="11101" href="Peras.SmallStep.html#10725" class="Function Operator">⇑</a> <a id="11103" href="Peras.SmallStep.html#11090" class="Bound">M</a>
    <a id="11109" href="Peras.SmallStep.html#10989" class="Function Operator">delay</a> <a id="11115" href="Peras.SmallStep.html#11115" class="Bound">m</a><a id="11116" class="Symbol">@(</a><a id="11118" href="Peras.SmallStep.html#2335" class="InductiveConstructor">VoteMsg</a> <a id="11126" href="Peras.SmallStep.html#11126" class="Bound">x</a><a id="11127" class="Symbol">)</a> <a id="11129" href="Peras.SmallStep.html#10989" class="Function Operator">by</a> <a id="11132" href="Peras.SmallStep.html#11132" class="Bound">fᵈ</a> <a id="11135" href="Peras.SmallStep.html#10989" class="Function Operator">update</a> <a id="11142" href="Peras.SmallStep.html#11142" class="Bound">M</a> <a id="11144" class="Symbol">=</a> <a id="11146" href="Peras.SmallStep.html#11115" class="Bound">m</a> <a id="11148" href="Peras.SmallStep.html#10725" class="Function Operator">,</a> <a id="11150" href="Peras.SmallStep.html#11132" class="Bound">fᵈ</a> <a id="11153" href="Peras.SmallStep.html#10725" class="Function Operator">⇑</a> <a id="11155" href="Peras.SmallStep.html#11142" class="Bound">M</a>
</pre>
<h2 id="fetching">Fetching</h2>
<p>A party receives messages from the global state by fetching messages
assigned to the party, updating the local block tree and putting the
local state back into the global state.</p>
<pre class="Agda">    <a id="11365" class="Keyword">data</a> <a id="11370" href="Peras.SmallStep.html#11370" class="Datatype Operator">_⊢_[_]⇀_</a> <a id="11379" class="Symbol">:</a> <a id="11381" class="Symbol">{</a><a id="11382" href="Peras.SmallStep.html#11382" class="Bound">p</a> <a id="11384" class="Symbol">:</a> <a id="11386" href="Peras.Block.html#450" class="Function">PartyId</a><a id="11393" class="Symbol">}</a> <a id="11395" class="Symbol">→</a> <a id="11397" href="Peras.Block.html#1014" class="Datatype">Honesty</a> <a id="11405" href="Peras.SmallStep.html#11382" class="Bound">p</a> <a id="11407" class="Symbol">→</a> <a id="11409" href="Peras.SmallStep.html#9503" class="Record">State</a> <a id="11415" class="Symbol">→</a> <a id="11417" href="Peras.SmallStep.html#2259" class="Datatype">Message</a> <a id="11425" class="Symbol">→</a> <a id="11427" href="Peras.SmallStep.html#9503" class="Record">State</a> <a id="11433" class="Symbol">→</a> <a id="11435" href="Agda.Primitive.html#388" class="Primitive">Set</a>
      <a id="11445" class="Keyword">where</a>
</pre>
An honest party consumes a message from the global message buffer and
updates the local state
<pre class="Agda">      <a id="11563" href="Peras.SmallStep.html#11563" class="InductiveConstructor">honest</a> <a id="11570" class="Symbol">:</a> <a id="11572" class="Symbol">∀</a> <a id="11574" class="Symbol">{</a><a id="11575" href="Peras.SmallStep.html#11575" class="Bound">p</a><a id="11576" class="Symbol">}</a> <a id="11578" class="Symbol">{</a><a id="11579" href="Peras.SmallStep.html#11579" class="Bound">t</a> <a id="11581" href="Peras.SmallStep.html#11581" class="Bound">t′</a><a id="11583" class="Symbol">}</a> <a id="11585" class="Symbol">{</a><a id="11586" href="Peras.SmallStep.html#11586" class="Bound">m</a><a id="11587" class="Symbol">}</a> <a id="11589" class="Symbol">{</a><a id="11590" href="Peras.SmallStep.html#11590" class="Bound">N</a><a id="11591" class="Symbol">}</a> <a id="11593" class="Symbol">→</a> <a id="11595" class="Keyword">let</a> <a id="11599" class="Keyword">open</a> <a id="11604" href="Peras.SmallStep.html#9503" class="Module">State</a> <a id="11610" href="Peras.SmallStep.html#11590" class="Bound">N</a> <a id="11612" class="Keyword">in</a>
          <a id="11625" href="Peras.SmallStep.html#9598" class="Field">blockTrees</a> <a id="11636" href="Prelude.AssocList.html#847" class="Function Operator">⁉</a> <a id="11638" href="Peras.SmallStep.html#11575" class="Bound">p</a> <a id="11640" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="11642" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="11647" href="Peras.SmallStep.html#11579" class="Bound">t</a>
        <a id="11657" class="Symbol">→</a> <a id="11659" class="Symbol">(</a><a id="11660" href="Peras.SmallStep.html#11660" class="Bound">m∈ms</a> <a id="11665" class="Symbol">:</a> <a id="11667" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦅</a> <a id="11669" href="Peras.SmallStep.html#11575" class="Bound">p</a> <a id="11671" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="11673" href="Peras.Block.html#1047" class="InductiveConstructor">Honest</a> <a id="11680" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="11682" href="Peras.SmallStep.html#11586" class="Bound">m</a> <a id="11684" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="11686" href="Peras.SmallStep.html#2476" class="InductiveConstructor">𝟘</a> <a id="11688" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦆</a> <a id="11690" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="11692" href="Peras.SmallStep.html#9639" class="Field">messages</a><a id="11700" class="Symbol">)</a>
        <a id="11710" class="Symbol">→</a> <a id="11712" href="Peras.SmallStep.html#11579" class="Bound">t</a> <a id="11714" href="Peras.SmallStep.html#6840" class="Datatype Operator">[</a> <a id="11716" href="Peras.SmallStep.html#11586" class="Bound">m</a> <a id="11718" href="Peras.SmallStep.html#6840" class="Datatype Operator">]→</a> <a id="11721" href="Peras.SmallStep.html#11581" class="Bound">t′</a>
          <a id="11734" class="Comment">---------------------------------------------</a>
        <a id="11788" class="Symbol">→</a> <a id="11790" href="Peras.Block.html#1047" class="InductiveConstructor">Honest</a> <a id="11797" class="Symbol">{</a><a id="11798" href="Peras.SmallStep.html#11575" class="Bound">p</a><a id="11799" class="Symbol">}</a> <a id="11801" href="Peras.SmallStep.html#11370" class="Datatype Operator">⊢</a>
          <a id="11813" href="Peras.SmallStep.html#11590" class="Bound">N</a> <a id="11815" href="Peras.SmallStep.html#11370" class="Datatype Operator">[</a> <a id="11817" href="Peras.SmallStep.html#11586" class="Bound">m</a> <a id="11819" href="Peras.SmallStep.html#11370" class="Datatype Operator">]⇀</a> <a id="11822" class="Keyword">record</a> <a id="11829" href="Peras.SmallStep.html#11590" class="Bound">N</a>
            <a id="11843" class="Symbol">{</a> <a id="11845" href="Peras.SmallStep.html#9598" class="Field">blockTrees</a> <a id="11856" class="Symbol">=</a> <a id="11858" href="Prelude.AssocList.html#1398" class="Function">set</a> <a id="11862" href="Peras.SmallStep.html#11575" class="Bound">p</a> <a id="11864" href="Peras.SmallStep.html#11581" class="Bound">t′</a> <a id="11867" href="Peras.SmallStep.html#9598" class="Field">blockTrees</a>
            <a id="11890" class="Symbol">;</a> <a id="11892" href="Peras.SmallStep.html#9639" class="Field">messages</a> <a id="11901" class="Symbol">=</a> <a id="11903" href="Peras.SmallStep.html#9639" class="Field">messages</a> <a id="11912" href="Data.List.Membership.Setoid.html#1155" class="Function Operator">─</a> <a id="11914" href="Peras.SmallStep.html#11660" class="Bound">m∈ms</a>
            <a id="11931" class="Symbol">}</a>
</pre>
An adversarial party might delay a message
<pre class="Agda">      <a id="11994" href="Peras.SmallStep.html#11994" class="InductiveConstructor">corrupt</a> <a id="12002" class="Symbol">:</a> <a id="12004" class="Symbol">∀</a> <a id="12006" class="Symbol">{</a><a id="12007" href="Peras.SmallStep.html#12007" class="Bound">p</a><a id="12008" class="Symbol">}</a> <a id="12010" class="Symbol">{</a><a id="12011" href="Peras.SmallStep.html#12011" class="Bound">as</a><a id="12013" class="Symbol">}</a> <a id="12015" class="Symbol">{</a><a id="12016" href="Peras.SmallStep.html#12016" class="Bound">m</a><a id="12017" class="Symbol">}</a> <a id="12019" class="Symbol">{</a><a id="12020" href="Peras.SmallStep.html#12020" class="Bound">N</a><a id="12021" class="Symbol">}</a> <a id="12023" class="Symbol">→</a> <a id="12025" class="Keyword">let</a> <a id="12029" class="Keyword">open</a> <a id="12034" href="Peras.SmallStep.html#9503" class="Module">State</a> <a id="12040" href="Peras.SmallStep.html#12020" class="Bound">N</a> <a id="12042" class="Keyword">in</a>
          <a id="12055" class="Symbol">(</a><a id="12056" href="Peras.SmallStep.html#12056" class="Bound">m∈ms</a> <a id="12061" class="Symbol">:</a> <a id="12063" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦅</a> <a id="12065" href="Peras.SmallStep.html#12007" class="Bound">p</a> <a id="12067" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="12069" href="Peras.Block.html#1091" class="InductiveConstructor">Corrupt</a> <a id="12077" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="12079" href="Peras.SmallStep.html#12016" class="Bound">m</a> <a id="12081" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="12083" href="Peras.SmallStep.html#2476" class="InductiveConstructor">𝟘</a> <a id="12085" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦆</a> <a id="12087" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="12089" href="Peras.SmallStep.html#9639" class="Field">messages</a><a id="12097" class="Symbol">)</a>
          <a id="12109" class="Comment">----------------------------------------------</a>
        <a id="12164" class="Symbol">→</a> <a id="12166" href="Peras.Block.html#1091" class="InductiveConstructor">Corrupt</a> <a id="12174" class="Symbol">{</a><a id="12175" href="Peras.SmallStep.html#12007" class="Bound">p</a><a id="12176" class="Symbol">}</a> <a id="12178" href="Peras.SmallStep.html#11370" class="Datatype Operator">⊢</a>
          <a id="12190" href="Peras.SmallStep.html#12020" class="Bound">N</a> <a id="12192" href="Peras.SmallStep.html#11370" class="Datatype Operator">[</a> <a id="12194" href="Peras.SmallStep.html#12016" class="Bound">m</a> <a id="12196" href="Peras.SmallStep.html#11370" class="Datatype Operator">]⇀</a> <a id="12199" class="Keyword">record</a> <a id="12206" href="Peras.SmallStep.html#12020" class="Bound">N</a>
            <a id="12220" class="Symbol">{</a> <a id="12222" href="Peras.SmallStep.html#9639" class="Field">messages</a> <a id="12231" class="Symbol">=</a> <a id="12233" href="Peras.SmallStep.html#12056" class="Bound">m∈ms</a> <a id="12238" href="Peras.SmallStep.html#337" class="Function Operator">∷ˡ=</a> <a id="12242" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦅</a> <a id="12244" href="Peras.SmallStep.html#12007" class="Bound">p</a> <a id="12246" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="12248" href="Peras.Block.html#1091" class="InductiveConstructor">Corrupt</a> <a id="12256" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="12258" href="Peras.SmallStep.html#12016" class="Bound">m</a> <a id="12260" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="12262" href="Peras.SmallStep.html#2496" class="InductiveConstructor">𝟙</a> <a id="12264" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦆</a>
            <a id="12278" class="Symbol">;</a> <a id="12280" href="Peras.SmallStep.html#9703" class="Field">adversarialState</a> <a id="12297" class="Symbol">=</a> <a id="12299" href="Peras.SmallStep.html#12011" class="Bound">as</a>
            <a id="12314" class="Symbol">}</a>
</pre>
<h2 id="voting">Voting</h2>
Helper function for creating a vote
<pre class="Agda">    <a id="12379" href="Peras.SmallStep.html#12379" class="Function">createVote</a> <a id="12390" class="Symbol">:</a> <a id="12392" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="12403" class="Symbol">→</a> <a id="12405" href="Peras.Block.html#450" class="Function">PartyId</a> <a id="12413" class="Symbol">→</a> <a id="12415" href="Peras.Crypto.html#2161" class="Record">MembershipProof</a> <a id="12431" class="Symbol">→</a> <a id="12433" href="Peras.Crypto.html#3115" class="Record">Signature</a> <a id="12443" class="Symbol">→</a> <a id="12445" href="Peras.Crypto.html#1542" class="Record">Hash</a> <a id="12450" href="Peras.Block.html#1708" class="Record">Block</a> <a id="12456" class="Symbol">→</a> <a id="12458" href="Peras.Chain.html#606" class="Record">Vote</a>
    <a id="12467" href="Peras.SmallStep.html#12379" class="Function">createVote</a> <a id="12478" href="Peras.SmallStep.html#12478" class="Bound">s</a> <a id="12480" href="Peras.SmallStep.html#12480" class="Bound">p</a> <a id="12482" href="Peras.SmallStep.html#12482" class="Bound">prf</a> <a id="12486" href="Peras.SmallStep.html#12486" class="Bound">sig</a> <a id="12490" href="Peras.SmallStep.html#12490" class="Bound">hb</a> <a id="12493" class="Symbol">=</a>
      <a id="12501" class="Keyword">record</a>
        <a id="12516" class="Symbol">{</a> <a id="12518" href="Peras.Chain.html#652" class="Field">votingRound</a> <a id="12530" class="Symbol">=</a> <a id="12532" href="Peras.Chain.html#3637" class="Function">v-round</a> <a id="12540" href="Peras.SmallStep.html#12478" class="Bound">s</a>
        <a id="12550" class="Symbol">;</a> <a id="12552" href="Peras.Chain.html#686" class="Field">creatorId</a> <a id="12562" class="Symbol">=</a> <a id="12564" href="Peras.SmallStep.html#12480" class="Bound">p</a>
        <a id="12574" class="Symbol">;</a> <a id="12576" href="Peras.Chain.html#716" class="Field">proofM</a> <a id="12583" class="Symbol">=</a> <a id="12585" href="Peras.SmallStep.html#12482" class="Bound">prf</a>
        <a id="12597" class="Symbol">;</a> <a id="12599" href="Peras.Chain.html#754" class="Field">blockHash</a> <a id="12609" class="Symbol">=</a> <a id="12611" href="Peras.SmallStep.html#12490" class="Bound">hb</a>
        <a id="12622" class="Symbol">;</a> <a id="12624" href="Peras.Chain.html#787" class="Field">signature</a> <a id="12634" class="Symbol">=</a> <a id="12636" href="Peras.SmallStep.html#12486" class="Bound">sig</a>
        <a id="12648" class="Symbol">}</a>
</pre>
<p>A party can vote for a block, if * the current slot is the first slot
in a voting round * the party is a member of the voting committee * the
chain is not in a cool-down phase</p>
Voting updates the party’s local state and for all other parties a
message is added to be consumed immediately.
<pre class="Agda">    <a id="12961" class="Keyword">infix</a> <a id="12967" class="Number">2</a> <a id="12969" href="Peras.SmallStep.html#12985" class="Datatype Operator">_⊢_⇉_</a>

    <a id="12980" class="Keyword">data</a> <a id="12985" href="Peras.SmallStep.html#12985" class="Datatype Operator">_⊢_⇉_</a> <a id="12991" class="Symbol">:</a> <a id="12993" class="Symbol">{</a><a id="12994" href="Peras.SmallStep.html#12994" class="Bound">p</a> <a id="12996" class="Symbol">:</a> <a id="12998" href="Peras.Block.html#450" class="Function">PartyId</a><a id="13005" class="Symbol">}</a> <a id="13007" class="Symbol">→</a> <a id="13009" href="Peras.Block.html#1014" class="Datatype">Honesty</a> <a id="13017" href="Peras.SmallStep.html#12994" class="Bound">p</a> <a id="13019" class="Symbol">→</a> <a id="13021" href="Peras.SmallStep.html#9503" class="Record">State</a> <a id="13027" class="Symbol">→</a> <a id="13029" href="Peras.SmallStep.html#9503" class="Record">State</a> <a id="13035" class="Symbol">→</a> <a id="13037" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="13041" class="Keyword">where</a>

      <a id="13054" href="Peras.SmallStep.html#13054" class="InductiveConstructor">honest</a> <a id="13061" class="Symbol">:</a> <a id="13063" class="Symbol">∀</a> <a id="13065" class="Symbol">{</a><a id="13066" href="Peras.SmallStep.html#13066" class="Bound">p</a><a id="13067" class="Symbol">}</a> <a id="13069" class="Symbol">{</a><a id="13070" href="Peras.SmallStep.html#13070" class="Bound">t</a><a id="13071" class="Symbol">}</a> <a id="13073" class="Symbol">{</a><a id="13074" href="Peras.SmallStep.html#13074" class="Bound">M</a><a id="13075" class="Symbol">}</a> <a id="13077" class="Symbol">{</a><a id="13078" href="Peras.SmallStep.html#13078" class="Bound">π</a><a id="13079" class="Symbol">}</a> <a id="13081" class="Symbol">{</a><a id="13082" href="Peras.SmallStep.html#13082" class="Bound">σ</a><a id="13083" class="Symbol">}</a> <a id="13085" class="Symbol">{</a><a id="13086" href="Peras.SmallStep.html#13086" class="Bound">b</a><a id="13087" class="Symbol">}</a>
        <a id="13097" class="Symbol">→</a> <a id="13099" class="Keyword">let</a>
            <a id="13115" class="Keyword">open</a> <a id="13120" href="Peras.SmallStep.html#9503" class="Module">State</a>
            <a id="13138" href="Peras.SmallStep.html#13138" class="Bound">s</a> <a id="13140" class="Symbol">=</a> <a id="13142" href="Peras.SmallStep.html#9571" class="Field">clock</a> <a id="13148" href="Peras.SmallStep.html#13074" class="Bound">M</a>
            <a id="13162" href="Peras.SmallStep.html#13162" class="Bound">r</a> <a id="13164" class="Symbol">=</a> <a id="13166" href="Peras.Chain.html#3637" class="Function">v-round</a> <a id="13174" href="Peras.SmallStep.html#13138" class="Bound">s</a>
            <a id="13188" href="Peras.SmallStep.html#13188" class="Bound">v</a> <a id="13190" class="Symbol">=</a> <a id="13192" href="Peras.SmallStep.html#12379" class="Function">createVote</a> <a id="13203" href="Peras.SmallStep.html#13138" class="Bound">s</a> <a id="13205" href="Peras.SmallStep.html#13066" class="Bound">p</a> <a id="13207" href="Peras.SmallStep.html#13078" class="Bound">π</a> <a id="13209" href="Peras.SmallStep.html#13082" class="Bound">σ</a> <a id="13211" href="Peras.SmallStep.html#13086" class="Bound">b</a>
          <a id="13223" class="Keyword">in</a>
          <a id="13236" href="Peras.SmallStep.html#7500" class="Function">BlockSelection</a> <a id="13251" href="Peras.SmallStep.html#13138" class="Bound">s</a> <a id="13253" href="Peras.SmallStep.html#13070" class="Bound">t</a> <a id="13255" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="13257" href="Peras.SmallStep.html#13086" class="Bound">b</a>
        <a id="13267" class="Symbol">→</a> <a id="13269" href="Peras.SmallStep.html#9598" class="Field">blockTrees</a> <a id="13280" href="Peras.SmallStep.html#13074" class="Bound">M</a> <a id="13282" href="Prelude.AssocList.html#847" class="Function Operator">⁉</a> <a id="13284" href="Peras.SmallStep.html#13066" class="Bound">p</a> <a id="13286" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="13288" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="13293" href="Peras.SmallStep.html#13070" class="Bound">t</a>
        <a id="13303" class="Symbol">→</a> <a id="13305" class="Symbol">(</a><a id="13306" href="Peras.SmallStep.html#13306" class="Bound">sig</a> <a id="13310" class="Symbol">:</a> <a id="13312" href="Peras.Chain.html#1603" class="Field">IsVoteSignature</a> <a id="13328" href="Peras.SmallStep.html#13188" class="Bound">v</a> <a id="13330" href="Peras.SmallStep.html#13082" class="Bound">σ</a><a id="13331" class="Symbol">)</a>
        <a id="13341" class="Symbol">→</a> <a id="13343" href="Peras.Chain.html#3447" class="Function">StartOfRound</a> <a id="13356" href="Peras.SmallStep.html#13138" class="Bound">s</a> <a id="13358" href="Peras.SmallStep.html#13162" class="Bound">r</a>
        <a id="13368" class="Symbol">→</a> <a id="13370" class="Symbol">(</a><a id="13371" href="Peras.SmallStep.html#13371" class="Bound">mem</a> <a id="13375" class="Symbol">:</a> <a id="13377" href="Peras.Chain.html#1486" class="Field">IsCommitteeMember</a> <a id="13395" href="Peras.SmallStep.html#13066" class="Bound">p</a> <a id="13397" href="Peras.SmallStep.html#13162" class="Bound">r</a> <a id="13399" href="Peras.SmallStep.html#13078" class="Bound">π</a><a id="13400" class="Symbol">)</a>
        <a id="13410" class="Symbol">→</a> <a id="13412" href="Peras.SmallStep.html#9059" class="Function">VotingRule</a> <a id="13423" href="Peras.SmallStep.html#13138" class="Bound">s</a> <a id="13425" href="Peras.SmallStep.html#13070" class="Bound">t</a>
        <a id="13435" class="Symbol">→</a> <a id="13437" class="Symbol">(</a><a id="13438" href="Peras.SmallStep.html#13438" class="Bound">fᵈ</a> <a id="13441" class="Symbol">:</a> <a id="13443" href="Peras.Block.html#450" class="Function">PartyId</a> <a id="13451" class="Symbol">→</a> <a id="13453" href="Peras.SmallStep.html#2439" class="Function">Delay</a><a id="13458" class="Symbol">)</a>
          <a id="13470" class="Comment">----------------------------------------------</a>
        <a id="13525" class="Symbol">→</a> <a id="13527" href="Peras.Block.html#1047" class="InductiveConstructor">Honest</a> <a id="13534" class="Symbol">{</a><a id="13535" href="Peras.SmallStep.html#13066" class="Bound">p</a><a id="13536" class="Symbol">}</a> <a id="13538" href="Peras.SmallStep.html#12985" class="Datatype Operator">⊢</a>
            <a id="13552" href="Peras.SmallStep.html#13074" class="Bound">M</a> <a id="13554" href="Peras.SmallStep.html#12985" class="Datatype Operator">⇉</a> <a id="13556" href="Peras.SmallStep.html#10989" class="Function Operator">delay</a> <a id="13562" href="Peras.SmallStep.html#2335" class="InductiveConstructor">VoteMsg</a> <a id="13570" class="Symbol">(</a><a id="13571" href="Peras.SmallStep.html#13371" class="Bound">mem</a> <a id="13575" href="Haskell.Prim.Tuple.html#211" class="InductiveConstructor Operator">,</a> <a id="13577" href="Peras.SmallStep.html#13306" class="Bound">sig</a><a id="13580" class="Symbol">)</a> <a id="13582" href="Peras.SmallStep.html#10989" class="Function Operator">by</a> <a id="13585" href="Peras.SmallStep.html#13438" class="Bound">fᵈ</a>
                 <a id="13605" href="Peras.SmallStep.html#10989" class="Function Operator">update</a> <a id="13612" href="Peras.SmallStep.html#13074" class="Bound">M</a>
</pre>
<p>Rather than creating a delayed vote, an adversary can honestly create
it and delay the message.</p>
<h2 id="block-creation">Block creation</h2>
<p>Certificates are conditionally added to a block. The following
function determines if there needs to be a certificate provided for a
given voting round and a local block-tree. The conditions are as
follows</p>
<ol type="a">
<li>There is no certificate from 2 rounds ago in certs</li>
<li>The last seen certificate is not expired</li>
<li>The last seen certificate is from a later round than the last
certificate on chain</li>
</ol>
<pre class="Agda">    <a id="14141" href="Peras.SmallStep.html#14141" class="Function">needCert</a> <a id="14150" class="Symbol">:</a> <a id="14152" href="Peras.Numbering.html#1669" class="Record">RoundNumber</a> <a id="14164" class="Symbol">→</a> <a id="14166" href="Peras.SmallStep.html#6309" class="Bound">T</a> <a id="14168" class="Symbol">→</a> <a id="14170" href="Haskell.Prim.Maybe.html#101" class="Datatype">Maybe</a> <a id="14176" href="Peras.Block.html#1750" class="Record">Certificate</a>
    <a id="14192" href="Peras.SmallStep.html#14141" class="Function">needCert</a> <a id="14201" class="Symbol">(</a><a id="14202" href="Peras.Numbering.html#1707" class="InductiveConstructor">MkRoundNumber</a> <a id="14216" href="Peras.SmallStep.html#14216" class="Bound">r</a><a id="14217" class="Symbol">)</a> <a id="14219" href="Peras.SmallStep.html#14219" class="Bound">t</a> <a id="14221" class="Symbol">=</a>
      <a id="14229" class="Keyword">let</a>
        <a id="14241" href="Peras.SmallStep.html#14241" class="Bound">cert⋆</a> <a id="14247" class="Symbol">=</a> <a id="14249" href="Peras.SmallStep.html#5497" class="Function">latestCertOnChain</a> <a id="14267" href="Peras.SmallStep.html#14219" class="Bound">t</a>
        <a id="14277" href="Peras.SmallStep.html#14277" class="Bound">cert′</a> <a id="14283" class="Symbol">=</a> <a id="14285" href="Peras.SmallStep.html#5625" class="Function">latestCertSeen</a> <a id="14300" href="Peras.SmallStep.html#14219" class="Bound">t</a>
      <a id="14308" class="Keyword">in</a>
        <a id="14319" href="Haskell.Prim.html#1713" class="Function Operator">if</a> <a id="14322" href="Haskell.Prim.Bool.html#273" class="Function">not</a> <a id="14326" class="Symbol">(</a><a id="14327" href="Haskell.Prim.Foldable.html#604" class="Field">any</a> <a id="14331" class="Symbol">(λ</a> <a id="14334" href="Peras.SmallStep.html#14334" class="Bound">c</a> <a id="14336" class="Symbol">→</a> <a id="14338" href="Peras.Block.html#1912" class="Function">roundNumber</a> <a id="14350" href="Peras.SmallStep.html#14334" class="Bound">c</a> <a id="14352" href="Haskell.Prim.Num.html#547" class="Field Operator">+</a> <a id="14354" class="Number">2</a> <a id="14356" href="Haskell.Prim.Eq.html#453" class="Field Operator">==</a> <a id="14359" href="Peras.SmallStep.html#14216" class="Bound">r</a><a id="14360" class="Symbol">)</a> <a id="14362" class="Symbol">(</a><a id="14363" href="Peras.SmallStep.html#5324" class="Function">certs</a> <a id="14369" href="Peras.SmallStep.html#14219" class="Bound">t</a><a id="14370" class="Symbol">))</a> <a id="14373" class="Comment">-- (a)</a>
           <a id="14391" href="Haskell.Prim.Bool.html#138" class="Function Operator">&amp;&amp;</a> <a id="14394" class="Symbol">(</a><a id="14395" href="Peras.SmallStep.html#14216" class="Bound">r</a> <a id="14397" href="Haskell.Prim.Ord.html#1144" class="Field Operator">&lt;=</a> <a id="14400" href="Peras.Params.html#249" class="Field">A</a> <a id="14402" href="Haskell.Prim.Num.html#547" class="Field Operator">+</a> <a id="14404" href="Peras.Block.html#1912" class="Function">roundNumber</a> <a id="14416" href="Peras.SmallStep.html#14277" class="Bound">cert′</a><a id="14421" class="Symbol">)</a>                    <a id="14442" class="Comment">-- (b)</a>
           <a id="14460" href="Haskell.Prim.Bool.html#138" class="Function Operator">&amp;&amp;</a> <a id="14463" class="Symbol">(</a><a id="14464" href="Peras.Block.html#1912" class="Function">roundNumber</a> <a id="14476" href="Peras.SmallStep.html#14241" class="Bound">cert⋆</a> <a id="14482" href="Haskell.Prim.Ord.html#1144" class="Field Operator">&lt;=</a> <a id="14485" href="Peras.Block.html#1912" class="Function">roundNumber</a> <a id="14497" href="Peras.SmallStep.html#14277" class="Bound">cert′</a><a id="14502" class="Symbol">)</a>        <a id="14511" class="Comment">-- (c)</a>
        <a id="14526" href="Haskell.Prim.html#1713" class="Function Operator">then</a> <a id="14531" href="Haskell.Prim.Maybe.html#162" class="InductiveConstructor">Just</a> <a id="14536" href="Peras.SmallStep.html#14277" class="Bound">cert′</a>
        <a id="14550" href="Haskell.Prim.html#1713" class="Function Operator">else</a> <a id="14555" href="Haskell.Prim.Maybe.html#142" class="InductiveConstructor">Nothing</a>
</pre>
Helper function for creating a block
<pre class="Agda">    <a id="14616" href="Peras.SmallStep.html#14616" class="Function">createBlock</a> <a id="14628" class="Symbol">:</a> <a id="14630" href="Peras.Numbering.html#742" class="Record">SlotNumber</a> <a id="14641" class="Symbol">→</a> <a id="14643" href="Peras.Block.html#450" class="Function">PartyId</a> <a id="14651" class="Symbol">→</a> <a id="14653" href="Peras.Crypto.html#2593" class="Record">LeadershipProof</a> <a id="14669" class="Symbol">→</a> <a id="14671" href="Peras.Crypto.html#3115" class="Record">Signature</a> <a id="14681" class="Symbol">→</a> <a id="14683" href="Peras.SmallStep.html#6309" class="Bound">T</a> <a id="14685" class="Symbol">→</a> <a id="14687" href="Peras.Block.html#1708" class="Record">Block</a>
    <a id="14697" href="Peras.SmallStep.html#14616" class="Function">createBlock</a> <a id="14709" href="Peras.SmallStep.html#14709" class="Bound">s</a> <a id="14711" href="Peras.SmallStep.html#14711" class="Bound">p</a> <a id="14713" href="Peras.SmallStep.html#14713" class="Bound">π</a> <a id="14715" href="Peras.SmallStep.html#14715" class="Bound">σ</a> <a id="14717" href="Peras.SmallStep.html#14717" class="Bound">t</a> <a id="14719" class="Symbol">=</a>
      <a id="14727" class="Keyword">record</a>
        <a id="14742" class="Symbol">{</a> <a id="14744" href="Peras.Block.html#2146" class="Field">slotNumber</a> <a id="14755" class="Symbol">=</a> <a id="14757" href="Peras.SmallStep.html#14709" class="Bound">s</a>
        <a id="14767" class="Symbol">;</a> <a id="14769" href="Peras.Block.html#2178" class="Field">creatorId</a> <a id="14779" class="Symbol">=</a> <a id="14781" href="Peras.SmallStep.html#14711" class="Bound">p</a>
        <a id="14791" class="Symbol">;</a> <a id="14793" href="Peras.Block.html#2206" class="Field">parentBlock</a> <a id="14805" class="Symbol">=</a>
            <a id="14819" class="Keyword">let</a> <a id="14823" class="Keyword">open</a> <a id="14828" href="Peras.SmallStep.html#2989" class="Module">IsTreeType</a>
            <a id="14851" class="Keyword">in</a> <a id="14854" href="Peras.Block.html#3843" class="Function">tipHash</a> <a id="14862" class="Symbol">(</a><a id="14863" href="Peras.SmallStep.html#5212" class="Function">preferredChain</a> <a id="14878" href="Peras.SmallStep.html#14717" class="Bound">t</a><a id="14879" class="Symbol">)</a>
        <a id="14889" class="Symbol">;</a> <a id="14891" href="Peras.Block.html#2239" class="Field">certificate</a> <a id="14903" class="Symbol">=</a>
            <a id="14917" class="Keyword">let</a> <a id="14921" href="Peras.SmallStep.html#14921" class="Bound">r</a> <a id="14923" class="Symbol">=</a> <a id="14925" href="Peras.Chain.html#3637" class="Function">v-round</a> <a id="14933" href="Peras.SmallStep.html#14709" class="Bound">s</a>
            <a id="14947" class="Keyword">in</a> <a id="14950" href="Peras.SmallStep.html#14141" class="Function">needCert</a> <a id="14959" href="Peras.SmallStep.html#14921" class="Bound">r</a> <a id="14961" href="Peras.SmallStep.html#14717" class="Bound">t</a>
        <a id="14971" class="Symbol">;</a> <a id="14973" href="Peras.Block.html#2279" class="Field">leadershipProof</a> <a id="14989" class="Symbol">=</a> <a id="14991" href="Peras.SmallStep.html#14713" class="Bound">π</a>
        <a id="15001" class="Symbol">;</a> <a id="15003" href="Peras.Block.html#2351" class="Field">bodyHash</a> <a id="15012" class="Symbol">=</a>
            <a id="15026" class="Keyword">let</a> <a id="15030" href="Peras.SmallStep.html#15030" class="Bound">txs</a> <a id="15034" class="Symbol">=</a> <a id="15036" href="Peras.SmallStep.html#6400" class="Bound">txSelection</a> <a id="15048" href="Peras.SmallStep.html#14709" class="Bound">s</a> <a id="15050" href="Peras.SmallStep.html#14711" class="Bound">p</a>
            <a id="15064" class="Keyword">in</a> <a id="15067" href="Peras.Block.html#2514" class="Field">blockHash</a>
                 <a id="15094" class="Keyword">record</a>
                   <a id="15120" class="Symbol">{</a> <a id="15122" href="Peras.Block.html#2514" class="Field">blockHash</a> <a id="15132" class="Symbol">=</a> <a id="15134" href="Peras.Crypto.html#2033" class="Field">hash</a> <a id="15139" href="Peras.SmallStep.html#15030" class="Bound">txs</a>
                   <a id="15162" class="Symbol">;</a> <a id="15164" href="Peras.Block.html#2547" class="Field">payload</a> <a id="15172" class="Symbol">=</a> <a id="15174" href="Peras.SmallStep.html#15030" class="Bound">txs</a>
                   <a id="15197" class="Symbol">}</a>
        <a id="15207" class="Symbol">;</a> <a id="15209" href="Peras.Block.html#2321" class="Field">signature</a> <a id="15219" class="Symbol">=</a> <a id="15221" href="Peras.SmallStep.html#14715" class="Bound">σ</a>
        <a id="15231" class="Symbol">}</a>
</pre>
<p>A party can create a new block by adding it to the local block tree
and diffuse the block creation messages to the other parties. Block
creation is possible, if as in <em>Praos</em></p>
<ul>
<li>the block signature is correct</li>
<li>the party is the slot leader</li>
</ul>
Block creation updates the party’s local state and for all other parties
a message is added to the message buffer
<pre class="Agda">    <a id="15608" class="Keyword">infix</a> <a id="15614" class="Number">2</a> <a id="15616" href="Peras.SmallStep.html#15632" class="Datatype Operator">_⊢_↷_</a>

    <a id="15627" class="Keyword">data</a> <a id="15632" href="Peras.SmallStep.html#15632" class="Datatype Operator">_⊢_↷_</a> <a id="15638" class="Symbol">:</a> <a id="15640" class="Symbol">{</a><a id="15641" href="Peras.SmallStep.html#15641" class="Bound">p</a> <a id="15643" class="Symbol">:</a> <a id="15645" href="Peras.Block.html#450" class="Function">PartyId</a><a id="15652" class="Symbol">}</a> <a id="15654" class="Symbol">→</a> <a id="15656" href="Peras.Block.html#1014" class="Datatype">Honesty</a> <a id="15664" href="Peras.SmallStep.html#15641" class="Bound">p</a> <a id="15666" class="Symbol">→</a> <a id="15668" href="Peras.SmallStep.html#9503" class="Record">State</a> <a id="15674" class="Symbol">→</a> <a id="15676" href="Peras.SmallStep.html#9503" class="Record">State</a> <a id="15682" class="Symbol">→</a> <a id="15684" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="15688" class="Keyword">where</a>

      <a id="15701" href="Peras.SmallStep.html#15701" class="InductiveConstructor">honest</a> <a id="15708" class="Symbol">:</a> <a id="15710" class="Symbol">∀</a> <a id="15712" class="Symbol">{</a><a id="15713" href="Peras.SmallStep.html#15713" class="Bound">p</a><a id="15714" class="Symbol">}</a> <a id="15716" class="Symbol">{</a><a id="15717" href="Peras.SmallStep.html#15717" class="Bound">t</a><a id="15718" class="Symbol">}</a> <a id="15720" class="Symbol">{</a><a id="15721" href="Peras.SmallStep.html#15721" class="Bound">M</a><a id="15722" class="Symbol">}</a> <a id="15724" class="Symbol">{</a><a id="15725" href="Peras.SmallStep.html#15725" class="Bound">π</a><a id="15726" class="Symbol">}</a> <a id="15728" class="Symbol">{</a><a id="15729" href="Peras.SmallStep.html#15729" class="Bound">σ</a><a id="15730" class="Symbol">}</a>
        <a id="15740" class="Symbol">→</a> <a id="15742" class="Keyword">let</a>
            <a id="15758" class="Keyword">open</a> <a id="15763" href="Peras.SmallStep.html#9503" class="Module">State</a>
            <a id="15781" href="Peras.SmallStep.html#15781" class="Bound">s</a> <a id="15783" class="Symbol">=</a> <a id="15785" href="Peras.SmallStep.html#9571" class="Field">clock</a> <a id="15791" href="Peras.SmallStep.html#15721" class="Bound">M</a>
            <a id="15805" href="Peras.SmallStep.html#15805" class="Bound">b</a> <a id="15807" class="Symbol">=</a> <a id="15809" href="Peras.SmallStep.html#14616" class="Function">createBlock</a> <a id="15821" href="Peras.SmallStep.html#15781" class="Bound">s</a> <a id="15823" href="Peras.SmallStep.html#15713" class="Bound">p</a> <a id="15825" href="Peras.SmallStep.html#15725" class="Bound">π</a> <a id="15827" href="Peras.SmallStep.html#15729" class="Bound">σ</a> <a id="15829" href="Peras.SmallStep.html#15717" class="Bound">t</a>
            <a id="15843" href="Peras.SmallStep.html#15843" class="Bound">pref</a> <a id="15848" class="Symbol">=</a> <a id="15850" href="Peras.SmallStep.html#5212" class="Function">preferredChain</a> <a id="15865" href="Peras.SmallStep.html#15717" class="Bound">t</a>
          <a id="15877" class="Keyword">in</a>
          <a id="15890" href="Peras.SmallStep.html#9598" class="Field">blockTrees</a> <a id="15901" href="Peras.SmallStep.html#15721" class="Bound">M</a> <a id="15903" href="Prelude.AssocList.html#847" class="Function Operator">⁉</a> <a id="15905" href="Peras.SmallStep.html#15713" class="Bound">p</a> <a id="15907" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="15909" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="15914" href="Peras.SmallStep.html#15717" class="Bound">t</a>
        <a id="15924" class="Symbol">→</a> <a id="15926" class="Symbol">(</a><a id="15927" href="Peras.SmallStep.html#15927" class="Bound">vc</a> <a id="15930" class="Symbol">:</a> <a id="15932" href="Peras.Chain.html#4237" class="Datatype">ValidChain</a> <a id="15943" class="Symbol">(</a><a id="15944" href="Peras.SmallStep.html#15805" class="Bound">b</a> <a id="15946" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="15948" href="Peras.SmallStep.html#15843" class="Bound">pref</a><a id="15952" class="Symbol">))</a>
        <a id="15963" class="Symbol">→</a> <a id="15965" class="Symbol">(</a><a id="15966" href="Peras.SmallStep.html#15966" class="Bound">fᵈ</a> <a id="15969" class="Symbol">:</a> <a id="15971" href="Peras.Block.html#450" class="Function">PartyId</a> <a id="15979" class="Symbol">→</a> <a id="15981" href="Peras.SmallStep.html#2439" class="Function">Delay</a><a id="15986" class="Symbol">)</a>
          <a id="15998" class="Comment">----------------------------</a>
        <a id="16035" class="Symbol">→</a> <a id="16037" href="Peras.Block.html#1047" class="InductiveConstructor">Honest</a> <a id="16044" class="Symbol">{</a><a id="16045" href="Peras.SmallStep.html#15713" class="Bound">p</a><a id="16046" class="Symbol">}</a> <a id="16048" href="Peras.SmallStep.html#15632" class="Datatype Operator">⊢</a>
            <a id="16062" href="Peras.SmallStep.html#15721" class="Bound">M</a> <a id="16064" href="Peras.SmallStep.html#15632" class="Datatype Operator">↷</a> <a id="16066" href="Peras.SmallStep.html#10989" class="Function Operator">delay</a> <a id="16072" href="Peras.SmallStep.html#2283" class="InductiveConstructor">ChainMsg</a> <a id="16081" href="Peras.SmallStep.html#15927" class="Bound">vc</a> <a id="16084" href="Peras.SmallStep.html#10989" class="Function Operator">by</a> <a id="16087" href="Peras.SmallStep.html#15966" class="Bound">fᵈ</a>
                 <a id="16107" href="Peras.SmallStep.html#10989" class="Function Operator">update</a> <a id="16114" href="Peras.SmallStep.html#15721" class="Bound">M</a>
</pre>
<h2 id="small-step-semantics-1">Small-step semantics</h2>
The small-step semantics describe the evolution of the global state.
<pre class="Agda">    <a id="16226" class="Keyword">variable</a>
      <a id="16241" href="Peras.SmallStep.html#16241" class="Generalizable">M</a> <a id="16243" href="Peras.SmallStep.html#16243" class="Generalizable">N</a> <a id="16245" href="Peras.SmallStep.html#16245" class="Generalizable">O</a> <a id="16247" class="Symbol">:</a> <a id="16249" href="Peras.SmallStep.html#9503" class="Record">State</a>
      <a id="16261" href="Peras.SmallStep.html#16261" class="Generalizable">p</a> <a id="16263" class="Symbol">:</a> <a id="16265" href="Peras.Block.html#450" class="Function">PartyId</a>
      <a id="16279" href="Peras.SmallStep.html#16279" class="Generalizable">h</a> <a id="16281" class="Symbol">:</a> <a id="16283" href="Peras.Block.html#1014" class="Datatype">Honesty</a> <a id="16291" href="Peras.SmallStep.html#16261" class="Generalizable">p</a>
</pre>
<p>The relation allows</p>
<ul>
<li>Fetching messages at the beginning of each slot</li>
<li>Block creation</li>
<li>Voting</li>
<li>Transitioning to next slot in the same voting round</li>
<li>Transitioning to next slot in a new voting round</li>
</ul>
Note, when transitioning to the next slot we need to distinguish whether
the next slot is in the same or a new voting round. This is necessary in
order to detect adversarial behaviour with respect to voting
(adversarialy not voting in a voting round)
<pre class="Agda">    <a id="16763" class="Keyword">data</a> <a id="16768" href="Peras.SmallStep.html#16768" class="Datatype Operator">_↝_</a> <a id="16772" class="Symbol">:</a> <a id="16774" href="Peras.SmallStep.html#9503" class="Record">State</a> <a id="16780" class="Symbol">→</a> <a id="16782" href="Peras.SmallStep.html#9503" class="Record">State</a> <a id="16788" class="Symbol">→</a> <a id="16790" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="16794" class="Keyword">where</a>

      <a id="16807" href="Peras.SmallStep.html#16807" class="InductiveConstructor">Fetch</a> <a id="16813" class="Symbol">:</a> <a id="16815" class="Symbol">∀</a> <a id="16817" class="Symbol">{</a><a id="16818" href="Peras.SmallStep.html#16818" class="Bound">m</a><a id="16819" class="Symbol">}</a> <a id="16821" class="Symbol">→</a>
        <a id="16831" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="16833" href="Peras.SmallStep.html#16279" class="Generalizable">h</a> <a id="16835" href="Peras.SmallStep.html#11370" class="Datatype Operator">⊢</a> <a id="16837" href="Peras.SmallStep.html#16241" class="Generalizable">M</a> <a id="16839" href="Peras.SmallStep.html#11370" class="Datatype Operator">[</a> <a id="16841" href="Peras.SmallStep.html#16818" class="Bound">m</a> <a id="16843" href="Peras.SmallStep.html#11370" class="Datatype Operator">]⇀</a> <a id="16846" href="Peras.SmallStep.html#16243" class="Generalizable">N</a>
          <a id="16858" href="Prelude.InferenceRules.html#14206" class="Function Operator">──────────────</a>
          <a id="16883" href="Peras.SmallStep.html#16241" class="Generalizable">M</a> <a id="16885" href="Peras.SmallStep.html#16768" class="Datatype Operator">↝</a> <a id="16887" href="Peras.SmallStep.html#16243" class="Generalizable">N</a>

      <a id="16896" href="Peras.SmallStep.html#16896" class="InductiveConstructor">CreateVote</a> <a id="16907" class="Symbol">:</a>
        <a id="16917" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="16919" href="Peras.SmallStep.html#10075" class="Function">Fetched</a> <a id="16927" href="Peras.SmallStep.html#16241" class="Generalizable">M</a>
        <a id="16937" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="16939" href="Peras.SmallStep.html#16279" class="Generalizable">h</a> <a id="16941" href="Peras.SmallStep.html#12985" class="Datatype Operator">⊢</a> <a id="16943" href="Peras.SmallStep.html#16241" class="Generalizable">M</a> <a id="16945" href="Peras.SmallStep.html#12985" class="Datatype Operator">⇉</a> <a id="16947" href="Peras.SmallStep.html#16243" class="Generalizable">N</a>
          <a id="16959" href="Prelude.InferenceRules.html#14291" class="Function Operator">─────────</a>
          <a id="16979" href="Peras.SmallStep.html#16241" class="Generalizable">M</a> <a id="16981" href="Peras.SmallStep.html#16768" class="Datatype Operator">↝</a> <a id="16983" href="Peras.SmallStep.html#16243" class="Generalizable">N</a>

      <a id="16992" href="Peras.SmallStep.html#16992" class="InductiveConstructor">CreateBlock</a> <a id="17004" class="Symbol">:</a>
        <a id="17014" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="17016" href="Peras.SmallStep.html#10075" class="Function">Fetched</a> <a id="17024" href="Peras.SmallStep.html#16241" class="Generalizable">M</a>
        <a id="17034" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="17036" href="Peras.SmallStep.html#16279" class="Generalizable">h</a> <a id="17038" href="Peras.SmallStep.html#15632" class="Datatype Operator">⊢</a> <a id="17040" href="Peras.SmallStep.html#16241" class="Generalizable">M</a> <a id="17042" href="Peras.SmallStep.html#15632" class="Datatype Operator">↷</a> <a id="17044" href="Peras.SmallStep.html#16243" class="Generalizable">N</a>
          <a id="17056" href="Prelude.InferenceRules.html#14291" class="Function Operator">─────────</a>
          <a id="17076" href="Peras.SmallStep.html#16241" class="Generalizable">M</a> <a id="17078" href="Peras.SmallStep.html#16768" class="Datatype Operator">↝</a> <a id="17080" href="Peras.SmallStep.html#16243" class="Generalizable">N</a>

      <a id="17089" href="Peras.SmallStep.html#17089" class="InductiveConstructor">NextSlot</a> <a id="17098" class="Symbol">:</a>
        <a id="17108" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="17110" href="Peras.SmallStep.html#10075" class="Function">Fetched</a> <a id="17118" href="Peras.SmallStep.html#16241" class="Generalizable">M</a>
          <a id="17130" href="Prelude.InferenceRules.html#14276" class="Function Operator">──────────</a>
          <a id="17151" href="Peras.SmallStep.html#16241" class="Generalizable">M</a> <a id="17153" href="Peras.SmallStep.html#16768" class="Datatype Operator">↝</a> <a id="17155" href="Peras.SmallStep.html#10313" class="Function">tick</a> <a id="17160" href="Peras.SmallStep.html#16241" class="Generalizable">M</a>
</pre>
<h4 id="reflexive-transitive-closure">Reflexive, transitive closure</h4>
List-like structure for defining execution paths.
<pre class="Agda">    <a id="17263" class="Keyword">infix</a>  <a id="17270" class="Number">2</a> <a id="17272" href="Peras.SmallStep.html#17319" class="Datatype Operator">_↝⋆_</a>
    <a id="17281" class="Keyword">infixr</a> <a id="17288" class="Number">2</a> <a id="17290" href="Peras.SmallStep.html#17375" class="InductiveConstructor Operator">_↣_</a>
    <a id="17298" class="Keyword">infix</a>  <a id="17305" class="Number">3</a> <a id="17307" href="Peras.SmallStep.html#17358" class="InductiveConstructor">∎</a>

    <a id="17314" class="Keyword">data</a> <a id="17319" href="Peras.SmallStep.html#17319" class="Datatype Operator">_↝⋆_</a> <a id="17324" class="Symbol">:</a> <a id="17326" href="Peras.SmallStep.html#9503" class="Record">State</a> <a id="17332" class="Symbol">→</a> <a id="17334" href="Peras.SmallStep.html#9503" class="Record">State</a> <a id="17340" class="Symbol">→</a> <a id="17342" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="17346" class="Keyword">where</a>
      <a id="17358" href="Peras.SmallStep.html#17358" class="InductiveConstructor">∎</a> <a id="17360" class="Symbol">:</a> <a id="17362" href="Peras.SmallStep.html#16241" class="Generalizable">M</a> <a id="17364" href="Peras.SmallStep.html#17319" class="Datatype Operator">↝⋆</a> <a id="17367" href="Peras.SmallStep.html#16241" class="Generalizable">M</a>
      <a id="17375" href="Peras.SmallStep.html#17375" class="InductiveConstructor Operator">_↣_</a> <a id="17379" class="Symbol">:</a> <a id="17381" href="Peras.SmallStep.html#16241" class="Generalizable">M</a> <a id="17383" href="Peras.SmallStep.html#16768" class="Datatype Operator">↝</a> <a id="17385" href="Peras.SmallStep.html#16243" class="Generalizable">N</a> <a id="17387" class="Symbol">→</a> <a id="17389" href="Peras.SmallStep.html#16243" class="Generalizable">N</a> <a id="17391" href="Peras.SmallStep.html#17319" class="Datatype Operator">↝⋆</a> <a id="17394" href="Peras.SmallStep.html#16245" class="Generalizable">O</a> <a id="17396" class="Symbol">→</a> <a id="17398" href="Peras.SmallStep.html#16241" class="Generalizable">M</a> <a id="17400" href="Peras.SmallStep.html#17319" class="Datatype Operator">↝⋆</a> <a id="17403" href="Peras.SmallStep.html#16245" class="Generalizable">O</a>
</pre>
<pre class="Agda">    <a id="17421" class="Keyword">infixr</a> <a id="17428" class="Number">2</a> <a id="17430" href="Peras.SmallStep.html#17441" class="Function Operator">_++&#39;_</a>

    <a id="17441" href="Peras.SmallStep.html#17441" class="Function Operator">_++&#39;_</a> <a id="17447" class="Symbol">:</a>
        <a id="17457" href="Peras.SmallStep.html#16241" class="Generalizable">M</a> <a id="17459" href="Peras.SmallStep.html#17319" class="Datatype Operator">↝⋆</a> <a id="17462" href="Peras.SmallStep.html#16243" class="Generalizable">N</a>
      <a id="17470" class="Symbol">→</a> <a id="17472" href="Peras.SmallStep.html#16243" class="Generalizable">N</a> <a id="17474" href="Peras.SmallStep.html#17319" class="Datatype Operator">↝⋆</a> <a id="17477" href="Peras.SmallStep.html#16245" class="Generalizable">O</a>
      <a id="17485" class="Symbol">→</a> <a id="17487" href="Peras.SmallStep.html#16241" class="Generalizable">M</a> <a id="17489" href="Peras.SmallStep.html#17319" class="Datatype Operator">↝⋆</a> <a id="17492" href="Peras.SmallStep.html#16245" class="Generalizable">O</a>
    <a id="17498" href="Peras.SmallStep.html#17358" class="InductiveConstructor">∎</a> <a id="17500" href="Peras.SmallStep.html#17441" class="Function Operator">++&#39;</a> <a id="17504" href="Peras.SmallStep.html#17504" class="Bound">M↝⋆O</a> <a id="17509" class="Symbol">=</a> <a id="17511" href="Peras.SmallStep.html#17504" class="Bound">M↝⋆O</a>
    <a id="17520" class="Symbol">(</a><a id="17521" href="Peras.SmallStep.html#17521" class="Bound">M↝M₁</a> <a id="17526" href="Peras.SmallStep.html#17375" class="InductiveConstructor Operator">↣</a> <a id="17528" href="Peras.SmallStep.html#17528" class="Bound">M₁↝⋆N</a><a id="17533" class="Symbol">)</a> <a id="17535" href="Peras.SmallStep.html#17441" class="Function Operator">++&#39;</a> <a id="17539" href="Peras.SmallStep.html#17539" class="Bound">N↝⋆O</a> <a id="17544" class="Symbol">=</a> <a id="17546" href="Peras.SmallStep.html#17521" class="Bound">M↝M₁</a> <a id="17551" href="Peras.SmallStep.html#17375" class="InductiveConstructor Operator">↣</a> <a id="17553" href="Peras.SmallStep.html#17528" class="Bound">M₁↝⋆N</a> <a id="17559" href="Peras.SmallStep.html#17441" class="Function Operator">++&#39;</a> <a id="17563" href="Peras.SmallStep.html#17539" class="Bound">N↝⋆O</a>
</pre>
<pre class="Agda">  <a id="17582" class="Keyword">open</a> <a id="17587" href="Peras.SmallStep.html#6287" class="Module">Semantics</a> <a id="17597" class="Keyword">public</a>
</pre>
</body>
</html>
