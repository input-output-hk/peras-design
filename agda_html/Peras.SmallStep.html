<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Peras.SmallStep</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="Agda.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<pre class="Agda"><a id="9" class="Keyword">module</a> <a id="16" href="Peras.SmallStep.html" class="Module">Peras.SmallStep</a> <a id="32" class="Keyword">where</a>
</pre>
<!--
<pre class="Agda"><a id="55" class="Keyword">open</a> <a id="60" class="Keyword">import</a> <a id="67" href="Prelude.AssocList.html" class="Module">Prelude.AssocList</a>
<a id="85" class="Keyword">open</a> <a id="90" class="Keyword">import</a> <a id="97" href="Prelude.DecEq.html" class="Module">Prelude.DecEq</a> <a id="111" class="Keyword">using</a> <a id="117" class="Symbol">(</a><a id="118" href="Prelude.DecEq.html#62" class="Record">DecEq</a><a id="123" class="Symbol">)</a>
<a id="125" class="Keyword">open</a> <a id="130" class="Keyword">import</a> <a id="137" href="Prelude.Default.html" class="Module">Prelude.Default</a> <a id="153" class="Keyword">using</a> <a id="159" class="Symbol">(</a><a id="160" href="Prelude.Default.html#100" class="Record">Default</a><a id="167" class="Symbol">)</a>
<a id="169" class="Keyword">open</a> <a id="174" href="Prelude.Default.html#100" class="Module">Default</a> <a id="182" class="Symbol">⦃...⦄</a>
<a id="188" class="Keyword">open</a> <a id="193" class="Keyword">import</a> <a id="200" href="Prelude.InferenceRules.html" class="Module">Prelude.InferenceRules</a>

<a id="224" class="Keyword">open</a> <a id="229" class="Keyword">import</a> <a id="236" href="Data.Maybe.html" class="Module">Data.Maybe</a> <a id="247" class="Keyword">using</a> <a id="253" class="Symbol">(</a><a id="254" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a><a id="258" class="Symbol">;</a> <a id="260" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a><a id="267" class="Symbol">)</a>
<a id="269" class="Keyword">open</a> <a id="274" class="Keyword">import</a> <a id="281" href="Data.List.Relation.Unary.Any.html" class="Module">Data.List.Relation.Unary.Any</a> <a id="310" class="Keyword">using</a> <a id="316" class="Symbol">()</a> <a id="319" class="Keyword">renaming</a> <a id="328" class="Symbol">(</a><a id="329" href="Data.List.Relation.Unary.Any.html#2027" class="Function Operator">_∷=_</a> <a id="334" class="Symbol">to</a> <a id="337" class="Function Operator">_∷ˡ=_</a><a id="342" class="Symbol">)</a>
<a id="344" class="Keyword">open</a> <a id="349" class="Keyword">import</a> <a id="356" href="Data.Fin.html" class="Module">Data.Fin</a> <a id="365" class="Keyword">using</a> <a id="371" class="Symbol">(</a><a id="372" href="Data.Fin.Base.html#1154" class="Datatype">Fin</a><a id="375" class="Symbol">)</a> <a id="377" class="Keyword">renaming</a> <a id="386" class="Symbol">(</a><a id="387" href="Data.Fin.Base.html#1176" class="InductiveConstructor">zero</a> <a id="392" class="Symbol">to</a> <a id="395" class="InductiveConstructor">fzero</a><a id="400" class="Symbol">;</a> <a id="402" href="Data.Fin.Base.html#1197" class="InductiveConstructor">suc</a> <a id="406" class="Symbol">to</a> <a id="409" class="InductiveConstructor">fsuc</a><a id="413" class="Symbol">)</a>
<a id="415" class="Keyword">open</a> <a id="420" class="Keyword">import</a> <a id="427" href="Data.Nat.html" class="Module">Data.Nat</a> <a id="436" class="Keyword">using</a> <a id="442" class="Symbol">(</a><a id="443" href="Data.Nat.Base.html#7279" class="Function Operator">_%_</a><a id="446" class="Symbol">;</a> <a id="448" href="Data.Nat.Base.html#2259" class="Function Operator">_≥_</a><a id="451" class="Symbol">;</a> <a id="453" href="Data.Nat.Base.html#2289" class="Function Operator">_&gt;_</a><a id="456" class="Symbol">;</a> <a id="458" href="Data.Nat.Base.html#1691" class="Datatype Operator">_≤_</a><a id="461" class="Symbol">;</a> <a id="463" href="Data.Nat.Base.html#3260" class="Record">NonZero</a><a id="470" class="Symbol">)</a>
<a id="472" class="Keyword">open</a> <a id="477" class="Keyword">import</a> <a id="484" href="Data.List.Membership.Propositional.html" class="Module">Data.List.Membership.Propositional</a>
<a id="519" class="Keyword">open</a> <a id="524" class="Keyword">import</a> <a id="531" href="Relation.Binary.PropositionalEquality.html" class="Module">Relation.Binary.PropositionalEquality</a> <a id="569" class="Keyword">using</a> <a id="575" class="Symbol">(</a><a id="576" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">_≡_</a><a id="579" class="Symbol">;</a> <a id="581" href="Relation.Binary.PropositionalEquality.Core.html#858" class="Function Operator">_≢_</a><a id="584" class="Symbol">)</a>
<a id="586" class="Keyword">open</a> <a id="591" class="Keyword">import</a> <a id="598" href="Data.Product.html" class="Module">Data.Product</a> <a id="611" class="Keyword">using</a> <a id="617" class="Symbol">()</a> <a id="620" class="Keyword">renaming</a> <a id="629" class="Symbol">(</a><a id="630" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">_,_</a> <a id="634" class="Symbol">to</a> <a id="637" class="InductiveConstructor Operator">_,ᵖ_</a><a id="641" class="Symbol">)</a>

<a id="644" class="Keyword">open</a> <a id="649" class="Keyword">import</a> <a id="656" href="Haskell.Prelude.html" class="Module">Haskell.Prelude</a> <a id="672" class="Keyword">hiding</a> <a id="679" class="Symbol">(</a><a id="680" href="Haskell.Prim.Ord.html#1096" class="Field Operator">_&gt;_</a><a id="683" class="Symbol">)</a>
<a id="685" class="Keyword">open</a> <a id="690" class="Keyword">import</a> <a id="697" href="Haskell.Extra.Dec.html" class="Module">Haskell.Extra.Dec</a>

<a id="716" class="Keyword">open</a> <a id="721" class="Keyword">import</a> <a id="728" href="Peras.Block.html" class="Module">Peras.Block</a>
<a id="740" class="Keyword">open</a> <a id="745" class="Keyword">import</a> <a id="752" href="Peras.Chain.html" class="Module">Peras.Chain</a>
<a id="764" class="Keyword">open</a> <a id="769" class="Keyword">import</a> <a id="776" href="Peras.Crypto.html" class="Module">Peras.Crypto</a>
<a id="789" class="Keyword">open</a> <a id="794" class="Keyword">import</a> <a id="801" href="Peras.Numbering.html" class="Module">Peras.Numbering</a>
<a id="817" class="Keyword">open</a> <a id="822" class="Keyword">import</a> <a id="829" href="Peras.Params.html" class="Module">Peras.Params</a>
<a id="842" class="Keyword">open</a> <a id="847" class="Keyword">import</a> <a id="854" href="Peras.Util.html" class="Module">Peras.Util</a>

<a id="866" class="Keyword">open</a> <a id="871" href="Peras.Block.html#1406" class="Module">Honesty</a> <a id="879" class="Keyword">public</a>
<a id="886" class="Keyword">open</a> <a id="891" href="Peras.Crypto.html#2454" class="Module">MembershipProof</a> <a id="907" class="Keyword">public</a>
<a id="914" class="Keyword">open</a> <a id="919" href="Peras.Crypto.html#3408" class="Module">Signature</a> <a id="929" class="Keyword">public</a>
<a id="936" class="Keyword">open</a> <a id="941" href="Peras.Numbering.html#1962" class="Module">RoundNumber</a> <a id="953" class="Keyword">public</a>
<a id="960" class="Keyword">open</a> <a id="965" href="Peras.Block.html#1006" class="Module">Party</a>
</pre>-->
<h1 id="small-step-semantics">Small-step semantics</h1>
<p>The small-step semantics of the <strong>Ouroboros Peras</strong>
protocol define the evolution of the global state of the system
modelling <em>honest</em> and <em>adversarial</em> parties. The number
of parties is fixed during the execution of the protocol and the list of
parties has to be provided as a module parameter. In addition the model
is parameterized by the lotteries (for slot leadership and voting
committee membership) as well as the type of the block tree. Furthermore
adversarial parties share generic, adversarial state.</p>
<p>References:</p>
<ul>
<li>Formalizing Nakamoto-Style Proof of Stake, Søren Eller Thomsen and
Bas Spitters</li>
</ul>
<h3 id="parameters">Parameters</h3>
<p>The parameters for the <em>Peras</em> protocol and hash functions are
defined as instance arguments of the module.</p>
<pre class="Agda"><a id="1745" class="Keyword">module</a> <a id="1752" href="Peras.SmallStep.html#1752" class="Module">_</a> <a id="1754" class="Symbol">⦃</a> <a id="1756" href="Peras.SmallStep.html#1756" class="Bound">_</a> <a id="1758" class="Symbol">:</a> <a id="1760" href="Peras.Crypto.html#2287" class="Record">Hashable</a> <a id="1769" href="Peras.Block.html#2100" class="Record">Block</a> <a id="1775" class="Symbol">⦄</a>
         <a id="1786" class="Symbol">⦃</a> <a id="1788" href="Peras.SmallStep.html#1788" class="Bound">_</a> <a id="1790" class="Symbol">:</a> <a id="1792" href="Peras.Crypto.html#2287" class="Record">Hashable</a> <a id="1801" class="Symbol">(</a><a id="1802" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="1807" href="Peras.Block.html#1622" class="Function">Tx</a><a id="1809" class="Symbol">)</a> <a id="1811" class="Symbol">⦄</a>
         <a id="1822" class="Symbol">⦃</a> <a id="1824" href="Peras.SmallStep.html#1824" class="Bound">_</a> <a id="1826" class="Symbol">:</a> <a id="1828" href="Peras.Params.html#166" class="Record">Params</a> <a id="1835" class="Symbol">⦄</a>
         <a id="1846" class="Symbol">⦃</a> <a id="1848" href="Peras.SmallStep.html#1848" class="Bound">_</a> <a id="1850" class="Symbol">:</a> <a id="1852" href="Peras.Chain.html#1945" class="Record">Network</a> <a id="1860" class="Symbol">⦄</a>
         <a id="1871" class="Symbol">⦃</a> <a id="1873" href="Peras.SmallStep.html#1873" class="Bound">_</a> <a id="1875" class="Symbol">:</a> <a id="1877" href="Peras.Chain.html#1679" class="Record">Postulates</a> <a id="1888" class="Symbol">⦄</a>

         <a id="1900" class="Keyword">where</a>
</pre>
The block tree, resp. the validity of the chain is defined with respect
of the parameters.
<pre class="Agda">  <a id="2015" class="Keyword">open</a> <a id="2020" href="Peras.Crypto.html#2287" class="Module">Hashable</a> <a id="2029" class="Symbol">⦃...⦄</a>
  <a id="2037" class="Keyword">open</a> <a id="2042" href="Peras.Params.html#166" class="Module">Params</a> <a id="2049" class="Symbol">⦃...⦄</a>
  <a id="2057" class="Keyword">open</a> <a id="2062" href="Peras.Chain.html#1945" class="Module">Network</a> <a id="2070" class="Symbol">⦃...⦄</a>
  <a id="2078" class="Keyword">open</a> <a id="2083" href="Peras.Chain.html#1679" class="Module">Postulates</a> <a id="2094" class="Symbol">⦃...⦄</a>
</pre>
<h4 id="messages">Messages</h4>
Messages for sending and receiving chains and votes. Note, in the
<em>Peras</em> protocol certificates are not diffused explicitly.
<pre class="Agda">  <a id="2254" class="Keyword">data</a> <a id="2259" href="Peras.SmallStep.html#2259" class="Datatype">Message</a> <a id="2267" class="Symbol">:</a> <a id="2269" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="2273" class="Keyword">where</a>
    <a id="2283" href="Peras.SmallStep.html#2283" class="InductiveConstructor">ChainMsg</a> <a id="2292" class="Symbol">:</a> <a id="2294" class="Symbol">{</a><a id="2295" href="Peras.SmallStep.html#2295" class="Bound">c</a> <a id="2297" class="Symbol">:</a> <a id="2299" href="Peras.Chain.html#2532" class="Function">Chain</a><a id="2304" class="Symbol">}</a> <a id="2306" class="Symbol">→</a> <a id="2308" href="Peras.Chain.html#4709" class="Datatype">ValidChain</a> <a id="2319" href="Peras.SmallStep.html#2295" class="Bound">c</a> <a id="2321" class="Symbol">→</a> <a id="2323" href="Peras.SmallStep.html#2259" class="Datatype">Message</a>
    <a id="2335" href="Peras.SmallStep.html#2335" class="InductiveConstructor">VoteMsg</a> <a id="2343" class="Symbol">:</a> <a id="2345" class="Symbol">{</a><a id="2346" href="Peras.SmallStep.html#2346" class="Bound">v</a> <a id="2348" class="Symbol">:</a> <a id="2350" href="Peras.Chain.html#899" class="Record">Vote</a><a id="2354" class="Symbol">}</a> <a id="2356" class="Symbol">→</a> <a id="2358" href="Peras.Chain.html#2069" class="Function">ValidVote</a> <a id="2368" href="Peras.SmallStep.html#2346" class="Bound">v</a> <a id="2370" class="Symbol">→</a> <a id="2372" href="Peras.SmallStep.html#2259" class="Datatype">Message</a>
</pre>
Messages can be delayed by a number of slots
<pre class="Agda">  <a id="2439" href="Peras.SmallStep.html#2439" class="Function">Delay</a> <a id="2445" class="Symbol">=</a> <a id="2447" href="Data.Fin.Base.html#1154" class="Datatype">Fin</a> <a id="2451" class="Symbol">(</a><a id="2452" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="2456" class="Symbol">(</a><a id="2457" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="2461" href="Peras.Chain.html#1978" class="Field">Δ</a><a id="2462" class="Symbol">))</a>

  <a id="2468" class="Keyword">pattern</a> <a id="2476" href="Peras.SmallStep.html#2476" class="InductiveConstructor">𝟘</a> <a id="2478" class="Symbol">=</a> <a id="2480" href="Peras.SmallStep.html#395" class="InductiveConstructor">fzero</a>
  <a id="2488" class="Keyword">pattern</a> <a id="2496" href="Peras.SmallStep.html#2496" class="InductiveConstructor">𝟙</a> <a id="2498" class="Symbol">=</a> <a id="2500" href="Peras.SmallStep.html#409" class="InductiveConstructor">fsuc</a> <a id="2505" href="Peras.SmallStep.html#395" class="InductiveConstructor">fzero</a>
  <a id="2513" class="Keyword">pattern</a> <a id="2521" href="Peras.SmallStep.html#2521" class="InductiveConstructor">𝟚</a> <a id="2523" class="Symbol">=</a> <a id="2525" href="Peras.SmallStep.html#409" class="InductiveConstructor">fsuc</a> <a id="2530" class="Symbol">(</a><a id="2531" href="Peras.SmallStep.html#409" class="InductiveConstructor">fsuc</a> <a id="2536" href="Peras.SmallStep.html#395" class="InductiveConstructor">fzero</a><a id="2541" class="Symbol">)</a>
</pre>
Messages are put into an envelope and assigned to a party. The message
can be delayed.
<pre class="Agda">  <a id="2644" class="Keyword">record</a> <a id="2651" href="Peras.SmallStep.html#2651" class="Record">Envelope</a> <a id="2660" class="Symbol">:</a> <a id="2662" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="2666" class="Keyword">where</a>
    <a id="2676" class="Keyword">constructor</a> <a id="2688" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦅_,_,_,_⦆</a>
    <a id="2702" class="Keyword">field</a>
      <a id="2714" href="Peras.SmallStep.html#2714" class="Field">partyId</a> <a id="2722" class="Symbol">:</a> <a id="2724" href="Peras.Block.html#842" class="Function">PartyId</a>
      <a id="2738" href="Peras.SmallStep.html#2738" class="Field">honesty</a> <a id="2746" class="Symbol">:</a> <a id="2748" href="Peras.Block.html#1406" class="Datatype">Honesty</a> <a id="2756" href="Peras.SmallStep.html#2714" class="Field">partyId</a>
      <a id="2770" href="Peras.SmallStep.html#2770" class="Field">message</a> <a id="2778" class="Symbol">:</a> <a id="2780" href="Peras.SmallStep.html#2259" class="Datatype">Message</a>
      <a id="2794" href="Peras.SmallStep.html#2794" class="Field">delay</a> <a id="2800" class="Symbol">:</a> <a id="2802" href="Peras.SmallStep.html#2439" class="Function">Delay</a>

  <a id="2811" class="Keyword">open</a> <a id="2816" href="Peras.SmallStep.html#2651" class="Module">Envelope</a>
</pre>
<h4 id="block-tree">Block-tree</h4>
A block-tree is defined by properties - an implementation of the
block-tree has to fulfil all the properties mentioned below:
<pre class="Agda">  <a id="2982" class="Keyword">record</a> <a id="2989" href="Peras.SmallStep.html#2989" class="Record">IsTreeType</a> <a id="3000" class="Symbol">{</a><a id="3001" href="Peras.SmallStep.html#3001" class="Bound">T</a> <a id="3003" class="Symbol">:</a> <a id="3005" href="Agda.Primitive.html#388" class="Primitive">Set</a><a id="3008" class="Symbol">}</a>
                    <a id="3030" class="Symbol">(</a><a id="3031" href="Peras.SmallStep.html#3031" class="Bound">tree₀</a> <a id="3037" class="Symbol">:</a> <a id="3039" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="3040" class="Symbol">)</a>
                    <a id="3062" class="Symbol">(</a><a id="3063" href="Peras.SmallStep.html#3063" class="Bound">addChain</a> <a id="3072" class="Symbol">:</a> <a id="3074" href="Peras.SmallStep.html#3001" class="Bound">T</a> <a id="3076" class="Symbol">→</a> <a id="3078" class="Symbol">{</a><a id="3079" href="Peras.SmallStep.html#3079" class="Bound">c</a> <a id="3081" class="Symbol">:</a> <a id="3083" href="Peras.Chain.html#2532" class="Function">Chain</a><a id="3088" class="Symbol">}</a> <a id="3090" class="Symbol">→</a> <a id="3092" href="Peras.Chain.html#4709" class="Datatype">ValidChain</a> <a id="3103" href="Peras.SmallStep.html#3079" class="Bound">c</a> <a id="3105" class="Symbol">→</a> <a id="3107" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="3108" class="Symbol">)</a>
                    <a id="3130" class="Symbol">(</a><a id="3131" href="Peras.SmallStep.html#3131" class="Bound">chains</a> <a id="3138" class="Symbol">:</a> <a id="3140" href="Peras.SmallStep.html#3001" class="Bound">T</a> <a id="3142" class="Symbol">→</a> <a id="3144" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="3149" href="Peras.Chain.html#2532" class="Function">Chain</a><a id="3154" class="Symbol">)</a>
                    <a id="3176" class="Symbol">(</a><a id="3177" href="Peras.SmallStep.html#3177" class="Bound">preferredChain</a> <a id="3192" class="Symbol">:</a> <a id="3194" href="Peras.SmallStep.html#3001" class="Bound">T</a> <a id="3196" class="Symbol">→</a> <a id="3198" href="Peras.Chain.html#2532" class="Function">Chain</a><a id="3203" class="Symbol">)</a>
                    <a id="3225" class="Symbol">(</a><a id="3226" href="Peras.SmallStep.html#3226" class="Bound">addVote</a> <a id="3234" class="Symbol">:</a> <a id="3236" href="Peras.SmallStep.html#3001" class="Bound">T</a> <a id="3238" class="Symbol">→</a> <a id="3240" class="Symbol">{</a><a id="3241" href="Peras.SmallStep.html#3241" class="Bound">v</a> <a id="3243" class="Symbol">:</a> <a id="3245" href="Peras.Chain.html#899" class="Record">Vote</a><a id="3249" class="Symbol">}</a> <a id="3251" class="Symbol">→</a> <a id="3253" href="Peras.Chain.html#2069" class="Function">ValidVote</a> <a id="3263" href="Peras.SmallStep.html#3241" class="Bound">v</a> <a id="3265" class="Symbol">→</a> <a id="3267" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="3268" class="Symbol">)</a>
                    <a id="3290" class="Symbol">(</a><a id="3291" href="Peras.SmallStep.html#3291" class="Bound">votes</a> <a id="3297" class="Symbol">:</a> <a id="3299" href="Peras.SmallStep.html#3001" class="Bound">T</a> <a id="3301" class="Symbol">→</a> <a id="3303" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="3308" href="Peras.Chain.html#899" class="Record">Vote</a><a id="3312" class="Symbol">)</a>
                    <a id="3334" class="Symbol">(</a><a id="3335" href="Peras.SmallStep.html#3335" class="Bound">certs</a> <a id="3341" class="Symbol">:</a> <a id="3343" href="Peras.SmallStep.html#3001" class="Bound">T</a> <a id="3345" class="Symbol">→</a> <a id="3347" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="3352" href="Peras.Block.html#2142" class="Record">Certificate</a><a id="3363" class="Symbol">)</a>
                    <a id="3385" class="Symbol">(</a><a id="3386" href="Peras.SmallStep.html#3386" class="Bound">cert₀</a> <a id="3392" class="Symbol">:</a> <a id="3394" href="Peras.Block.html#2142" class="Record">Certificate</a><a id="3405" class="Symbol">)</a>
         <a id="3416" class="Symbol">:</a> <a id="3418" href="Agda.Primitive.html#388" class="Primitive">Set₁</a> <a id="3423" class="Keyword">where</a>

    <a id="3434" class="Keyword">field</a>
</pre>
Properties that must hold with respect to chains, certificates and
votes.
<pre class="Agda">      <a id="3532" href="Peras.SmallStep.html#3532" class="Field">instantiated</a> <a id="3545" class="Symbol">:</a>
        <a id="3555" href="Peras.SmallStep.html#3177" class="Bound">preferredChain</a> <a id="3570" href="Peras.SmallStep.html#3031" class="Bound">tree₀</a> <a id="3576" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="3578" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>

      <a id="3588" href="Peras.SmallStep.html#3588" class="Field">instantiated-certs</a> <a id="3607" class="Symbol">:</a>
        <a id="3617" href="Peras.SmallStep.html#3335" class="Bound">certs</a> <a id="3623" href="Peras.SmallStep.html#3031" class="Bound">tree₀</a> <a id="3629" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="3631" href="Peras.SmallStep.html#3386" class="Bound">cert₀</a> <a id="3637" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="3639" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>

      <a id="3649" href="Peras.SmallStep.html#3649" class="Field">instantiated-votes</a> <a id="3668" class="Symbol">:</a>
        <a id="3678" href="Peras.SmallStep.html#3291" class="Bound">votes</a> <a id="3684" href="Peras.SmallStep.html#3031" class="Bound">tree₀</a> <a id="3690" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="3692" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>

      <a id="3702" href="Peras.SmallStep.html#3702" class="Field">extendable-votes</a> <a id="3719" class="Symbol">:</a> <a id="3721" class="Symbol">∀</a> <a id="3723" class="Symbol">(</a><a id="3724" href="Peras.SmallStep.html#3724" class="Bound">t</a> <a id="3726" class="Symbol">:</a> <a id="3728" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="3729" class="Symbol">)</a> <a id="3731" class="Symbol">{</a><a id="3732" href="Peras.SmallStep.html#3732" class="Bound">v</a> <a id="3734" class="Symbol">:</a> <a id="3736" href="Peras.Chain.html#899" class="Record">Vote</a><a id="3740" class="Symbol">}</a> <a id="3742" class="Symbol">(</a><a id="3743" href="Peras.SmallStep.html#3743" class="Bound">vv</a> <a id="3746" class="Symbol">:</a> <a id="3748" href="Peras.Chain.html#2069" class="Function">ValidVote</a> <a id="3758" href="Peras.SmallStep.html#3732" class="Bound">v</a><a id="3759" class="Symbol">)</a>
        <a id="3769" class="Symbol">→</a> <a id="3771" href="Peras.SmallStep.html#3732" class="Bound">v</a> <a id="3773" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="3775" href="Peras.SmallStep.html#3291" class="Bound">votes</a> <a id="3781" class="Symbol">(</a><a id="3782" href="Peras.SmallStep.html#3226" class="Bound">addVote</a> <a id="3790" href="Peras.SmallStep.html#3724" class="Bound">t</a> <a id="3792" href="Peras.SmallStep.html#3743" class="Bound">vv</a><a id="3794" class="Symbol">)</a>

      <a id="3803" href="Peras.SmallStep.html#3803" class="Field">extendable-chain</a> <a id="3820" class="Symbol">:</a> <a id="3822" class="Symbol">∀</a> <a id="3824" class="Symbol">(</a><a id="3825" href="Peras.SmallStep.html#3825" class="Bound">t</a> <a id="3827" class="Symbol">:</a> <a id="3829" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="3830" class="Symbol">)</a> <a id="3832" class="Symbol">{</a><a id="3833" href="Peras.SmallStep.html#3833" class="Bound">c</a> <a id="3835" class="Symbol">:</a> <a id="3837" href="Peras.Chain.html#2532" class="Function">Chain</a><a id="3842" class="Symbol">}</a> <a id="3844" class="Symbol">(</a><a id="3845" href="Peras.SmallStep.html#3845" class="Bound">vc</a> <a id="3848" class="Symbol">:</a> <a id="3850" href="Peras.Chain.html#4709" class="Datatype">ValidChain</a> <a id="3861" href="Peras.SmallStep.html#3833" class="Bound">c</a><a id="3862" class="Symbol">)</a>
        <a id="3872" class="Symbol">→</a> <a id="3874" href="Peras.SmallStep.html#3335" class="Bound">certs</a> <a id="3880" class="Symbol">(</a><a id="3881" href="Peras.SmallStep.html#3063" class="Bound">addChain</a> <a id="3890" href="Peras.SmallStep.html#3825" class="Bound">t</a> <a id="3892" href="Peras.SmallStep.html#3845" class="Bound">vc</a><a id="3894" class="Symbol">)</a> <a id="3896" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="3898" href="Haskell.Prim.Foldable.html#528" class="Field">foldr</a> <a id="3904" href="Peras.Chain.html#2726" class="Function">insertCert</a> <a id="3915" class="Symbol">(</a><a id="3916" href="Peras.SmallStep.html#3335" class="Bound">certs</a> <a id="3922" href="Peras.SmallStep.html#3825" class="Bound">t</a><a id="3923" class="Symbol">)</a> <a id="3925" class="Symbol">(</a><a id="3926" href="Peras.Chain.html#2594" class="Function">certsFromChain</a> <a id="3941" href="Peras.SmallStep.html#3833" class="Bound">c</a><a id="3942" class="Symbol">)</a>

      <a id="3951" class="Comment">-- TODO: can be express by other properties</a>
      <a id="4001" href="Peras.SmallStep.html#4001" class="Field">self-contained-certs</a> <a id="4022" class="Symbol">:</a> <a id="4024" class="Symbol">∀</a> <a id="4026" class="Symbol">(</a><a id="4027" href="Peras.SmallStep.html#4027" class="Bound">t</a> <a id="4029" class="Symbol">:</a> <a id="4031" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="4032" class="Symbol">)</a> <a id="4034" class="Symbol">{</a><a id="4035" href="Peras.SmallStep.html#4035" class="Bound">c</a> <a id="4037" class="Symbol">:</a> <a id="4039" href="Peras.Chain.html#2532" class="Function">Chain</a><a id="4044" class="Symbol">}</a>
        <a id="4054" class="Symbol">→</a> <a id="4056" href="Peras.SmallStep.html#4035" class="Bound">c</a> <a id="4058" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="4060" href="Peras.SmallStep.html#3131" class="Bound">chains</a> <a id="4067" href="Peras.SmallStep.html#4027" class="Bound">t</a>
        <a id="4077" class="Symbol">→</a> <a id="4079" href="Peras.SmallStep.html#3335" class="Bound">certs</a> <a id="4085" href="Peras.SmallStep.html#4027" class="Bound">t</a> <a id="4087" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="4089" href="Haskell.Prim.Foldable.html#528" class="Field">foldr</a> <a id="4095" href="Peras.Chain.html#2726" class="Function">insertCert</a> <a id="4106" class="Symbol">(</a><a id="4107" href="Peras.SmallStep.html#3335" class="Bound">certs</a> <a id="4113" href="Peras.SmallStep.html#4027" class="Bound">t</a><a id="4114" class="Symbol">)</a> <a id="4116" class="Symbol">(</a><a id="4117" href="Peras.Chain.html#2594" class="Function">certsFromChain</a> <a id="4132" href="Peras.SmallStep.html#4035" class="Bound">c</a><a id="4133" class="Symbol">)</a>

      <a id="4142" href="Peras.SmallStep.html#4142" class="Field">valid</a> <a id="4148" class="Symbol">:</a> <a id="4150" class="Symbol">∀</a> <a id="4152" class="Symbol">(</a><a id="4153" href="Peras.SmallStep.html#4153" class="Bound">t</a> <a id="4155" class="Symbol">:</a> <a id="4157" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="4158" class="Symbol">)</a>
        <a id="4168" class="Symbol">→</a> <a id="4170" href="Peras.Chain.html#4709" class="Datatype">ValidChain</a> <a id="4181" class="Symbol">(</a><a id="4182" href="Peras.SmallStep.html#3177" class="Bound">preferredChain</a> <a id="4197" href="Peras.SmallStep.html#4153" class="Bound">t</a><a id="4198" class="Symbol">)</a>

      <a id="4207" href="Peras.SmallStep.html#4207" class="Field">optimal</a> <a id="4215" class="Symbol">:</a> <a id="4217" class="Symbol">∀</a> <a id="4219" class="Symbol">(</a><a id="4220" href="Peras.SmallStep.html#4220" class="Bound">c</a> <a id="4222" class="Symbol">:</a> <a id="4224" href="Peras.Chain.html#2532" class="Function">Chain</a><a id="4229" class="Symbol">)</a> <a id="4231" class="Symbol">(</a><a id="4232" href="Peras.SmallStep.html#4232" class="Bound">t</a> <a id="4234" class="Symbol">:</a> <a id="4236" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="4237" class="Symbol">)</a>
        <a id="4247" class="Symbol">→</a> <a id="4249" class="Keyword">let</a>
            <a id="4265" href="Peras.SmallStep.html#4265" class="Bound">b</a> <a id="4267" class="Symbol">=</a> <a id="4269" href="Peras.SmallStep.html#3177" class="Bound">preferredChain</a> <a id="4284" href="Peras.SmallStep.html#4232" class="Bound">t</a>
            <a id="4298" href="Peras.SmallStep.html#4298" class="Bound">cts</a> <a id="4302" class="Symbol">=</a> <a id="4304" href="Peras.SmallStep.html#3335" class="Bound">certs</a> <a id="4310" href="Peras.SmallStep.html#4232" class="Bound">t</a>
          <a id="4322" class="Keyword">in</a>
          <a id="4335" href="Peras.Chain.html#4709" class="Datatype">ValidChain</a> <a id="4346" href="Peras.SmallStep.html#4220" class="Bound">c</a>
        <a id="4356" class="Symbol">→</a> <a id="4358" href="Peras.SmallStep.html#4220" class="Bound">c</a> <a id="4360" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="4362" href="Peras.SmallStep.html#3131" class="Bound">chains</a> <a id="4369" href="Peras.SmallStep.html#4232" class="Bound">t</a>
        <a id="4379" class="Symbol">→</a> <a id="4381" href="Peras.Chain.html#4298" class="Function">weight</a> <a id="4388" href="Peras.SmallStep.html#4220" class="Bound">c</a> <a id="4390" href="Peras.SmallStep.html#4298" class="Bound">cts</a> <a id="4394" href="Data.Nat.Base.html#1691" class="Datatype Operator">≤</a> <a id="4396" href="Peras.Chain.html#4298" class="Function">weight</a> <a id="4403" href="Peras.SmallStep.html#4265" class="Bound">b</a> <a id="4405" href="Peras.SmallStep.html#4298" class="Bound">cts</a>

      <a id="4416" href="Peras.SmallStep.html#4416" class="Field">self-contained</a> <a id="4431" class="Symbol">:</a> <a id="4433" class="Symbol">∀</a> <a id="4435" class="Symbol">(</a><a id="4436" href="Peras.SmallStep.html#4436" class="Bound">t</a> <a id="4438" class="Symbol">:</a> <a id="4440" href="Peras.SmallStep.html#3001" class="Bound">T</a><a id="4441" class="Symbol">)</a>
        <a id="4451" class="Symbol">→</a> <a id="4453" href="Peras.SmallStep.html#3177" class="Bound">preferredChain</a> <a id="4468" href="Peras.SmallStep.html#4436" class="Bound">t</a> <a id="4470" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="4472" href="Peras.SmallStep.html#3131" class="Bound">chains</a> <a id="4479" href="Peras.SmallStep.html#4436" class="Bound">t</a>

<a id="4482" class="Comment">{-
      valid-votes : ∀ (t : T)
        → All ValidVote (votes t)
-}</a>

<a id="4553" class="Comment">{-
      unique-votes : ∀ (t : T) {v : Vote} (vv : ValidVote v)
        → let vs = votes t
          in
          v ∈ vs
        → vs ≡ votes (addVote t vv)

      no-equivocations : ∀ (t : T) {v : Vote} (vv : ValidVote v)
        → let vs = votes t
          in
          Any (v ∻_) vs
        → vs ≡ votes (addVote t vv)
-}</a>
<a id="4879" class="Comment">{-
      quorum-cert : ∀ (t : T) (b : Block) (r : ℕ)
        → length (filter (λ {v →
                    (getRoundNumber (votingRound v) ≟ r)
              ×-dec (blockHash v ≟-BlockHash hash b)}
            ) (votes t)) ≥ τ
        → Any (λ {c →
            (getRoundNumber (round c) ≡ r)
          × (blockRef c ≡ hash b) }) (certs t)
-}</a>
</pre>
In addition to chains the block-tree manages votes and certificates as
well. The block-tree type is defined as follows:
<pre class="Agda">  <a id="5354" class="Keyword">record</a> <a id="5361" href="Peras.SmallStep.html#5361" class="Record">TreeType</a> <a id="5370" class="Symbol">(</a><a id="5371" href="Peras.SmallStep.html#5371" class="Bound">T</a> <a id="5373" class="Symbol">:</a> <a id="5375" href="Agda.Primitive.html#388" class="Primitive">Set</a><a id="5378" class="Symbol">)</a> <a id="5380" class="Symbol">:</a> <a id="5382" href="Agda.Primitive.html#388" class="Primitive">Set₁</a> <a id="5387" class="Keyword">where</a>

    <a id="5398" class="Keyword">field</a>
      <a id="5410" href="Peras.SmallStep.html#5410" class="Field">tree₀</a> <a id="5416" class="Symbol">:</a> <a id="5418" href="Peras.SmallStep.html#5371" class="Bound">T</a>

      <a id="5427" href="Peras.SmallStep.html#5427" class="Field">addChain</a> <a id="5436" class="Symbol">:</a> <a id="5438" href="Peras.SmallStep.html#5371" class="Bound">T</a> <a id="5440" class="Symbol">→</a> <a id="5442" class="Symbol">{</a><a id="5443" href="Peras.SmallStep.html#5443" class="Bound">c</a> <a id="5445" class="Symbol">:</a> <a id="5447" href="Peras.Chain.html#2532" class="Function">Chain</a><a id="5452" class="Symbol">}</a> <a id="5454" class="Symbol">→</a> <a id="5456" href="Peras.Chain.html#4709" class="Datatype">ValidChain</a> <a id="5467" href="Peras.SmallStep.html#5443" class="Bound">c</a> <a id="5469" class="Symbol">→</a> <a id="5471" href="Peras.SmallStep.html#5371" class="Bound">T</a>
      <a id="5479" href="Peras.SmallStep.html#5479" class="Field">chains</a> <a id="5486" class="Symbol">:</a> <a id="5488" href="Peras.SmallStep.html#5371" class="Bound">T</a> <a id="5490" class="Symbol">→</a> <a id="5492" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="5497" href="Peras.Chain.html#2532" class="Function">Chain</a>
      <a id="5509" href="Peras.SmallStep.html#5509" class="Field">preferredChain</a> <a id="5524" class="Symbol">:</a> <a id="5526" href="Peras.SmallStep.html#5371" class="Bound">T</a> <a id="5528" class="Symbol">→</a> <a id="5530" href="Peras.Chain.html#2532" class="Function">Chain</a>

      <a id="5543" href="Peras.SmallStep.html#5543" class="Field">addVote</a> <a id="5551" class="Symbol">:</a> <a id="5553" href="Peras.SmallStep.html#5371" class="Bound">T</a> <a id="5555" class="Symbol">→</a> <a id="5557" class="Symbol">{</a><a id="5558" href="Peras.SmallStep.html#5558" class="Bound">v</a> <a id="5560" class="Symbol">:</a> <a id="5562" href="Peras.Chain.html#899" class="Record">Vote</a><a id="5566" class="Symbol">}</a> <a id="5568" class="Symbol">→</a> <a id="5570" href="Peras.Chain.html#2069" class="Function">ValidVote</a> <a id="5580" href="Peras.SmallStep.html#5558" class="Bound">v</a> <a id="5582" class="Symbol">→</a> <a id="5584" href="Peras.SmallStep.html#5371" class="Bound">T</a>
      <a id="5592" href="Peras.SmallStep.html#5592" class="Field">votes</a> <a id="5598" class="Symbol">:</a> <a id="5600" href="Peras.SmallStep.html#5371" class="Bound">T</a> <a id="5602" class="Symbol">→</a> <a id="5604" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="5609" href="Peras.Chain.html#899" class="Record">Vote</a>

      <a id="5621" href="Peras.SmallStep.html#5621" class="Field">certs</a> <a id="5627" class="Symbol">:</a> <a id="5629" href="Peras.SmallStep.html#5371" class="Bound">T</a> <a id="5631" class="Symbol">→</a> <a id="5633" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="5638" href="Peras.Block.html#2142" class="Record">Certificate</a>

      <a id="5657" href="Peras.SmallStep.html#5657" class="Field">is-TreeType</a> <a id="5669" class="Symbol">:</a> <a id="5671" href="Peras.SmallStep.html#2989" class="Record">IsTreeType</a>
                      <a id="5704" href="Peras.SmallStep.html#5410" class="Field">tree₀</a> <a id="5710" href="Peras.SmallStep.html#5427" class="Field">addChain</a> <a id="5719" href="Peras.SmallStep.html#5479" class="Field">chains</a> <a id="5726" href="Peras.SmallStep.html#5509" class="Field">preferredChain</a>
                      <a id="5763" href="Peras.SmallStep.html#5543" class="Field">addVote</a> <a id="5771" href="Peras.SmallStep.html#5592" class="Field">votes</a> <a id="5777" href="Peras.SmallStep.html#5621" class="Field">certs</a> <a id="5783" href="Peras.Chain.html#3222" class="Function">cert₀</a>

    <a id="5794" href="Peras.SmallStep.html#5794" class="Function">latestCertOnChain</a> <a id="5812" class="Symbol">:</a> <a id="5814" href="Peras.SmallStep.html#5371" class="Bound">T</a> <a id="5816" class="Symbol">→</a> <a id="5818" href="Peras.Block.html#2142" class="Record">Certificate</a>
    <a id="5834" href="Peras.SmallStep.html#5794" class="Function">latestCertOnChain</a> <a id="5852" class="Symbol">=</a>
      <a id="5860" href="Peras.Block.html#2385" class="Function">latestCert</a> <a id="5871" href="Peras.Chain.html#3222" class="Function">cert₀</a> <a id="5877" href="Haskell.Prim.html#1330" class="Function Operator">∘</a> <a id="5879" href="Peras.Util.html#1416" class="Function">mapMaybe</a> <a id="5888" href="Peras.Block.html#2631" class="Field">certificate</a> <a id="5900" href="Haskell.Prim.html#1330" class="Function Operator">∘</a> <a id="5902" href="Peras.SmallStep.html#5509" class="Field">preferredChain</a>

    <a id="5922" href="Peras.SmallStep.html#5922" class="Function">latestCertSeen</a> <a id="5937" class="Symbol">:</a> <a id="5939" href="Peras.SmallStep.html#5371" class="Bound">T</a> <a id="5941" class="Symbol">→</a> <a id="5943" href="Peras.Block.html#2142" class="Record">Certificate</a>
    <a id="5959" href="Peras.SmallStep.html#5922" class="Function">latestCertSeen</a> <a id="5974" class="Symbol">=</a> <a id="5976" href="Peras.Block.html#2385" class="Function">latestCert</a> <a id="5987" href="Peras.Chain.html#3222" class="Function">cert₀</a> <a id="5993" href="Haskell.Prim.html#1330" class="Function Operator">∘</a> <a id="5995" href="Peras.SmallStep.html#5621" class="Field">certs</a>

    <a id="6006" href="Peras.SmallStep.html#6006" class="Function">hasCert</a> <a id="6014" class="Symbol">:</a> <a id="6016" href="Peras.Numbering.html#1962" class="Record">RoundNumber</a> <a id="6028" class="Symbol">→</a> <a id="6030" href="Peras.SmallStep.html#5371" class="Bound">T</a> <a id="6032" class="Symbol">→</a> <a id="6034" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="6042" href="Peras.SmallStep.html#6006" class="Function">hasCert</a> <a id="6050" class="Symbol">(</a><a id="6051" href="Peras.Numbering.html#2000" class="InductiveConstructor">MkRoundNumber</a> <a id="6065" href="Peras.SmallStep.html#6065" class="Bound">r</a><a id="6066" class="Symbol">)</a> <a id="6068" href="Peras.SmallStep.html#6068" class="Bound">t</a> <a id="6070" class="Symbol">=</a> <a id="6072" href="Haskell.Prim.html#2981" class="Datatype">Any</a> <a id="6076" class="Symbol">(λ</a> <a id="6079" href="Peras.SmallStep.html#6079" class="Bound">c</a> <a id="6081" class="Symbol">→</a> <a id="6083" href="Peras.SmallStep.html#6065" class="Bound">r</a> <a id="6085" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="6087" href="Peras.Block.html#2304" class="Function">roundNumber</a> <a id="6099" href="Peras.SmallStep.html#6079" class="Bound">c</a><a id="6100" class="Symbol">)</a> <a id="6102" class="Symbol">(</a><a id="6103" href="Peras.SmallStep.html#5621" class="Field">certs</a> <a id="6109" href="Peras.SmallStep.html#6068" class="Bound">t</a><a id="6110" class="Symbol">)</a>

    <a id="6117" href="Peras.SmallStep.html#6117" class="Function">hasVote</a> <a id="6125" class="Symbol">:</a> <a id="6127" href="Peras.Numbering.html#1962" class="Record">RoundNumber</a> <a id="6139" class="Symbol">→</a> <a id="6141" href="Peras.SmallStep.html#5371" class="Bound">T</a> <a id="6143" class="Symbol">→</a> <a id="6145" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="6153" href="Peras.SmallStep.html#6117" class="Function">hasVote</a> <a id="6161" class="Symbol">(</a><a id="6162" href="Peras.Numbering.html#2000" class="InductiveConstructor">MkRoundNumber</a> <a id="6176" href="Peras.SmallStep.html#6176" class="Bound">r</a><a id="6177" class="Symbol">)</a> <a id="6179" href="Peras.SmallStep.html#6179" class="Bound">t</a> <a id="6181" class="Symbol">=</a> <a id="6183" href="Haskell.Prim.html#2981" class="Datatype">Any</a> <a id="6187" class="Symbol">(λ</a> <a id="6190" href="Peras.SmallStep.html#6190" class="Bound">v</a> <a id="6192" class="Symbol">→</a> <a id="6194" href="Peras.SmallStep.html#6176" class="Bound">r</a> <a id="6196" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="6198" href="Peras.Chain.html#1107" class="Function">votingRound&#39;</a> <a id="6211" href="Peras.SmallStep.html#6190" class="Bound">v</a><a id="6212" class="Symbol">)</a> <a id="6214" class="Symbol">(</a><a id="6215" href="Peras.SmallStep.html#5592" class="Field">votes</a> <a id="6221" href="Peras.SmallStep.html#6179" class="Bound">t</a><a id="6222" class="Symbol">)</a>

    <a id="6229" href="Peras.SmallStep.html#6229" class="Function">allBlocks</a> <a id="6239" class="Symbol">:</a> <a id="6241" href="Peras.SmallStep.html#5371" class="Bound">T</a> <a id="6243" class="Symbol">→</a> <a id="6245" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="6250" href="Peras.Block.html#2100" class="Record">Block</a>
    <a id="6260" href="Peras.SmallStep.html#6229" class="Function">allBlocks</a> <a id="6270" class="Symbol">=</a> <a id="6272" href="Haskell.Prim.Foldable.html#741" class="Field">concat</a> <a id="6279" href="Haskell.Prim.html#1330" class="Function Operator">∘</a> <a id="6281" href="Peras.SmallStep.html#5479" class="Field">chains</a>

    <a id="6293" class="Keyword">postulate</a>
      <a id="6309" href="Peras.SmallStep.html#6309" class="Postulate">latestCertSeen∈certs</a> <a id="6330" class="Symbol">:</a> <a id="6332" class="Symbol">∀</a> <a id="6334" href="Peras.SmallStep.html#6334" class="Bound">t</a> <a id="6336" class="Symbol">→</a> <a id="6338" href="Peras.SmallStep.html#5922" class="Function">latestCertSeen</a> <a id="6353" href="Peras.SmallStep.html#6334" class="Bound">t</a> <a id="6355" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="6357" href="Peras.SmallStep.html#5621" class="Field">certs</a> <a id="6363" href="Peras.SmallStep.html#6334" class="Bound">t</a>
</pre>
<h3 id="additional-parameters">Additional parameters</h3>
<p>In order to define the semantics the following parameters are
required additionally:</p>
<ul>
<li>The type of the block-tree</li>
<li>adversarialState₀ is the initial adversarial state</li>
<li>Tx selection function per party and slot number</li>
<li>The list of parties
<pre class="Agda">  <a id="6654" class="Keyword">module</a> <a id="6661" href="Peras.SmallStep.html#6661" class="Module">Semantics</a>
       <a id="6682" class="Symbol">{</a><a id="6683" href="Peras.SmallStep.html#6683" class="Bound">T</a> <a id="6685" class="Symbol">:</a> <a id="6687" href="Agda.Primitive.html#388" class="Primitive">Set</a><a id="6690" class="Symbol">}</a> <a id="6692" class="Symbol">{</a><a id="6693" href="Peras.SmallStep.html#6693" class="Bound">blockTree</a> <a id="6703" class="Symbol">:</a> <a id="6705" href="Peras.SmallStep.html#5361" class="Record">TreeType</a> <a id="6714" href="Peras.SmallStep.html#6683" class="Bound">T</a><a id="6715" class="Symbol">}</a>
       <a id="6728" class="Symbol">{</a><a id="6729" href="Peras.SmallStep.html#6729" class="Bound">S</a> <a id="6731" class="Symbol">:</a> <a id="6733" href="Agda.Primitive.html#388" class="Primitive">Set</a><a id="6736" class="Symbol">}</a> <a id="6738" class="Symbol">{</a><a id="6739" href="Peras.SmallStep.html#6739" class="Bound">adversarialState₀</a> <a id="6757" class="Symbol">:</a> <a id="6759" href="Peras.SmallStep.html#6729" class="Bound">S</a><a id="6760" class="Symbol">}</a>
       <a id="6773" class="Symbol">{</a><a id="6774" href="Peras.SmallStep.html#6774" class="Bound">txSelection</a> <a id="6786" class="Symbol">:</a> <a id="6788" href="Peras.Numbering.html#1035" class="Record">SlotNumber</a> <a id="6799" class="Symbol">→</a> <a id="6801" href="Peras.Block.html#842" class="Function">PartyId</a> <a id="6809" class="Symbol">→</a> <a id="6811" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="6816" href="Peras.Block.html#1622" class="Function">Tx</a><a id="6818" class="Symbol">}</a>
       <a id="6831" class="Symbol">{</a><a id="6832" href="Peras.SmallStep.html#6832" class="Bound">parties</a> <a id="6840" class="Symbol">:</a> <a id="6842" href="Peras.Block.html#1568" class="Function">Parties</a><a id="6849" class="Symbol">}</a> <a id="6851" class="Comment">-- TODO: use parties from blockTrees</a>
                           <a id="6919" class="Comment">-- i.e. allow dynamic participation</a>
       <a id="6966" class="Keyword">where</a>

<a id="6977" class="Keyword">open</a> <a id="6982" href="Peras.SmallStep.html#5361" class="Module">TreeType</a> <a id="6991" href="Peras.SmallStep.html#6693" class="Bound">blockTree</a>

<a id="7006" class="Keyword">private</a>
  <a id="7020" class="Keyword">instance</a>
    <a id="7037" href="Peras.SmallStep.html#7037" class="Function">Default-T</a> <a id="7047" class="Symbol">:</a> <a id="7049" href="Prelude.Default.html#100" class="Record">Default</a> <a id="7057" href="Peras.SmallStep.html#6683" class="Bound">T</a>
    <a id="7067" href="Peras.SmallStep.html#7037" class="Function">Default-T</a> <a id="7077" class="Symbol">.</a><a id="7078" href="Prelude.Default.html#140" class="Field">def</a> <a id="7082" class="Symbol">=</a> <a id="7084" href="Peras.SmallStep.html#5410" class="Function">tree₀</a>
</pre>
<h4 id="block-tree-update">Block-tree update</h4></li>
</ul>
<p>Updating the block-tree upon receiving a message for vote and block
messages.</p>
<pre class="Agda">    <a id="7209" class="Keyword">data</a> <a id="7214" href="Peras.SmallStep.html#7214" class="Datatype Operator">_[_]→_</a> <a id="7221" class="Symbol">:</a> <a id="7223" href="Peras.SmallStep.html#6683" class="Bound">T</a> <a id="7225" class="Symbol">→</a> <a id="7227" href="Peras.SmallStep.html#2259" class="Datatype">Message</a> <a id="7235" class="Symbol">→</a> <a id="7237" href="Peras.SmallStep.html#6683" class="Bound">T</a> <a id="7239" class="Symbol">→</a> <a id="7241" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="7245" class="Keyword">where</a>

      <a id="7258" href="Peras.SmallStep.html#7258" class="InductiveConstructor">VoteReceived</a> <a id="7271" class="Symbol">:</a> <a id="7273" class="Symbol">∀</a> <a id="7275" class="Symbol">{</a><a id="7276" href="Peras.SmallStep.html#7276" class="Bound">v</a> <a id="7278" href="Peras.SmallStep.html#7278" class="Bound">vv</a> <a id="7281" href="Peras.SmallStep.html#7281" class="Bound">t</a><a id="7282" class="Symbol">}</a> <a id="7284" class="Symbol">→</a>
          <a id="7296" href="Prelude.InferenceRules.html#45702" class="Function Operator">────────────────────────────</a>
          <a id="7335" href="Peras.SmallStep.html#7281" class="Bound">t</a> <a id="7337" href="Peras.SmallStep.html#7214" class="Datatype Operator">[</a> <a id="7339" href="Peras.SmallStep.html#2335" class="InductiveConstructor">VoteMsg</a> <a id="7347" class="Symbol">{</a><a id="7348" href="Peras.SmallStep.html#7276" class="Bound">v</a><a id="7349" class="Symbol">}</a> <a id="7351" href="Peras.SmallStep.html#7278" class="Bound">vv</a> <a id="7354" href="Peras.SmallStep.html#7214" class="Datatype Operator">]→</a> <a id="7357" href="Peras.SmallStep.html#5543" class="Function">addVote</a> <a id="7365" href="Peras.SmallStep.html#7281" class="Bound">t</a> <a id="7367" href="Peras.SmallStep.html#7278" class="Bound">vv</a>

      <a id="7377" href="Peras.SmallStep.html#7377" class="InductiveConstructor">ChainReceived</a> <a id="7391" class="Symbol">:</a> <a id="7393" class="Symbol">∀</a> <a id="7395" class="Symbol">{</a><a id="7396" href="Peras.SmallStep.html#7396" class="Bound">c</a> <a id="7398" href="Peras.SmallStep.html#7398" class="Bound">vc</a> <a id="7401" href="Peras.SmallStep.html#7401" class="Bound">t</a><a id="7402" class="Symbol">}</a> <a id="7404" class="Symbol">→</a>
          <a id="7416" href="Prelude.InferenceRules.html#45468" class="Function Operator">──────────────────────────────</a>
          <a id="7457" href="Peras.SmallStep.html#7401" class="Bound">t</a> <a id="7459" href="Peras.SmallStep.html#7214" class="Datatype Operator">[</a> <a id="7461" href="Peras.SmallStep.html#2283" class="InductiveConstructor">ChainMsg</a> <a id="7470" class="Symbol">{</a><a id="7471" href="Peras.SmallStep.html#7396" class="Bound">c</a><a id="7472" class="Symbol">}</a> <a id="7474" href="Peras.SmallStep.html#7398" class="Bound">vc</a> <a id="7477" href="Peras.SmallStep.html#7214" class="Datatype Operator">]→</a> <a id="7480" href="Peras.SmallStep.html#5427" class="Function">addChain</a> <a id="7489" href="Peras.SmallStep.html#7401" class="Bound">t</a> <a id="7491" href="Peras.SmallStep.html#7398" class="Bound">vc</a>
</pre>
<h4 id="vote-in-round">Vote in round</h4>
<p>When does a party vote in a round? The protocol expects regular
voting, i.e. if in the previous round a quorum has been achieved or that
voting resumes after a cool-down phase.</p>
<h4 id="blockselection">BlockSelection</h4>
<pre class="Agda">    <a id="7728" href="Peras.SmallStep.html#7728" class="Function">BlockSelection&#39;</a> <a id="7744" class="Symbol">:</a> <a id="7746" href="Peras.Numbering.html#1035" class="Record">SlotNumber</a> <a id="7757" class="Symbol">→</a> <a id="7759" href="Peras.Chain.html#2532" class="Function">Chain</a> <a id="7765" class="Symbol">→</a> <a id="7767" href="Peras.Crypto.html#1835" class="Record">Hash</a> <a id="7772" href="Peras.Block.html#2100" class="Record">Block</a>
    <a id="7782" href="Peras.SmallStep.html#7728" class="Function">BlockSelection&#39;</a> <a id="7798" class="Symbol">(</a><a id="7799" href="Peras.Numbering.html#1072" class="InductiveConstructor">MkSlotNumber</a> <a id="7812" href="Peras.SmallStep.html#7812" class="Bound">s</a><a id="7813" class="Symbol">)</a> <a id="7815" class="Symbol">=</a> <a id="7817" href="Peras.Block.html#4809" class="Function">tipHash</a> <a id="7825" href="Haskell.Prim.html#1330" class="Function Operator">∘</a> <a id="7827" href="Haskell.Prim.List.html#419" class="Function">filter</a> <a id="7834" class="Symbol">(λ</a> <a id="7837" class="Symbol">{</a><a id="7838" href="Peras.SmallStep.html#7838" class="Bound">b</a> <a id="7840" class="Symbol">→</a> <a id="7842" class="Symbol">(</a><a id="7843" href="Peras.Block.html#2770" class="Function">slotNumber&#39;</a> <a id="7855" href="Peras.SmallStep.html#7838" class="Bound">b</a><a id="7856" class="Symbol">)</a> <a id="7858" href="Haskell.Prim.Num.html#547" class="Field Operator">+</a> <a id="7860" href="Peras.Params.html#235" class="Field">L</a> <a id="7862" href="Haskell.Prim.Ord.html#1144" class="Field Operator">&lt;=</a> <a id="7865" href="Peras.SmallStep.html#7812" class="Bound">s</a><a id="7866" class="Symbol">})</a>

    <a id="7874" href="Peras.SmallStep.html#7874" class="Function">BlockSelection</a> <a id="7889" class="Symbol">:</a> <a id="7891" href="Peras.Numbering.html#1035" class="Record">SlotNumber</a> <a id="7902" class="Symbol">→</a> <a id="7904" href="Peras.SmallStep.html#6683" class="Bound">T</a> <a id="7906" class="Symbol">→</a> <a id="7908" href="Peras.Crypto.html#1835" class="Record">Hash</a> <a id="7913" href="Peras.Block.html#2100" class="Record">Block</a>
    <a id="7923" href="Peras.SmallStep.html#7874" class="Function">BlockSelection</a> <a id="7938" href="Peras.SmallStep.html#7938" class="Bound">s</a> <a id="7940" class="Symbol">=</a> <a id="7942" href="Peras.SmallStep.html#7728" class="Function">BlockSelection&#39;</a> <a id="7958" href="Peras.SmallStep.html#7938" class="Bound">s</a> <a id="7960" href="Haskell.Prim.html#1330" class="Function Operator">∘</a> <a id="7962" href="Peras.SmallStep.html#5509" class="Function">preferredChain</a>
</pre>
<h4 id="voting-rules">Voting rules</h4>
VR-1A: A party has seen a certificate cert-r−1 for round r−1
<pre class="Agda">    <a id="8073" href="Peras.SmallStep.html#8073" class="Function">VotingRule-1A</a> <a id="8087" class="Symbol">:</a> <a id="8089" href="Peras.Numbering.html#1962" class="Record">RoundNumber</a> <a id="8101" class="Symbol">→</a> <a id="8103" href="Peras.SmallStep.html#6683" class="Bound">T</a> <a id="8105" class="Symbol">→</a> <a id="8107" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="8115" href="Peras.SmallStep.html#8073" class="Function">VotingRule-1A</a> <a id="8129" href="Peras.SmallStep.html#8129" class="Bound">r</a> <a id="8131" href="Peras.SmallStep.html#8131" class="Bound">t</a> <a id="8133" class="Symbol">=</a> <a id="8135" href="Peras.SmallStep.html#8129" class="Bound">r</a> <a id="8137" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="8139" href="Peras.Numbering.html#3684" class="Function">nextRound</a> <a id="8149" class="Symbol">(</a><a id="8150" href="Peras.Block.html#2251" class="Field">round</a> <a id="8156" class="Symbol">(</a><a id="8157" href="Peras.SmallStep.html#5922" class="Function">latestCertSeen</a> <a id="8172" href="Peras.SmallStep.html#8131" class="Bound">t</a><a id="8173" class="Symbol">))</a>
</pre>
VR-1B: The extends the block certified by cert-r−1,
<pre class="Agda">    <a id="8245" href="Peras.SmallStep.html#8245" class="Function">VotingRule-1B</a> <a id="8259" class="Symbol">:</a> <a id="8261" href="Peras.Numbering.html#1035" class="Record">SlotNumber</a> <a id="8272" class="Symbol">→</a> <a id="8274" href="Peras.SmallStep.html#6683" class="Bound">T</a> <a id="8276" class="Symbol">→</a> <a id="8278" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="8286" href="Peras.SmallStep.html#8245" class="Function">VotingRule-1B</a> <a id="8300" href="Peras.SmallStep.html#8300" class="Bound">s</a> <a id="8302" href="Peras.SmallStep.html#8302" class="Bound">t</a> <a id="8304" class="Symbol">=</a> <a id="8306" href="Peras.Chain.html#3484" class="Function">Extends</a> <a id="8314" class="Symbol">(</a><a id="8315" href="Peras.SmallStep.html#7874" class="Function">BlockSelection</a> <a id="8330" href="Peras.SmallStep.html#8300" class="Bound">s</a> <a id="8332" href="Peras.SmallStep.html#8302" class="Bound">t</a><a id="8333" class="Symbol">)</a> <a id="8335" class="Symbol">(</a><a id="8336" href="Peras.SmallStep.html#5922" class="Function">latestCertSeen</a> <a id="8351" href="Peras.SmallStep.html#8302" class="Bound">t</a><a id="8352" class="Symbol">)</a> <a id="8354" class="Symbol">(</a><a id="8355" href="Peras.SmallStep.html#5479" class="Function">chains</a> <a id="8362" href="Peras.SmallStep.html#8302" class="Bound">t</a><a id="8363" class="Symbol">)</a>
</pre>
VR-1: Both VR-1A and VR-1B hold
<pre class="Agda">    <a id="8413" href="Peras.SmallStep.html#8413" class="Function">VotingRule-1</a> <a id="8426" class="Symbol">:</a> <a id="8428" href="Peras.Numbering.html#1035" class="Record">SlotNumber</a> <a id="8439" class="Symbol">→</a> <a id="8441" href="Peras.SmallStep.html#6683" class="Bound">T</a> <a id="8443" class="Symbol">→</a> <a id="8445" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="8453" href="Peras.SmallStep.html#8413" class="Function">VotingRule-1</a> <a id="8466" href="Peras.SmallStep.html#8466" class="Bound">s</a> <a id="8468" href="Peras.SmallStep.html#8468" class="Bound">t</a> <a id="8470" class="Symbol">=</a>
        <a id="8480" href="Peras.SmallStep.html#8073" class="Function">VotingRule-1A</a> <a id="8494" class="Symbol">(</a><a id="8495" href="Peras.Chain.html#4109" class="Function">v-round</a> <a id="8503" href="Peras.SmallStep.html#8466" class="Bound">s</a><a id="8504" class="Symbol">)</a> <a id="8506" href="Peras.SmallStep.html#8468" class="Bound">t</a>
      <a id="8514" href="Haskell.Prim.Tuple.html#169" class="Record Operator">×</a> <a id="8516" href="Peras.SmallStep.html#8245" class="Function">VotingRule-1B</a> <a id="8530" href="Peras.SmallStep.html#8466" class="Bound">s</a> <a id="8532" href="Peras.SmallStep.html#8468" class="Bound">t</a>
</pre>
VR-2A: The last certificate a party has seen is from a round at least R
rounds back
<pre class="Agda">    <a id="8634" href="Peras.SmallStep.html#8634" class="Function">VotingRule-2A</a> <a id="8648" class="Symbol">:</a> <a id="8650" href="Peras.Numbering.html#1962" class="Record">RoundNumber</a> <a id="8662" class="Symbol">→</a> <a id="8664" href="Peras.SmallStep.html#6683" class="Bound">T</a> <a id="8666" class="Symbol">→</a> <a id="8668" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="8676" href="Peras.SmallStep.html#8634" class="Function">VotingRule-2A</a> <a id="8690" class="Symbol">(</a><a id="8691" href="Peras.Numbering.html#2000" class="InductiveConstructor">MkRoundNumber</a> <a id="8705" href="Peras.SmallStep.html#8705" class="Bound">r</a><a id="8706" class="Symbol">)</a> <a id="8708" href="Peras.SmallStep.html#8708" class="Bound">t</a> <a id="8710" class="Symbol">=</a> <a id="8712" href="Peras.SmallStep.html#8705" class="Bound">r</a> <a id="8714" href="Data.Nat.Base.html#2259" class="Function Operator">≥</a> <a id="8716" href="Peras.Block.html#2304" class="Function">roundNumber</a> <a id="8728" class="Symbol">(</a><a id="8729" href="Peras.SmallStep.html#5922" class="Function">latestCertSeen</a> <a id="8744" href="Peras.SmallStep.html#8708" class="Bound">t</a><a id="8745" class="Symbol">)</a> <a id="8747" href="Haskell.Prim.Num.html#547" class="Field Operator">+</a> <a id="8749" href="Peras.Params.html#221" class="Field">R</a>
</pre>
VR-2B: The last certificate included in a party’s current chain is from
a round exactly c⋆K rounds ago for some c : ℕ, c ≥ 0 <!--
<pre class="Agda">    <a id="8897" href="Peras.SmallStep.html#8897" class="Function Operator">_mod_</a> <a id="8903" class="Symbol">:</a> <a id="8905" href="Agda.Builtin.Nat.html#203" class="Datatype">Nat</a> <a id="8909" class="Symbol">→</a> <a id="8911" class="Symbol">(</a><a id="8912" href="Peras.SmallStep.html#8912" class="Bound">n</a> <a id="8914" class="Symbol">:</a> <a id="8916" href="Agda.Builtin.Nat.html#203" class="Datatype">Nat</a><a id="8919" class="Symbol">)</a> <a id="8921" class="Symbol">→</a> <a id="8923" class="Symbol">⦃</a> <a id="8925" href="Data.Nat.Base.html#3260" class="Record">NonZero</a> <a id="8933" href="Peras.SmallStep.html#8912" class="Bound">n</a> <a id="8935" class="Symbol">⦄</a> <a id="8937" class="Symbol">→</a> <a id="8939" href="Agda.Builtin.Nat.html#203" class="Datatype">Nat</a>
    <a id="8947" href="Peras.SmallStep.html#8897" class="Function Operator">_mod_</a> <a id="8953" href="Peras.SmallStep.html#8953" class="Bound">a</a> <a id="8955" href="Peras.SmallStep.html#8955" class="Bound">b</a> <a id="8957" class="Symbol">⦃</a> <a id="8959" href="Peras.SmallStep.html#8959" class="Bound">prf</a> <a id="8963" class="Symbol">⦄</a> <a id="8965" class="Symbol">=</a> <a id="8967" href="Data.Nat.Base.html#7279" class="Function Operator">_%_</a> <a id="8971" href="Peras.SmallStep.html#8953" class="Bound">a</a> <a id="8973" href="Peras.SmallStep.html#8955" class="Bound">b</a> <a id="8975" class="Symbol">⦃</a> <a id="8977" href="Peras.SmallStep.html#8959" class="Bound">prf</a> <a id="8981" class="Symbol">⦄</a>
</pre>-->
<pre class="Agda">    <a id="9003" href="Peras.SmallStep.html#9003" class="Function">VotingRule-2B</a> <a id="9017" class="Symbol">:</a> <a id="9019" href="Peras.Numbering.html#1962" class="Record">RoundNumber</a> <a id="9031" class="Symbol">→</a> <a id="9033" href="Peras.SmallStep.html#6683" class="Bound">T</a> <a id="9035" class="Symbol">→</a> <a id="9037" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="9045" href="Peras.SmallStep.html#9003" class="Function">VotingRule-2B</a> <a id="9059" class="Symbol">(</a><a id="9060" href="Peras.Numbering.html#2000" class="InductiveConstructor">MkRoundNumber</a> <a id="9074" href="Peras.SmallStep.html#9074" class="Bound">r</a><a id="9075" class="Symbol">)</a> <a id="9077" href="Peras.SmallStep.html#9077" class="Bound">t</a> <a id="9079" class="Symbol">=</a>
        <a id="9089" href="Peras.SmallStep.html#9074" class="Bound">r</a> <a id="9091" href="Data.Nat.Base.html#2289" class="Function Operator">&gt;</a> <a id="9093" href="Peras.Block.html#2304" class="Function">roundNumber</a> <a id="9105" class="Symbol">(</a><a id="9106" href="Peras.SmallStep.html#5794" class="Function">latestCertOnChain</a> <a id="9124" href="Peras.SmallStep.html#9077" class="Bound">t</a><a id="9125" class="Symbol">)</a>
      <a id="9133" href="Haskell.Prim.Tuple.html#169" class="Record Operator">×</a> <a id="9135" href="Peras.SmallStep.html#9074" class="Bound">r</a> <a id="9137" href="Peras.SmallStep.html#8897" class="Function Operator">mod</a> <a id="9141" href="Peras.Params.html#207" class="Field">K</a> <a id="9143" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="9145" class="Symbol">(</a><a id="9146" href="Peras.Block.html#2304" class="Function">roundNumber</a> <a id="9158" class="Symbol">(</a><a id="9159" href="Peras.SmallStep.html#5794" class="Function">latestCertOnChain</a> <a id="9177" href="Peras.SmallStep.html#9077" class="Bound">t</a><a id="9178" class="Symbol">))</a> <a id="9181" href="Peras.SmallStep.html#8897" class="Function Operator">mod</a> <a id="9185" href="Peras.Params.html#207" class="Field">K</a>
</pre>
VR-2: Both VR-2A and VR-2B hold
<pre class="Agda">    <a id="9235" href="Peras.SmallStep.html#9235" class="Function">VotingRule-2</a> <a id="9248" class="Symbol">:</a> <a id="9250" href="Peras.Numbering.html#1962" class="Record">RoundNumber</a> <a id="9262" class="Symbol">→</a> <a id="9264" href="Peras.SmallStep.html#6683" class="Bound">T</a> <a id="9266" class="Symbol">→</a> <a id="9268" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="9276" href="Peras.SmallStep.html#9235" class="Function">VotingRule-2</a> <a id="9289" href="Peras.SmallStep.html#9289" class="Bound">r</a> <a id="9291" href="Peras.SmallStep.html#9291" class="Bound">t</a> <a id="9293" class="Symbol">=</a>
        <a id="9303" href="Peras.SmallStep.html#8634" class="Function">VotingRule-2A</a> <a id="9317" href="Peras.SmallStep.html#9289" class="Bound">r</a> <a id="9319" href="Peras.SmallStep.html#9291" class="Bound">t</a>
      <a id="9327" href="Haskell.Prim.Tuple.html#169" class="Record Operator">×</a> <a id="9329" href="Peras.SmallStep.html#9003" class="Function">VotingRule-2B</a> <a id="9343" href="Peras.SmallStep.html#9289" class="Bound">r</a> <a id="9345" href="Peras.SmallStep.html#9291" class="Bound">t</a>
</pre>
If either VR-1A and VR-1B or VR-2A and VR-2B hold, voting is expected
<pre class="Agda">    <a id="9433" href="Peras.SmallStep.html#9433" class="Function">VotingRule</a> <a id="9444" class="Symbol">:</a> <a id="9446" href="Peras.Numbering.html#1035" class="Record">SlotNumber</a> <a id="9457" class="Symbol">→</a> <a id="9459" href="Peras.SmallStep.html#6683" class="Bound">T</a> <a id="9461" class="Symbol">→</a> <a id="9463" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="9471" href="Peras.SmallStep.html#9433" class="Function">VotingRule</a> <a id="9482" href="Peras.SmallStep.html#9482" class="Bound">s</a> <a id="9484" href="Peras.SmallStep.html#9484" class="Bound">t</a> <a id="9486" class="Symbol">=</a>
      <a id="9494" href="Haskell.Prim.Either.html#159" class="Datatype">Either</a>
        <a id="9509" class="Symbol">(</a><a id="9510" href="Peras.SmallStep.html#8413" class="Function">VotingRule-1</a> <a id="9523" href="Peras.SmallStep.html#9482" class="Bound">s</a> <a id="9525" href="Peras.SmallStep.html#9484" class="Bound">t</a><a id="9526" class="Symbol">)</a>
        <a id="9536" class="Symbol">(</a><a id="9537" href="Peras.SmallStep.html#9235" class="Function">VotingRule-2</a> <a id="9550" class="Symbol">(</a><a id="9551" href="Peras.Chain.html#4109" class="Function">v-round</a> <a id="9559" href="Peras.SmallStep.html#9482" class="Bound">s</a><a id="9560" class="Symbol">)</a> <a id="9562" href="Peras.SmallStep.html#9484" class="Bound">t</a><a id="9563" class="Symbol">)</a>
</pre>
<h3 id="state">State</h3>
<p>The small-step semantics rely on a global state, which consists of
the following fields:</p>
<ul>
<li>Current slot of the system</li>
<li>Map with local state per party</li>
<li>All the messages that have been sent but not yet been delivered</li>
<li>All the messages that have been sent</li>
<li>Adversarial state</li>
</ul>
<pre class="Agda">    <a id="9870" class="Keyword">record</a> <a id="9877" href="Peras.SmallStep.html#9877" class="Record">State</a> <a id="9883" class="Symbol">:</a> <a id="9885" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="9889" class="Keyword">where</a>
      <a id="9901" class="Keyword">constructor</a> <a id="9913" href="Peras.SmallStep.html#9913" class="InductiveConstructor Operator">⟦_,_,_,_,_⟧</a>
      <a id="9931" class="Keyword">field</a>
        <a id="9945" href="Peras.SmallStep.html#9945" class="Field">clock</a> <a id="9951" class="Symbol">:</a> <a id="9953" href="Peras.Numbering.html#1035" class="Record">SlotNumber</a>
        <a id="9972" href="Peras.SmallStep.html#9972" class="Field">blockTrees</a> <a id="9983" class="Symbol">:</a> <a id="9985" href="Prelude.AssocList.html#211" class="Function">AssocList</a> <a id="9995" href="Peras.Block.html#842" class="Function">PartyId</a> <a id="10003" href="Peras.SmallStep.html#6683" class="Bound">T</a>
        <a id="10013" href="Peras.SmallStep.html#10013" class="Field">messages</a> <a id="10022" class="Symbol">:</a> <a id="10024" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="10029" href="Peras.SmallStep.html#2651" class="Record">Envelope</a>
        <a id="10046" href="Peras.SmallStep.html#10046" class="Field">history</a> <a id="10054" class="Symbol">:</a> <a id="10056" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="10061" href="Peras.SmallStep.html#2259" class="Datatype">Message</a>
        <a id="10077" href="Peras.SmallStep.html#10077" class="Field">adversarialState</a> <a id="10094" class="Symbol">:</a> <a id="10096" href="Peras.SmallStep.html#6729" class="Bound">S</a>

      <a id="10105" href="Peras.SmallStep.html#10105" class="Function">v-rnd</a> <a id="10111" class="Symbol">:</a> <a id="10113" href="Peras.Numbering.html#1962" class="Record">RoundNumber</a>
      <a id="10131" href="Peras.SmallStep.html#10105" class="Function">v-rnd</a> <a id="10137" class="Symbol">=</a> <a id="10139" href="Peras.Chain.html#4109" class="Function">v-round</a> <a id="10147" href="Peras.SmallStep.html#9945" class="Field">clock</a>

      <a id="10160" href="Peras.SmallStep.html#10160" class="Function">v-rnd&#39;</a> <a id="10167" class="Symbol">:</a> <a id="10169" href="Agda.Builtin.Nat.html#203" class="Datatype">Nat</a>
      <a id="10179" href="Peras.SmallStep.html#10160" class="Function">v-rnd&#39;</a> <a id="10186" class="Symbol">=</a> <a id="10188" href="Peras.Numbering.html#2022" class="Field">getRoundNumber</a> <a id="10203" href="Peras.SmallStep.html#10105" class="Function">v-rnd</a>
</pre>
<h4 id="progress">Progress</h4>
Rather than keeping track of progress, we introduce a predicate stating
that all messages that are not delayed have been delivered. This is a
precondition that must hold before transitioning to the next slot.
<pre class="Agda">    <a id="10449" href="Peras.SmallStep.html#10449" class="Function">Fetched</a> <a id="10457" class="Symbol">:</a> <a id="10459" href="Peras.SmallStep.html#9877" class="Record">State</a> <a id="10465" class="Symbol">→</a> <a id="10467" href="Agda.Primitive.html#388" class="Primitive">Set</a>
    <a id="10475" href="Peras.SmallStep.html#10449" class="Function">Fetched</a> <a id="10483" href="Peras.SmallStep.html#10483" class="Bound">s</a> <a id="10485" class="Symbol">=</a> <a id="10487" href="Haskell.Prim.html#2804" class="Datatype">All</a> <a id="10491" class="Symbol">(λ</a> <a id="10494" class="Symbol">{</a> <a id="10496" href="Peras.SmallStep.html#10496" class="Bound">z</a> <a id="10498" class="Symbol">→</a> <a id="10500" href="Peras.SmallStep.html#2794" class="Field">delay</a> <a id="10506" href="Peras.SmallStep.html#10496" class="Bound">z</a> <a id="10508" href="Relation.Binary.PropositionalEquality.Core.html#858" class="Function Operator">≢</a> <a id="10510" href="Peras.SmallStep.html#2476" class="InductiveConstructor">𝟘</a> <a id="10512" class="Symbol">})</a> <a id="10515" class="Symbol">(</a><a id="10516" href="Peras.SmallStep.html#10013" class="Field">messages</a> <a id="10525" href="Peras.SmallStep.html#10483" class="Bound">s</a><a id="10526" class="Symbol">)</a>
      <a id="10534" class="Keyword">where</a> <a id="10540" class="Keyword">open</a> <a id="10545" href="Peras.SmallStep.html#9877" class="Module">State</a>
</pre>
Ticking the global clock increments the slot number and decrements the
delay of all the messages in the message buffer.
<pre class="Agda">    <a id="10687" href="Peras.SmallStep.html#10687" class="Function">tick</a> <a id="10692" class="Symbol">:</a> <a id="10694" href="Peras.SmallStep.html#9877" class="Record">State</a> <a id="10700" class="Symbol">→</a> <a id="10702" href="Peras.SmallStep.html#9877" class="Record">State</a>
    <a id="10712" href="Peras.SmallStep.html#10687" class="Function">tick</a> <a id="10717" href="Peras.SmallStep.html#10717" class="Bound">M</a> <a id="10719" class="Symbol">=</a>
      <a id="10727" class="Keyword">record</a> <a id="10734" href="Peras.SmallStep.html#10717" class="Bound">M</a>
        <a id="10744" class="Symbol">{</a> <a id="10746" href="Peras.SmallStep.html#9945" class="Field">clock</a> <a id="10752" class="Symbol">=</a> <a id="10754" href="Peras.Numbering.html#1114" class="Function">next</a> <a id="10759" href="Peras.SmallStep.html#9945" class="Field">clock</a>
        <a id="10773" class="Symbol">;</a> <a id="10775" href="Peras.SmallStep.html#10013" class="Field">messages</a> <a id="10784" class="Symbol">=</a>
            <a id="10798" href="Haskell.Prim.List.html#211" class="Function">map</a> <a id="10802" class="Symbol">(λ</a> <a id="10805" class="Keyword">where</a> <a id="10811" href="Peras.SmallStep.html#10811" class="Bound">e</a> <a id="10813" class="Symbol">→</a> <a id="10815" class="Keyword">record</a> <a id="10822" href="Peras.SmallStep.html#10811" class="Bound">e</a> <a id="10824" class="Symbol">{</a> <a id="10826" href="Peras.SmallStep.html#2794" class="Field">delay</a> <a id="10832" class="Symbol">=</a> <a id="10834" href="Data.Fin.Base.html#6461" class="Function">Data.Fin.pred</a> <a id="10848" class="Symbol">(</a><a id="10849" href="Peras.SmallStep.html#2794" class="Field">delay</a> <a id="10855" href="Peras.SmallStep.html#10811" class="Bound">e</a><a id="10856" class="Symbol">)</a> <a id="10858" class="Symbol">})</a>
              <a id="10875" href="Peras.SmallStep.html#10013" class="Field">messages</a>
        <a id="10892" class="Symbol">}</a>
      <a id="10900" class="Keyword">where</a> <a id="10906" class="Keyword">open</a> <a id="10911" href="Peras.SmallStep.html#9877" class="Module">State</a> <a id="10917" href="Peras.SmallStep.html#10717" class="Bound">M</a>
</pre>
Updating the global state inserting the updated block-tree for a given
party, adding messages to the message buffer for the other parties and
appending the history
<pre class="Agda">    <a id="11099" href="Peras.SmallStep.html#11099" class="Function Operator">_,_⇑_</a> <a id="11105" class="Symbol">:</a> <a id="11107" href="Peras.SmallStep.html#2259" class="Datatype">Message</a> <a id="11115" class="Symbol">→</a> <a id="11117" class="Symbol">(</a><a id="11118" href="Peras.Block.html#842" class="Function">PartyId</a> <a id="11126" class="Symbol">→</a> <a id="11128" href="Peras.SmallStep.html#2439" class="Function">Delay</a><a id="11133" class="Symbol">)</a> <a id="11135" class="Symbol">→</a> <a id="11137" href="Peras.SmallStep.html#9877" class="Record">State</a> <a id="11143" class="Symbol">→</a> <a id="11145" href="Peras.SmallStep.html#9877" class="Record">State</a>
    <a id="11155" href="Peras.SmallStep.html#11155" class="Bound">m</a> <a id="11157" href="Peras.SmallStep.html#11099" class="Function Operator">,</a> <a id="11159" href="Peras.SmallStep.html#11159" class="Bound">fᵈ</a> <a id="11162" href="Peras.SmallStep.html#11099" class="Function Operator">⇑</a> <a id="11164" href="Peras.SmallStep.html#11164" class="Bound">M</a> <a id="11166" class="Symbol">=</a>
      <a id="11174" class="Keyword">record</a> <a id="11181" href="Peras.SmallStep.html#11164" class="Bound">M</a>
        <a id="11191" class="Symbol">{</a> <a id="11193" href="Peras.SmallStep.html#10013" class="Field">messages</a> <a id="11202" class="Symbol">=</a>
            <a id="11216" href="Haskell.Prim.List.html#211" class="Function">map</a> <a id="11220" class="Symbol">(λ</a> <a id="11223" class="Symbol">(</a><a id="11224" href="Peras.SmallStep.html#11224" class="Bound">p</a> <a id="11226" href="Peras.SmallStep.html#637" class="InductiveConstructor Operator">,ᵖ</a> <a id="11229" href="Peras.SmallStep.html#11229" class="Bound">h</a><a id="11230" class="Symbol">)</a> <a id="11232" class="Symbol">→</a> <a id="11234" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦅</a> <a id="11236" href="Peras.SmallStep.html#11224" class="Bound">p</a> <a id="11238" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="11240" href="Peras.SmallStep.html#11229" class="Bound">h</a> <a id="11242" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="11244" href="Peras.SmallStep.html#11155" class="Bound">m</a> <a id="11246" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="11248" href="Peras.SmallStep.html#11159" class="Bound">fᵈ</a> <a id="11251" href="Peras.SmallStep.html#11224" class="Bound">p</a> <a id="11253" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦆</a><a id="11254" class="Symbol">)</a> <a id="11256" href="Peras.SmallStep.html#6832" class="Bound">parties</a>
              <a id="11278" href="Haskell.Prim.List.html#310" class="Function Operator">++</a> <a id="11281" href="Peras.SmallStep.html#10013" class="Field">messages</a>

        <a id="11299" class="Symbol">;</a> <a id="11301" href="Peras.SmallStep.html#10046" class="Field">history</a> <a id="11309" class="Symbol">=</a> <a id="11311" href="Peras.SmallStep.html#11155" class="Bound">m</a> <a id="11313" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="11315" href="Peras.SmallStep.html#10046" class="Field">history</a>
        <a id="11331" class="Symbol">}</a>
      <a id="11339" class="Keyword">where</a> <a id="11345" class="Keyword">open</a> <a id="11350" href="Peras.SmallStep.html#9877" class="Module">State</a> <a id="11356" href="Peras.SmallStep.html#11164" class="Bound">M</a>

    <a id="11363" href="Peras.SmallStep.html#11363" class="Function Operator">delay_by_update_</a> <a id="11380" class="Symbol">:</a> <a id="11382" href="Peras.SmallStep.html#2259" class="Datatype">Message</a> <a id="11390" class="Symbol">→</a> <a id="11392" class="Symbol">(</a><a id="11393" href="Peras.Block.html#842" class="Function">PartyId</a> <a id="11401" class="Symbol">→</a> <a id="11403" href="Peras.SmallStep.html#2439" class="Function">Delay</a><a id="11408" class="Symbol">)</a> <a id="11410" class="Symbol">→</a> <a id="11412" href="Peras.SmallStep.html#9877" class="Record">State</a> <a id="11418" class="Symbol">→</a> <a id="11420" href="Peras.SmallStep.html#9877" class="Record">State</a>
    <a id="11430" href="Peras.SmallStep.html#11363" class="Function Operator">delay</a> <a id="11436" href="Peras.SmallStep.html#11436" class="Bound">m</a><a id="11437" class="Symbol">@(</a><a id="11439" href="Peras.SmallStep.html#2283" class="InductiveConstructor">ChainMsg</a> <a id="11448" href="Peras.SmallStep.html#11448" class="Bound">x</a><a id="11449" class="Symbol">)</a> <a id="11451" href="Peras.SmallStep.html#11363" class="Function Operator">by</a> <a id="11454" href="Peras.SmallStep.html#11454" class="Bound">fᵈ</a> <a id="11457" href="Peras.SmallStep.html#11363" class="Function Operator">update</a> <a id="11464" href="Peras.SmallStep.html#11464" class="Bound">M</a> <a id="11466" class="Symbol">=</a> <a id="11468" href="Peras.SmallStep.html#11436" class="Bound">m</a> <a id="11470" href="Peras.SmallStep.html#11099" class="Function Operator">,</a> <a id="11472" href="Peras.SmallStep.html#11454" class="Bound">fᵈ</a> <a id="11475" href="Peras.SmallStep.html#11099" class="Function Operator">⇑</a> <a id="11477" href="Peras.SmallStep.html#11464" class="Bound">M</a>
    <a id="11483" href="Peras.SmallStep.html#11363" class="Function Operator">delay</a> <a id="11489" href="Peras.SmallStep.html#11489" class="Bound">m</a><a id="11490" class="Symbol">@(</a><a id="11492" href="Peras.SmallStep.html#2335" class="InductiveConstructor">VoteMsg</a> <a id="11500" href="Peras.SmallStep.html#11500" class="Bound">x</a><a id="11501" class="Symbol">)</a> <a id="11503" href="Peras.SmallStep.html#11363" class="Function Operator">by</a> <a id="11506" href="Peras.SmallStep.html#11506" class="Bound">fᵈ</a> <a id="11509" href="Peras.SmallStep.html#11363" class="Function Operator">update</a> <a id="11516" href="Peras.SmallStep.html#11516" class="Bound">M</a> <a id="11518" class="Symbol">=</a> <a id="11520" href="Peras.SmallStep.html#11489" class="Bound">m</a> <a id="11522" href="Peras.SmallStep.html#11099" class="Function Operator">,</a> <a id="11524" href="Peras.SmallStep.html#11506" class="Bound">fᵈ</a> <a id="11527" href="Peras.SmallStep.html#11099" class="Function Operator">⇑</a> <a id="11529" href="Peras.SmallStep.html#11516" class="Bound">M</a>
</pre>
<h2 id="fetching">Fetching</h2>
<p>A party receives messages from the global state by fetching messages
assigned to the party, updating the local block tree and putting the
local state back into the global state.</p>
<pre class="Agda">    <a id="11739" class="Keyword">data</a> <a id="11744" href="Peras.SmallStep.html#11744" class="Datatype Operator">_⊢_[_]⇀_</a> <a id="11753" class="Symbol">:</a> <a id="11755" class="Symbol">{</a><a id="11756" href="Peras.SmallStep.html#11756" class="Bound">p</a> <a id="11758" class="Symbol">:</a> <a id="11760" href="Peras.Block.html#842" class="Function">PartyId</a><a id="11767" class="Symbol">}</a> <a id="11769" class="Symbol">→</a> <a id="11771" href="Peras.Block.html#1406" class="Datatype">Honesty</a> <a id="11779" href="Peras.SmallStep.html#11756" class="Bound">p</a> <a id="11781" class="Symbol">→</a> <a id="11783" href="Peras.SmallStep.html#9877" class="Record">State</a> <a id="11789" class="Symbol">→</a> <a id="11791" href="Peras.SmallStep.html#2259" class="Datatype">Message</a> <a id="11799" class="Symbol">→</a> <a id="11801" href="Peras.SmallStep.html#9877" class="Record">State</a> <a id="11807" class="Symbol">→</a> <a id="11809" href="Agda.Primitive.html#388" class="Primitive">Set</a>
      <a id="11819" class="Keyword">where</a>
</pre>
An honest party consumes a message from the global message buffer and
updates the local state
<pre class="Agda">      <a id="11937" href="Peras.SmallStep.html#11937" class="InductiveConstructor">honest</a> <a id="11944" class="Symbol">:</a> <a id="11946" class="Symbol">∀</a> <a id="11948" class="Symbol">{</a><a id="11949" href="Peras.SmallStep.html#11949" class="Bound">p</a><a id="11950" class="Symbol">}</a> <a id="11952" class="Symbol">{</a><a id="11953" href="Peras.SmallStep.html#11953" class="Bound">t</a> <a id="11955" href="Peras.SmallStep.html#11955" class="Bound">t′</a><a id="11957" class="Symbol">}</a> <a id="11959" class="Symbol">{</a><a id="11960" href="Peras.SmallStep.html#11960" class="Bound">m</a><a id="11961" class="Symbol">}</a> <a id="11963" class="Symbol">{</a><a id="11964" href="Peras.SmallStep.html#11964" class="Bound">N</a><a id="11965" class="Symbol">}</a> <a id="11967" class="Symbol">→</a> <a id="11969" class="Keyword">let</a> <a id="11973" class="Keyword">open</a> <a id="11978" href="Peras.SmallStep.html#9877" class="Module">State</a> <a id="11984" href="Peras.SmallStep.html#11964" class="Bound">N</a> <a id="11986" class="Keyword">in</a>
          <a id="11999" href="Peras.SmallStep.html#9972" class="Field">blockTrees</a> <a id="12010" href="Prelude.AssocList.html#847" class="Function Operator">⁉</a> <a id="12012" href="Peras.SmallStep.html#11949" class="Bound">p</a> <a id="12014" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="12016" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="12021" href="Peras.SmallStep.html#11953" class="Bound">t</a>
        <a id="12031" class="Symbol">→</a> <a id="12033" class="Symbol">(</a><a id="12034" href="Peras.SmallStep.html#12034" class="Bound">m∈ms</a> <a id="12039" class="Symbol">:</a> <a id="12041" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦅</a> <a id="12043" href="Peras.SmallStep.html#11949" class="Bound">p</a> <a id="12045" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="12047" href="Peras.Block.html#1439" class="InductiveConstructor">Honest</a> <a id="12054" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="12056" href="Peras.SmallStep.html#11960" class="Bound">m</a> <a id="12058" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="12060" href="Peras.SmallStep.html#2476" class="InductiveConstructor">𝟘</a> <a id="12062" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦆</a> <a id="12064" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="12066" href="Peras.SmallStep.html#10013" class="Field">messages</a><a id="12074" class="Symbol">)</a>
        <a id="12084" class="Symbol">→</a> <a id="12086" href="Peras.SmallStep.html#11953" class="Bound">t</a> <a id="12088" href="Peras.SmallStep.html#7214" class="Datatype Operator">[</a> <a id="12090" href="Peras.SmallStep.html#11960" class="Bound">m</a> <a id="12092" href="Peras.SmallStep.html#7214" class="Datatype Operator">]→</a> <a id="12095" href="Peras.SmallStep.html#11955" class="Bound">t′</a>
          <a id="12108" class="Comment">---------------------------------------------</a>
        <a id="12162" class="Symbol">→</a> <a id="12164" href="Peras.Block.html#1439" class="InductiveConstructor">Honest</a> <a id="12171" class="Symbol">{</a><a id="12172" href="Peras.SmallStep.html#11949" class="Bound">p</a><a id="12173" class="Symbol">}</a> <a id="12175" href="Peras.SmallStep.html#11744" class="Datatype Operator">⊢</a>
          <a id="12187" href="Peras.SmallStep.html#11964" class="Bound">N</a> <a id="12189" href="Peras.SmallStep.html#11744" class="Datatype Operator">[</a> <a id="12191" href="Peras.SmallStep.html#11960" class="Bound">m</a> <a id="12193" href="Peras.SmallStep.html#11744" class="Datatype Operator">]⇀</a> <a id="12196" class="Keyword">record</a> <a id="12203" href="Peras.SmallStep.html#11964" class="Bound">N</a>
            <a id="12217" class="Symbol">{</a> <a id="12219" href="Peras.SmallStep.html#9972" class="Field">blockTrees</a> <a id="12230" class="Symbol">=</a> <a id="12232" href="Prelude.AssocList.html#1398" class="Function">set</a> <a id="12236" href="Peras.SmallStep.html#11949" class="Bound">p</a> <a id="12238" href="Peras.SmallStep.html#11955" class="Bound">t′</a> <a id="12241" href="Peras.SmallStep.html#9972" class="Field">blockTrees</a>
            <a id="12264" class="Symbol">;</a> <a id="12266" href="Peras.SmallStep.html#10013" class="Field">messages</a> <a id="12275" class="Symbol">=</a> <a id="12277" href="Peras.SmallStep.html#10013" class="Field">messages</a> <a id="12286" href="Data.List.Membership.Setoid.html#1155" class="Function Operator">─</a> <a id="12288" href="Peras.SmallStep.html#12034" class="Bound">m∈ms</a>
            <a id="12305" class="Symbol">}</a>
</pre>
An adversarial party might delay a message
<pre class="Agda">      <a id="12368" href="Peras.SmallStep.html#12368" class="InductiveConstructor">corrupt</a> <a id="12376" class="Symbol">:</a> <a id="12378" class="Symbol">∀</a> <a id="12380" class="Symbol">{</a><a id="12381" href="Peras.SmallStep.html#12381" class="Bound">p</a><a id="12382" class="Symbol">}</a> <a id="12384" class="Symbol">{</a><a id="12385" href="Peras.SmallStep.html#12385" class="Bound">as</a><a id="12387" class="Symbol">}</a> <a id="12389" class="Symbol">{</a><a id="12390" href="Peras.SmallStep.html#12390" class="Bound">m</a><a id="12391" class="Symbol">}</a> <a id="12393" class="Symbol">{</a><a id="12394" href="Peras.SmallStep.html#12394" class="Bound">N</a><a id="12395" class="Symbol">}</a> <a id="12397" class="Symbol">→</a> <a id="12399" class="Keyword">let</a> <a id="12403" class="Keyword">open</a> <a id="12408" href="Peras.SmallStep.html#9877" class="Module">State</a> <a id="12414" href="Peras.SmallStep.html#12394" class="Bound">N</a> <a id="12416" class="Keyword">in</a>
          <a id="12429" class="Symbol">(</a><a id="12430" href="Peras.SmallStep.html#12430" class="Bound">m∈ms</a> <a id="12435" class="Symbol">:</a> <a id="12437" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦅</a> <a id="12439" href="Peras.SmallStep.html#12381" class="Bound">p</a> <a id="12441" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="12443" href="Peras.Block.html#1483" class="InductiveConstructor">Corrupt</a> <a id="12451" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="12453" href="Peras.SmallStep.html#12390" class="Bound">m</a> <a id="12455" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="12457" href="Peras.SmallStep.html#2476" class="InductiveConstructor">𝟘</a> <a id="12459" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦆</a> <a id="12461" href="Data.List.Membership.Setoid.html#950" class="Function Operator">∈</a> <a id="12463" href="Peras.SmallStep.html#10013" class="Field">messages</a><a id="12471" class="Symbol">)</a>
          <a id="12483" class="Comment">----------------------------------------------</a>
        <a id="12538" class="Symbol">→</a> <a id="12540" href="Peras.Block.html#1483" class="InductiveConstructor">Corrupt</a> <a id="12548" class="Symbol">{</a><a id="12549" href="Peras.SmallStep.html#12381" class="Bound">p</a><a id="12550" class="Symbol">}</a> <a id="12552" href="Peras.SmallStep.html#11744" class="Datatype Operator">⊢</a>
          <a id="12564" href="Peras.SmallStep.html#12394" class="Bound">N</a> <a id="12566" href="Peras.SmallStep.html#11744" class="Datatype Operator">[</a> <a id="12568" href="Peras.SmallStep.html#12390" class="Bound">m</a> <a id="12570" href="Peras.SmallStep.html#11744" class="Datatype Operator">]⇀</a> <a id="12573" class="Keyword">record</a> <a id="12580" href="Peras.SmallStep.html#12394" class="Bound">N</a>
            <a id="12594" class="Symbol">{</a> <a id="12596" href="Peras.SmallStep.html#10013" class="Field">messages</a> <a id="12605" class="Symbol">=</a> <a id="12607" href="Peras.SmallStep.html#12430" class="Bound">m∈ms</a> <a id="12612" href="Peras.SmallStep.html#337" class="Function Operator">∷ˡ=</a> <a id="12616" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦅</a> <a id="12618" href="Peras.SmallStep.html#12381" class="Bound">p</a> <a id="12620" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="12622" href="Peras.Block.html#1483" class="InductiveConstructor">Corrupt</a> <a id="12630" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="12632" href="Peras.SmallStep.html#12390" class="Bound">m</a> <a id="12634" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">,</a> <a id="12636" href="Peras.SmallStep.html#2496" class="InductiveConstructor">𝟙</a> <a id="12638" href="Peras.SmallStep.html#2688" class="InductiveConstructor Operator">⦆</a>
            <a id="12652" class="Symbol">;</a> <a id="12654" href="Peras.SmallStep.html#10077" class="Field">adversarialState</a> <a id="12671" class="Symbol">=</a> <a id="12673" href="Peras.SmallStep.html#12385" class="Bound">as</a>
            <a id="12688" class="Symbol">}</a>
</pre>
<h2 id="voting">Voting</h2>
Helper function for creating a vote
<pre class="Agda">    <a id="12753" href="Peras.SmallStep.html#12753" class="Function">createVote</a> <a id="12764" class="Symbol">:</a> <a id="12766" href="Peras.Numbering.html#1035" class="Record">SlotNumber</a> <a id="12777" class="Symbol">→</a> <a id="12779" href="Peras.Block.html#842" class="Function">PartyId</a> <a id="12787" class="Symbol">→</a> <a id="12789" href="Peras.Crypto.html#2454" class="Record">MembershipProof</a> <a id="12805" class="Symbol">→</a> <a id="12807" href="Peras.Crypto.html#3408" class="Record">Signature</a> <a id="12817" class="Symbol">→</a> <a id="12819" href="Peras.Crypto.html#1835" class="Record">Hash</a> <a id="12824" href="Peras.Block.html#2100" class="Record">Block</a> <a id="12830" class="Symbol">→</a> <a id="12832" href="Peras.Chain.html#899" class="Record">Vote</a>
    <a id="12841" href="Peras.SmallStep.html#12753" class="Function">createVote</a> <a id="12852" href="Peras.SmallStep.html#12852" class="Bound">s</a> <a id="12854" href="Peras.SmallStep.html#12854" class="Bound">p</a> <a id="12856" href="Peras.SmallStep.html#12856" class="Bound">prf</a> <a id="12860" href="Peras.SmallStep.html#12860" class="Bound">sig</a> <a id="12864" href="Peras.SmallStep.html#12864" class="Bound">hb</a> <a id="12867" class="Symbol">=</a>
      <a id="12875" class="Keyword">record</a>
        <a id="12890" class="Symbol">{</a> <a id="12892" href="Peras.Chain.html#945" class="Field">votingRound</a> <a id="12904" class="Symbol">=</a> <a id="12906" href="Peras.Chain.html#4109" class="Function">v-round</a> <a id="12914" href="Peras.SmallStep.html#12852" class="Bound">s</a>
        <a id="12924" class="Symbol">;</a> <a id="12926" href="Peras.Chain.html#979" class="Field">creatorId</a> <a id="12936" class="Symbol">=</a> <a id="12938" href="Peras.SmallStep.html#12854" class="Bound">p</a>
        <a id="12948" class="Symbol">;</a> <a id="12950" href="Peras.Chain.html#1009" class="Field">proofM</a> <a id="12957" class="Symbol">=</a> <a id="12959" href="Peras.SmallStep.html#12856" class="Bound">prf</a>
        <a id="12971" class="Symbol">;</a> <a id="12973" href="Peras.Chain.html#1047" class="Field">blockHash</a> <a id="12983" class="Symbol">=</a> <a id="12985" href="Peras.SmallStep.html#12864" class="Bound">hb</a>
        <a id="12996" class="Symbol">;</a> <a id="12998" href="Peras.Chain.html#1080" class="Field">signature</a> <a id="13008" class="Symbol">=</a> <a id="13010" href="Peras.SmallStep.html#12860" class="Bound">sig</a>
        <a id="13022" class="Symbol">}</a>
</pre>
<p>A party can vote for a block, if * the current slot is the first slot
in a voting round * the party is a member of the voting committee * the
chain is not in a cool-down phase</p>
Voting updates the party’s local state and for all other parties a
message is added to be consumed immediately.
<pre class="Agda">    <a id="13335" class="Keyword">infix</a> <a id="13341" class="Number">2</a> <a id="13343" href="Peras.SmallStep.html#13359" class="Datatype Operator">_⊢_⇉_</a>

    <a id="13354" class="Keyword">data</a> <a id="13359" href="Peras.SmallStep.html#13359" class="Datatype Operator">_⊢_⇉_</a> <a id="13365" class="Symbol">:</a> <a id="13367" class="Symbol">{</a><a id="13368" href="Peras.SmallStep.html#13368" class="Bound">p</a> <a id="13370" class="Symbol">:</a> <a id="13372" href="Peras.Block.html#842" class="Function">PartyId</a><a id="13379" class="Symbol">}</a> <a id="13381" class="Symbol">→</a> <a id="13383" href="Peras.Block.html#1406" class="Datatype">Honesty</a> <a id="13391" href="Peras.SmallStep.html#13368" class="Bound">p</a> <a id="13393" class="Symbol">→</a> <a id="13395" href="Peras.SmallStep.html#9877" class="Record">State</a> <a id="13401" class="Symbol">→</a> <a id="13403" href="Peras.SmallStep.html#9877" class="Record">State</a> <a id="13409" class="Symbol">→</a> <a id="13411" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="13415" class="Keyword">where</a>

      <a id="13428" href="Peras.SmallStep.html#13428" class="InductiveConstructor">honest</a> <a id="13435" class="Symbol">:</a> <a id="13437" class="Symbol">∀</a> <a id="13439" class="Symbol">{</a><a id="13440" href="Peras.SmallStep.html#13440" class="Bound">p</a><a id="13441" class="Symbol">}</a> <a id="13443" class="Symbol">{</a><a id="13444" href="Peras.SmallStep.html#13444" class="Bound">t</a><a id="13445" class="Symbol">}</a> <a id="13447" class="Symbol">{</a><a id="13448" href="Peras.SmallStep.html#13448" class="Bound">M</a><a id="13449" class="Symbol">}</a> <a id="13451" class="Symbol">{</a><a id="13452" href="Peras.SmallStep.html#13452" class="Bound">π</a><a id="13453" class="Symbol">}</a> <a id="13455" class="Symbol">{</a><a id="13456" href="Peras.SmallStep.html#13456" class="Bound">σ</a><a id="13457" class="Symbol">}</a> <a id="13459" class="Symbol">{</a><a id="13460" href="Peras.SmallStep.html#13460" class="Bound">b</a><a id="13461" class="Symbol">}</a>
        <a id="13471" class="Symbol">→</a> <a id="13473" class="Keyword">let</a>
            <a id="13489" class="Keyword">open</a> <a id="13494" href="Peras.SmallStep.html#9877" class="Module">State</a>
            <a id="13512" href="Peras.SmallStep.html#13512" class="Bound">s</a> <a id="13514" class="Symbol">=</a> <a id="13516" href="Peras.SmallStep.html#9945" class="Field">clock</a> <a id="13522" href="Peras.SmallStep.html#13448" class="Bound">M</a>
            <a id="13536" href="Peras.SmallStep.html#13536" class="Bound">r</a> <a id="13538" class="Symbol">=</a> <a id="13540" href="Peras.Chain.html#4109" class="Function">v-round</a> <a id="13548" href="Peras.SmallStep.html#13512" class="Bound">s</a>
            <a id="13562" href="Peras.SmallStep.html#13562" class="Bound">v</a> <a id="13564" class="Symbol">=</a> <a id="13566" href="Peras.SmallStep.html#12753" class="Function">createVote</a> <a id="13577" href="Peras.SmallStep.html#13512" class="Bound">s</a> <a id="13579" href="Peras.SmallStep.html#13440" class="Bound">p</a> <a id="13581" href="Peras.SmallStep.html#13452" class="Bound">π</a> <a id="13583" href="Peras.SmallStep.html#13456" class="Bound">σ</a> <a id="13585" href="Peras.SmallStep.html#13460" class="Bound">b</a>
          <a id="13597" class="Keyword">in</a>
          <a id="13610" href="Peras.SmallStep.html#7874" class="Function">BlockSelection</a> <a id="13625" href="Peras.SmallStep.html#13512" class="Bound">s</a> <a id="13627" href="Peras.SmallStep.html#13444" class="Bound">t</a> <a id="13629" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="13631" href="Peras.SmallStep.html#13460" class="Bound">b</a>
        <a id="13641" class="Symbol">→</a> <a id="13643" href="Peras.SmallStep.html#9972" class="Field">blockTrees</a> <a id="13654" href="Peras.SmallStep.html#13448" class="Bound">M</a> <a id="13656" href="Prelude.AssocList.html#847" class="Function Operator">⁉</a> <a id="13658" href="Peras.SmallStep.html#13440" class="Bound">p</a> <a id="13660" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="13662" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="13667" href="Peras.SmallStep.html#13444" class="Bound">t</a>
        <a id="13677" class="Symbol">→</a> <a id="13679" class="Symbol">(</a><a id="13680" href="Peras.SmallStep.html#13680" class="Bound">sig</a> <a id="13684" class="Symbol">:</a> <a id="13686" href="Peras.Chain.html#1896" class="Field">IsVoteSignature</a> <a id="13702" href="Peras.SmallStep.html#13562" class="Bound">v</a> <a id="13704" href="Peras.SmallStep.html#13456" class="Bound">σ</a><a id="13705" class="Symbol">)</a>
        <a id="13715" class="Symbol">→</a> <a id="13717" href="Peras.Chain.html#3919" class="Function">StartOfRound</a> <a id="13730" href="Peras.SmallStep.html#13512" class="Bound">s</a> <a id="13732" href="Peras.SmallStep.html#13536" class="Bound">r</a>
        <a id="13742" class="Symbol">→</a> <a id="13744" class="Symbol">(</a><a id="13745" href="Peras.SmallStep.html#13745" class="Bound">mem</a> <a id="13749" class="Symbol">:</a> <a id="13751" href="Peras.Chain.html#1779" class="Field">IsCommitteeMember</a> <a id="13769" href="Peras.SmallStep.html#13440" class="Bound">p</a> <a id="13771" href="Peras.SmallStep.html#13536" class="Bound">r</a> <a id="13773" href="Peras.SmallStep.html#13452" class="Bound">π</a><a id="13774" class="Symbol">)</a>
        <a id="13784" class="Symbol">→</a> <a id="13786" href="Peras.SmallStep.html#9433" class="Function">VotingRule</a> <a id="13797" href="Peras.SmallStep.html#13512" class="Bound">s</a> <a id="13799" href="Peras.SmallStep.html#13444" class="Bound">t</a>
        <a id="13809" class="Symbol">→</a> <a id="13811" class="Symbol">(</a><a id="13812" href="Peras.SmallStep.html#13812" class="Bound">fᵈ</a> <a id="13815" class="Symbol">:</a> <a id="13817" href="Peras.Block.html#842" class="Function">PartyId</a> <a id="13825" class="Symbol">→</a> <a id="13827" href="Peras.SmallStep.html#2439" class="Function">Delay</a><a id="13832" class="Symbol">)</a>
          <a id="13844" class="Comment">----------------------------------------------</a>
        <a id="13899" class="Symbol">→</a> <a id="13901" href="Peras.Block.html#1439" class="InductiveConstructor">Honest</a> <a id="13908" class="Symbol">{</a><a id="13909" href="Peras.SmallStep.html#13440" class="Bound">p</a><a id="13910" class="Symbol">}</a> <a id="13912" href="Peras.SmallStep.html#13359" class="Datatype Operator">⊢</a>
            <a id="13926" href="Peras.SmallStep.html#13448" class="Bound">M</a> <a id="13928" href="Peras.SmallStep.html#13359" class="Datatype Operator">⇉</a> <a id="13930" href="Peras.SmallStep.html#11363" class="Function Operator">delay</a> <a id="13936" href="Peras.SmallStep.html#2335" class="InductiveConstructor">VoteMsg</a> <a id="13944" class="Symbol">(</a><a id="13945" href="Peras.SmallStep.html#13745" class="Bound">mem</a> <a id="13949" href="Haskell.Prim.Tuple.html#211" class="InductiveConstructor Operator">,</a> <a id="13951" href="Peras.SmallStep.html#13680" class="Bound">sig</a><a id="13954" class="Symbol">)</a> <a id="13956" href="Peras.SmallStep.html#11363" class="Function Operator">by</a> <a id="13959" href="Peras.SmallStep.html#13812" class="Bound">fᵈ</a>
                 <a id="13979" href="Peras.SmallStep.html#11363" class="Function Operator">update</a> <a id="13986" href="Peras.SmallStep.html#13448" class="Bound">M</a>
</pre>
<p>Rather than creating a delayed vote, an adversary can honestly create
it and delay the message.</p>
<h2 id="block-creation">Block creation</h2>
<p>Certificates are conditionally added to a block. The following
function determines if there needs to be a certificate provided for a
given voting round and a local block-tree. The conditions are as
follows</p>
<ol type="a">
<li>There is no certificate from 2 rounds ago in certs</li>
<li>The last seen certificate is not expired</li>
<li>The last seen certificate is from a later round than the last
certificate on chain</li>
</ol>
<pre class="Agda">    <a id="14515" href="Peras.SmallStep.html#14515" class="Function">needCert</a> <a id="14524" class="Symbol">:</a> <a id="14526" href="Peras.Numbering.html#1962" class="Record">RoundNumber</a> <a id="14538" class="Symbol">→</a> <a id="14540" href="Peras.SmallStep.html#6683" class="Bound">T</a> <a id="14542" class="Symbol">→</a> <a id="14544" href="Haskell.Prim.Maybe.html#101" class="Datatype">Maybe</a> <a id="14550" href="Peras.Block.html#2142" class="Record">Certificate</a>
    <a id="14566" href="Peras.SmallStep.html#14515" class="Function">needCert</a> <a id="14575" class="Symbol">(</a><a id="14576" href="Peras.Numbering.html#2000" class="InductiveConstructor">MkRoundNumber</a> <a id="14590" href="Peras.SmallStep.html#14590" class="Bound">r</a><a id="14591" class="Symbol">)</a> <a id="14593" href="Peras.SmallStep.html#14593" class="Bound">t</a> <a id="14595" class="Symbol">=</a>
      <a id="14603" class="Keyword">let</a>
        <a id="14615" href="Peras.SmallStep.html#14615" class="Bound">cert⋆</a> <a id="14621" class="Symbol">=</a> <a id="14623" href="Peras.SmallStep.html#5794" class="Function">latestCertOnChain</a> <a id="14641" href="Peras.SmallStep.html#14593" class="Bound">t</a>
        <a id="14651" href="Peras.SmallStep.html#14651" class="Bound">cert′</a> <a id="14657" class="Symbol">=</a> <a id="14659" href="Peras.SmallStep.html#5922" class="Function">latestCertSeen</a> <a id="14674" href="Peras.SmallStep.html#14593" class="Bound">t</a>
      <a id="14682" class="Keyword">in</a>
        <a id="14693" href="Haskell.Prim.html#1713" class="Function Operator">if</a> <a id="14696" href="Haskell.Prim.Bool.html#273" class="Function">not</a> <a id="14700" class="Symbol">(</a><a id="14701" href="Haskell.Prim.Foldable.html#604" class="Field">any</a> <a id="14705" class="Symbol">(λ</a> <a id="14708" href="Peras.SmallStep.html#14708" class="Bound">c</a> <a id="14710" class="Symbol">→</a> <a id="14712" href="Peras.Block.html#2304" class="Function">roundNumber</a> <a id="14724" href="Peras.SmallStep.html#14708" class="Bound">c</a> <a id="14726" href="Haskell.Prim.Num.html#547" class="Field Operator">+</a> <a id="14728" class="Number">2</a> <a id="14730" href="Haskell.Prim.Eq.html#453" class="Field Operator">==</a> <a id="14733" href="Peras.SmallStep.html#14590" class="Bound">r</a><a id="14734" class="Symbol">)</a> <a id="14736" class="Symbol">(</a><a id="14737" href="Peras.SmallStep.html#5621" class="Function">certs</a> <a id="14743" href="Peras.SmallStep.html#14593" class="Bound">t</a><a id="14744" class="Symbol">))</a> <a id="14747" class="Comment">-- (a)</a>
           <a id="14765" href="Haskell.Prim.Bool.html#138" class="Function Operator">&amp;&amp;</a> <a id="14768" class="Symbol">(</a><a id="14769" href="Peras.SmallStep.html#14590" class="Bound">r</a> <a id="14771" href="Haskell.Prim.Ord.html#1144" class="Field Operator">&lt;=</a> <a id="14774" href="Peras.Params.html#249" class="Field">A</a> <a id="14776" href="Haskell.Prim.Num.html#547" class="Field Operator">+</a> <a id="14778" href="Peras.Block.html#2304" class="Function">roundNumber</a> <a id="14790" href="Peras.SmallStep.html#14651" class="Bound">cert′</a><a id="14795" class="Symbol">)</a>                    <a id="14816" class="Comment">-- (b)</a>
           <a id="14834" href="Haskell.Prim.Bool.html#138" class="Function Operator">&amp;&amp;</a> <a id="14837" class="Symbol">(</a><a id="14838" href="Peras.Block.html#2304" class="Function">roundNumber</a> <a id="14850" href="Peras.SmallStep.html#14615" class="Bound">cert⋆</a> <a id="14856" href="Haskell.Prim.Ord.html#1072" class="Field Operator">&lt;</a> <a id="14858" href="Peras.Block.html#2304" class="Function">roundNumber</a> <a id="14870" href="Peras.SmallStep.html#14651" class="Bound">cert′</a><a id="14875" class="Symbol">)</a>         <a id="14885" class="Comment">-- (c)</a>
        <a id="14900" href="Haskell.Prim.html#1713" class="Function Operator">then</a> <a id="14905" href="Haskell.Prim.Maybe.html#162" class="InductiveConstructor">Just</a> <a id="14910" href="Peras.SmallStep.html#14651" class="Bound">cert′</a>
        <a id="14924" href="Haskell.Prim.html#1713" class="Function Operator">else</a> <a id="14929" href="Haskell.Prim.Maybe.html#142" class="InductiveConstructor">Nothing</a>
</pre>
Helper function for creating a block
<pre class="Agda">    <a id="14990" href="Peras.SmallStep.html#14990" class="Function">createBlock</a> <a id="15002" class="Symbol">:</a> <a id="15004" href="Peras.Numbering.html#1035" class="Record">SlotNumber</a> <a id="15015" class="Symbol">→</a> <a id="15017" href="Peras.Block.html#842" class="Function">PartyId</a> <a id="15025" class="Symbol">→</a> <a id="15027" href="Peras.Crypto.html#2886" class="Record">LeadershipProof</a> <a id="15043" class="Symbol">→</a> <a id="15045" href="Peras.Crypto.html#3408" class="Record">Signature</a> <a id="15055" class="Symbol">→</a> <a id="15057" href="Peras.SmallStep.html#6683" class="Bound">T</a> <a id="15059" class="Symbol">→</a> <a id="15061" href="Peras.Block.html#2100" class="Record">Block</a>
    <a id="15071" href="Peras.SmallStep.html#14990" class="Function">createBlock</a> <a id="15083" href="Peras.SmallStep.html#15083" class="Bound">s</a> <a id="15085" href="Peras.SmallStep.html#15085" class="Bound">p</a> <a id="15087" href="Peras.SmallStep.html#15087" class="Bound">π</a> <a id="15089" href="Peras.SmallStep.html#15089" class="Bound">σ</a> <a id="15091" href="Peras.SmallStep.html#15091" class="Bound">t</a> <a id="15093" class="Symbol">=</a>
      <a id="15101" class="Keyword">record</a>
        <a id="15116" class="Symbol">{</a> <a id="15118" href="Peras.Block.html#2538" class="Field">slotNumber</a> <a id="15129" class="Symbol">=</a> <a id="15131" href="Peras.SmallStep.html#15083" class="Bound">s</a>
        <a id="15141" class="Symbol">;</a> <a id="15143" href="Peras.Block.html#2570" class="Field">creatorId</a> <a id="15153" class="Symbol">=</a> <a id="15155" href="Peras.SmallStep.html#15085" class="Bound">p</a>
        <a id="15165" class="Symbol">;</a> <a id="15167" href="Peras.Block.html#2598" class="Field">parentBlock</a> <a id="15179" class="Symbol">=</a> <a id="15181" href="Peras.Block.html#4809" class="Function">tipHash</a> <a id="15189" class="Symbol">(</a><a id="15190" href="Peras.SmallStep.html#5509" class="Function">preferredChain</a> <a id="15205" href="Peras.SmallStep.html#15091" class="Bound">t</a><a id="15206" class="Symbol">)</a>
        <a id="15216" class="Symbol">;</a> <a id="15218" href="Peras.Block.html#2631" class="Field">certificate</a> <a id="15230" class="Symbol">=</a> <a id="15232" href="Peras.SmallStep.html#14515" class="Function">needCert</a> <a id="15241" class="Symbol">(</a><a id="15242" href="Peras.Chain.html#4109" class="Function">v-round</a> <a id="15250" href="Peras.SmallStep.html#15083" class="Bound">s</a><a id="15251" class="Symbol">)</a> <a id="15253" href="Peras.SmallStep.html#15091" class="Bound">t</a>
        <a id="15263" class="Symbol">;</a> <a id="15265" href="Peras.Block.html#2671" class="Field">leadershipProof</a> <a id="15281" class="Symbol">=</a> <a id="15283" href="Peras.SmallStep.html#15087" class="Bound">π</a>
        <a id="15293" class="Symbol">;</a> <a id="15295" href="Peras.Block.html#2743" class="Field">bodyHash</a> <a id="15304" class="Symbol">=</a> <a id="15306" href="Peras.Crypto.html#2326" class="Field">hash</a> <a id="15311" class="Symbol">(</a><a id="15312" href="Peras.SmallStep.html#6774" class="Bound">txSelection</a> <a id="15324" href="Peras.SmallStep.html#15083" class="Bound">s</a> <a id="15326" href="Peras.SmallStep.html#15085" class="Bound">p</a><a id="15327" class="Symbol">)</a>
        <a id="15337" class="Symbol">;</a> <a id="15339" href="Peras.Block.html#2713" class="Field">signature</a> <a id="15349" class="Symbol">=</a> <a id="15351" href="Peras.SmallStep.html#15089" class="Bound">σ</a>
        <a id="15361" class="Symbol">}</a>
</pre>
<p>A party can create a new block by adding it to the local block tree
and diffuse the block creation messages to the other parties. Block
creation is possible, if as in <em>Praos</em></p>
<ul>
<li>the block signature is correct</li>
<li>the party is the slot leader</li>
</ul>
Block creation updates the party’s local state and for all other parties
a message is added to the message buffer
<pre class="Agda">    <a id="15738" class="Keyword">infix</a> <a id="15744" class="Number">2</a> <a id="15746" href="Peras.SmallStep.html#15762" class="Datatype Operator">_⊢_↷_</a>

    <a id="15757" class="Keyword">data</a> <a id="15762" href="Peras.SmallStep.html#15762" class="Datatype Operator">_⊢_↷_</a> <a id="15768" class="Symbol">:</a> <a id="15770" class="Symbol">{</a><a id="15771" href="Peras.SmallStep.html#15771" class="Bound">p</a> <a id="15773" class="Symbol">:</a> <a id="15775" href="Peras.Block.html#842" class="Function">PartyId</a><a id="15782" class="Symbol">}</a> <a id="15784" class="Symbol">→</a> <a id="15786" href="Peras.Block.html#1406" class="Datatype">Honesty</a> <a id="15794" href="Peras.SmallStep.html#15771" class="Bound">p</a> <a id="15796" class="Symbol">→</a> <a id="15798" href="Peras.SmallStep.html#9877" class="Record">State</a> <a id="15804" class="Symbol">→</a> <a id="15806" href="Peras.SmallStep.html#9877" class="Record">State</a> <a id="15812" class="Symbol">→</a> <a id="15814" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="15818" class="Keyword">where</a>

      <a id="15831" href="Peras.SmallStep.html#15831" class="InductiveConstructor">honest</a> <a id="15838" class="Symbol">:</a> <a id="15840" class="Symbol">∀</a> <a id="15842" class="Symbol">{</a><a id="15843" href="Peras.SmallStep.html#15843" class="Bound">p</a><a id="15844" class="Symbol">}</a> <a id="15846" class="Symbol">{</a><a id="15847" href="Peras.SmallStep.html#15847" class="Bound">t</a><a id="15848" class="Symbol">}</a> <a id="15850" class="Symbol">{</a><a id="15851" href="Peras.SmallStep.html#15851" class="Bound">M</a><a id="15852" class="Symbol">}</a> <a id="15854" class="Symbol">{</a><a id="15855" href="Peras.SmallStep.html#15855" class="Bound">π</a><a id="15856" class="Symbol">}</a> <a id="15858" class="Symbol">{</a><a id="15859" href="Peras.SmallStep.html#15859" class="Bound">σ</a><a id="15860" class="Symbol">}</a>
        <a id="15870" class="Symbol">→</a> <a id="15872" class="Keyword">let</a>
            <a id="15888" class="Keyword">open</a> <a id="15893" href="Peras.SmallStep.html#9877" class="Module">State</a>
            <a id="15911" href="Peras.SmallStep.html#15911" class="Bound">s</a> <a id="15913" class="Symbol">=</a> <a id="15915" href="Peras.SmallStep.html#9945" class="Field">clock</a> <a id="15921" href="Peras.SmallStep.html#15851" class="Bound">M</a>
            <a id="15935" href="Peras.SmallStep.html#15935" class="Bound">b</a> <a id="15937" class="Symbol">=</a> <a id="15939" href="Peras.SmallStep.html#14990" class="Function">createBlock</a> <a id="15951" href="Peras.SmallStep.html#15911" class="Bound">s</a> <a id="15953" href="Peras.SmallStep.html#15843" class="Bound">p</a> <a id="15955" href="Peras.SmallStep.html#15855" class="Bound">π</a> <a id="15957" href="Peras.SmallStep.html#15859" class="Bound">σ</a> <a id="15959" href="Peras.SmallStep.html#15847" class="Bound">t</a>
            <a id="15973" href="Peras.SmallStep.html#15973" class="Bound">pref</a> <a id="15978" class="Symbol">=</a> <a id="15980" href="Peras.SmallStep.html#5509" class="Function">preferredChain</a> <a id="15995" href="Peras.SmallStep.html#15847" class="Bound">t</a>
          <a id="16007" class="Keyword">in</a>
          <a id="16020" href="Peras.SmallStep.html#9972" class="Field">blockTrees</a> <a id="16031" href="Peras.SmallStep.html#15851" class="Bound">M</a> <a id="16033" href="Prelude.AssocList.html#847" class="Function Operator">⁉</a> <a id="16035" href="Peras.SmallStep.html#15843" class="Bound">p</a> <a id="16037" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="16039" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="16044" href="Peras.SmallStep.html#15847" class="Bound">t</a>
        <a id="16054" class="Symbol">→</a> <a id="16056" class="Symbol">(</a><a id="16057" href="Peras.SmallStep.html#16057" class="Bound">vc</a> <a id="16060" class="Symbol">:</a> <a id="16062" href="Peras.Chain.html#4709" class="Datatype">ValidChain</a> <a id="16073" class="Symbol">(</a><a id="16074" href="Peras.SmallStep.html#15935" class="Bound">b</a> <a id="16076" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="16078" href="Peras.SmallStep.html#15973" class="Bound">pref</a><a id="16082" class="Symbol">))</a>
        <a id="16093" class="Symbol">→</a> <a id="16095" class="Symbol">(</a><a id="16096" href="Peras.SmallStep.html#16096" class="Bound">fᵈ</a> <a id="16099" class="Symbol">:</a> <a id="16101" href="Peras.Block.html#842" class="Function">PartyId</a> <a id="16109" class="Symbol">→</a> <a id="16111" href="Peras.SmallStep.html#2439" class="Function">Delay</a><a id="16116" class="Symbol">)</a>
          <a id="16128" class="Comment">----------------------------</a>
        <a id="16165" class="Symbol">→</a> <a id="16167" href="Peras.Block.html#1439" class="InductiveConstructor">Honest</a> <a id="16174" class="Symbol">{</a><a id="16175" href="Peras.SmallStep.html#15843" class="Bound">p</a><a id="16176" class="Symbol">}</a> <a id="16178" href="Peras.SmallStep.html#15762" class="Datatype Operator">⊢</a>
            <a id="16192" href="Peras.SmallStep.html#15851" class="Bound">M</a> <a id="16194" href="Peras.SmallStep.html#15762" class="Datatype Operator">↷</a> <a id="16196" href="Peras.SmallStep.html#11363" class="Function Operator">delay</a> <a id="16202" href="Peras.SmallStep.html#2283" class="InductiveConstructor">ChainMsg</a> <a id="16211" href="Peras.SmallStep.html#16057" class="Bound">vc</a> <a id="16214" href="Peras.SmallStep.html#11363" class="Function Operator">by</a> <a id="16217" href="Peras.SmallStep.html#16096" class="Bound">fᵈ</a>
                 <a id="16237" href="Peras.SmallStep.html#11363" class="Function Operator">update</a> <a id="16244" href="Peras.SmallStep.html#15851" class="Bound">M</a>
</pre>
<h2 id="small-step-semantics-1">Small-step semantics</h2>
The small-step semantics describe the evolution of the global state.
<pre class="Agda">    <a id="16356" class="Keyword">variable</a>
      <a id="16371" href="Peras.SmallStep.html#16371" class="Generalizable">M</a> <a id="16373" href="Peras.SmallStep.html#16373" class="Generalizable">N</a> <a id="16375" href="Peras.SmallStep.html#16375" class="Generalizable">O</a> <a id="16377" class="Symbol">:</a> <a id="16379" href="Peras.SmallStep.html#9877" class="Record">State</a>
      <a id="16391" href="Peras.SmallStep.html#16391" class="Generalizable">p</a> <a id="16393" class="Symbol">:</a> <a id="16395" href="Peras.Block.html#842" class="Function">PartyId</a>
      <a id="16409" href="Peras.SmallStep.html#16409" class="Generalizable">h</a> <a id="16411" class="Symbol">:</a> <a id="16413" href="Peras.Block.html#1406" class="Datatype">Honesty</a> <a id="16421" href="Peras.SmallStep.html#16391" class="Generalizable">p</a>
</pre>
<p>The relation allows</p>
<ul>
<li>Fetching messages at the beginning of each slot</li>
<li>Block creation</li>
<li>Voting</li>
<li>Transitioning to next slot in the same voting round</li>
<li>Transitioning to next slot in a new voting round</li>
</ul>
Note, when transitioning to the next slot we need to distinguish whether
the next slot is in the same or a new voting round. This is necessary in
order to detect adversarial behaviour with respect to voting
(adversarialy not voting in a voting round)
<pre class="Agda">    <a id="16893" class="Keyword">data</a> <a id="16898" href="Peras.SmallStep.html#16898" class="Datatype Operator">_↝_</a> <a id="16902" class="Symbol">:</a> <a id="16904" href="Peras.SmallStep.html#9877" class="Record">State</a> <a id="16910" class="Symbol">→</a> <a id="16912" href="Peras.SmallStep.html#9877" class="Record">State</a> <a id="16918" class="Symbol">→</a> <a id="16920" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="16924" class="Keyword">where</a>

      <a id="16937" href="Peras.SmallStep.html#16937" class="InductiveConstructor">Fetch</a> <a id="16943" class="Symbol">:</a> <a id="16945" class="Symbol">∀</a> <a id="16947" class="Symbol">{</a><a id="16948" href="Peras.SmallStep.html#16948" class="Bound">m</a><a id="16949" class="Symbol">}</a> <a id="16951" class="Symbol">→</a>
        <a id="16961" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="16963" href="Peras.SmallStep.html#16409" class="Generalizable">h</a> <a id="16965" href="Peras.SmallStep.html#11744" class="Datatype Operator">⊢</a> <a id="16967" href="Peras.SmallStep.html#16371" class="Generalizable">M</a> <a id="16969" href="Peras.SmallStep.html#11744" class="Datatype Operator">[</a> <a id="16971" href="Peras.SmallStep.html#16948" class="Bound">m</a> <a id="16973" href="Peras.SmallStep.html#11744" class="Datatype Operator">]⇀</a> <a id="16976" href="Peras.SmallStep.html#16373" class="Generalizable">N</a>
          <a id="16988" href="Prelude.InferenceRules.html#14206" class="Function Operator">──────────────</a>
          <a id="17013" href="Peras.SmallStep.html#16371" class="Generalizable">M</a> <a id="17015" href="Peras.SmallStep.html#16898" class="Datatype Operator">↝</a> <a id="17017" href="Peras.SmallStep.html#16373" class="Generalizable">N</a>

      <a id="17026" href="Peras.SmallStep.html#17026" class="InductiveConstructor">CreateVote</a> <a id="17037" class="Symbol">:</a>
        <a id="17047" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="17049" href="Peras.SmallStep.html#10449" class="Function">Fetched</a> <a id="17057" href="Peras.SmallStep.html#16371" class="Generalizable">M</a>
        <a id="17067" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="17069" href="Peras.SmallStep.html#16409" class="Generalizable">h</a> <a id="17071" href="Peras.SmallStep.html#13359" class="Datatype Operator">⊢</a> <a id="17073" href="Peras.SmallStep.html#16371" class="Generalizable">M</a> <a id="17075" href="Peras.SmallStep.html#13359" class="Datatype Operator">⇉</a> <a id="17077" href="Peras.SmallStep.html#16373" class="Generalizable">N</a>
          <a id="17089" href="Prelude.InferenceRules.html#14291" class="Function Operator">─────────</a>
          <a id="17109" href="Peras.SmallStep.html#16371" class="Generalizable">M</a> <a id="17111" href="Peras.SmallStep.html#16898" class="Datatype Operator">↝</a> <a id="17113" href="Peras.SmallStep.html#16373" class="Generalizable">N</a>

      <a id="17122" href="Peras.SmallStep.html#17122" class="InductiveConstructor">CreateBlock</a> <a id="17134" class="Symbol">:</a>
        <a id="17144" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="17146" href="Peras.SmallStep.html#10449" class="Function">Fetched</a> <a id="17154" href="Peras.SmallStep.html#16371" class="Generalizable">M</a>
        <a id="17164" href="Prelude.InferenceRules.html#56005" class="Function Operator">∙</a> <a id="17166" href="Peras.SmallStep.html#16409" class="Generalizable">h</a> <a id="17168" href="Peras.SmallStep.html#15762" class="Datatype Operator">⊢</a> <a id="17170" href="Peras.SmallStep.html#16371" class="Generalizable">M</a> <a id="17172" href="Peras.SmallStep.html#15762" class="Datatype Operator">↷</a> <a id="17174" href="Peras.SmallStep.html#16373" class="Generalizable">N</a>
          <a id="17186" href="Prelude.InferenceRules.html#14291" class="Function Operator">─────────</a>
          <a id="17206" href="Peras.SmallStep.html#16371" class="Generalizable">M</a> <a id="17208" href="Peras.SmallStep.html#16898" class="Datatype Operator">↝</a> <a id="17210" href="Peras.SmallStep.html#16373" class="Generalizable">N</a>

      <a id="17219" href="Peras.SmallStep.html#17219" class="InductiveConstructor">NextSlot</a> <a id="17228" class="Symbol">:</a>
        <a id="17238" href="Prelude.InferenceRules.html#56074" class="Function Operator">∙</a> <a id="17240" href="Peras.SmallStep.html#10449" class="Function">Fetched</a> <a id="17248" href="Peras.SmallStep.html#16371" class="Generalizable">M</a>
          <a id="17260" href="Prelude.InferenceRules.html#14276" class="Function Operator">──────────</a>
          <a id="17281" href="Peras.SmallStep.html#16371" class="Generalizable">M</a> <a id="17283" href="Peras.SmallStep.html#16898" class="Datatype Operator">↝</a> <a id="17285" href="Peras.SmallStep.html#10687" class="Function">tick</a> <a id="17290" href="Peras.SmallStep.html#16371" class="Generalizable">M</a>
</pre>
<h4 id="reflexive-transitive-closure">Reflexive, transitive closure</h4>
List-like structure for defining execution paths.
<pre class="Agda">    <a id="17393" class="Keyword">infix</a>  <a id="17400" class="Number">2</a> <a id="17402" href="Peras.SmallStep.html#17449" class="Datatype Operator">_↝⋆_</a>
    <a id="17411" class="Keyword">infixr</a> <a id="17418" class="Number">2</a> <a id="17420" href="Peras.SmallStep.html#17505" class="InductiveConstructor Operator">_↣_</a>
    <a id="17428" class="Keyword">infix</a>  <a id="17435" class="Number">3</a> <a id="17437" href="Peras.SmallStep.html#17488" class="InductiveConstructor">∎</a>

    <a id="17444" class="Keyword">data</a> <a id="17449" href="Peras.SmallStep.html#17449" class="Datatype Operator">_↝⋆_</a> <a id="17454" class="Symbol">:</a> <a id="17456" href="Peras.SmallStep.html#9877" class="Record">State</a> <a id="17462" class="Symbol">→</a> <a id="17464" href="Peras.SmallStep.html#9877" class="Record">State</a> <a id="17470" class="Symbol">→</a> <a id="17472" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="17476" class="Keyword">where</a>
      <a id="17488" href="Peras.SmallStep.html#17488" class="InductiveConstructor">∎</a> <a id="17490" class="Symbol">:</a> <a id="17492" href="Peras.SmallStep.html#16371" class="Generalizable">M</a> <a id="17494" href="Peras.SmallStep.html#17449" class="Datatype Operator">↝⋆</a> <a id="17497" href="Peras.SmallStep.html#16371" class="Generalizable">M</a>
      <a id="17505" href="Peras.SmallStep.html#17505" class="InductiveConstructor Operator">_↣_</a> <a id="17509" class="Symbol">:</a> <a id="17511" href="Peras.SmallStep.html#16371" class="Generalizable">M</a> <a id="17513" href="Peras.SmallStep.html#16898" class="Datatype Operator">↝</a> <a id="17515" href="Peras.SmallStep.html#16373" class="Generalizable">N</a> <a id="17517" class="Symbol">→</a> <a id="17519" href="Peras.SmallStep.html#16373" class="Generalizable">N</a> <a id="17521" href="Peras.SmallStep.html#17449" class="Datatype Operator">↝⋆</a> <a id="17524" href="Peras.SmallStep.html#16375" class="Generalizable">O</a> <a id="17526" class="Symbol">→</a> <a id="17528" href="Peras.SmallStep.html#16371" class="Generalizable">M</a> <a id="17530" href="Peras.SmallStep.html#17449" class="Datatype Operator">↝⋆</a> <a id="17533" href="Peras.SmallStep.html#16375" class="Generalizable">O</a>
</pre>
<pre class="Agda">    <a id="17551" class="Keyword">infixr</a> <a id="17558" class="Number">2</a> <a id="17560" href="Peras.SmallStep.html#17571" class="Function Operator">_++&#39;_</a>

    <a id="17571" href="Peras.SmallStep.html#17571" class="Function Operator">_++&#39;_</a> <a id="17577" class="Symbol">:</a>
        <a id="17587" href="Peras.SmallStep.html#16371" class="Generalizable">M</a> <a id="17589" href="Peras.SmallStep.html#17449" class="Datatype Operator">↝⋆</a> <a id="17592" href="Peras.SmallStep.html#16373" class="Generalizable">N</a>
      <a id="17600" class="Symbol">→</a> <a id="17602" href="Peras.SmallStep.html#16373" class="Generalizable">N</a> <a id="17604" href="Peras.SmallStep.html#17449" class="Datatype Operator">↝⋆</a> <a id="17607" href="Peras.SmallStep.html#16375" class="Generalizable">O</a>
      <a id="17615" class="Symbol">→</a> <a id="17617" href="Peras.SmallStep.html#16371" class="Generalizable">M</a> <a id="17619" href="Peras.SmallStep.html#17449" class="Datatype Operator">↝⋆</a> <a id="17622" href="Peras.SmallStep.html#16375" class="Generalizable">O</a>
    <a id="17628" href="Peras.SmallStep.html#17488" class="InductiveConstructor">∎</a> <a id="17630" href="Peras.SmallStep.html#17571" class="Function Operator">++&#39;</a> <a id="17634" href="Peras.SmallStep.html#17634" class="Bound">M↝⋆O</a> <a id="17639" class="Symbol">=</a> <a id="17641" href="Peras.SmallStep.html#17634" class="Bound">M↝⋆O</a>
    <a id="17650" class="Symbol">(</a><a id="17651" href="Peras.SmallStep.html#17651" class="Bound">M↝M₁</a> <a id="17656" href="Peras.SmallStep.html#17505" class="InductiveConstructor Operator">↣</a> <a id="17658" href="Peras.SmallStep.html#17658" class="Bound">M₁↝⋆N</a><a id="17663" class="Symbol">)</a> <a id="17665" href="Peras.SmallStep.html#17571" class="Function Operator">++&#39;</a> <a id="17669" href="Peras.SmallStep.html#17669" class="Bound">N↝⋆O</a> <a id="17674" class="Symbol">=</a> <a id="17676" href="Peras.SmallStep.html#17651" class="Bound">M↝M₁</a> <a id="17681" href="Peras.SmallStep.html#17505" class="InductiveConstructor Operator">↣</a> <a id="17683" href="Peras.SmallStep.html#17658" class="Bound">M₁↝⋆N</a> <a id="17689" href="Peras.SmallStep.html#17571" class="Function Operator">++&#39;</a> <a id="17693" href="Peras.SmallStep.html#17669" class="Bound">N↝⋆O</a>
</pre>
<pre class="Agda">  <a id="17712" class="Keyword">open</a> <a id="17717" href="Peras.SmallStep.html#6661" class="Module">Semantics</a> <a id="17727" class="Keyword">public</a>
</pre>
</body>
</html>
