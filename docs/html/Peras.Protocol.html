<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>Peras.Protocol</title><link rel="stylesheet" href="Agda.css"></head><body><pre class="Agda"><a id="1" class="Symbol">{-#</a> <a id="5" class="Keyword">OPTIONS</a> <a id="13" class="Pragma">--type-in-type</a> <a id="28" class="Pragma">--allow-unsolved-metas</a> <a id="51" class="Symbol">#-}</a>
<a id="55" class="Comment">{- An attempt at &quot;sideways-engineering&quot; pseudo-code from Peras document -}</a>
<a id="130" class="Keyword">module</a> <a id="137" href="Peras.Protocol.html" class="Module">Peras.Protocol</a> <a id="152" class="Keyword">where</a>

<a id="159" class="Keyword">open</a> <a id="164" class="Keyword">import</a> <a id="171" href="Effect.Monad.html" class="Module">Effect.Monad</a>
<a id="184" class="Keyword">open</a> <a id="189" class="Keyword">import</a> <a id="196" href="Data.Nat.DivMod.html" class="Module">Data.Nat.DivMod</a> <a id="212" class="Keyword">using</a> <a id="218" class="Symbol">(</a> <a id="220" href="Data.Nat.DivMod.html#18903" class="Function Operator">_div_</a> <a id="226" class="Symbol">;</a> <a id="228" href="Data.Nat.DivMod.html#18976" class="Function Operator">_mod_</a> <a id="234" class="Symbol">)</a>
<a id="236" class="Keyword">open</a> <a id="241" class="Keyword">import</a> <a id="248" href="Data.Nat.html" class="Module">Data.Nat</a> <a id="257" class="Keyword">hiding</a> <a id="264" class="Symbol">(</a><a id="265" href="Data.Nat.Properties.html#3311" class="Function Operator">_≟_</a> <a id="269" class="Symbol">;</a> <a id="271" href="Data.Nat.Base.html#2289" class="Function Operator">_&gt;_</a> <a id="275" class="Symbol">;</a> <a id="277" href="Data.Nat.Base.html#7096" class="Function Operator">_/_</a> <a id="281" class="Symbol">;</a> <a id="283" href="Data.Nat.Base.html#1691" class="Datatype Operator">_≤_</a> <a id="287" class="Symbol">;</a> <a id="289" href="Data.Nat.Base.html#2259" class="Function Operator">_≥_</a> <a id="293" class="Symbol">)</a>
<a id="295" class="Keyword">open</a> <a id="300" class="Keyword">import</a> <a id="307" href="Agda.Builtin.Unit.html" class="Module">Agda.Builtin.Unit</a>
<a id="325" class="Keyword">open</a> <a id="330" class="Keyword">import</a> <a id="337" href="Agda.Builtin.List.html" class="Module">Agda.Builtin.List</a>
<a id="355" class="Keyword">open</a> <a id="360" class="Keyword">import</a> <a id="367" href="Data.List.html" class="Module">Data.List</a> <a id="377" class="Keyword">using</a> <a id="383" class="Symbol">(</a><a id="384" href="Data.List.Base.html#4336" class="Function">foldr</a> <a id="390" class="Symbol">;</a> <a id="392" href="Data.List.Base.html#1631" class="Function">map</a><a id="395" class="Symbol">)</a>
<a id="397" class="Keyword">open</a> <a id="402" class="Keyword">import</a> <a id="409" href="Data.Bool.html" class="Module">Data.Bool</a> <a id="419" class="Keyword">hiding</a> <a id="426" class="Symbol">(</a><a id="427" href="Data.Bool.Base.html#681" class="Datatype Operator">_≤_</a><a id="430" class="Symbol">)</a>
<a id="432" class="Keyword">open</a> <a id="437" class="Keyword">import</a> <a id="444" href="Data.Maybe.html" class="Module">Data.Maybe</a> <a id="455" class="Keyword">using</a> <a id="461" class="Symbol">(</a><a id="462" href="Agda.Builtin.Maybe.html#135" class="Datatype">Maybe</a> <a id="468" class="Symbol">;</a> <a id="470" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a> <a id="478" class="Symbol">;</a> <a id="480" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a><a id="484" class="Symbol">)</a>
<a id="486" class="Keyword">open</a> <a id="491" class="Keyword">import</a> <a id="498" href="Function.html" class="Module">Function</a> <a id="507" class="Keyword">using</a> <a id="513" class="Symbol">(</a><a id="514" href="Function.Base.html#1974" class="Function Operator">_$_</a><a id="517" class="Symbol">)</a>

<a id="520" class="Comment">{-
Preliminaries
Parameters
Ouroboros Peras has the following parameters:
T: the length (in slots) of a voting round
K: the length of a cooldown period (in voting rounds)
R: chain-ignorance period
L: the cutoff window (in slots) which is ignored to select block to vote for in a round
Llow, Lhigh: define vote-candidate window
A: max. age for including vote certificate
τ: number of votes required for quorum
b B: weight boost per vote certificate
W: weight to cut off for common prefix
-}</a>

<a id="Slot"></a><a id="1011" href="Peras.Protocol.html#1011" class="Function">Slot</a> <a id="1016" class="Symbol">=</a> <a id="1018" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>

<a id="Round"></a><a id="1021" href="Peras.Protocol.html#1021" class="Function">Round</a> <a id="1027" class="Symbol">=</a> <a id="1029" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>

<a id="1032" class="Keyword">postulate</a>
  <a id="Party"></a><a id="1044" href="Peras.Protocol.html#1044" class="Postulate">Party</a> <a id="1050" class="Symbol">:</a> <a id="1052" href="Agda.Primitive.html#388" class="Primitive">Set</a>
  <a id="Chain"></a><a id="1058" href="Peras.Protocol.html#1058" class="Postulate">Chain</a> <a id="1064" class="Symbol">:</a> <a id="1066" href="Agda.Primitive.html#388" class="Primitive">Set</a>
  <a id="Block"></a><a id="1072" href="Peras.Protocol.html#1072" class="Postulate">Block</a> <a id="1078" class="Symbol">:</a> <a id="1080" href="Agda.Primitive.html#388" class="Primitive">Set</a>
  <a id="Certificate"></a><a id="1086" href="Peras.Protocol.html#1086" class="Postulate">Certificate</a> <a id="1098" class="Symbol">:</a> <a id="1100" href="Agda.Primitive.html#388" class="Primitive">Set</a>
  <a id="Certify"></a><a id="1106" href="Peras.Protocol.html#1106" class="Postulate">Certify</a> <a id="1114" class="Symbol">:</a> <a id="1116" href="Peras.Protocol.html#1072" class="Postulate">Block</a> <a id="1122" class="Symbol">-&gt;</a> <a id="1125" href="Peras.Protocol.html#1086" class="Postulate">Certificate</a> <a id="1137" class="Symbol">-&gt;</a> <a id="1140" href="Peras.Protocol.html#1072" class="Postulate">Block</a>

  <a id="set"></a><a id="1149" href="Peras.Protocol.html#1149" class="Postulate">set</a> <a id="1153" class="Symbol">:</a> <a id="1155" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="1159" class="Symbol">-&gt;</a> <a id="1162" href="Agda.Primitive.html#388" class="Primitive">Set</a>
  <a id="singleton"></a><a id="1168" href="Peras.Protocol.html#1168" class="Postulate">singleton</a> <a id="1178" class="Symbol">:</a> <a id="1180" class="Symbol">forall</a> <a id="1187" class="Symbol">{</a><a id="1188" href="Peras.Protocol.html#1188" class="Bound">a</a><a id="1189" class="Symbol">}</a> <a id="1191" class="Symbol">-&gt;</a> <a id="1194" href="Peras.Protocol.html#1188" class="Bound">a</a> <a id="1196" class="Symbol">-&gt;</a> <a id="1199" href="Peras.Protocol.html#1149" class="Postulate">set</a> <a id="1203" href="Peras.Protocol.html#1188" class="Bound">a</a>
  <a id="null"></a><a id="1207" href="Peras.Protocol.html#1207" class="Postulate">null</a> <a id="1212" class="Symbol">:</a> <a id="1214" href="Peras.Protocol.html#1086" class="Postulate">Certificate</a>
  <a id="toList"></a><a id="1228" href="Peras.Protocol.html#1228" class="Postulate">toList</a> <a id="1235" class="Symbol">:</a> <a id="1237" class="Symbol">forall</a> <a id="1244" class="Symbol">{</a><a id="1245" href="Peras.Protocol.html#1245" class="Bound">a</a><a id="1246" class="Symbol">}</a> <a id="1248" class="Symbol">-&gt;</a> <a id="1251" href="Peras.Protocol.html#1149" class="Postulate">set</a> <a id="1255" href="Peras.Protocol.html#1245" class="Bound">a</a> <a id="1257" class="Symbol">-&gt;</a> <a id="1260" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="1265" href="Peras.Protocol.html#1245" class="Bound">a</a>

  <a id="_isLeaderInSlot_"></a><a id="1270" href="Peras.Protocol.html#1270" class="Postulate Operator">_isLeaderInSlot_</a> <a id="1287" class="Symbol">:</a> <a id="1289" href="Peras.Protocol.html#1044" class="Postulate">Party</a> <a id="1295" class="Symbol">-&gt;</a> <a id="1298" href="Peras.Protocol.html#1011" class="Function">Slot</a> <a id="1303" class="Symbol">-&gt;</a> <a id="1306" href="Agda.Builtin.Bool.html#173" class="Datatype">Bool</a>
  <a id="_trimmedBy_"></a><a id="1313" href="Peras.Protocol.html#1313" class="Postulate Operator">_trimmedBy_</a> <a id="1325" class="Symbol">:</a> <a id="1327" href="Peras.Protocol.html#1058" class="Postulate">Chain</a> <a id="1333" class="Symbol">-&gt;</a> <a id="1336" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="1338" class="Symbol">-&gt;</a> <a id="1341" href="Peras.Protocol.html#1058" class="Postulate">Chain</a>
  <a id="_isCommitteeMemberInRound_"></a><a id="1349" href="Peras.Protocol.html#1349" class="Postulate Operator">_isCommitteeMemberInRound_</a> <a id="1376" class="Symbol">:</a> <a id="1378" href="Peras.Protocol.html#1044" class="Postulate">Party</a> <a id="1384" class="Symbol">-&gt;</a> <a id="1387" href="Peras.Protocol.html#1021" class="Function">Round</a> <a id="1393" class="Symbol">-&gt;</a> <a id="1396" href="Agda.Builtin.Bool.html#173" class="Datatype">Bool</a>
  <a id="_pointsInto_"></a><a id="1403" href="Peras.Protocol.html#1403" class="Postulate Operator">_pointsInto_</a> <a id="1416" class="Symbol">:</a> <a id="1418" href="Peras.Protocol.html#1086" class="Postulate">Certificate</a> <a id="1430" class="Symbol">-&gt;</a> <a id="1433" href="Peras.Protocol.html#1058" class="Postulate">Chain</a> <a id="1439" class="Symbol">-&gt;</a> <a id="1442" href="Agda.Builtin.Bool.html#173" class="Datatype">Bool</a>

  <a id="length"></a><a id="1450" href="Peras.Protocol.html#1450" class="Postulate">length</a> <a id="1457" class="Symbol">:</a> <a id="1459" href="Peras.Protocol.html#1058" class="Postulate">Chain</a> <a id="1465" class="Symbol">-&gt;</a> <a id="1468" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>

  <a id="round"></a><a id="1473" href="Peras.Protocol.html#1473" class="Postulate">round</a> <a id="1479" class="Symbol">:</a> <a id="1481" href="Peras.Protocol.html#1086" class="Postulate">Certificate</a> <a id="1493" class="Symbol">-&gt;</a> <a id="1496" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>

  <a id="_[_]"></a><a id="1501" href="Peras.Protocol.html#1501" class="Postulate Operator">_[_]</a> <a id="1506" class="Symbol">:</a> <a id="1508" class="Symbol">forall</a> <a id="1515" class="Symbol">{</a><a id="1516" href="Peras.Protocol.html#1516" class="Bound">a</a><a id="1517" class="Symbol">}</a> <a id="1519" class="Symbol">-&gt;</a> <a id="1522" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="1527" href="Peras.Protocol.html#1516" class="Bound">a</a> <a id="1529" class="Symbol">-&gt;</a> <a id="1532" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="1534" class="Symbol">-&gt;</a> <a id="1537" href="Peras.Protocol.html#1516" class="Bound">a</a>

  <a id="_⟦_⟧"></a><a id="1542" href="Peras.Protocol.html#1542" class="Postulate Operator">_⟦_⟧</a> <a id="1547" class="Symbol">:</a> <a id="1549" href="Peras.Protocol.html#1058" class="Postulate">Chain</a> <a id="1555" class="Symbol">-&gt;</a> <a id="1558" href="Peras.Protocol.html#1011" class="Function">Slot</a> <a id="1563" class="Symbol">-&gt;</a> <a id="1566" href="Peras.Protocol.html#1072" class="Postulate">Block</a>

  <a id="_==_"></a><a id="1575" href="Peras.Protocol.html#1575" class="Postulate Operator">_==_</a> <a id="1580" class="Symbol">:</a> <a id="1582" class="Symbol">forall</a> <a id="1589" class="Symbol">{</a><a id="1590" href="Peras.Protocol.html#1590" class="Bound">a</a> <a id="1592" class="Symbol">:</a> <a id="1594" href="Agda.Primitive.html#388" class="Primitive">Set</a><a id="1597" class="Symbol">}</a> <a id="1599" class="Symbol">-&gt;</a> <a id="1602" href="Peras.Protocol.html#1590" class="Bound">a</a> <a id="1604" class="Symbol">-&gt;</a> <a id="1607" href="Peras.Protocol.html#1590" class="Bound">a</a> <a id="1609" class="Symbol">-&gt;</a> <a id="1612" href="Agda.Builtin.Bool.html#173" class="Datatype">Bool</a>

  <a id="_and_"></a><a id="1620" href="Peras.Protocol.html#1620" class="Postulate Operator">_and_</a> <a id="1626" class="Symbol">:</a> <a id="1628" href="Agda.Builtin.Bool.html#173" class="Datatype">Bool</a> <a id="1633" class="Symbol">-&gt;</a> <a id="1636" href="Agda.Builtin.Bool.html#173" class="Datatype">Bool</a> <a id="1641" class="Symbol">-&gt;</a> <a id="1644" href="Agda.Builtin.Bool.html#173" class="Datatype">Bool</a>
  <a id="_≤_"></a><a id="1651" href="Peras.Protocol.html#1651" class="Postulate Operator">_≤_</a> <a id="1655" class="Symbol">:</a> <a id="1657" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="1659" class="Symbol">-&gt;</a> <a id="1662" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="1664" class="Symbol">-&gt;</a> <a id="1667" href="Agda.Builtin.Bool.html#173" class="Datatype">Bool</a>
  <a id="_≥_"></a><a id="1674" href="Peras.Protocol.html#1674" class="Postulate Operator">_≥_</a> <a id="1678" class="Symbol">:</a> <a id="1680" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="1682" class="Symbol">-&gt;</a> <a id="1685" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="1687" class="Symbol">-&gt;</a> <a id="1690" href="Agda.Builtin.Bool.html#173" class="Datatype">Bool</a>
  <a id="_&gt;_"></a><a id="1697" href="Peras.Protocol.html#1697" class="Postulate Operator">_&gt;_</a> <a id="1701" class="Symbol">:</a> <a id="1703" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="1705" class="Symbol">-&gt;</a> <a id="1708" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="1710" class="Symbol">-&gt;</a> <a id="1713" href="Agda.Builtin.Bool.html#173" class="Datatype">Bool</a>
  <a id="_-_"></a><a id="1720" href="Peras.Protocol.html#1720" class="Postulate Operator">_-_</a> <a id="1724" class="Symbol">:</a> <a id="1726" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="1728" class="Symbol">-&gt;</a> <a id="1731" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="1733" class="Symbol">-&gt;</a> <a id="1736" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
  <a id="_/_"></a><a id="1740" href="Peras.Protocol.html#1740" class="Postulate Operator">_/_</a> <a id="1744" class="Symbol">:</a> <a id="1746" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="1748" class="Symbol">-&gt;</a> <a id="1751" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="1753" class="Symbol">-&gt;</a> <a id="1756" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>

  <a id="U"></a><a id="1761" href="Peras.Protocol.html#1761" class="Postulate">U</a> <a id="1763" class="Symbol">:</a> <a id="1765" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
  <a id="A"></a><a id="1769" href="Peras.Protocol.html#1769" class="Postulate">A</a> <a id="1771" class="Symbol">:</a> <a id="1773" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
  <a id="W"></a><a id="1777" href="Peras.Protocol.html#1777" class="Postulate">W</a> <a id="1779" class="Symbol">:</a> <a id="1781" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
  <a id="L"></a><a id="1785" href="Peras.Protocol.html#1785" class="Postulate">L</a> <a id="1787" class="Symbol">:</a> <a id="1789" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
  <a id="B"></a><a id="1793" href="Peras.Protocol.html#1793" class="Postulate">B</a> <a id="1795" class="Symbol">:</a> <a id="1797" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
  <a id="R"></a><a id="1801" href="Peras.Protocol.html#1801" class="Postulate">R</a> <a id="1803" class="Symbol">:</a> <a id="1805" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
  <a id="K"></a><a id="1809" href="Peras.Protocol.html#1809" class="Postulate">K</a> <a id="1811" class="Symbol">:</a> <a id="1813" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>

<a id="1816" class="Keyword">data</a> <a id="Vote"></a><a id="1821" href="Peras.Protocol.html#1821" class="Datatype">Vote</a> <a id="1826" class="Symbol">:</a> <a id="1828" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="1832" class="Keyword">where</a>
 <a id="Vote.MkVote"></a><a id="1839" href="Peras.Protocol.html#1839" class="InductiveConstructor">MkVote</a> <a id="1846" class="Symbol">:</a> <a id="1848" href="Peras.Protocol.html#1021" class="Function">Round</a> <a id="1854" class="Symbol">-&gt;</a> <a id="1857" href="Peras.Protocol.html#1044" class="Postulate">Party</a> <a id="1863" class="Symbol">-&gt;</a> <a id="1866" href="Peras.Protocol.html#1072" class="Postulate">Block</a> <a id="1872" class="Symbol">-&gt;</a> <a id="1875" href="Peras.Protocol.html#1821" class="Datatype">Vote</a>

<a id="slot"></a><a id="1881" href="Peras.Protocol.html#1881" class="Function">slot</a> <a id="1886" class="Symbol">:</a> <a id="1888" href="Peras.Protocol.html#1021" class="Function">Round</a> <a id="1894" class="Symbol">-&gt;</a> <a id="1897" href="Peras.Protocol.html#1011" class="Function">Slot</a>
<a id="1902" href="Peras.Protocol.html#1881" class="Function">slot</a> <a id="1907" href="Peras.Protocol.html#1907" class="Bound">r</a> <a id="1909" class="Symbol">=</a> <a id="1911" href="Peras.Protocol.html#1907" class="Bound">r</a> <a id="1913" href="Peras.Protocol.html#1740" class="Postulate Operator">/</a> <a id="1915" href="Peras.Protocol.html#1761" class="Postulate">U</a>

<a id="1918" class="Keyword">infixl</a> <a id="1925" class="Number">4</a> <a id="1927" href="Peras.Protocol.html#1720" class="Postulate Operator">_-_</a>
<a id="1931" class="Keyword">infixl</a> <a id="1938" class="Number">10</a> <a id="1941" href="Peras.Protocol.html#1501" class="Postulate Operator">_[_]</a>

<a id="1947" class="Keyword">data</a> <a id="Node"></a><a id="1952" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="1957" class="Symbol">:</a> <a id="1959" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="1963" class="Symbol">-&gt;</a> <a id="1966" href="Agda.Primitive.html#388" class="Primitive">Set₁</a> <a id="1971" class="Keyword">where</a>
  <a id="Node.bind"></a><a id="1979" href="Peras.Protocol.html#1979" class="InductiveConstructor">bind</a> <a id="1984" class="Symbol">:</a> <a id="1986" class="Symbol">forall</a> <a id="1993" class="Symbol">{</a><a id="1994" href="Peras.Protocol.html#1994" class="Bound">a</a><a id="1995" class="Symbol">}</a> <a id="1997" class="Symbol">{</a><a id="1998" href="Peras.Protocol.html#1998" class="Bound">b</a><a id="1999" class="Symbol">}</a> <a id="2001" class="Symbol">-&gt;</a> <a id="2004" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2009" href="Peras.Protocol.html#1994" class="Bound">a</a> <a id="2011" class="Symbol">-&gt;</a> <a id="2014" class="Symbol">(</a><a id="2015" href="Peras.Protocol.html#1994" class="Bound">a</a> <a id="2017" class="Symbol">-&gt;</a> <a id="2020" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2025" href="Peras.Protocol.html#1998" class="Bound">b</a><a id="2026" class="Symbol">)</a> <a id="2028" class="Symbol">-&gt;</a> <a id="2031" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2036" href="Peras.Protocol.html#1998" class="Bound">b</a>
  <a id="Node.ret"></a><a id="2040" href="Peras.Protocol.html#2040" class="InductiveConstructor">ret</a> <a id="2044" class="Symbol">:</a> <a id="2046" class="Symbol">forall</a> <a id="2053" class="Symbol">{</a><a id="2054" href="Peras.Protocol.html#2054" class="Bound">a</a><a id="2055" class="Symbol">}</a> <a id="2057" class="Symbol">-&gt;</a> <a id="2060" href="Peras.Protocol.html#2054" class="Bound">a</a> <a id="2062" class="Symbol">-&gt;</a> <a id="2065" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2070" href="Peras.Protocol.html#2054" class="Bound">a</a>
  <a id="Node.forgeBlock"></a><a id="2074" href="Peras.Protocol.html#2074" class="InductiveConstructor">forgeBlock</a> <a id="2085" class="Symbol">:</a> <a id="2087" href="Peras.Protocol.html#1058" class="Postulate">Chain</a> <a id="2093" class="Symbol">-&gt;</a> <a id="2096" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2101" href="Peras.Protocol.html#1072" class="Postulate">Block</a>
  <a id="Node.preferredChain"></a><a id="2109" href="Peras.Protocol.html#2109" class="InductiveConstructor">preferredChain</a> <a id="2124" class="Symbol">:</a> <a id="2126" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2131" href="Peras.Protocol.html#1058" class="Postulate">Chain</a>
  <a id="Node.preferredVotes"></a><a id="2139" href="Peras.Protocol.html#2139" class="InductiveConstructor">preferredVotes</a> <a id="2154" class="Symbol">:</a> <a id="2156" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2161" class="Symbol">(</a><a id="2162" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="2167" class="Symbol">(</a><a id="2168" href="Peras.Protocol.html#1149" class="Postulate">set</a> <a id="2172" href="Peras.Protocol.html#1821" class="Datatype">Vote</a><a id="2176" class="Symbol">))</a>
  <a id="Node.certificates"></a><a id="2181" href="Peras.Protocol.html#2181" class="InductiveConstructor">certificates</a> <a id="2194" class="Symbol">:</a> <a id="2196" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2201" class="Symbol">(</a><a id="2202" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="2207" href="Peras.Protocol.html#1086" class="Postulate">Certificate</a><a id="2218" class="Symbol">)</a>
  <a id="Node.latestCertificateOnChain"></a><a id="2222" href="Peras.Protocol.html#2222" class="InductiveConstructor">latestCertificateOnChain</a> <a id="2247" class="Symbol">:</a> <a id="2249" href="Peras.Protocol.html#1058" class="Postulate">Chain</a> <a id="2255" class="Symbol">-&gt;</a> <a id="2258" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2263" href="Peras.Protocol.html#1086" class="Postulate">Certificate</a>
  <a id="Node.latestCertificateSeen"></a><a id="2277" href="Peras.Protocol.html#2277" class="InductiveConstructor">latestCertificateSeen</a> <a id="2299" class="Symbol">:</a> <a id="2301" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2306" href="Peras.Protocol.html#1086" class="Postulate">Certificate</a>
  <a id="Node.mkCertificate"></a><a id="2320" href="Peras.Protocol.html#2320" class="InductiveConstructor">mkCertificate</a> <a id="2334" class="Symbol">:</a> <a id="2336" href="Peras.Protocol.html#1021" class="Function">Round</a> <a id="2342" class="Symbol">-&gt;</a> <a id="2345" href="Peras.Protocol.html#1072" class="Postulate">Block</a> <a id="2351" class="Symbol">-&gt;</a> <a id="2354" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2359" href="Peras.Protocol.html#1086" class="Postulate">Certificate</a>
  <a id="Node.existsBlockWithQuorum"></a><a id="2373" href="Peras.Protocol.html#2373" class="InductiveConstructor">existsBlockWithQuorum</a> <a id="2395" class="Symbol">:</a> <a id="2397" href="Peras.Protocol.html#1149" class="Postulate">set</a> <a id="2401" href="Peras.Protocol.html#1821" class="Datatype">Vote</a> <a id="2406" class="Symbol">-&gt;</a> <a id="2409" class="Symbol">(</a><a id="2410" href="Agda.Builtin.Maybe.html#135" class="Datatype">Maybe</a> <a id="2416" href="Peras.Protocol.html#1072" class="Postulate">Block</a> <a id="2422" class="Symbol">-&gt;</a> <a id="2425" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2430" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a><a id="2431" class="Symbol">)</a> <a id="2433" class="Symbol">-&gt;</a> <a id="2436" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2441" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
  <a id="Node._extendWith_"></a><a id="2445" href="Peras.Protocol.html#2445" class="InductiveConstructor Operator">_extendWith_</a> <a id="2458" class="Symbol">:</a> <a id="2460" href="Peras.Protocol.html#1058" class="Postulate">Chain</a> <a id="2466" class="Symbol">-&gt;</a> <a id="2469" href="Peras.Protocol.html#1072" class="Postulate">Block</a> <a id="2475" class="Symbol">-&gt;</a> <a id="2478" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2483" href="Peras.Protocol.html#1058" class="Postulate">Chain</a>
  <a id="Node.output"></a><a id="2491" href="Peras.Protocol.html#2491" class="InductiveConstructor">output</a> <a id="2498" class="Symbol">:</a> <a id="2500" href="Peras.Protocol.html#1058" class="Postulate">Chain</a> <a id="2506" class="Symbol">-&gt;</a> <a id="2509" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2514" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
  <a id="Node._:=_"></a><a id="2518" href="Peras.Protocol.html#2518" class="InductiveConstructor Operator">_:=_</a> <a id="2523" class="Symbol">:</a> <a id="2525" class="Symbol">forall</a> <a id="2532" class="Symbol">{</a><a id="2533" href="Peras.Protocol.html#2533" class="Bound">a</a><a id="2534" class="Symbol">}</a> <a id="2536" class="Symbol">-&gt;</a> <a id="2539" href="Peras.Protocol.html#2533" class="Bound">a</a> <a id="2541" class="Symbol">-&gt;</a> <a id="2544" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2549" href="Peras.Protocol.html#2533" class="Bound">a</a> <a id="2551" class="Symbol">-&gt;</a> <a id="2554" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2559" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
  <a id="Node._+=_"></a><a id="2563" href="Peras.Protocol.html#2563" class="InductiveConstructor Operator">_+=_</a> <a id="2568" class="Symbol">:</a> <a id="2570" class="Symbol">forall</a> <a id="2577" class="Symbol">{</a><a id="2578" href="Peras.Protocol.html#2578" class="Bound">a</a> <a id="2580" class="Symbol">:</a> <a id="2582" href="Agda.Primitive.html#388" class="Primitive">Set</a><a id="2585" class="Symbol">}</a> <a id="2587" class="Symbol">-&gt;</a> <a id="2590" href="Peras.Protocol.html#2578" class="Bound">a</a> <a id="2592" class="Symbol">-&gt;</a> <a id="2595" href="Peras.Protocol.html#2578" class="Bound">a</a> <a id="2597" class="Symbol">-&gt;</a> <a id="2600" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="2605" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>

<a id="2608" class="Keyword">record</a> <a id="Monad"></a><a id="2615" href="Peras.Protocol.html#2615" class="Record">Monad</a> <a id="2621" class="Symbol">(</a><a id="2622" href="Peras.Protocol.html#2622" class="Bound">M</a> <a id="2624" class="Symbol">:</a> <a id="2626" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="2630" class="Symbol">-&gt;</a> <a id="2633" href="Agda.Primitive.html#388" class="Primitive">Set₁</a><a id="2637" class="Symbol">)</a> <a id="2639" class="Symbol">:</a> <a id="2641" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="2645" class="Keyword">where</a>
  <a id="2653" class="Keyword">field</a>
    <a id="Monad._&gt;&gt;=_"></a><a id="2663" href="Peras.Protocol.html#2663" class="Field Operator">_&gt;&gt;=_</a> <a id="2669" class="Symbol">:</a> <a id="2671" class="Symbol">forall</a> <a id="2678" class="Symbol">{</a><a id="2679" href="Peras.Protocol.html#2679" class="Bound">a</a><a id="2680" class="Symbol">}</a> <a id="2682" class="Symbol">{</a><a id="2683" href="Peras.Protocol.html#2683" class="Bound">b</a><a id="2684" class="Symbol">}</a> <a id="2686" class="Symbol">-&gt;</a> <a id="2689" href="Peras.Protocol.html#2622" class="Bound">M</a> <a id="2691" href="Peras.Protocol.html#2679" class="Bound">a</a> <a id="2693" class="Symbol">-&gt;</a> <a id="2696" class="Symbol">(</a><a id="2697" href="Peras.Protocol.html#2679" class="Bound">a</a> <a id="2699" class="Symbol">-&gt;</a> <a id="2702" href="Peras.Protocol.html#2622" class="Bound">M</a> <a id="2704" href="Peras.Protocol.html#2683" class="Bound">b</a><a id="2705" class="Symbol">)</a> <a id="2707" class="Symbol">-&gt;</a> <a id="2710" href="Peras.Protocol.html#2622" class="Bound">M</a> <a id="2712" href="Peras.Protocol.html#2683" class="Bound">b</a>
    <a id="Monad.return"></a><a id="2718" href="Peras.Protocol.html#2718" class="Field">return</a> <a id="2725" class="Symbol">:</a> <a id="2727" class="Symbol">forall</a> <a id="2734" class="Symbol">{</a><a id="2735" href="Peras.Protocol.html#2735" class="Bound">a</a><a id="2736" class="Symbol">}</a> <a id="2738" class="Symbol">-&gt;</a> <a id="2741" href="Peras.Protocol.html#2735" class="Bound">a</a> <a id="2743" class="Symbol">-&gt;</a> <a id="2746" href="Peras.Protocol.html#2622" class="Bound">M</a> <a id="2748" href="Peras.Protocol.html#2735" class="Bound">a</a>

  <a id="Monad._&gt;&gt;_"></a><a id="2753" href="Peras.Protocol.html#2753" class="Function Operator">_&gt;&gt;_</a> <a id="2758" class="Symbol">:</a> <a id="2760" class="Symbol">forall</a> <a id="2767" class="Symbol">{</a><a id="2768" href="Peras.Protocol.html#2768" class="Bound">a</a><a id="2769" class="Symbol">}</a> <a id="2771" class="Symbol">{</a><a id="2772" href="Peras.Protocol.html#2772" class="Bound">b</a><a id="2773" class="Symbol">}</a> <a id="2775" class="Symbol">-&gt;</a> <a id="2778" href="Peras.Protocol.html#2622" class="Bound">M</a> <a id="2780" href="Peras.Protocol.html#2768" class="Bound">a</a> <a id="2782" class="Symbol">-&gt;</a> <a id="2785" href="Peras.Protocol.html#2622" class="Bound">M</a> <a id="2787" href="Peras.Protocol.html#2772" class="Bound">b</a> <a id="2789" class="Symbol">-&gt;</a> <a id="2792" href="Peras.Protocol.html#2622" class="Bound">M</a> <a id="2794" href="Peras.Protocol.html#2772" class="Bound">b</a>
  <a id="2798" href="Peras.Protocol.html#2798" class="Bound">m</a> <a id="2800" href="Peras.Protocol.html#2753" class="Function Operator">&gt;&gt;</a> <a id="2803" href="Peras.Protocol.html#2803" class="Bound">m&#39;</a> <a id="2806" class="Symbol">=</a> <a id="2808" href="Peras.Protocol.html#2798" class="Bound">m</a> <a id="2810" href="Peras.Protocol.html#2663" class="Field Operator">&gt;&gt;=</a> <a id="2814" class="Symbol">λ</a> <a id="2816" href="Peras.Protocol.html#2816" class="Bound">_</a> <a id="2818" class="Symbol">-&gt;</a> <a id="2821" href="Peras.Protocol.html#2803" class="Bound">m&#39;</a>

  <a id="Monad.when"></a><a id="2827" href="Peras.Protocol.html#2827" class="Function">when</a> <a id="2832" class="Symbol">:</a> <a id="2834" class="Symbol">forall</a> <a id="2841" class="Symbol">{</a><a id="2842" href="Peras.Protocol.html#2842" class="Bound">a</a><a id="2843" class="Symbol">}</a> <a id="2845" class="Symbol">-&gt;</a> <a id="2848" href="Agda.Builtin.Bool.html#173" class="Datatype">Bool</a> <a id="2853" class="Symbol">-&gt;</a> <a id="2856" href="Peras.Protocol.html#2622" class="Bound">M</a> <a id="2858" href="Peras.Protocol.html#2842" class="Bound">a</a> <a id="2860" class="Symbol">-&gt;</a> <a id="2863" href="Peras.Protocol.html#2622" class="Bound">M</a> <a id="2865" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
  <a id="2869" href="Peras.Protocol.html#2827" class="Function">when</a> <a id="2874" href="Peras.Protocol.html#2874" class="Bound">cond</a> <a id="2879" href="Peras.Protocol.html#2879" class="Bound">act</a> <a id="2883" class="Symbol">=</a>
    <a id="2889" href="Data.Bool.Base.html#1505" class="Function Operator">if</a> <a id="2892" href="Peras.Protocol.html#2874" class="Bound">cond</a>
     <a id="2902" href="Data.Bool.Base.html#1505" class="Function Operator">then</a> <a id="2907" href="Peras.Protocol.html#2879" class="Bound">act</a> <a id="2911" href="Peras.Protocol.html#2753" class="Function Operator">&gt;&gt;</a> <a id="2914" href="Peras.Protocol.html#2718" class="Field">return</a> <a id="2921" class="Symbol">_</a>
     <a id="2928" href="Data.Bool.Base.html#1505" class="Function Operator">else</a> <a id="2933" href="Peras.Protocol.html#2718" class="Field">return</a> <a id="2940" class="Symbol">_</a>

<a id="2943" class="Keyword">instance</a>
  <a id="NodeMonad"></a><a id="2954" href="Peras.Protocol.html#2954" class="Function">NodeMonad</a> <a id="2964" class="Symbol">:</a> <a id="2966" href="Peras.Protocol.html#2615" class="Record">Monad</a> <a id="2972" href="Peras.Protocol.html#1952" class="Datatype">Node</a>
  <a id="2979" href="Peras.Protocol.html#2954" class="Function">NodeMonad</a> <a id="2989" class="Symbol">=</a> <a id="2991" class="Keyword">record</a> <a id="2998" class="Symbol">{</a> <a id="3000" href="Peras.Protocol.html#2663" class="Field Operator">_&gt;&gt;=_</a> <a id="3006" class="Symbol">=</a> <a id="3008" href="Peras.Protocol.html#1979" class="InductiveConstructor">bind</a> <a id="3013" class="Symbol">;</a> <a id="3015" href="Peras.Protocol.html#2718" class="Field">return</a> <a id="3022" class="Symbol">=</a> <a id="3024" href="Peras.Protocol.html#2040" class="InductiveConstructor">ret</a> <a id="3028" class="Symbol">}</a>

<a id="3031" class="Keyword">open</a> <a id="3036" href="Peras.Protocol.html#2615" class="Module">Monad</a> <a id="3042" class="Symbol">{{...}}</a> <a id="3050" class="Keyword">public</a>

<a id="3058" class="Keyword">postulate</a>
  <a id="Cpref"></a><a id="3070" href="Peras.Protocol.html#3070" class="Postulate">Cpref</a> <a id="3076" class="Symbol">:</a> <a id="3078" href="Peras.Protocol.html#1058" class="Postulate">Chain</a>
  <a id="certseen"></a><a id="3086" href="Peras.Protocol.html#3086" class="Postulate">certseen</a> <a id="3095" class="Symbol">:</a> <a id="3097" href="Peras.Protocol.html#1086" class="Postulate">Certificate</a>
  <a id="certchain"></a><a id="3111" href="Peras.Protocol.html#3111" class="Postulate">certchain</a> <a id="3121" class="Symbol">:</a> <a id="3123" href="Peras.Protocol.html#1086" class="Postulate">Certificate</a>
  <a id="Vpref"></a><a id="3137" href="Peras.Protocol.html#3137" class="Postulate">Vpref</a> <a id="3143" class="Symbol">:</a> <a id="3145" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="3150" class="Symbol">(</a><a id="3151" href="Peras.Protocol.html#1149" class="Postulate">set</a> <a id="3155" href="Peras.Protocol.html#1821" class="Datatype">Vote</a><a id="3159" class="Symbol">)</a>
  <a id="Certs"></a><a id="3163" href="Peras.Protocol.html#3163" class="Postulate">Certs</a> <a id="3169" class="Symbol">:</a> <a id="3171" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="3176" href="Peras.Protocol.html#1086" class="Postulate">Certificate</a>

<a id="3189" class="Comment">-- Original specification from Google doc</a>
<a id="3231" class="Comment">--</a>
<a id="3234" class="Comment">-- upon entering new slot s</a>
<a id="3262" class="Comment">--    if P is leader in slot s</a>
<a id="3293" class="Comment">--      B := new block extending Cpref</a>
<a id="3332" class="Comment">--      if Certs[rcurrent-2] = null</a>
<a id="3368" class="Comment">--         and rcurrent - round(certseen) &lt;= A</a>
<a id="3415" class="Comment">--         and round(certseen) &gt; round(certchain)</a>
<a id="3465" class="Comment">--           B := (B, certseen)</a>
<a id="3497" class="Comment">--           Cpref := Cpref || B</a>
<a id="3530" class="Comment">--           output (chain, Cpref&lt;-W&gt;) to Z</a>
<a id="onNewSlot"></a><a id="3574" href="Peras.Protocol.html#3574" class="Function">onNewSlot</a> <a id="3584" class="Symbol">:</a> <a id="3586" href="Peras.Protocol.html#1044" class="Postulate">Party</a> <a id="3592" class="Symbol">-&gt;</a> <a id="3595" href="Peras.Protocol.html#1011" class="Function">Slot</a> <a id="3600" class="Symbol">-&gt;</a> <a id="3603" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="3608" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="3610" href="Peras.Protocol.html#3574" class="Function">onNewSlot</a> <a id="3620" href="Peras.Protocol.html#3620" class="Bound">p</a> <a id="3622" href="Peras.Protocol.html#3622" class="Bound">s</a> <a id="3624" class="Symbol">=</a>
 <a id="3627" href="Peras.Protocol.html#2827" class="Function">when</a> <a id="3632" class="Symbol">(</a><a id="3633" href="Peras.Protocol.html#3620" class="Bound">p</a> <a id="3635" href="Peras.Protocol.html#1270" class="Postulate Operator">isLeaderInSlot</a> <a id="3650" href="Peras.Protocol.html#3622" class="Bound">s</a><a id="3651" class="Symbol">)</a> <a id="3653" class="Symbol">(</a><a id="3654" class="Keyword">do</a>
     <a id="3662" href="Peras.Protocol.html#3662" class="Bound">b</a> <a id="3664" href="Peras.Protocol.html#2663" class="Field Operator">←</a> <a id="3666" href="Peras.Protocol.html#2074" class="InductiveConstructor">forgeBlock</a> <a id="3677" href="Peras.Protocol.html#3070" class="Postulate">Cpref</a>
     <a id="3688" class="Keyword">let</a> <a id="3692" href="Peras.Protocol.html#3692" class="Bound">rcurrent</a> <a id="3701" class="Symbol">=</a> <a id="3703" href="Peras.Protocol.html#3622" class="Bound">s</a> <a id="3705" href="Peras.Protocol.html#1740" class="Postulate Operator">/</a> <a id="3707" href="Peras.Protocol.html#1761" class="Postulate">U</a>
     <a id="3714" href="Peras.Protocol.html#2827" class="Function">when</a>
       <a id="3726" class="Symbol">(</a> <a id="3728" class="Symbol">(</a><a id="3729" href="Peras.Protocol.html#3163" class="Postulate">Certs</a> <a id="3735" href="Peras.Protocol.html#1501" class="Postulate Operator">[</a> <a id="3737" href="Peras.Protocol.html#3692" class="Bound">rcurrent</a> <a id="3746" href="Peras.Protocol.html#1720" class="Postulate Operator">-</a> <a id="3748" class="Number">2</a> <a id="3750" href="Peras.Protocol.html#1501" class="Postulate Operator">]</a><a id="3751" class="Symbol">)</a> <a id="3753" href="Peras.Protocol.html#1575" class="Postulate Operator">==</a> <a id="3756" href="Peras.Protocol.html#1207" class="Postulate">null</a>
           <a id="3772" href="Data.Bool.Base.html#995" class="Function Operator">∧</a> <a id="3774" class="Symbol">((</a><a id="3776" href="Peras.Protocol.html#3692" class="Bound">rcurrent</a> <a id="3785" href="Peras.Protocol.html#1720" class="Postulate Operator">-</a> <a id="3787" href="Peras.Protocol.html#1473" class="Postulate">round</a> <a id="3793" href="Peras.Protocol.html#3086" class="Postulate">certseen</a><a id="3801" class="Symbol">)</a> <a id="3803" href="Peras.Protocol.html#1651" class="Postulate Operator">≤</a> <a id="3805" href="Peras.Protocol.html#1769" class="Postulate">A</a><a id="3806" class="Symbol">)</a>
           <a id="3819" href="Data.Bool.Base.html#995" class="Function Operator">∧</a> <a id="3821" class="Symbol">(</a><a id="3822" href="Peras.Protocol.html#1473" class="Postulate">round</a> <a id="3828" href="Peras.Protocol.html#3086" class="Postulate">certseen</a> <a id="3837" href="Peras.Protocol.html#1697" class="Postulate Operator">&gt;</a> <a id="3839" href="Peras.Protocol.html#1473" class="Postulate">round</a> <a id="3845" href="Peras.Protocol.html#3111" class="Postulate">certchain</a><a id="3854" class="Symbol">)</a>
       <a id="3863" class="Symbol">)</a> <a id="3865" class="Keyword">do</a>
         <a id="3877" class="Keyword">let</a> <a id="3881" href="Peras.Protocol.html#3881" class="Bound">b&#39;</a> <a id="3884" class="Symbol">=</a> <a id="3886" href="Peras.Protocol.html#1106" class="Postulate">Certify</a> <a id="3894" href="Peras.Protocol.html#3662" class="Bound">b</a> <a id="3896" href="Peras.Protocol.html#3086" class="Postulate">certseen</a>
         <a id="3914" href="Peras.Protocol.html#3914" class="Bound">Cpref</a> <a id="3920" href="Peras.Protocol.html#2663" class="Field Operator">←</a> <a id="3922" href="Peras.Protocol.html#3070" class="Postulate">Cpref</a> <a id="3928" href="Peras.Protocol.html#2445" class="InductiveConstructor Operator">extendWith</a> <a id="3939" href="Peras.Protocol.html#3662" class="Bound">b</a>
         <a id="3950" href="Peras.Protocol.html#2491" class="InductiveConstructor">output</a> <a id="3957" class="Symbol">(</a><a id="3958" href="Peras.Protocol.html#3914" class="Bound">Cpref</a> <a id="3964" href="Peras.Protocol.html#1313" class="Postulate Operator">trimmedBy</a> <a id="3974" href="Peras.Protocol.html#1777" class="Postulate">W</a><a id="3975" class="Symbol">))</a>

<a id="3979" class="Comment">-- if (round(certseen) = r-1 and certseen is for a block on Cpref)</a>
<a id="4046" class="Comment">--    or</a>
<a id="4055" class="Comment">--    r - round(certseen) &gt;= R and r - round(certchain) = cK for some c &gt; 0</a>
<a id="4131" class="Comment">--   return true</a>
<a id="4148" class="Comment">-- return false</a>

<a id="cooldownHasPassed"></a><a id="4165" href="Peras.Protocol.html#4165" class="Function">cooldownHasPassed</a> <a id="4183" class="Symbol">:</a> <a id="4185" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="4187" class="Symbol">-&gt;</a> <a id="4190" href="Agda.Builtin.Bool.html#173" class="Datatype">Bool</a>
<a id="4195" href="Peras.Protocol.html#4165" class="Function">cooldownHasPassed</a> <a id="4213" href="Peras.Protocol.html#4213" class="Bound">rounds</a> <a id="4220" class="Keyword">with</a> <a id="4225" href="Peras.Protocol.html#1809" class="Postulate">K</a>
<a id="4227" class="Symbol">...</a> <a id="4231" class="Symbol">|</a> <a id="4233" class="Number">0</a> <a id="4235" class="MissingDefinition Symbol">=</a> <a id="4237" href="Agda.Builtin.Bool.html#192" class="InductiveConstructor">false</a>
<a id="4243" class="Symbol">...</a> <a id="4247" class="Symbol">|</a> <a id="4249" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="4253" href="Peras.Protocol.html#4253" class="Bound">n</a> <a id="4255" class="Symbol">=</a> <a id="4257" class="Symbol">(</a><a id="4258" href="Peras.Protocol.html#4291" class="Function">q</a> <a id="4260" href="Peras.Protocol.html#1697" class="Postulate Operator">&gt;</a> <a id="4262" class="Number">0</a><a id="4263" class="Symbol">)</a> <a id="4265" href="Data.Bool.Base.html#995" class="Function Operator">∧</a> <a id="4267" class="Symbol">(</a><a id="4268" href="Peras.Protocol.html#4319" class="Function">r</a> <a id="4270" href="Peras.Protocol.html#1575" class="Postulate Operator">==</a> <a id="4273" class="Number">0</a><a id="4274" class="Symbol">)</a>
    <a id="4280" class="Keyword">where</a>
     <a id="4291" href="Peras.Protocol.html#4291" class="Function">q</a> <a id="4293" class="Symbol">=</a> <a id="4295" class="Bound">rounds</a> <a id="4302" href="Data.Nat.DivMod.html#18903" class="Function Operator">div</a> <a id="4306" class="Symbol">(</a><a id="4307" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="4311" href="Peras.Protocol.html#4253" class="Bound">n</a><a id="4312" class="Symbol">)</a>
     <a id="4319" href="Peras.Protocol.html#4319" class="Function">r</a> <a id="4321" class="Symbol">=</a> <a id="4323" class="Bound">rounds</a> <a id="4330" href="Data.Nat.Base.html#7279" class="Function Operator">%</a> <a id="4332" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="4336" href="Peras.Protocol.html#4253" class="Bound">n</a>

<a id="voteInRound"></a><a id="4339" href="Peras.Protocol.html#4339" class="Function">voteInRound</a> <a id="4351" class="Symbol">:</a> <a id="4353" href="Peras.Protocol.html#1058" class="Postulate">Chain</a> <a id="4359" class="Symbol">-&gt;</a> <a id="4362" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="4367" href="Peras.Protocol.html#1086" class="Postulate">Certificate</a> <a id="4379" class="Symbol">-&gt;</a> <a id="4382" href="Peras.Protocol.html#1021" class="Function">Round</a> <a id="4388" class="Symbol">-&gt;</a> <a id="4391" href="Agda.Builtin.Bool.html#173" class="Datatype">Bool</a>
<a id="4396" href="Peras.Protocol.html#4339" class="Function">voteInRound</a> <a id="4408" href="Peras.Protocol.html#4408" class="Bound">chain</a> <a id="4414" href="Peras.Protocol.html#4414" class="Bound">certs</a> <a id="4420" href="Peras.Protocol.html#4420" class="Bound">r</a> <a id="4422" class="Symbol">=</a>
  <a id="4426" class="Symbol">(</a><a id="4427" href="Peras.Protocol.html#1473" class="Postulate">round</a> <a id="4433" href="Peras.Protocol.html#3086" class="Postulate">certseen</a> <a id="4442" href="Peras.Protocol.html#1575" class="Postulate Operator">==</a> <a id="4445" class="Symbol">(</a><a id="4446" href="Peras.Protocol.html#4420" class="Bound">r</a> <a id="4448" href="Peras.Protocol.html#1720" class="Postulate Operator">-</a> <a id="4450" class="Number">1</a><a id="4451" class="Symbol">)</a> <a id="4453" href="Data.Bool.Base.html#995" class="Function Operator">∧</a> <a id="4455" href="Peras.Protocol.html#3086" class="Postulate">certseen</a> <a id="4464" href="Peras.Protocol.html#1403" class="Postulate Operator">pointsInto</a> <a id="4475" href="Peras.Protocol.html#3070" class="Postulate">Cpref</a><a id="4480" class="Symbol">)</a>
   <a id="4485" href="Data.Bool.Base.html#1053" class="Function Operator">∨</a> <a id="4487" class="Symbol">((</a><a id="4489" href="Peras.Protocol.html#4420" class="Bound">r</a> <a id="4491" href="Peras.Protocol.html#1720" class="Postulate Operator">-</a> <a id="4493" href="Peras.Protocol.html#1473" class="Postulate">round</a> <a id="4499" href="Peras.Protocol.html#3086" class="Postulate">certseen</a><a id="4507" class="Symbol">)</a> <a id="4509" href="Peras.Protocol.html#1674" class="Postulate Operator">≥</a> <a id="4511" href="Peras.Protocol.html#1801" class="Postulate">R</a> <a id="4513" href="Data.Bool.Base.html#995" class="Function Operator">∧</a> <a id="4515" href="Peras.Protocol.html#4165" class="Function">cooldownHasPassed</a> <a id="4533" class="Symbol">(</a><a id="4534" href="Peras.Protocol.html#4420" class="Bound">r</a> <a id="4536" href="Peras.Protocol.html#1720" class="Postulate Operator">-</a> <a id="4538" href="Peras.Protocol.html#1473" class="Postulate">round</a> <a id="4544" href="Peras.Protocol.html#3111" class="Postulate">certchain</a><a id="4553" class="Symbol">))</a>


<a id="4558" class="Comment">-- upon entering new round r &gt; 0</a>
<a id="4591" class="Comment">--   if P is committee member in round r and voteInRound(Cpref, Certs, r)</a>
<a id="4665" class="Comment">--     Vpref[r] += (“vote”, r, P, C[slot(r)-L])</a>
<a id="onNewRound"></a><a id="4713" href="Peras.Protocol.html#4713" class="Function">onNewRound</a> <a id="4724" class="Symbol">:</a> <a id="4726" href="Peras.Protocol.html#1044" class="Postulate">Party</a> <a id="4732" class="Symbol">-&gt;</a> <a id="4735" href="Peras.Protocol.html#1021" class="Function">Round</a> <a id="4741" class="Symbol">-&gt;</a> <a id="4744" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="4749" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="4751" href="Peras.Protocol.html#4713" class="Function">onNewRound</a> <a id="4762" href="Peras.Protocol.html#4762" class="Bound">P</a> <a id="4764" href="Peras.Protocol.html#4764" class="Bound">r</a> <a id="4766" class="Symbol">=</a>
  <a id="4770" href="Peras.Protocol.html#2827" class="Function">when</a> <a id="4775" class="Symbol">(</a> <a id="4777" class="Symbol">(</a><a id="4778" href="Peras.Protocol.html#4762" class="Bound">P</a> <a id="4780" href="Peras.Protocol.html#1349" class="Postulate Operator">isCommitteeMemberInRound</a> <a id="4805" href="Peras.Protocol.html#4764" class="Bound">r</a><a id="4806" class="Symbol">)</a> <a id="4808" href="Data.Bool.Base.html#995" class="Function Operator">∧</a>
         <a id="4819" href="Peras.Protocol.html#4339" class="Function">voteInRound</a> <a id="4831" href="Peras.Protocol.html#3070" class="Postulate">Cpref</a> <a id="4837" href="Peras.Protocol.html#3163" class="Postulate">Certs</a> <a id="4843" href="Peras.Protocol.html#4764" class="Bound">r</a> <a id="4845" class="Symbol">)</a>
      <a id="4853" class="Symbol">((</a><a id="4855" href="Peras.Protocol.html#3137" class="Postulate">Vpref</a> <a id="4861" href="Peras.Protocol.html#1501" class="Postulate Operator">[</a> <a id="4863" href="Peras.Protocol.html#4764" class="Bound">r</a> <a id="4865" href="Peras.Protocol.html#1501" class="Postulate Operator">]</a><a id="4866" class="Symbol">)</a> <a id="4868" href="Peras.Protocol.html#2563" class="InductiveConstructor Operator">+=</a> <a id="4871" href="Peras.Protocol.html#1168" class="Postulate">singleton</a> <a id="4881" class="Symbol">(</a><a id="4882" href="Peras.Protocol.html#1839" class="InductiveConstructor">MkVote</a> <a id="4889" href="Peras.Protocol.html#4764" class="Bound">r</a> <a id="4891" href="Peras.Protocol.html#4762" class="Bound">P</a> <a id="4893" class="Symbol">(</a><a id="4894" href="Peras.Protocol.html#3070" class="Postulate">Cpref</a> <a id="4900" href="Peras.Protocol.html#1542" class="Postulate Operator">⟦</a> <a id="4902" class="Symbol">(</a><a id="4903" href="Peras.Protocol.html#1881" class="Function">slot</a> <a id="4908" href="Peras.Protocol.html#4764" class="Bound">r</a> <a id="4910" href="Peras.Protocol.html#1720" class="Postulate Operator">-</a> <a id="4912" href="Peras.Protocol.html#1785" class="Postulate">L</a><a id="4913" class="Symbol">)</a> <a id="4915" href="Peras.Protocol.html#1542" class="Postulate Operator">⟧</a><a id="4916" class="Symbol">)))</a>

<a id="4921" class="Comment">-- upon change in a peer’s V’pref[rcurrent]</a>
<a id="4965" class="Comment">--   if Certspref[rcurrent] = null</a>
<a id="5000" class="Comment">--      Vpref[rcurrent] += V’pref[rcurrent] 	preferring the versions in Vpref in case of equivocations</a>
<a id="5103" class="Comment">--      if exists C s.t. |{ (.,.,.,C) in Vpref[rcurrent] }| &gt;= τ</a>
<a id="5168" class="Comment">--           create certificate cert on C from corresponding votes in Vpref[rcurrent]</a>
<a id="5254" class="Comment">--           Certspref[rcurrent] := cert</a>

<a id="onPeerVotesChange"></a><a id="5296" href="Peras.Protocol.html#5296" class="Function">onPeerVotesChange</a> <a id="5314" class="Symbol">:</a> <a id="5316" href="Peras.Protocol.html#1149" class="Postulate">set</a> <a id="5320" href="Peras.Protocol.html#1821" class="Datatype">Vote</a> <a id="5325" class="Symbol">-&gt;</a> <a id="5328" href="Peras.Protocol.html#1021" class="Function">Round</a> <a id="5334" class="Symbol">-&gt;</a> <a id="5337" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="5342" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="5344" href="Peras.Protocol.html#5296" class="Function">onPeerVotesChange</a> <a id="5362" href="Peras.Protocol.html#5362" class="Bound">v&#39;pref</a> <a id="5369" href="Peras.Protocol.html#5369" class="Bound">rcurrent</a> <a id="5378" class="Symbol">=</a> <a id="5380" class="Keyword">do</a>
  <a id="5385" href="Peras.Protocol.html#2827" class="Function">when</a> <a id="5390" class="Symbol">((</a><a id="5392" href="Peras.Protocol.html#3163" class="Postulate">Certs</a> <a id="5398" href="Peras.Protocol.html#1501" class="Postulate Operator">[</a> <a id="5400" href="Peras.Protocol.html#5369" class="Bound">rcurrent</a> <a id="5409" href="Peras.Protocol.html#1501" class="Postulate Operator">]</a><a id="5410" class="Symbol">)</a> <a id="5412" href="Peras.Protocol.html#1575" class="Postulate Operator">==</a> <a id="5415" href="Peras.Protocol.html#1207" class="Postulate">null</a><a id="5419" class="Symbol">)</a> <a id="5421" class="Symbol">(</a><a id="5422" class="Keyword">do</a>
     <a id="5430" class="Symbol">(</a><a id="5431" href="Peras.Protocol.html#3137" class="Postulate">Vpref</a> <a id="5437" href="Peras.Protocol.html#1501" class="Postulate Operator">[</a> <a id="5439" href="Peras.Protocol.html#5369" class="Bound">rcurrent</a> <a id="5448" href="Peras.Protocol.html#1501" class="Postulate Operator">]</a><a id="5449" class="Symbol">)</a> <a id="5451" href="Peras.Protocol.html#2563" class="InductiveConstructor Operator">+=</a> <a id="5454" href="Peras.Protocol.html#5362" class="Bound">v&#39;pref</a>
     <a id="5466" href="Peras.Protocol.html#2373" class="InductiveConstructor">existsBlockWithQuorum</a> <a id="5488" class="Symbol">(</a><a id="5489" href="Peras.Protocol.html#3137" class="Postulate">Vpref</a> <a id="5495" href="Peras.Protocol.html#1501" class="Postulate Operator">[</a> <a id="5497" href="Peras.Protocol.html#5369" class="Bound">rcurrent</a> <a id="5506" href="Peras.Protocol.html#1501" class="Postulate Operator">]</a><a id="5507" class="Symbol">)</a> <a id="5509" class="Symbol">λ</a> <a id="5511" class="Keyword">where</a>
        <a id="5525" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a> <a id="5533" class="Symbol">-&gt;</a> <a id="5536" href="Peras.Protocol.html#2718" class="Field">return</a> <a id="5543" class="Symbol">_</a>
        <a id="5553" class="Symbol">(</a><a id="5554" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="5559" href="Peras.Protocol.html#5559" class="Bound">C</a><a id="5560" class="Symbol">)</a> <a id="5562" class="Symbol">-&gt;</a>
          <a id="5575" class="Symbol">(</a><a id="5576" href="Peras.Protocol.html#3163" class="Postulate">Certs</a> <a id="5582" href="Peras.Protocol.html#1501" class="Postulate Operator">[</a> <a id="5584" href="Peras.Protocol.html#5369" class="Bound">rcurrent</a> <a id="5593" href="Peras.Protocol.html#1501" class="Postulate Operator">]</a><a id="5594" class="Symbol">)</a> <a id="5596" href="Peras.Protocol.html#2518" class="InductiveConstructor Operator">:=</a> <a id="5599" href="Peras.Protocol.html#2320" class="InductiveConstructor">mkCertificate</a> <a id="5613" href="Peras.Protocol.html#5369" class="Bound">rcurrent</a> <a id="5622" href="Peras.Protocol.html#5559" class="Bound">C</a>
     <a id="5629" class="Symbol">)</a>


<a id="5633" class="Comment">-- upon change in peer’s Certs’pref[r] for some r</a>
<a id="5683" class="Comment">--   if Certspref[r] = null</a>
<a id="5711" class="Comment">--     Certspref[r] := Certs’pref[r]</a>

<a id="onPeerCertsChange"></a><a id="5749" href="Peras.Protocol.html#5749" class="Function">onPeerCertsChange</a> <a id="5767" class="Symbol">:</a> <a id="5769" href="Peras.Protocol.html#1086" class="Postulate">Certificate</a> <a id="5781" class="Symbol">-&gt;</a> <a id="5784" href="Peras.Protocol.html#1021" class="Function">Round</a> <a id="5790" class="Symbol">-&gt;</a> <a id="5793" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="5798" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="5800" href="Peras.Protocol.html#5749" class="Function">onPeerCertsChange</a> <a id="5818" href="Peras.Protocol.html#5818" class="Bound">certs&#39;pref</a> <a id="5829" href="Peras.Protocol.html#5829" class="Bound">r</a> <a id="5831" class="Symbol">=</a>
  <a id="5835" href="Peras.Protocol.html#2827" class="Function">when</a> <a id="5840" class="Symbol">((</a><a id="5842" href="Peras.Protocol.html#3163" class="Postulate">Certs</a> <a id="5848" href="Peras.Protocol.html#1501" class="Postulate Operator">[</a> <a id="5850" href="Peras.Protocol.html#5829" class="Bound">r</a> <a id="5852" href="Peras.Protocol.html#1501" class="Postulate Operator">]</a><a id="5853" class="Symbol">)</a> <a id="5855" href="Peras.Protocol.html#1575" class="Postulate Operator">==</a> <a id="5858" href="Peras.Protocol.html#1207" class="Postulate">null</a><a id="5862" class="Symbol">)</a> <a id="5864" href="Function.Base.html#1974" class="Function Operator">$</a>
     <a id="5871" class="Symbol">(</a><a id="5872" href="Peras.Protocol.html#3163" class="Postulate">Certs</a> <a id="5878" href="Peras.Protocol.html#1501" class="Postulate Operator">[</a> <a id="5880" href="Peras.Protocol.html#5829" class="Bound">r</a> <a id="5882" href="Peras.Protocol.html#1501" class="Postulate Operator">]</a><a id="5883" class="Symbol">)</a> <a id="5885" href="Peras.Protocol.html#2518" class="InductiveConstructor Operator">:=</a> <a id="5888" href="Peras.Protocol.html#2718" class="Field">return</a> <a id="5895" href="Peras.Protocol.html#5818" class="Bound">certs&#39;pref</a>

<a id="5907" class="Comment">-- A Peras chain consists of a set of blocks. A chain is valid if the blocks (ignoring the certificates) form a valid Praos chain.</a>
<a id="6038" class="Comment">-- The following algorithm is used to compute the weight, given a set of certificates:</a>

<a id="chainWeight"></a><a id="6126" href="Peras.Protocol.html#6126" class="Function">chainWeight</a> <a id="6138" class="Symbol">:</a> <a id="6140" href="Peras.Protocol.html#1058" class="Postulate">Chain</a> <a id="6146" class="Symbol">-&gt;</a> <a id="6149" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="6154" href="Peras.Protocol.html#1086" class="Postulate">Certificate</a> <a id="6166" class="Symbol">-&gt;</a> <a id="6169" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
<a id="6171" href="Peras.Protocol.html#6126" class="Function">chainWeight</a> <a id="6183" href="Peras.Protocol.html#6183" class="Bound">chain</a> <a id="6189" href="Peras.Protocol.html#6189" class="Bound">certs</a> <a id="6195" class="Symbol">=</a>
   <a id="6200" href="Data.List.Base.html#4336" class="Function">foldr</a> <a id="6206" class="Symbol">(λ</a> <a id="6209" href="Peras.Protocol.html#6209" class="Bound">cert</a> <a id="6214" href="Peras.Protocol.html#6214" class="Bound">weight</a> <a id="6221" class="Symbol">-&gt;</a>
           <a id="6235" href="Data.Bool.Base.html#1505" class="Function Operator">if</a> <a id="6238" class="Symbol">(</a><a id="6239" href="Peras.Protocol.html#6209" class="Bound">cert</a> <a id="6244" href="Peras.Protocol.html#1403" class="Postulate Operator">pointsInto</a> <a id="6255" href="Peras.Protocol.html#6183" class="Bound">chain</a><a id="6260" class="Symbol">)</a>
           <a id="6273" href="Data.Bool.Base.html#1505" class="Function Operator">then</a>  <a id="6279" href="Peras.Protocol.html#6214" class="Bound">weight</a> <a id="6286" href="Agda.Builtin.Nat.html#336" class="Primitive Operator">+</a> <a id="6288" href="Peras.Protocol.html#1793" class="Postulate">B</a>
           <a id="6301" href="Data.Bool.Base.html#1505" class="Function Operator">else</a> <a id="6306" href="Peras.Protocol.html#6214" class="Bound">weight</a><a id="6312" class="Symbol">)</a>
         <a id="6323" class="Symbol">(</a><a id="6324" href="Peras.Protocol.html#1450" class="Postulate">length</a> <a id="6331" href="Peras.Protocol.html#6183" class="Bound">chain</a><a id="6336" class="Symbol">)</a> <a id="6338" href="Peras.Protocol.html#6189" class="Bound">certs</a>

<a id="onPeerChainChange"></a><a id="6345" href="Peras.Protocol.html#6345" class="Function">onPeerChainChange</a> <a id="6363" class="Symbol">:</a> <a id="6365" href="Peras.Protocol.html#1058" class="Postulate">Chain</a> <a id="6371" class="Symbol">-&gt;</a> <a id="6374" href="Peras.Protocol.html#1086" class="Postulate">Certificate</a> <a id="6386" class="Symbol">-&gt;</a> <a id="6389" href="Peras.Protocol.html#1952" class="Datatype">Node</a> <a id="6394" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="6396" href="Peras.Protocol.html#6345" class="Function">onPeerChainChange</a> <a id="6414" href="Peras.Protocol.html#6414" class="Bound">C&#39;pref</a> <a id="6421" href="Peras.Protocol.html#6421" class="Bound">Certs&#39;pref</a> <a id="6432" class="Symbol">=</a> <a id="6434" class="Keyword">do</a>
  <a id="6439" href="Peras.Protocol.html#2827" class="Function">when</a> <a id="6444" class="Symbol">(</a><a id="6445" href="Peras.Protocol.html#6126" class="Function">chainWeight</a> <a id="6457" href="Peras.Protocol.html#6414" class="Bound">C&#39;pref</a> <a id="6464" href="Peras.Protocol.html#3163" class="Postulate">Certs</a> <a id="6470" href="Peras.Protocol.html#1697" class="Postulate Operator">&gt;</a> <a id="6472" href="Peras.Protocol.html#6126" class="Function">chainWeight</a> <a id="6484" href="Peras.Protocol.html#3070" class="Postulate">Cpref</a> <a id="6490" href="Peras.Protocol.html#3163" class="Postulate">Certs</a><a id="6495" class="Symbol">)</a> <a id="6497" href="Function.Base.html#1974" class="Function Operator">$</a>
     <a id="6504" href="Peras.Protocol.html#3070" class="Postulate">Cpref</a> <a id="6510" href="Peras.Protocol.html#2518" class="InductiveConstructor Operator">:=</a> <a id="6513" href="Peras.Protocol.html#2718" class="Field">return</a> <a id="6520" href="Peras.Protocol.html#6414" class="Bound">C&#39;pref</a>
  <a id="6529" href="Peras.Protocol.html#2491" class="InductiveConstructor">output</a> <a id="6536" class="Symbol">(</a><a id="6537" href="Peras.Protocol.html#3070" class="Postulate">Cpref</a> <a id="6543" href="Peras.Protocol.html#1313" class="Postulate Operator">trimmedBy</a> <a id="6553" href="Peras.Protocol.html#1777" class="Postulate">W</a><a id="6554" class="Symbol">)</a>
</pre></body></html>