<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-reports/tech-report-1" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.3.2">
<title data-rh="true">Peras Technical Report #1 | Ouroboros Peras</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://input-output-hk.github.io/peras-design/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://input-output-hk.github.io/peras-design/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://input-output-hk.github.io/peras-design/docs/reports/tech-report-1"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Peras Technical Report #1 | Ouroboros Peras"><meta data-rh="true" name="description" content="The goal of this document is to provide a detailed analysis of the Peras protocol from an engineering point of view, based upon the work done by the Innovation team between November and April 2024. The design of the protocol itself is carried out by the Research team and is not the focus of this document as the paper is still actively being worked on."><meta data-rh="true" property="og:description" content="The goal of this document is to provide a detailed analysis of the Peras protocol from an engineering point of view, based upon the work done by the Innovation team between November and April 2024. The design of the protocol itself is carried out by the Research team and is not the focus of this document as the paper is still actively being worked on."><link data-rh="true" rel="icon" href="/peras-design/img/pilcrow.ico"><link data-rh="true" rel="canonical" href="https://input-output-hk.github.io/peras-design/docs/reports/tech-report-1"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/peras-design/docs/reports/tech-report-1" hreflang="en"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/peras-design/docs/reports/tech-report-1" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/peras-design/weekly/rss.xml" title="Peras R&amp;D Feed RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/peras-design/weekly/atom.xml" title="Peras R&amp;D Feed Atom Feed">
<link rel="alternate" type="application/json" href="/peras-design/weekly/feed.json" title="Peras R&amp;D Feed JSON Feed">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/peras-design/assets/css/styles.8b81767d.css">
<script src="/peras-design/assets/js/runtime~main.07bd8bda.js" defer="defer"></script>
<script src="/peras-design/assets/js/main.83e32cbc.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/peras-design/"><div class="navbar__logo"><img src="/peras-design/img/pilcrow.jpeg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/peras-design/img/pilcrow.jpeg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Peras R&amp;D</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/peras-design/docs/reports/">Documents</a><a href="/peras-design/agda_html/Peras.Protocol.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Formal Specification</a><a class="navbar__item navbar__link" href="/peras-design/weekly">Updates</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/input-output-hk/peras-design" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/peras-design/docs/reports/">Reports</a><button aria-label="Collapse sidebar category &#x27;Reports&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/peras-design/docs/reports/2024-04-10-paris-workshop">Peras Team Paris Workshop</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/peras-design/docs/reports/cip">Peras - Faster Settlement on Cardano</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/peras-design/docs/reports/tech-report-1">Peras Technical Report #1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/peras-design/docs/reports/tech-report-2">Peras Technical Report #2</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/peras-design/docs/diagrams/">Peras Diagrams</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/peras-design/docs/intro">What is Peras?</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/peras-design/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/peras-design/docs/reports/"><span itemprop="name">Reports</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Peras Technical Report #1</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><p>The goal of this document is to provide a detailed analysis of the Peras protocol from an engineering point of view, based upon the work done by the <em>Innovation team</em> between November and April 2024. The design of the protocol itself is carried out by the <em>Research team</em> and is not the focus of this document as the paper is still actively being worked on.</p>
<h1>Executive summary</h1>
<p>This section lists a number of findings, conclusions, ideas, and known risks that we have garnered as part of the Peras innovation project.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="findings">Findings<a href="#findings" class="hash-link" aria-label="Direct link to Findings" title="Direct link to Findings">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="product-wise">Product-wise<a href="#product-wise" class="hash-link" aria-label="Direct link to Product-wise" title="Direct link to Product-wise">​</a></h3>
<p>We built evidence that the Peras protocol in its most recent incarnation can be implemented on top of Praos, in the existing <a href="https://github.com/IntersectMBO/ouroboros-consensus" target="_blank" rel="noopener noreferrer">ouroboros-consensus</a> codebase, without compromising the core operations of the node (block creation, validation, and diffusion):</p>
<ul>
<li><a href="#network-performance-analysis">Network Modelling</a> has shown initial versions would add an unbearable overhead to block diffusion,</li>
<li><a href="#simulations">Simulation</a> and prototyping have allowed us to sketch implementation and better understand the interplay between Peras and Praos,</li>
<li>Decoupling votes and certificates handling from blocks handling could pave the way to a smooth incremental <a href="#integration-into-cardano-node">building and deployment</a> of Peras,</li>
<li>While still not formally evaluated (see <em>Remaining questions</em> section) it seems the impact of vote and certificates diffusion on node operation will not be significant and the network will provide strong guarantees those messages can be delivered in a timely fashion.</li>
</ul>
<p>We clarified the expected benefits of Peras over Praos expressed in terms of <a href="#settlement-time"><em>settlement failure probabilities</em></a>: Outside cool-down period, with the proper set of parameters, Peras provides the same probability of settlement failure than Praos <strong>faster</strong> by a factor of roughly 1000, i.e. roughly 2 minutes instead of 36 hours.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="process-wise">Process-wise<a href="#process-wise" class="hash-link" aria-label="Direct link to Process-wise" title="Direct link to Process-wise">​</a></h3>
<p>The following picture sketches the architecture of the project and the interaction between the various &quot;domains&quot; relevant to Innovation team. Black lines represent <em>implemented</em> direct relations, grey lines and boxes represent <em>planned</em> relations and tools, green lines represent <em>expected</em> feedback relations.</p>
<p><img decoding="async" loading="lazy" alt="Peras Project Architecture" src="/peras-design/assets/images/peras-high-level-architecture-91a24ca3efebbf799365a3157360da37.jpg" width="4978" height="3213" class="img_ev3q"></p>
<p>We confirmed the relevance of <a href="#network-performance-analysis">ΔQ modeling</a> technique to provide insights on a protocol&#x27;s performance profile, and how particular design decisions (even apparently minor ones) can impact this performance profile. We also gave feedback to the maintainers on the current state of the tool and libraries, and how to improve it in order to increase the reach of this technique.</p>
<p>We explored the use of formal modeling language Agda to <a href="#protocol-specification">specify</a> the protocol and application of Proof-of-Stake-specific <a href="#small-step-semantics">proof techniques</a> to state and prove relevant properties of the protocol. We also started work on building a trail of evidence from research to implementation by:</p>
<ul>
<li>Experimenting with Quviq on the <a href="#relating-test-model-to-formal-model">generation of quickcheck-dynamic</a> test models from Agda models,</li>
<li>Sketching a research-centric <a href="#pseudo-code"><em>Domain Specific Language</em></a> that could be used in research papers and as a foundation for formal modeling and engineering work.</li>
</ul>
<p>While prototyping, we demonstrated the applicability of an Agda-centric chain of evidence even to &quot;foreign&quot; languages by testing with <code>quickcheck-dynamic</code> the same properties against Haskell and <a href="#rust-based-simulation">Rust prototypes</a>, collaborating with the Creative engineering team on sketching a <a href="https://github.com/input-output-hk/ce-netsim" target="_blank" rel="noopener noreferrer">network simulator</a> library in Rust.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="remaining-questions">Remaining questions<a href="#remaining-questions" class="hash-link" aria-label="Direct link to Remaining questions" title="Direct link to Remaining questions">​</a></h2>
<p>There remain a number of open questions that could be investigated in future work increments.</p>
<ul>
<li>Peras features, both benefits and shortcomings, need to be aligned with business cases and overall strategy for scaling Cardano. This implies more research is needed in two directions:<!-- -->
<ul>
<li>From a product and user perspective, to evaluate the actual value that Peras delivers and the possible countermeasures to its drawbacks (e.g. the risk of cool-down could be covered by an <em>options</em> or <em>insurance premium</em> mechanism),</li>
<li>From a technical perspective, to explore the parameters space and find the best combinations.</li>
</ul>
</li>
<li>There are a number of components about which we have some ideas but no concrete figures or design:<!-- -->
<ul>
<li>Certificate structure and capabilities,</li>
<li>Vote and certificate CPU requirements and their possible impact on the node,</li>
<li>Optimal committee size,</li>
</ul>
</li>
<li>The protocol leaves room for a wide choice of options to design an implementation that should be considered and refined,</li>
<li>There is a need for more theoretical research on ways to make cool-down less impactful.</li>
</ul>
<h1>Previous work</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="peras-workshop">Peras workshop<a href="#peras-workshop" class="hash-link" aria-label="Direct link to Peras workshop" title="Direct link to Peras workshop">​</a></h2>
<p>A follow-up action from the <a href="https://docs.google.com/document/d/1dv796m2Fc7WH38DNmGc68WOXnqtxj7F30o-kGzM4zKA/edit" target="_blank" rel="noopener noreferrer">Peras workshop in Edinburgh</a>, which happened in September 2023, was to define a set of questions and experiments to be conducted in order to better understand the properties of the Peras protocol, along with an assessment of the protocol&#x27;s <em>Software readiness level</em>. The following sections recall the questions that were raised during the workshop, points to the answers given, and details the SRL assessment along with a comparison with current estimated SRL.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="questions-about-peras">Questions about Peras<a href="#questions-about-peras" class="hash-link" aria-label="Direct link to Questions about Peras" title="Direct link to Questions about Peras">​</a></h3>
<p>For each of these questions we check whether or not it has been answered:</p>
<ul class="contains-task-list containsTaskList_mC6p">
<li class="task-list-item"><input type="checkbox" disabled="" checked=""> <!-- -->How do you detect double voting? Is double voting possible? How can the voting state be bounded?<!-- -->
<ul>
<li><em>each vote is signed individually and the signature is checked by the receiving node</em></li>
<li><em>the voting state is bound by the committee size and the limited validity for each vote</em></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""> <!-- -->How are the voting committee members selected? What are the properties of the voting committee?<!-- -->
<ul>
<li><em>Committee members are selected by a VRF-based sortition, its properties are exposed in the paper and <a href="#overview">overview</a></em></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""> <!-- -->Where should votes be included: block body, block header, or some other aggregate<!-- -->
<ul>
<li><em>models and simulation show that votes need to be propagated and aggregated independently  while not in cooldown period</em></li>
<li><em>the &quot;anchor&quot; certificate used in cooldown period will need to be part of or attached to block bodies while its weight could be recorded as part of the corresponding block header</em></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Under what circumstance can a cool down be entered?<!-- -->
<ul>
<li><em>The question of how much adversarial power is needed to trigger a cool-down period is still open</em></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""> <!-- -->How significant is the risk of suppressing votes to trigger a cool-down period?<!-- -->
<ul>
<li><em>it is significant, as being able to trigger cool-downs often ruins the benefits of Peras</em></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Should vote contributions be incentivized?<!-- -->
<ul>
<li><em>this question has not been explored in this report</em></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""> <!-- -->How much weight is added per round of voting?<!-- -->
<ul>
<li><em>This is a parameter <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.05017em">B</span></span></span></span> in the protocol whose exact value depends on business requirements</em></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->How to expose the weight/settlement of a block to a consumer of chain data, such as a wallet?<!-- -->
<ul>
<li><em>This has not been addressed yet, as most of the user-facing and business domain aspects of the protocol</em></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""> <!-- -->Can included votes be aggregated into an artifact to prove the existence of votes &amp; the weight they provide?<!-- -->
<ul>
<li><em>This is the role of certificates</em></li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="potential-experiments-for-peras">Potential experiments for Peras<a href="#potential-experiments-for-peras" class="hash-link" aria-label="Direct link to Potential experiments for Peras" title="Direct link to Potential experiments for Peras">​</a></h3>
<p>We refer the reader to the relevant section for each of those potential experiments to demonstrate (in)feasability of Peras:</p>
<ul class="contains-task-list containsTaskList_mC6p">
<li class="task-list-item"><input type="checkbox" disabled="" checked=""> <!-- -->Network traffic simulation of vote messages<!-- -->
<ul>
<li><em>This has been <a href="#simulations">simulated</a> but needs to be refined</em></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""> <!-- -->Protocol formalization &amp; performance simulations of Peras<!-- -->
<ul>
<li><em>This has been done in <a href="#agda-specification">Agda</a> with (parts of) performance modeling using <a href="#network-performance-analysis">ΔQ</a> and simulation</em></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""> <!-- -->Optimal look-back parameter (measured in number of slots) within a round<!-- -->
<ul class="contains-task-list containsTaskList_mC6p">
<li class="task-list-item"><input type="checkbox" disabled=""> <em>Historic analytical study (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span></span></span></span>-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.03588em">σ</span></span></span></span> for reliability based on the number of 9s desired)</em></li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""> <em>Some parameters value are provided in the research paper and <a href="https://docs.google.com/presentation/d/1QGCvDoOJIWug8jJgCNv3p9BZV-R8UZCyvosgNmN-lJU/edit#slide=id.g2ca1209fec0_0_450" target="_blank" rel="noopener noreferrer">slides</a></em></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Chain growth simulations for the accumulation of vote data<!-- -->
<ul>
<li><em>This has not been done as the protocol has evolved since the workshop</em></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled="" checked=""> <!-- -->Added chain catch-up time<!-- -->
<ul>
<li><em>This is cool-down period length and is estimated in the <a href="https://docs.google.com/presentation/d/1QGCvDoOJIWug8jJgCNv3p9BZV-R8UZCyvosgNmN-lJU/edit#slide=id.g2ca1209fec0_0_450" target="_blank" rel="noopener noreferrer">slides</a></em></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Cost of diffusing votes and blocks that contain votes<!-- -->
<ul>
<li><em>not estimated</em></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Need to refine: Details of VRF-based committee selection and its size</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="srl">SRL<a href="#srl" class="hash-link" aria-label="Direct link to SRL" title="Direct link to SRL">​</a></h3>
<p>SRL (software readiness level) was initially assessed to be between 1 and 2, with the following definitions:</p>
<table><thead><tr><th>Questions to resolve</th><th>Status</th></tr></thead><tbody><tr><td>A concept formulated?</td><td>Done</td></tr><tr><td>Basic scientific principles underpinning the concept identified?</td><td>Done</td></tr><tr><td>Basic properties of algorithms, representations &amp; concepts defined?</td><td>Done</td></tr><tr><td>Preliminary analytical studies confirm the basic concept?</td><td></td></tr><tr><td>Application identified?</td><td>Done (Partner chains)</td></tr><tr><td>Preliminary design solution identified?</td><td>Partial</td></tr><tr><td>Preliminary system studies show the application to be feasible?</td><td></td></tr><tr><td>Preliminary performance predictions made?</td><td>Done</td></tr><tr><td>Basic principles coded?</td><td></td></tr><tr><td>Modeling &amp; Simulation used to refine performance predictions further and confirm benefits?</td><td></td></tr><tr><td>Benefits formulated?</td><td></td></tr><tr><td>Research &amp; development approach formulated?</td><td>Done</td></tr><tr><td>Preliminary definition of Laboratory tests and test environments established?</td><td>Preliminary</td></tr><tr><td>Experiments performed with synthetic data?</td><td></td></tr><tr><td>Concept/application feasibility &amp; benefits reported in paper</td><td></td></tr></tbody></table>
<p>We assess the current SRL to be between 3 and 4, given the following <a href="https://input-output.atlassian.net/wiki/spaces/CI/pages/3875110920/SRL+3+Analytical+and+or+experimental+critical+function+or+characteristic+proof-of-concept." target="_blank" rel="noopener noreferrer">SRL 3</a> definition:</p>
<table><thead><tr><th>Questions to resolve</th><th>Status</th></tr></thead><tbody><tr><td>Critical functions/components of the concept/application identified?</td><td>Done</td></tr><tr><td>Subsystem or component analytical predictions made?</td><td>Partial</td></tr><tr><td>Subsystem or component performance assessed by Modeling and Simulation?</td><td>Partial</td></tr><tr><td>Preliminary performance metrics established for key parameters?</td><td>Done</td></tr><tr><td>Laboratory tests and test environments established?</td><td>Done</td></tr><tr><td>Laboratory test support equipment and computing environment completed for component/proof-of-concept testing?</td><td>N/A</td></tr><tr><td>Component acquisition/coding completed?</td><td>No</td></tr><tr><td>Component verification and validation completed?</td><td>Partial</td></tr><tr><td>Analysis of test results completed establishing key performance metrics for components/ subsystems?</td><td>Done</td></tr><tr><td>Analytical verification of critical functions from proof-of-concept made?</td><td>Done</td></tr><tr><td>Analytical and experimental proof-of-concept documented?</td><td>Done</td></tr></tbody></table>
<h1>Protocol specification</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>A presentation of the motivation and principles of the protocol is available in these <a href="https://docs.google.com/presentation/d/1QGCvDoOJIWug8jJgCNv3p9BZV-R8UZCyvosgNmN-lJU/edit" target="_blank" rel="noopener noreferrer">slides</a>. We summarize the main points here but refer the interested reader to the slides and the research article for details.</p>
<ul>
<li>Peras adds a Voting layer on top of Praos, Cardano&#x27;s Nakamoto-style consensus protocol.</li>
<li>In every voting round, stakeholders (SPOs) get selected to be part of the voting committee through a stake-based sortition mechanism (using their existing VRF keys) and vote for the newest block at least <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">L</span></span></span></span> slots old, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">L</span></span></span></span> is a parameter of the construction (e.g., <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">L</span></span></span></span> = 120 slots).</li>
<li>Votes are broadcast to other nodes through network diffusion.</li>
<li>If a block gains more than a certain threshold of votes (from the same round), a so-called <em>quorum</em> (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.1132em">τ</span></span></span></span>), it gets extra weight <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.05017em">B</span></span></span></span> (where each block has a base weight of 1). Since nodes always select the heaviest chain (as opposed to the longest chain in Praos), these blocks with extra weight accelerate settlement of all blocks before them.</li>
<li>A set of votes (from the same round) can be turned into a short certificate. Certificates are needed during the cool-down period (see below), but they can also be broadcast to nodes that are catching up.</li>
<li>If a quorum is not reached in a round, the protocol enters a cool-down period, in order to heal from the “damage” that could result from adversarial strategies centered around withholding adversarial votes. During the cool-down, voting is suspended, and block producers include information required to coordinate the restart (the latest known certificate) in their blocks. The duration of the cool-down period is roughly equal to the number of slots equivalent to produce <em>k</em> + <em>B</em> blocks, where <em>k</em> is the settlement parameter of Praos.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="certificates">Certificates<a href="#certificates" class="hash-link" aria-label="Direct link to Certificates" title="Direct link to Certificates">​</a></h3>
<p>The exact construction of Peras certificates is still unknown but we already know the feature set it should provide:</p>
<ul>
<li>A Peras certificate must be reasonably &quot;small&quot; in order to fit within the limits of a single block without leading to increased transmission delay.<!-- -->
<ul>
<li>The current block size on <code>mainnet</code> is 90kB, with each transaction limited to 16kB.</li>
<li>In order to not clutter the chain and take up too much block estate, a certificate should fit in a <em>single transaction</em>.</li>
</ul>
</li>
<li>Certificates need to be produced <em>locally</em> by a single node from the aggregation of multiple votes reaching a quorum.<!-- -->
<ul>
<li>Certificate forging should be reasonably fast but is not critical for block diffusion: A round spans multiple possible blocks so there is more time to produce and broadcast it.</li>
</ul>
</li>
<li>A certificate must be reasonably fast to verify as it is on the critical path of chain selection: When a node receives a new block and/or a new certificate, it needs to decide whether or not this changes its best chain according to the weight,</li>
<li>The <a href="https://iohk.io/en/research/library/papers/approximate-lower-bound-arguments/" target="_blank" rel="noopener noreferrer">ALBA</a> paper provides a construction through a mechanism called a <em>Telescope</em> which seems like a good candidate for Peras certificates.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pseudo-code">Pseudo-code<a href="#pseudo-code" class="hash-link" aria-label="Direct link to Pseudo-code" title="Direct link to Pseudo-code">​</a></h2>
<p>We initially started working from researchers&#x27; pseudo-code which was detailed in various documents:</p>
<ul>
<li>The initial <a href="https://docs.google.com/document/d/1QMn1CqS4zSbKzvozhcAtc7MN_nMfVHhP25pMTxyhhZ8/edit#heading=h.8bsvt41k7bj1" target="_blank" rel="noopener noreferrer">protocol definition</a> as presented in the Edinburgh workshop, in September 2023,</li>
<li>The <a href="https://docs.google.com/document/d/1lywi65s1nQpAGgMpzPXD-sLzYNES-FZ8SHXF75VCKuI/edit#heading=h.dqvlvyqlb2s4" target="_blank" rel="noopener noreferrer">post-workshop definition</a>  which considered votes and blocks diffusion and chain selection in a more integrated manner,</li>
<li>The newest version from <a href="https://docs.google.com/document/d/1w_jHsojcBxZHgGrr63ZGa4nhkgEpkL6a2cFYiq8Vf8c/edit" target="_blank" rel="noopener noreferrer">March 2024</a> which addressed the shortcomings of tallying individual votes in the chain selection process from earlier versions.</li>
</ul>
<p>In the Paris Workshop in April 2024, we tried to address a key issue of this pseudo-code: The fact it lives in an unstructured and informal document, is not machine-checkable, and is therefore poised to be quickly out of the sync with both the R&amp;D work on the formal specification, the prototyping work, and the research work. This collective effort led to writing the exact same pseudo-code as a <em>literate Agda</em> document, the internal consistency of which can be checked by the Agda compiler, while providing a similar level of flexibility and readability than the original document.</p>
<p>This document is available in the <a href="https://github.com/input-output-hk/peras-design/blob/65d8a98817df119b3902e43e5acca86fdcca6f92/src/Peras/ProtocolL.lagda.md#L1" target="_blank" rel="noopener noreferrer">Peras repository</a> and is a first step towards better integration between research and engineering work streams.</p>
<p>Next steps include:</p>
<ul>
<li>Refining the pseudo-code&#x27;s syntax to make it readable and maintainable by researchers and engineers alike,</li>
<li>Understanding how this code relates with the actual Agda code,</li>
<li>Adding some semantics.</li>
</ul>
<p>It is envisioned that at some point this kind of code could become commonplace in the security researchers community in order to provide formally verifiable and machine-checkable specifications, based on the theoretical framework used by researchers (e.g. Universal Composition).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="settlement-time">Settlement time<a href="#settlement-time" class="hash-link" aria-label="Direct link to Settlement time" title="Direct link to Settlement time">​</a></h2>
<p><a href="https://eprint.iacr.org/2022/1571.pdf" target="_blank" rel="noopener noreferrer">Practical Settlement Bounds for Longest-Chain Consensus</a> <em>(Gazi, Ren, and Russell, 2023)</em> provides a formal treatment of the settlement guarantees for proof-of-stake (PoS) blockchains.</p>
<p><em>Settlement time</em> can be defined as the time needed for a given transaction to be considered permanent by some honest party. On Cardano, the upper bound for settlement time is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mi>k</mi><mi mathvariant="normal">/</mi><mi>f</mi></mrow><annotation encoding="application/x-tex">3k / f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">3</span><span class="mord mathnormal" style="margin-right:0.03148em">k</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span></span></span> to produce <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span></span></span></span> subsequent blocks, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span></span></span></span> is the <em>security parameter</em> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span></span></span> is the <em>active slot coefficient</em>. On the current mainchain, this time is 36 hours. Note that even if in practice the settlement time is fixed, in theory this bound is always probabilistic. The security parameter <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span></span></span></span> is chosen in such a way that the probability of a transaction being reverted after <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span></span></span></span> blocks is lower than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>60</mn></mrow></msup></mrow><annotation encoding="application/x-tex">10^{-60}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">60</span></span></span></span></span></span></span></span></span></span></span></span>.</p>
<p>The following picture from the aforementioned paper shows block settlement failure probability given some block depth for Cardano PoS chain. Under the assumptions given there, the probability for a transaction to be rolled back after 20 blocks is 0.001% , and is exponentially decreasing with the block depth.</p>
<p><img decoding="async" loading="lazy" alt="Settlement failure probability / depth for 10% adversary" src="/peras-design/assets/images/settlement-failure-probability-306f400a2fdfb6d8050525a6167d2144.png" width="2028" height="1516" class="img_ev3q"></p>
<p>We also have anecdotal evidence from observations of the Cardano mainchain over the past few years that the settlement time is much shorter than the theoretical bound, as basically forks over 2 blocks length are exceedingly rare, and no fork over 3 blocks length has been observed on core nodes since the launch of Shelley.</p>
<p>There&#x27;s however no evidence this situation will continue in the future, obviously, as it could very well be the case the network was never seriously under attack, hence we should take those numbers with caution.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="settlement-bounds-for-peras">Settlement bounds for Peras<a href="#settlement-bounds-for-peras" class="hash-link" aria-label="Direct link to Settlement bounds for Peras" title="Direct link to Settlement bounds for Peras">​</a></h3>
<blockquote>
<p>[!WARNING]</p>
<p>Take the following analysis with a grain of salt as the researchers are still actively working on the protocol&#x27;s security properties and numeric analysis.</p>
</blockquote>
<p>While these numbers seem comforting and reasonably small to provide a very high degree of confidence after less than 10 minutes (a block is produced on average every 20s), it should be noted that they are based on non-existent to low adversarial power assumption (e.g. lower than 10% total stake), in other words they represent the best case scenario and say nothing about the potential impact of an adversary with significant resources and high motivation to either disrupt the network, e.g. as a form of denial of service to degrade the perceived value of Cardano, or more obviously to double spend. As the stakes increase and the network becomes more valuable, the probability of such an attack increases and our confidence in the settlement time should be adjusted accordingly.</p>
<p>In the optimistic case, Peras is expected to provide the level of settlement Praos provides after <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span></span></span></span> blocks but after only about a few rounds of voting. With the following parameters:</p>
<ul>
<li>Committee size <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>=</mo><mn>2000</mn></mrow><annotation encoding="application/x-tex">S = 2000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.05764em">S</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">2000</span></span></span></span>,</li>
<li>Boost per certificate <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>=</mo><mi>k</mi><mi mathvariant="normal">/</mi><mn>10</mn><mo>=</mo><mn>216</mn></mrow><annotation encoding="application/x-tex">B = k / 10 = 216</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.05017em">B</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span><span class="mord">/10</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">216</span></span></span></span>,</li>
<li>Quorum <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi><mo>=</mo><mn>3</mn><mo separator="true">,</mo><mi>S</mi><mi mathvariant="normal">/</mi><mn>4</mn><mo>=</mo><mn>1500</mn></mrow><annotation encoding="application/x-tex">\tau = 3, S / 4 = 1500</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.1132em">τ</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.05764em">S</span><span class="mord">/4</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1500</span></span></span></span>,</li>
<li>Round length <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">U = 10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.10903em">U</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">10</span></span></span></span> slots.</li>
</ul>
<p>we can expect a negligible (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mn>1</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>60</mn></mrow></msup></mrow><annotation encoding="application/x-tex">&lt; 10^{-60}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">60</span></span></span></span></span></span></span></span></span></span></span></span>) probability of settlement failure after 10 rounds or 100 slots, which is less than 2 minutes. In other words, Peras improves settlement upper bound over Praos by a factor of 1000, in the <em>optimistic case</em>, e.g. outside of a <em>cool-down period</em>.</p>
<p>However, triggering cool-down is cheap and does not require a large adversarial power as it is enough for an adversary to be able to create a relatively short fork that lasts slightly longer than the length of the voting window (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">L</span></span></span></span>) to be able to force a split vote and a cool-down period.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="agda-specification">Agda specification<a href="#agda-specification" class="hash-link" aria-label="Direct link to Agda specification" title="Direct link to Agda specification">​</a></h2>
<p>The formal specification of the Peras protocol is implemented in Agda. It is a declarative specification, there are entities that are only defined by properties rather than by an explicit implementation. But still the specification is extractable to Haskell and allows to generate QuickCheck tests for checking an arbitrary implementation against the reference specification.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="domain-model">Domain model<a href="#domain-model" class="hash-link" aria-label="Direct link to Domain model" title="Direct link to Domain model">​</a></h3>
<p><strong>Note</strong>: The code here is substantially different from the <a href="#pseudo-code">pseudo-code</a> mentioned before. These represent two different lines of work that ultimately should be reconciled.</p>
<p>The domain model is defined as Agda data types and implemented with Haskell code extraction in mind. The extractable domain model comprises entities like <code>Block</code>, <code>Chain</code>, <code>Vote</code> or <code>Certificate</code>. For example the Agda record type for <code>Block</code></p>
<div class="language-agda codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-agda codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">record Block where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  field slotNumber : Slot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        creatorId : PartyId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        parentBlock : Hash Block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        certificate : Maybe Certificate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        leadershipProof : LeadershipProof</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        signature : Signature</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bodyHash : Hash (List Tx)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>is extracted to the Haskell data type:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">data Block = Block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  { slotNumber :: Slot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , creatorId :: PartyId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , parentBlock :: Hash Block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , certificate :: Maybe Certificate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , leadershipProof :: LeadershipProof</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , signature :: Signature</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , bodyHash :: Hash [Tx]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  deriving (Eq)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Cryptographic functions are not implemented in the specification. For example, for hash functions there is the record type <code>Hashable</code></p>
<div class="language-agda codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-agda codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">record Hashable (a : Set) : Set where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  field hash : a → Hash a</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>that is extracted to a corresponding type class in Haskell:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class Hashable a where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hash :: a -&gt; Hash a</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For executing the reference specification, an instance of the different kind of hashes (for example for hashing blocks) needs to be provided.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="agda2hs">Agda2hs<a href="#agda2hs" class="hash-link" aria-label="Direct link to Agda2hs" title="Direct link to Agda2hs">​</a></h4>
<p>In order to generate &quot;readable&quot; Haskell code, we use <a href="https://agda.github.io/agda2hs" target="_blank" rel="noopener noreferrer">agda2hs</a> rather than relying on the standard Haskell generator code (<code>MAlonzo</code>) directly. It happens that <code>agda2hs</code> is not compatible with the Agda standard library and therefore we are using the custom <code>Prelude</code> provided by <code>agda2hs</code> that is also extractable to Haskell.</p>
<p>For extracting properties from Agda to Haskell we can use a similar type as the <code>Equal</code> type from the <code>agda2hs</code> examples. The constructor for <code>Equal</code> takes a pair of items and a proof that those are equal. When extracting to Haskell the proof gets erased. We can use this idea for extracting properties to be used with quick-check.</p>
<div class="language-agda codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-agda codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">prop-genesis-in-slot0 : ∀ {c : Chain} → (v : ValidChain c) → slot (last c) ≡ 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prop-genesis-in-slot0 = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">propGenesisInSlot0 : ∀ (c : Chain) → (@0 v : ValidChain c) → Equal ℕ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">propGenesisInSlot0 c v = MkEqual (slot (last c) , 0) (prop-genesis-in-slot0 v)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="small-step-semantics">Small-step semantics<a href="#small-step-semantics" class="hash-link" aria-label="Direct link to Small-step semantics" title="Direct link to Small-step semantics">​</a></h3>
<p>In order to describe the execution of the protocol, we are proposing a <a href="https://github.com/input-output-hk/peras-design/blob/65d8a98817df119b3902e43e5acca86fdcca6f92/src/Peras/SmallStep.lagda.md#L1" target="_blank" rel="noopener noreferrer">small-step semantics for Ouroboros Peras</a> in Agda based on ideas from the small-step semantics for Ouroboros Praos as laid out in the PoS-NSB paper. The differences in the small-step semantics of the Ouroboros Praos part of the protocol are explained in the following sections.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="local-state">Local state<a href="#local-state" class="hash-link" aria-label="Direct link to Local state" title="Direct link to Local state">​</a></h4>
<p>The local state is the state of a single party, respectively a single node. It consists of a declarative <em>blocktree</em>, i.e. an abstract data structure representing possible chains specified by a set of properties. In addition to blocks, the blocktree for Ouroboros, Peras also includes votes and certificates and for this reason there are additional properties with respect to those entities.</p>
<p>The fields of the blocktree allow to:</p>
<ul>
<li>Extend the tree with blocks and votes,</li>
<li>Get all blocks, votes and certificates,</li>
<li>Get the best chain.</li>
</ul>
<p>The property stating that the best chain is always a valid chain is such a property:</p>
<div class="language-agda codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-agda codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">valid : ∀ (t : tT) (sl : Slot)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → ValidChain (bestChain sl t)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The condition which chain is considered the best is given by the following property:</p>
<div class="language-agda codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-agda codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">optimal : ∀ (c : Chain) (t : tT) (sl : Slot)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → let b = bestChain sl t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValidChain c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → c ⊆ allBlocksUpTo sl t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → weight c (certs t c) ≤ weight b (certs t b)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In words, this says that the <em>best</em> chain is <em>valid</em> (<code>ValidChain</code> is a predicate asserting that a chain is valid with respect to Ouroboros Praos) and the <em>heaviest</em> chain out of all valid chains is the best.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="global-state">Global state<a href="#global-state" class="hash-link" aria-label="Direct link to Global state" title="Direct link to Global state">​</a></h4>
<p>In order to describe progress with respect to the Ouroboros Peras protocol, a global state is introduced. The global state consists of the following entities:</p>
<ul>
<li><em>clock:</em> Keeps track of the current slot of the system.</li>
<li><em>state map:</em> Map storing local state per party, i.e. the blocktrees of all the nodes.</li>
<li><em>messages:</em> All the messages that have been sent but not yet delivered.</li>
<li><em>history:</em> All the messages that have been sent.</li>
<li><em>adversarial state:</em> The adversarial state can be anything, with the type is passed to the specification as a parameter.</li>
</ul>
<p>The differences compared to the model proposed in the PoS-NSB paper are:</p>
<ul>
<li>the execution order is not stored in the global state and therefore permutations of the messages as well as permutations of parties are not needed,</li>
<li>the <code>Progress</code> of the system as described in the PoS-NSB paper is not stored in the global state, as we define the global relation more granular</li>
</ul>
<p>Instead of keeping track of the execution order of the parties in the global state, the global relation is defined with respect to parties. The list of parties is considered fixed from the beginning and passed to the specification as a parameter. Together with a party, we know as well the party&#x27;s honesty (<code>Honesty</code> is a predicate for a party).
Instead of keeping track of progress globally we only need to assert that before the clock reaches the next slot, all the deliverable messages (i.e. messages where the delay is 0) in the global message buffer have been consumed.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="global-relation">Global relation<a href="#global-relation" class="hash-link" aria-label="Direct link to Global relation" title="Direct link to Global relation">​</a></h4>
<p>The protocol defines messages to be distributed between parties of the system. The specification currently implements the following message types:</p>
<ul>
<li><em>Block message:</em> When a party is the slot leader a new block can be created and a message notifying the other parties about the block creation is broadcast. Note that, in case a cool-down phase according to the Ouroboros Peras protocol is detected, the block also includes a certificate that references a block of the party&#x27;s preferred chain,</li>
<li><em>Vote message:</em> When a party creates a vote according to the protocol, this is wrapped into a message and delivered to the other parties.</li>
</ul>
<p>The global relation expresses the evolution of the global state:</p>
<div class="language-agda codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-agda codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    data _↝_ : Stateᵍ → Stateᵍ → Set where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Deliver : ∀ {M N p} {h : Honesty p} {m}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        → h ⊢ M [ m ]⇀ N</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          --------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        → M ↝ N</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      CastVote : ∀ {M N p} {h : Honesty p}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        → h ⊢ M ⇉ N</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ---------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        → M ↝ N</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      CreateBlock : ∀ {M N p} {h : Honesty p}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        → h ⊢ M ↷ N</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ---------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        → M ↝ N</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      NextSlot : ∀ {M}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        → Delivered M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          -----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        → M ↝ tick M</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The global relation consists of the following constructors:</p>
<ul>
<li><em>Deliver</em>: A party consuming a message from the global message buffer is a global state transition. The party might be <em>honest</em> or <em>adversarial</em>, in the latter case a message will be delayed rather than consumed,</li>
<li><em>Cast vote</em>: A vote is created by a party and a corresponding message is put into the global message buffer for all parties respectively,</li>
<li><em>Create block</em>: If a party is a slot leader, a new block can be created and put into the global message buffer for the other parties. In case that a chain according to the Peras protocol enters a cool-down phase, the party adds a certificate to the block as well,</li>
<li><em>Next slot</em>: Allows to advance the global clock by one slot. Note that this is only possible, if all the messages for the current slot are consumed as expressed by the <code>Delivered</code> predicate.</li>
</ul>
<p>The reflexive transitive closure of the global relation describes what global states are reachable.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="proofs">Proofs<a href="#proofs" class="hash-link" aria-label="Direct link to Proofs" title="Direct link to Proofs">​</a></h3>
<p>The properties and proofs that we can state based upon the formal specification are in <a href="https://github.com/input-output-hk/peras-design/blob/65d8a98817df119b3902e43e5acca86fdcca6f92/src/Peras/SmallStep/Properties.lagda.md#L1" target="_blank" rel="noopener noreferrer">Properties.lagda.md</a>.</p>
<p>A first property is <code>knowledge-propagation</code>, a lemma that states that knowledge about blocks is propagated between honest parties in the system. In detail the lemma expresses that for two honest parties the blocks in the blocktree of the first party will be a subset of the blocks of the second party after any number of state transitions into a state where all the messages have been delivered. Or in Agda:</p>
<div class="language-agda codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-agda codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    knowledge-propagation : ∀ {N₁ N₂ : GlobalState}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      → {p₁ p₂ : PartyId}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      → {t₁ t₂ : A}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      → {honesty₁ : Honesty p₁}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      → {honesty₂ : Honesty p₂}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      → honesty₁ ≡ Honest {p₁}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      → honesty₂ ≡ Honest {p₂}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      → (p₁ , honesty₁) ∈ parties</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      → (p₂ , honesty₂) ∈ parties</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      → N₀ ↝⋆ N₁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      → N₁ ↝⋆ N₂</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      → lookup (stateMap N₁) p₁ ≡ just ⟪ t₁ ⟫</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      → lookup (stateMap N₂) p₂ ≡ just ⟪ t₂ ⟫</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      → Delivered N₂</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      → clock N₁ ≡ clock N₂</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      → allBlocks blockTree t₁ ⊆ allBlocks blockTree t₂</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Knowledge propagation is a pre-requisite for the chain growth property, it informally states that in each period, the best chain of any honest party will increase at least by a number that is proportional to the number of lucky slots in that period, where a lucky slot is any slot where an honest party is a slot leader.</p>
<h1>Network performance analysis</h1>
<p>We provide in this section the methodology and results of the analysis of the Peras protocol performance in the context of the Cardano network. This analysis is not complete as it only covers the impact of including certificates in block headers, which is not a property of the protocol anymore. More analysis is needed on the votes and certificates diffusion process following changes to the protocol in March 2024.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="certificates-in-block-header">Certificates in block header<a href="#certificates-in-block-header" class="hash-link" aria-label="Direct link to Certificates in block header" title="Direct link to Certificates in block header">​</a></h2>
<p>This section provides high-level analysis of the impact of Peras protocol on the existing Cardano network, using <a href="https://iohk.io/en/research/library/papers/mind-your-outcomes-the-dqsd-paradigm-for-quality-centric-systems-development-and-its-application-to-a-blockchain-case-study/" target="_blank" rel="noopener noreferrer">ΔQSD methodology</a>. In order to provide a baseline to compare with, we first applied ΔQ to the existing Praos protocol reconstructing the results that lead to the current set of parameters defining the performance characteristics of Cardano, following section 4 of the aforementioned paper. We then used the same modeling technique taking into account the Peras protocol <strong>assuming inclusion of certificates in headers</strong> insofar as they impact the core <em>outcome</em> of the Cardano network, namely <em>block diffusion time</em>.</p>
<blockquote>
<p>[!NOTE]
One of the sub-goals for Peras project is to collaborate with PNSol, the original inventor of ΔQ methodology, to improve the usability of the whole method and promote it as a standard tool for designing distributed systems.</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="baseline---praos-δq-modeling">Baseline - Praos ΔQ modeling<a href="#baseline---praos-δq-modeling" class="hash-link" aria-label="Direct link to Baseline - Praos ΔQ modeling" title="Direct link to Baseline - Praos ΔQ modeling">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="model-overview">Model overview<a href="#model-overview" class="hash-link" aria-label="Direct link to Model overview" title="Direct link to Model overview">​</a></h4>
<p>Here is a graphical representation of the <em>outcome diagram</em> for the ΔQ model of Cardano network under Praos protocol:</p>
<p><img decoding="async" loading="lazy" alt="Outcome diagram for Praos" src="/peras-design/assets/images/praos-delta-q-d7913779f05ff548fe55be28967e4c06.svg" width="775" height="807" class="img_ev3q"></p>
<p>This model is based on the following assumptions:</p>
<ul>
<li>Full block diffusion is separated in a number of steps: request and reply of the block header, then request and reply of the block body,</li>
<li>Propagating a block across the network might require several &quot;hops&quot; as there is not a direct connection between every pair of nodes, with the distribution of paths length depending on the network topology,</li>
<li>We have not considered the probability of loss in the current model.</li>
</ul>
<p>The block and body sizes are assumed to be:</p>
<ul>
<li>Block header size is smaller than typical MTU of IP network (e.g. 1500 bytes) and therefore requires a single roundtrip of TCP messages for propagation,</li>
<li>Block body size is about 64kB which implies propagation requires several TCP packets sending and therefore takes more time.</li>
</ul>
<blockquote>
<p>[!NOTE]
As the Cardano network uses TCP/IP for its transport, we should base the header size on the <a href="https://en.wikipedia.org/wiki/Maximum_segment_size" target="_blank" rel="noopener noreferrer">Maximum Segment Size</a>, not the MTU.
This size is 536 for IPv4 and 1220 for IPv6.</p>
</blockquote>
<p>Average latency numbers are drawn from table 1 in the paper and depend on the (physical) distance between 2 connected nodes:</p>
<table><thead><tr><th>Distance</th><th>1 segment RTT (ms)</th><th>64 kB RTT (ms)</th></tr></thead><tbody><tr><td>Short</td><td>12</td><td>24</td></tr><tr><td>Medium</td><td>69</td><td>143</td></tr><tr><td>Long</td><td>268</td><td>531</td></tr></tbody></table>
<p>For each step in the diffusion of a block, we assume an equal (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mn>3</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>) chance for each class of distance.</p>
<blockquote>
<p>[!NOTE]
The actual maximum block body size at the time of this writing is 90kB, but for want of an actual delay value for this size, we chose the nearest increment available. We need to actually measure the real value for this block size and other significant increments.</p>
</blockquote>
<p>We have chosen to define two models of ΔQ diffusion, one based on an average node degree of 10, and another one on 15. Table 2 gives us the following distribution of paths length:</p>
<table><thead><tr><th>Length</th><th>Degree = 10</th><th>Degree = 15</th></tr></thead><tbody><tr><td>1</td><td>0.40%</td><td>0.60%</td></tr><tr><td>2</td><td>3.91%</td><td>8.58%</td></tr><tr><td>3</td><td>31.06%</td><td>65.86%</td></tr><tr><td>4</td><td>61.85%</td><td>24.95%</td></tr><tr><td>5</td><td>2.78%</td><td>0</td></tr></tbody></table>
<p>These numbers are reflected (somewhat inaccurately) in the above graph, representing the probabilities for the number of hops a block will have to go through before reaching another node.</p>
<blockquote>
<p>[!NOTE]
The current target valency for cardano-node&#x27;s connection is 20, and while there are a large number of stake pools in operation, there is some significant concentration of stake, which means the actual number of &quot;core&quot; nodes to consider would be smaller and the distribution of paths length closer to 1.</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="modeling-process">Modeling process<a href="#modeling-process" class="hash-link" aria-label="Direct link to Modeling process" title="Direct link to Modeling process">​</a></h4>
<p>We have experimented with three different libraries for encoding this baseline model:</p>
<ol>
<li>Original <a href="https://github.com/DeltaQ-SD/pnsol-deltaq-clone" target="_blank" rel="noopener noreferrer">ΔQ library</a> built by Neil Davies, which uses randomized sampling to graph the <em>Cumulative Distribution Function</em> resulting from the ΔQ model,</li>
<li>A library for <a href="https://github.com/DeltaQ-SD/Artjoms" target="_blank" rel="noopener noreferrer">algebraic representation</a> of ΔQ models built to support the <a href="https://arxiv.org/pdf/2308.10654v1.pdf" target="_blank" rel="noopener noreferrer">Algebraic Reasoning with Timeliness</a> paper, which uses discretization of probability density functions to approximate CFDs resulting from the various ΔQ language combinators,</li>
<li>Another recent library built by Peter Thompson to represent ΔQ probability distributions using <a href="https://github.com/DeltaQ-SD/dqsd-piecewise-poly" target="_blank" rel="noopener noreferrer">piecewise polynomials</a>, which should provide high-fidelity CDFs.</li>
</ol>
<p>Library 2 was used to express the <em>outcome diagram</em> depicted above using so-called <em>O language</em>, but while we were able to encode the model itself, the resulting computation of <em>CDFs</em> for composite expressions resulting from <em>convolution</em> of atomic expressions turned out to be unusable, yielding CDFs with accumulated probability lower than 1 even though we did not model any loss. Library 3, although the most promising to provide accurate models, turned out to be unsatisfactory as we were not able to produce proper numerical representations of a CDF for more complex expressions.</p>
<p>Using code from library 1, we were able to write the following ΔQ expressions to represent our Cardano model:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">oneMTU =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fromQTA @SimpleUniform</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        [(0, 0), (1 % 3, 0.012), (2 % 3, 0.069), (3 % 3, 0.268)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blockBody64K =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fromQTA @SimpleUniform</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        [(0, 0), (1 % 3, 0.024), (2 % 3, 0.143), (3 % 3, 0.531)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">headerRequestReply = oneMTU ⊕ oneMTU -- request/reply</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bodyRequestReply = oneMTU ⊕ blockBody64K -- request/reply</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oneBlockDiffusion = headerRequestReply ⊕ bodyRequestReply</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">combine [(p, dq), (_, dq&#x27;)] = (⇋) (toRational $ p / 100) dq dq&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">combine ((p, dq) : rest) = (⇋) (toRational $ p / 100) dq (combine rest)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">multihops = (`multiHop` oneBlockDiffusion) &lt;$&gt; [1 ..]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pathLengthsDistributionDegree15 =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [0.60, 8.58, 65.86, 24.95]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hopsProba15 = zip (scanl1 (+) pathLengthsDistributionDegree15 &lt;&gt; [0]) multihops</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deltaq15 = combine hopsProba15</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then computing the empirical CDF over 5000 different random samples yield the following graph:</p>
<p><img decoding="async" loading="lazy" alt="Praos ΔQ Model CDF" src="/peras-design/assets/images/plot-hops-distribution-aa25ba01c72d2cd26e6cca5d4b0a6c5f.svg" width="1200" height="800" class="img_ev3q"></p>
<p>To calibrate our model, we have computed an empirical distribution of block adoption time<sup><a href="#user-content-fn-2" id="user-content-fnref-2" data-footnote-ref="true" aria-describedby="footnote-label">1</a></sup> observed on the <code>mainnet</code> over the course of 4 weeks (from 22nd February 2024 to 18th March 2024), as provided by <a href="https://api.clio.one/blocklog/timeline/" target="_blank" rel="noopener noreferrer">https://api.clio.one/blocklog/timeline/</a>. The raw data is provided as a file with 12 millions entries similar to:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">9963861,117000029,57.128.141.149,192.168.1.1,570,0,60,30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9963861,117000029,57.128.141.149,192.168.1.1,540,0,60,40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9963861,117000029,158.101.97.195,150.136.84.82,320,0,10,50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9963861,117000029,185.185.82.168,158.220.80.17,610,0,50,50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9963861,117000029,74.122.122.114,10.10.100.12,450,0,10,50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9963861,117000029,69.156.16.141,69.156.16.141,420,0,10,50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9963861,117000029,165.227.139.87,10.114.0.2,620,10,0,70</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9963861,117000029,192.99.4.52,144.217.78.44,460,0,10,100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9963861,117000029,49.12.89.235,135.125.188.228,550,0,20,50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9963861,117000029,168.119.9.11,3.217.90.52,450,150,10,50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Each entry provides:</p>
<ul>
<li>Block height,</li>
<li>Slot number,</li>
<li>Emitter and receiver&#x27;s IP addresses,</li>
<li>Time (in ms) to header announcement,</li>
<li>then additional time to fetch header,</li>
<li>time to download block,</li>
<li>and finally time to adopt a block on the receiver.</li>
</ul>
<p>Therefore the total time for block diffusion is the sum of the last 4 columns.</p>
<p>This data is gathered through a network of over 100 collaborating nodes that agreed to report various statistics to a central aggregator, so it is not exhaustive and could be biased. The following graph compares this observed CDF to various CDFs for different distances (in the graph sense, e.g. number of hops one need to go through from an emitting node to a recipient node) between nodes.</p>
<p><img decoding="async" loading="lazy" alt="Multiple hops &amp;amp; empirical CDF" src="/peras-design/assets/images/plot-praos-multi-hops-cea059abfcadc982fdddcdf96e3f0af4.svg" width="1200" height="800" class="img_ev3q"></p>
<p>While this would require some more rigorous analysis to be asserted in a sound way, it seems there is a good correlation between empirical distribution and 1-hop distribution, which is comforting as it validates the relevance of the model.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="peras-δq-model---blocks">Peras ΔQ model - blocks<a href="#peras-δq-model---blocks" class="hash-link" aria-label="Direct link to Peras ΔQ model - blocks" title="Direct link to Peras ΔQ model - blocks">​</a></h3>
<p>Things to take into account for modeling Peras:</p>
<ul>
<li><em>Impact of the size of the certificate:</em> If adding the certificate increases the size of the header beyond the MSS (or MTU?), this will impact header diffusion.<!-- -->
<ul>
<li>We might need to just add a hash to the header (32 bytes) and then have the node request the certificate, which also increases (full) header diffusion time.</li>
</ul>
</li>
<li><em>Impact of validating the certificate:</em> If it is not cheap (e.g. a few ms like a signature verification), this could also lead to an increase in block adoption time as a node receiving a header will have to add more time to validate it before sharing it with its peers.</li>
<li>There might not be a certificate for each header, depending on the length of the rounds. Given round length <em>R</em> in slots and average block production length <em>S</em>, then frequency of headers with certificate is <em>S</em>/<em>R</em>.<!-- -->
<ul>
<li>The model must take into account different paths for retrieving a header, one with a certificate and one without.</li>
</ul>
</li>
<li>Diffusion of votes and certificates does not seem to have other impacts on diffusion of blocks: e.g. just because we have more messages to handle and therefore we consume more bandwidth between nodes, this could lead to delays for block propagation, but it seems there is enough bandwidth (in steady state, perhaps not when syncing) to diffuse both votes, certificates, transactions, and blocks without one impacting the other.</li>
</ul>
<p>The following diagram compares the ΔQ distribution of block diffusion (for 4 hops) under different assumptions:</p>
<ol>
<li>Standard block without a certificate,</li>
<li>Block header points to a certificate.</li>
</ol>
<p>Certificate validation is assumed to be a constant 50ms.</p>
<p><img decoding="async" loading="lazy" alt="Impact of certificate" src="/peras-design/assets/images/block-with-cert-d6199dcdc9f4ca75fc2bda6207da24ca.svg" width="800" height="600" class="img_ev3q"></p>
<p>Obviously, adding a round-trip network exchange to retrieve the certificate for a given header degrades the &quot;timeliness&quot; of block diffusion.
For the case of 2500 nodes with average degree 15, we get the following distributions, comparing blocks with and without certificates:</p>
<p><img decoding="async" loading="lazy" alt="Diffusion with and without certificate" src="/peras-design/assets/images/network-with-cert-544a6d783c976f6fc99e4b02132b202e.svg" width="800" height="600" class="img_ev3q"></p>
<blockquote>
<p>[!NOTE]
Depending on the value of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.10903em">U</span></span></span></span>, the round length, not all block headers will have a certificate and the ratio could actually be quite small, e.g. if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>=</mo><mn>60</mn></mrow><annotation encoding="application/x-tex">T=60</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">T</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">60</span></span></span></span> then we would expect 1/3rd of the headers to have a certificate on average. While we tried to factor that ratio in the model, that is misleading because of the second order effect an additional certificate fetching could have on the whole system: More delay in the block diffusion process increases the likelihood of forks which have an adversarial impact on the whole system, and averaging this impact hides it.</p>
</blockquote>
<blockquote>
<p>[!NOTE]
In practice, <code>cardano-node</code> uses <em>network-level pipelining</em> to avoid having to request individually every block/header: e.g. when sending multiple blocks to a peer a node will not wait for its peer&#x27;s request and will keep sending headers as long as not instructed to do otherwise.</p>
<p>This is not to be confused with <em>consensus pipelining</em> which streamlines block headers diffusion from upstream to downstream peers before waiting for full block body validation.</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h3>
<p>This analysis demonstrates that Peras certificates cannot be on the critical path of block headers diffusion lest we run the risk of increased delays in block diffusion and number of forks. Certificates either have to be small enough to not require an additional round-trip to transmit on top of the block header, or be part of the block body. Note that in the latter case the certificates should also be relatively small as there is limited space available in blocks.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="votes--certificates-diffusion">Votes &amp; certificates diffusion<a href="#votes--certificates-diffusion" class="hash-link" aria-label="Direct link to Votes &amp; certificates diffusion" title="Direct link to Votes &amp; certificates diffusion">​</a></h2>
<p>Detailed analysis of votes and certificates diffusion is still ongoing and will be reported in a future document. Some preliminary discussions with PNSol allowed us to identify the following points to consider:</p>
<ul>
<li>The vote diffusion will very likely be unproblematic on &quot;sunny days&quot;, so the modeling and thinking effort should be focused on &quot;rainy days&quot;, e.g. what happens under heavy load, e.g. CPU load (also possibly network load?). These are the circumstances into which backpressure should be applied.</li>
<li>Some key questions to answer to:<!-- -->
<ul>
<li>How much computation do we do on each vote?</li>
<li>How much computation do we do on each certificate?</li>
<li>What kind of backpressure do we need to bake in?</li>
</ul>
</li>
<li>An interesting observation: We could build certificates to reduce the amount of data transferred, e.g. trading CPU time (building certificate) for space and network bandwidth consumption.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="impact-on-user-experience">Impact on user experience<a href="#impact-on-user-experience" class="hash-link" aria-label="Direct link to Impact on user experience" title="Direct link to Impact on user experience">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="model">Model<a href="#model" class="hash-link" aria-label="Direct link to Model" title="Direct link to Model">​</a></h3>
<p>We could want to model the outcomes of Peras in terms of <em>user experience</em>, e.g. how does Peras impact the user experience? From the point of view of the users, the thing that matters is the <em>settlement time</em> of their transactions: How long does it take for a transaction submitted to be <em>settled</em>, e.g. to have enough (how much?) guarantee that the transaction is definitely part of the chain?</p>
<p>From this point of view, the whole path from transaction submission to observing a (deep enough) block matters, which means we need to take into account in our modeling the propagation of the transaction through the mempools of various nodes in the network until it reaches a block producer. This also means we need to take into account the potential <em>delays</em> incurred in that journey that can occur because of <em>mempool congestion</em> in the system: When the mempool of a node is full, it will not pull more transactions from the peers that are connected to it.</p>
<p>The following diagram illustrates the &quot;happy path&quot; of a transaction until the block its part of gets adopted by the emitting node, in Praos.</p>
<div class="language-mermaid codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mermaid codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sequenceDiagram</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">actor Alice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">participant N1 as Node1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">participant N2 as Node2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">participant N3 as Node3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">participant BP as Minter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N2 --&gt;&gt; +N1: Next tx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Alice -&gt;&gt; N1: Post tx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N1 -&gt;&gt; +N2: Tx id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N2 -&gt;&gt; +N1: Get tx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N1 -&gt;&gt; +N2: Send tx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BP --&gt;&gt; +N2: Next tx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N2 -&gt;&gt; +BP: Tx id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BP -&gt;&gt; +N2: Get tx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N2 -&gt;&gt; +BP: Send tx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BP -&gt;&gt; BP: Mint block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N2 -&gt;&gt; +BP: Next block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BP -&gt;&gt; N2: Block header</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N2 -&gt;&gt; BP: Get block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BP -&gt;&gt; N2: Send block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N1 -&gt;&gt; +N2: Next block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N2 -&gt;&gt; N1: Block header</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N1 -&gt;&gt; N2: Get block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N2 -&gt;&gt; N1: Send block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">N1 --&gt;&gt; Alice: Tx in block</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This question is discussed in much more detail in the <a href="https://docs.google.com/document/d/1B42ep9mvP472-s6p_1qkVmf_b1-McLNPyXGjGHEVJ0w/edit" target="_blank" rel="noopener noreferrer">report on timeliness</a> and should be considered outside of the scope of Peras protocol itself.</p>
<h1>Property-based testing with state-machine based QuickCheck</h1>
<p>The <code>quickcheck-dynamic</code> Haskell package enables property-based testing of state machines. It is the primary testing framework used for testing the Peras implementations in Haskell and Rust. Eventually, the dynamic model instances used in <code>quickcheck-dynamic</code> will be generated directly from the Agda specification of Peras using <code>agda2hs</code>.</p>
<p>Testing that uses the standard (non-dynamic) <code>quickcheck</code> package is limited to the JSON serialization tests, such as golden and roundtrip tests and round-trip tests.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="praos-properties">Praos properties<a href="#praos-properties" class="hash-link" aria-label="Direct link to Praos properties" title="Direct link to Praos properties">​</a></h2>
<p>Praos <code>NodeModel</code> and <code>NetworkModel</code> test the state transitions related to slot leadership and forging blocks. They can be used with the Haskell node and network implemented in <code>peras-iosim</code>, or the Rust node and network implementation in <code>peras-rust</code>. This dual-language capability demonstrated the feasibility of providing dynamic QuickCheck models for language-agnostic testing. The properties tested are that the forging rate of a node matches the theoretical expectation to within statistical variations and that, sufficiently after genesis, the nodes in a network have a common chain-prefix.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="peras-properties">Peras properties<a href="#peras-properties" class="hash-link" aria-label="Direct link to Peras properties" title="Direct link to Peras properties">​</a></h2>
<p>A <code>quickcheck-dynamic</code> model was created for closer and cleaner linkage between code generated by <code>agda2hs</code> and Haskell and Rust simulations. The model has the following features:</p>
<p>The &quot;idealized&quot; votes, certificates, blocks, and chains of the QuickCheck model are separated from &quot;realized&quot; ones generated by <code>agda2hs</code> and used in the simulations. The idealized version ignores some details like signatures and proofs. It is possible to remove this separation between ideal and real if behaviors are fully deterministic (including the bytes of signatures and proofs). However, this prototype demonstrates the feasibility of having a slightly more abstract model of a node for use in <code>Test.QuickCheck.StateModel</code>.</p>
<p>The <a href="https://github.com/input-output-hk/peras-design/blob/4bc364f52dd33665cbb13d03d7ca16efea98f4ee/peras-quickcheck/src/Peras/OptimalModel.hs#L1" target="_blank" rel="noopener noreferrer"><code>NodeModel</code></a> has sufficient detail to faitfully represents Peras protocol. Ideally, this would be generated directly by <code>agda2hs</code>. This instance of <code>StateModel</code> uses the executable specification for state transitions and includes generators for actions, constrained by preconditions.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">data NodeModel = NodeModel { ... }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">instance StateModel NodeModel where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data Action NodeModel a where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Initialize :: Protocol -&gt; PartyId {- i.e., the owner of the node -} -&gt; Action NodeModel ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ATick :: IsSlotLeader -&gt; IsCommitteeMember -&gt; Action NodeModel [MessageIdeal]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ANewChain :: ChainIdeal -&gt; Action NodeModel [MessageIdeal]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASomeCert :: CertIdeal -&gt; Action NodeModel [MessageIdeal]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ASomeVote :: VoteIdeal -&gt; Action NodeModel [MessageIdeal]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  arbitraryAction = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  precondition = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  initialState = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nextState = ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The executable specification for the node model is embodied in a typeclass <code>PerasNode</code> representing the abstract interface of nodes. An <code>instance (Monad m, PerasNode n m) =&gt; RunModel NodeModel (RunMonad n m)</code> executes actions on a <code>PerasNode</code> and checks postconditions. This also could be generated by <code>agda2hs</code> from the specification.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class Monad m =&gt; PerasNode a m where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  newSlot :: IsSlotLeader -&gt; IsCommitteeMember -&gt; a -&gt; m ([Message], a)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  newChain :: Chain -&gt; a -&gt; m ([Message], a)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For demonstration purposes, an <code>instance PerasNode ExampleNode</code> implements a simple, intentionally buggy, node for exercising the dynamic logic tests. This could be a full Haskell or Rust implementation, an implementation generated via <code>agda2hs</code> from operational (executable) semantics in Agda, etc.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">data ExampleNode = ExampleNode { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">instance PerasNode ExampleNode Gen where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The example property below simply runs a simulation using <code>ExampleNode</code> and checks the trace conforms to the executable specification.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">propSimulate :: (Actions NodeModel -&gt; Property) -&gt; Property</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">propSimulate = forAllDL simulate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">simulate :: DL NodeModel ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">simulate = action initialize &gt;&gt; anyActions_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- | Act on the example node.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">propOptimalModelExample :: Actions NodeModel -&gt; Property</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">propOptimalModelExample actions = property . runPropExampleNode $ do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  void $ runActions actions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  assert True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- | Test a property in the example node.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runPropExampleNode :: Testable a =&gt; PropertyM (RunMonad ExampleNode Gen) a -&gt; Gen Property</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runPropExampleNode p = do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Capture eval &lt;- capture</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  flip evalStateT def . runMonad . eval $ monadic&#x27; p</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Because the example node contains a couple of intentional bugs, one expects the test to fail. Shrinking reveals a parsimonious series of actions that exhibit one of the bugs.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spec :: Spec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec = describe &quot;Example node&quot; . prop &quot;Simulation respects model&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         . expectFailure $ propSimulate propOptimalModelExample</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cabal run test:peras-quickcheck-test -- --match &quot;/Peras.OptimalModel/Example node/Simulation respects model/&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Peras.OptimalModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Example node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Simulation respects model [✔]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      +++ OK, failed as expected. Assertion failed (after 4 tests and 1 shrink):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      do action $ Initialize (Peras {roundLength = 10, quorum = 3, boost = 0.25}) 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         action $ ANewChain [BlockIdeal {hash = &quot;92dc9c1906312bb4&quot;, creator = 1, slot = 0, cert = Nothing, parent = &quot;&quot;}]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         action $ ATick False True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         pure ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Finished in 0.0027 seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 example, 0 failures</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="relating-test-model-to-formal-model">Relating test model to formal model<a href="#relating-test-model-to-formal-model" class="hash-link" aria-label="Direct link to Relating test model to formal model" title="Direct link to Relating test model to formal model">​</a></h2>
<p>The team has been working with <a href="https://drive.google.com/file/d/1vDfwiR24t3K6INkabwR43A4Ryc-j7SzG/view" target="_blank" rel="noopener noreferrer"><em>Quviq</em></a> to provide assistance and expertise on tighter integration between the Agda specification and the <code>quickcheck-dynamic</code> model. This work resulted in the development of a prototype that demonstrates the feasibility of generating the <code>quickcheck-dynamic</code> model from the Agda specification, as described in Milestone 1 of the <em>Statement of Work</em>.</p>
<p>The following picture summarizes how the various parts of the testing framework for Peras are related:</p>
<p><img decoding="async" loading="lazy" alt="Agda-QuickCheck Integration" src="/peras-design/assets/images/agda-quickcheck-f6b64d1b63c46d0d942c69378a790bb1.png" width="2384" height="1274" class="img_ev3q"></p>
<p>The key points of this line of work are:</p>
<ol>
<li>While both written in Agda, we differentiate the <em>Formal model</em> from the <em>Test model</em> as they serve different purposes. More importantly, we acknowledge the fact there be more than one <em>Test model</em> for a given <em>Formal model</em>, depending on the level of abstraction and the properties we want to test,</li>
<li>The <em>Formal model</em> is the actual <a href="#agda-specification">specification</a> of the protocol and is meant to write <em>proofs</em> related to the protocol (e.g the usual blockchain properties like chain growth, chain quality, etc. and the specific properties of Peras). Ideally, this model should be part of the research work and written in close collaboration with them,</li>
<li>The <em>Test model</em> describes some relevant behavior of the system for the purpose of asserting a liveness or safety property, in the form of a state machine relating: A state data type, some <em>signals</em> sent to the SUT for testing purpose, and a <em>step</em> function describing possible transitions of the system,</li>
<li>The <em>Test model</em>&#x27;s soundness w.r.t the <em>Formal model</em> is proven through a <em>soundness</em> theorem that guarantees each sequence of transition in the <em>Test model</em> can be mapped to a valid sequence of transitions in the <em>Formal model</em>,</li>
<li>Using <code>agda2hs</code> Haskell code is generated from the <em>Test model</em> and integrated in a small hand-written wrapper complying with quickcheck-dynamic API,</li>
<li>Note the <code>perform</code> function is not generated because it&#x27;s specific to the actual implementation of the <em>System-Under-Test</em> (SUT).</li>
</ol>
<p>The provided models are very simple toy examples of some chain protocol as the purpose of this first step was to validate the approach and identify potential issues. In further steps, we need to:</p>
<ol>
<li>Work on a more complex and realistic Test model checking some core properties of the Peras protocol,</li>
<li>Ensure the Formal model&#x27;s semantics is amenable to testability and proving soundness of the Test model.</li>
</ol>
<h1>Simulations</h1>
<p>In order to test the language-neutrality of the testing framework for Peras, we developed both Haskell-based and Rust-based simulations of the Peras and Praos protocols.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="haskell-based-simulation">Haskell-based simulation<a href="#haskell-based-simulation" class="hash-link" aria-label="Direct link to Haskell-based simulation" title="Direct link to Haskell-based simulation">​</a></h2>
<p>The initial phase of the first Peras PI&#x27;s work on simulation revolves around discovery. This involves several key tasks, including prototyping and evaluating different simulation architectures, investigating simulation-based analysis workflows, assessing existing network simulation tools, establishing interface and serialization formats, eliciting requirements for both simulation and analysis purposes, and gaining a deeper understanding of Peras behaviors. The first prototype simulation, developed in Haskell, is closely intertwined with the Agda specification. This integration extends to the generation of types directly from Agda. Subsequent work will migrate a significant portion of the Peras implementation from Haskell to functions within the Agda specification, which will necessitate reconceptualizing and refining various components of the simulation.</p>
<p>The Peras simulation employs language-agnostic components that collaborate seamlessly (see figure below). This includes node implementations in Haskell, with Rust implementations forthcoming. Additionally, the native-Haskell simulation utilizes the <a href="https://hackage.haskell.org/package/io-classes" target="_blank" rel="noopener noreferrer">IOSim</a> packages in a manner consistent with QuickCheck tests in <code>peras-quickcheck</code>, which also supports a <em>Foreign Function Interface</em> (FFI) connection to <a href="https://github.com/input-output-hk/ce-netsim" target="_blank" rel="noopener noreferrer">Netsim</a> and <code>peras-rust</code>. The simulation setup also encompasses statistically designed experiments, the ability to inject rare events or adversarial behaviors, tools for generating networks and scenarios, as well as analysis and visualization tools to interpret the simulation results. A significant aspect of the workflow is geared towards analysis. This involves an observability approach to gathering metrics, utilization of language-independent file formats, visualization of network structures, and statistical analyses primarily conducted using <a href="https://www.r-project.org/" target="_blank" rel="noopener noreferrer">R</a>.</p>
<p><img decoding="async" loading="lazy" alt="Workflow for simulation experiments" src="/peras-design/assets/images/sim-workflow-6b7448bd89056e53b0243cb410879bc5.png" width="438" height="287" class="img_ev3q"></p>
<p>The IOSim-based Haskell simulator for Peras currently provides a provisional implementation of the Peras protocol&#x27;s intricacies, including committee selection, voting rounds, and cool-down periods. Presently, the fidelity of the simulation to the Peras protocol is moderate, while the fidelity at the network layer remains low. Substantial refactoring and refinement efforts are deemed necessary moving forward to enhance the simulation&#x27;s accuracy and effectiveness.</p>
<p>The simulation implements the February version of the Peras protocol, illustrated in the <a href="https://en.wikipedia.org/wiki/Unified_Modeling_Language" target="_blank" rel="noopener noreferrer">UML</a> sequence diagrams below for node behavior, and the activity diagram for node state transitions. Nodes receive messages for entering a new slot or new voting round; they also receive new preferred chains or votes from their upstream peers via messages. When they vote, forge blocks, or adopt a new preferred chain, they notify their downstream peers via messages.</p>
<blockquote>
<p>[!WARNING]
The detailed behavior of the February protocol differs somewhat from later versions such as the March protocol.</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="UML sequence diagram for the February version of the Peras protocol" src="/peras-design/assets/images/peras-sequence-0a9a26e930a2b3ed0e865f5ade920498.png" width="685" height="1054" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="UML activity diagram for the February version of the Peras protocol" src="/peras-design/assets/images/peras-activity-cb1ea659d6d55d7a8a4d6b3bded254f9.png" width="1740" height="1012" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="design">Design<a href="#design" class="hash-link" aria-label="Direct link to Design" title="Direct link to Design">​</a></h3>
<p>The architecture, design, and implementation of the Haskell-based <code>peras-iosim</code> package evolved significantly during Peras&#x27;s first PI, so here we just summarize the software approach that the series of prototypes has converged upon.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="iosim">IOSim<a href="#iosim" class="hash-link" aria-label="Direct link to IOSim" title="Direct link to IOSim">​</a></h4>
<p>The simulator initially relied heavily on <code>io-sim</code> and <code>io-classes</code> as it was inspired by similar work based on IOSim, like <a href="https://github.com/input-output-hk/hydra-sim" target="_blank" rel="noopener noreferrer">hydra-sim</a>: Each node would be a separate actor, possibly running several threads. We then moved to a much more lightweight use of IOSim&#x27;s capabilities.</p>
<p>First of all, IOSim&#x27;s implementation is currently single-threaded with a centralized scheduler that handles the simulated threads. Thus, IOSim does not provide the speed advantages of a parallel simulator. However, it conveniently provides many of the commonly used MTL (monad transformer library) instances typically used with <code>IO</code> or <code>MonadIO</code> but in a manner compatible with a simulation environment. For example, <code>threadDelay</code> in <code>IOSim</code> simulates the passage of time whereas in <code>IO</code> it blocks while time actually passes. Furthermore, the STM usage in earlier Peras prototypes was first refactored to higher-level constructs (such as STM in the network simulation layer instead of in the nodes themselves) but then finally eliminated altogether. The elimination of STM reduces the boilerplate and thread orchestration in QuickCheck tests and provides a cleaner testing interface to the node, so that interface is far less language dependent. Overall, the added complexity of STM simply was not justified by requirements for the node, since the reference node purposefully should not be highly optimized. Additionally, IOSim&#x27;s event logging is primarily used to handle logging via the <code>contra-tracer</code> package. IOSim&#x27;s <code>MonadTime</code> and <code>MonadTimer</code> classes are used for managing the simulation of the passage of time.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="node-interface">Node interface<a href="#node-interface" class="hash-link" aria-label="Direct link to Node interface" title="Direct link to Node interface">​</a></h4>
<p>The node interface has evolved towards a request-response pattern, with several auxiliary getters and setters. This will further evolve as alignment with the Agda-generated code and QuickCheck Dynamic become tighter. At this point, however, the node interface and implementation is sufficient for a fully faithful simulation of the protocol, along with the detailed observability required for quantifying and debugging its performance.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class PerasNode a where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  getNodeId :: a -&gt; NodeId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  getOwner :: a -&gt; PartyId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  getStake :: a -&gt; Coin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  setStake :: a -&gt; Coin -&gt; a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  getDownstreams :: a -&gt; [NodeId]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  getPreferredChain :: a -&gt; Chain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  getPreferredVotes :: a -&gt; [Vote]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  getPreferredCerts :: a -&gt; [Certificate]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  getPreferredBodies :: a -&gt; [BlockBody]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  handleMessage :: Monad m =&gt; a -&gt; NodeContext m -&gt; InEnvelope -&gt; m (NodeResult, a)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stop :: Monad m =&gt; a -&gt; NodeContext m -&gt; m a</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Honest versus adversarial nodes can be wrapped in the existential type <code>SomeNode</code>. The <code>NodeResult</code> captures the messages emitted by the node in response to the message (<code>InEnvelope</code>) that it receives, specifies the lower bound on the time of the node&#x27;s next activity (<code>wakeup</code>), and collects metrics regarding the node&#x27;s activity:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">data NodeResult = NodeResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  { wakeup :: UTCTime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , outputs :: [OutEnvelope]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , stats :: NodeStats</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data NodeStats = NodeStats</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  { preferredTip :: [(Slot, BlockHash)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , rollbacks :: [Rollback]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>NodeContext</code> includes critical environmental information such as the current time and the total stake in the system:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">data NodeContext m = NodeContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  { protocol :: Protocol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , totalStake :: Coin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , slot :: Slot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , clock :: UTCTime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , traceSelf :: TraceSelf m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="auxiliary-data-structures">Auxiliary data structures<a href="#auxiliary-data-structures" class="hash-link" aria-label="Direct link to Auxiliary data structures" title="Direct link to Auxiliary data structures">​</a></h4>
<p>An efficient Haskell simulation requires auxiliary data structures to index the blocks, votes, and certificates in the block tree, to memoize quorum checks, etc. A node can use a small state machine for each channel to an upstream node and supplement that with its own global state machine.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">data ChainState = ChainState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  { tracker :: ChainTracker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , channelTrackers :: Map NodeId ChainTracker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , chainIndex :: ChainIndex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Each <code>ChainTracker</code> records node- or peer-specific states.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">data ChainTracker = ChainTracker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  { preferredChain :: Chain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , preferredVoteHashes :: Set VoteHash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , preferredCertHashes :: Set CertificateHash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , missingBodies :: Set BodyHash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , latestSeen :: Maybe Certificate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , latestPreferred :: Maybe Certificate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>An index facilitates efficient lookup and avoids recomputation of quorum information.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">data ChainIndex = ChainIndex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  { headerIndex :: Map BlockHash Block</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , bodyIndex :: Map BodyHash BlockBody</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , voteIndex :: Map VoteHash Vote</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , certIndex :: Map CertificateHash Certificate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , votesByRound :: Map RoundNumber (Set VoteHash)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , certsByRound :: Map RoundNumber (Set VoteHash)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , weightIndex :: Map BlockHash Double</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Combined, these types allow a node to track the information it has sent or received from downstream or upstream peers, to eliminate recomputing chain weights, to avoid asking multiple peers for the same information, and to record its and its peers&#x27; preferred chains, votes, and certificates. Note that this instrumentation and optimization does not affect the simulated performance of the node because that performance is tracked via a cost model, regardless of the performance of the simulation code.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="observability">Observability<a href="#observability" class="hash-link" aria-label="Direct link to Observability" title="Direct link to Observability">​</a></h4>
<p>Tracing occurs via a <code>TraceReport</code> which records ad-hoc information or the structured statistics.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">data TraceReport</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  = TraceValue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      { self :: NodeId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      , slot :: Slot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      , clock :: UTCTime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      , value :: Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | TraceStats</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      { self :: NodeId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      , slot :: Slot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      , clock :: UTCTime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      , statistics :: NodeStats</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>value</code> in the interface above can hold the result of a single &quot;big step&quot;, recorded in a <code>StepResult</code> of outputs and events.</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">data StepResult = StepResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  { stepTime :: UTCTime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , stepOutputs :: [OutEnvelope]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  , stepEvents :: [Event]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data Event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  = Send { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | Drop { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | Trace Value</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>peras-iosim</code> executable supports optional capture of the trace as a stream of JSON objects. In experiments, <code>jq</code> is used for ad-hoc data extraction and <code>mongo</code> is used for complex queries. The result is analyzed using R scripts.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="message-routing">Message routing<a href="#message-routing" class="hash-link" aria-label="Direct link to Message routing" title="Direct link to Message routing">​</a></h4>
<p>The messaging and state-transition behavior of the network of nodes can be modeled via a discrete event simulation (DES). Such simulations are often parallelized (PDES) in order to take advantage of the speed gains possible from multiple threads of execution. Otherwise, a single thread must manage routing of messages and nodes&#x27; computations: for large networks and long simulated times, the simulation&#x27;s execution may become prohibitively slow. Peras simulations are well suited to <em>conservative PDES</em> where strong guarantees ensure that messages are always delivered at monotonically non-decreasing times to each node; the alternative is an <em>optimistic PDES</em> where the node and/or message queue states have to be rolled back if a message with an out-of-order timestamp is delivered. A PDES for Peras can be readily constructed if each time a node emits a message it also declares a guarantee that it will not emit another message until a specified later time. Such declarations provide sufficient information for its downstream peers to advance their clocks to the minimum timestamp guaranteed by their upstream peers: i.e., when a node sees empty incoming message queues from all of its upstream peers, it can compute a safe time to advance forward, thus avoiding race conditions or deadlock. Hence, each node can run its own thread and have upstream and downstream message queues directly connected to its peers, all without the centrally managed message routing that would form a potential bottleneck for scaling performance. The experiments described later in this document indicate that PDES is not needed at this time because simulations execute sufficiently fast without it and the cpu resources could be better used for running ensembles of simulations in parallel.</p>
<p>That said, it likely is the case that Peras simulations will not need to simulate contiguous weeks or months of network operation, so at this point <code>peras-iosim</code> uses a centrally managed time-ordered priority queue for message routing. Also, instead of each node running autonomously in its own thread, nodes are driven by the receipt of a message and respond with timestamped output messages and a &quot;wakeup&quot; timestamp bounding the node&#x27;s next activity. If long-running simulations are later required, the node design is consistent with later upgrading the message-routing implementation to a conservative PDES and operating each node in its own thread in a fully parallelized or distributed simulation. The basic rationales against long-running simulations are (1) that ΔQ analyses are better suited for network traffic and resource studies and (2) simulation is best focused on the rare scenarios involving forking and cool-down, which occur below Cardano&#x27;s Ouroboros security parameter <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span></span></span></span> of 2160 blocks (approximately thirty-six hours).</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="sync-protocol">Sync protocol<a href="#sync-protocol" class="hash-link" aria-label="Direct link to Sync protocol" title="Direct link to Sync protocol">​</a></h4>
<p>Five designs for node sync protocol were considered.</p>
<ol>
<li>Simple handoffs between client and server<!-- -->
<ul>
<li>Closely corresponds to Agda Message</li>
<li>Client could use blocking calls to tidily process messages</li>
<li><code>FetchChain</code> does not stream, so another <code>FetchChain</code> request must be made for each subsequent block header in the new chain</li>
<li>Cannot handle <code>FetchVotes</code> or <code>FetchBlocks</code> when multiple hashes are provided, so all queries must be singletons</li>
</ul>
</li>
<li>Messy multiplexing<!-- -->
<ul>
<li>Similar to how early prototypes used incoming and outgoing STM channels</li>
<li>Incoming messages will not be in any particular order</li>
<li>Client needs to correlate what they received to what they are waiting for, and why - maybe use futures or promises with closures</li>
</ul>
</li>
<li>Sequential mini-protocols<!-- -->
<ul>
<li>Reminiscent of the Ouroboros design currently in production</li>
<li>Client needs to <code>Cancel</code> and re-query when they want a different type of information, a pattern which differs from real nodes&#x27; simple abandonment of responses that become irrelevant</li>
</ul>
</li>
<li>Parallel mini-protocols<!-- -->
<ul>
<li>Separate threads for each type of sync (header, vote, block)</li>
<li>Client needs to orchestrate intra-thread communication</li>
</ul>
</li>
<li>Constrained fetching<!-- -->
<ul>
<li>Supports the most common use case of fetching votes and bodies right after a new header is received</li>
<li>Reduces to a request/replies protocol if the protcol&#x27;s state machine is erased or implicit</li>
</ul>
</li>
</ol>
<table><thead><tr><th>Design 1</th><th>Design 2</th><th>Design 3</th><th>Design 5</th></tr></thead><tbody><tr><td><img decoding="async" loading="lazy" alt="Simple handoffs" src="/peras-design/assets/images/protocol-1-7b320775b9b2229fed53fe2bd008a080.png" width="804" height="357" class="img_ev3q"></td><td><img decoding="async" loading="lazy" alt="Multiplexing" src="/peras-design/assets/images/protocol-2-efc7fe5c9cd0d8e38807a7be93225a51.png" width="884" height="353" class="img_ev3q"></td><td><img decoding="async" loading="lazy" alt="Mini-protocols" src="/peras-design/assets/images/protocol-3-eb4154aaae64efe8d225831da5cb85d7.png" width="1096" height="512" class="img_ev3q"></td><td><img decoding="async" loading="lazy" alt="Constrained fetching" src="/peras-design/assets/images/protocol-5-c357fc7599ef6c19eb272437dd3cdb6e.png" width="823" height="703" class="img_ev3q"></td></tr></tbody></table>
<p>These highlight some key design issues:</p>
<ul>
<li><code>FetchVotes</code> and <code>FetchBlocks</code> trigger multiple responses, as <code>FetchChain</code> may also do,</li>
<li>Three types of information are being queried (headers, votes, blocks) in only a semi-predictable sequence,</li>
<li>The DoS attack surface somewhat depends upon when the node yields agency to its peers,</li>
<li>Pull-based protocols involve more communication than push-based ones.</li>
</ul>
<p>The current implementation uses a simple request/reply protocol that avoids complexity, but is not explicitly defined as a state machine. This is actually quite similar to the fifth design, but with no <code>Next</code> request. It abandons the notion of when the client or server has agency. If the client sends a new request before the stream of responses to the previous request is complete, then responses will be multiplexed.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="experiments">Experiments<a href="#experiments" class="hash-link" aria-label="Direct link to Experiments" title="Direct link to Experiments">​</a></h3>
<p>The simulation experiments below use slightly different versions of the ever-evolving Haskell package <code>peras-iosim</code>, which relies on the types generated by <code>agda2hs</code>, but with the now slightly outdated February version of the Peras protocol. Visualization was performed with the <a href="https://graphviz.org" target="_blank" rel="noopener noreferrer">GraphViz</a> tool, and statistical and data analysis was done with R.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="block-production">Block production<a href="#block-production" class="hash-link" aria-label="Direct link to Block production" title="Direct link to Block production">​</a></h4>
<p>The &quot;block production&quot; experiment laid the groundwork for testing simulated block-production rates using QuickCheck properties. Because the VRF determines which slots a node leads and forges a block, the production is sporadic and pseudo-random. Heretofore, the Peras simulation has used a simple probabilistic approximation to this process: a uniformly distributed random variable is selected and the node produces a block in the slot if that variable is less than the probability <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>=</mo><mn>1</mn><mo>−</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>f</mi><msup><mo stretchy="false">)</mo><mo stretchy="false">(</mo></msup><msub><mi>s</mi><mi>n</mi></msub><mi mathvariant="normal">/</mi><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p = 1 - (1 - f) ^ (s_n / s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mopen mtight">(</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>e</mi><mi>s</mi><mi>l</mi><mi>o</mi><mi>t</mi><mi>c</mi><mi>o</mi><mi>e</mi><mi>f</mi><mi>f</mi><mi>i</mi><mi>c</mi><mi>i</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>a</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">f is the active slot coefficient and </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mord mathnormal">es</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mord mathnormal">coe</span><span class="mord mathnormal" style="margin-right:0.10764em">ff</span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span><span class="mord mathnormal">i</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">an</span><span class="mord mathnormal">d</span></span></span></span>s_n<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>n</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">and</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">an</span><span class="mord mathnormal">d</span></span></span></span>s_t$ are the stake held by the node and the whole network, respectively.</p>
<p>The experiment involved running 1000 simulations of two hours of block production for a node with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>=</mo><mn>0.05</mn></mrow><annotation encoding="application/x-tex">\alpha = 0.05</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0.05</span></span></span></span>. The stake held by the node was randomly chosen in each of the simulations. The plot below shows the number of blocks produced as a function of the node&#x27;s stake. The probability contours in the plot indicate the theoretical relationship. For example, the 99.9% quantile (indicated by 0.999 in the legend) is expected to have only 1/1000 of the observations below it; similarly, 90% of the observations should lie between the 5% and 95% contours. The distribution of the number of blocks produced in the experiment appears to obey the theoretical expectations.</p>
<p><img decoding="async" loading="lazy" alt="Relationship between a node&amp;#39;s stake and the number of blocks it produces" src="/peras-design/assets/images/blockproduction-scatter-22b7430b318eaabf04155944c1db5f52.png" width="840" height="840" class="img_ev3q"></p>
<p>Although the above plot indicates qualitative agreement, it is somewhat difficult to quantify the level of agreement because stake was varied in the different simulations. The following histogram shows another view of the same data, where the effect of different stake is removed by applying the binomial cumulative probability distribution function (CDF) for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>=</mo><mn>0.05</mn></mrow><annotation encoding="application/x-tex">\alpha = 0.05</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0.05</span></span></span></span> to the data. Theoretically, this transformed distribution should be uniform between zero and one. Once again, the data appears to match expectations.</p>
<p><img decoding="async" loading="lazy" alt="Empirically observed quantiles of binomial distribution in block-production experiment" src="/peras-design/assets/images/blockproduction-quantiles-3a1a518996d2ef063d35a508139351c1.png" width="840" height="840" class="img_ev3q"></p>
<p>A Kolmogorov-Smirnov (KS) test quantifies the conformance of the results to such a uniform distribution:</p>
<div class="language-R language-r codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-r codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ks.test(results$`Quantile`, &quot;punif&quot;, min=0, max=1)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">D = 0.023265, p-value = 0.6587</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alternative hypothesis: two-sided</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <em>p</em>-value of 66% solidly indicates that the block production count matches our expectation and the theoretical model.</p>
<p>Because it is slightly inconvenient to embed a KS computation within a QuickCheck property, one can instead use an approximation based on the law of large numbers. The mean number of blocks produced in this binomial process should be the number of slots times the probability of producing a block in a slot, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">n p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">p</span></span></span></span>,  and the variance should be <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>p</mi><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">n p (1-p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span>. The <code>peras-quickcheck</code> module contains the following function in <code>Data.Statistics.Util</code>:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-- | Check whether a value falls within the central portion of a binomial distribution.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">equalsBinomialWithinTails ::</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- | The sample size.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Int -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- | The binomial probability.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Double -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- | The number of sigmas that define the central acceptance portion.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Double -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- | The actual observation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Int -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- | Whether the observation falls within the central region.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Bool</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The Peras continuous-integration tests are configured to require that the observed number of blocks matches the theoretical value to within three standard deviations. Practically, this means that the test measurement is a random variable that will fall outside the three σ range about once in every ten or so invocations of the CI (continuous integration) tests, since each invocation executes 100 tests.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="network-and-praos-chain-generation">Network and Praos chain generation<a href="#network-and-praos-chain-generation" class="hash-link" aria-label="Direct link to Network and Praos chain generation" title="Direct link to Network and Praos chain generation">​</a></h4>
<p>The simulation experiments generate a reasonable but random topology of peers, with a specified number of upstream and downstream nodes from each node. Slot leadership is determined according to the procedure outlined in the previous section above. Both the <code>peras-iosim</code> Haskell package and the <code>peras_topology</code> Rust package can generate these randomized topologies and store them in YAML files. The <code>peras-iosim</code> package generates valid Praos chains.</p>
<table><thead><tr><th>Example chain</th><th>Example topology</th></tr></thead><tbody><tr><td><img decoding="async" loading="lazy" alt="Example chain" src="/peras-design/assets/images/example-chain-92b6ba6854d99e6e319dc2b78b1ab669.png" width="1875" height="419" class="img_ev3q"></td><td><img decoding="async" loading="lazy" alt="Example topology" src="/peras-design/assets/images/example-network-587f3c75a9baae1a48a1bedcfaf92e8f.png" width="1198" height="1106" class="img_ev3q"></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="february-version-of-peras">February version of Peras<a href="#february-version-of-peras" class="hash-link" aria-label="Direct link to February version of Peras" title="Direct link to February version of Peras">​</a></h4>
<p>A semi-realistic set of protocol parameters and network configuration was set for a 100-node network with a mean committee size of 10.
Committee selection in the following simulation was set by limiting each node to a maximum of one vote. (However, the March version of the protocol clarifies that a node may have more than one vote.) The probability of becoming a member of the voting committee in a given round is</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo>=</mo><mn>1</mn><mo>−</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msub><mi>p</mi><mi>l</mi></msub><msup><mo stretchy="false">)</mo><mi>s</mi></msup></mrow><annotation encoding="application/x-tex">P = 1 - (1 - p_l)^s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span></span></span></span></span></span></span></span></span>
<p>given</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mi>l</mi></msub><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mn>1</mn><mi mathvariant="normal">/</mi><mi>c</mi><msup><mo stretchy="false">)</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mi mathvariant="normal">/</mi><mi>t</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">p_l = (1 - 1 / c)^{(c / t)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em"></span><span class="mord">1/</span><span class="mord mathnormal">c</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">c</span><span class="mord mtight">/</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span>
<p>where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">s</span></span></span></span> is the node&#x27;s stake, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em"></span><span class="mord mathnormal">t</span></span></span></span> is the total stake in the system, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">c</span></span></span></span> is the mean committee size.</p>
<p>The following figure compares similar Praos and Peras chains, highlighting how the latter&#x27;s voting boost affects the choice of preferred chain. The simulation involved 100 nodes and a mean committee size of 10 nodes; the active slot coefficient was set to 0.25 in order to provoke more frequent forking than would normally be observed. The voting boost is a modest 10% per vote.</p>
<p><img decoding="async" loading="lazy" alt="Comparison between Praos and Peras chains" src="/peras-design/assets/images/peras-praos-comparison-6f1e72f76fc119dbe33e4e3ca4e67a00.png" width="928" height="270" class="img_ev3q"></p>
<p>The difference is fork adoption results from more Peras votes being received by the lower chain than by the upper one, as illustrated below.</p>
<p><img decoding="async" loading="lazy" alt="Detail of Peras and Praos chain comparison" src="/peras-design/assets/images/peras-voting-5117f5502818e9f8d77d98415d531c7d.png" width="935" height="489" class="img_ev3q"></p>
<p>Statistics for rollbacks, such as the ones shown below, are measured in these simulations to quantify the number of slots or blocks that are reverted: such can be used to compute the likelihood of a transaction appearing in a block that is later rolled back. The diagram below shows a proof-of-principle measurement of rollback lengths in an ensemble of simulations. The horizontal axis shows the number of slots rolled back during the course of the whole simulation, and the vertical axis shows the corresponding number of blocks rolled back: the marginal histograms show the empirically observed frequency of each. (Note that the point indicating the number of slots vs blocks rolled back do not represent single rollbacks of that many slots or blocks: instead a simulation might have had many rollbacks and the slots and blocks listed are the total among the rollbacks. Also note that the active slot coefficient was set to a high value in order to provoke more forking.) Although the voting boost weight is varied among these simulations, it has almost no effect on the rollback statistics.</p>
<p><img decoding="async" loading="lazy" alt="Example of rollback statistics" src="/peras-design/assets/images/rollbacks-d1b2dd505b36e18781e88ccaa24a3e3b.png" width="1800" height="1800" class="img_ev3q"></p>
<p>Findings from the simulation runs highlight the impracticality of blindly running simulations with realistic parameters and then mining the data:</p>
<ul>
<li>The simulation results are strongly dependent upon the speed of diffusion of messages through the network, so a moderately high fidelity model for that is required.</li>
<li>Both Peras and Praos are so stable that one would need very long simulations to observe naturally occurring forks of more than one or two blocks.<!-- -->
<ul>
<li>Only in cases of very sparse connectivity or slow message diffusion are longer forks seen.</li>
<li>Peras quickly stabilizes the chain at the first block or two in each round, so even longer forks typically never last beyond then.</li>
</ul>
</li>
<li>Hence, even for honest nodes, one needs a mechanism to inject rare events such as multi-block forks, so that the effect of Peras can be studied efficiently.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="split-brain">&quot;Split brain&quot;<a href="#split-brain" class="hash-link" aria-label="Direct link to &quot;Split brain&quot;" title="Direct link to &quot;Split brain&quot;">​</a></h4>
<p>This first &quot;split-brain&quot; experiment with <code>peras-iosim</code> involved running a network of 100 nodes with fivefold connectivity for 15 minutes, but where nodes are partitioned into two non-communicating sets between the 5th and 10th minute. The nodes quickly establish consensus after genesis, but split into two long-lived forks after the 5th minute; shortly after the 10th minute, one of the forks is abandoned as consensus is reestablished.</p>
<p>Nodes were divided into two &quot;parities&quot; determined by whether the hash of their name is an even or odd number. When the network is partitioned, only nodes of the same parity are allowed to communicate with each other: the Haskell module <a href="https://github.com/input-output-hk/peras-design/blob/65d8a98817df119b3902e43e5acca86fdcca6f92/peras-iosim/src/Peras/IOSim/Experiment.hs#L1" target="_blank" rel="noopener noreferrer"><code>Peras.IOSIM.Experiment.splitBrain</code></a> implements the experiment and is readily extensible for defining additional experiments.</p>
<p>Both the Praos and Peras protocols were simulated, with the following Peras parameters for creating a scenario that exhibits occasional cool-down periods and a strong influence of the voting boost.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">activeSlotCoefficient</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">roundDuration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">pCommitteeLottery</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.00021</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">votingBoost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">votingWindow</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">150</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">votingQuorum</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">voteMaximumAge</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">cooldownDuration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">prefixCutoffWeight</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">10000000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The control (&quot;normal&quot;) case is a network that does not experience partitioning:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">randomSeed</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">13234</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">peerCount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">downstreamCount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">maximumStake</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">messageDelay</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">350000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">endSlot</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">experiment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tag</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NoExperiment</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The treatment (&quot;split&quot;) case experiences partitioning between the 5th and 10th minutes:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">randomSeed</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">13234</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">peerCount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">downstreamCount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">maximumStake</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">messageDelay</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">350000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">endSlot</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">experiment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tag</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SplitBrain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">experimentStart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">experimentFinish</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the Peras simulation, the chain that eventually became dominant forged fewer blocks during the partition period, but it was lucky to include sufficient votes for a quorum at slot 503 and that kept the chain out of the cool-down period long enough to put more votes on the chain, which increased the chain weight. It appears that that was sufficient for the chain to eventually dominate. Note that multiple small forks occurred between the time that network connectivity was restored and consensus was reestablished.</p>
<p><img decoding="async" loading="lazy" alt="Forking and reestablishment of quorum in Peras split-brain experiment" src="/peras-design/assets/images/split-brain-73d9751af4d3501796276bd4bfdb70a7.png" width="11615" height="1691" class="img_ev3q"></p>
<p>The primary measurements related to the loss and reestablishment of consensus relate to the length of the forks, measured in blocks or slots. The table shows the statistics of these forks, of which the Peras case had several.</p>
<table><thead><tr><th>Protocol</th><th>Metric</th><th style="text-align:right">Blocks</th><th style="text-align:right">Slots</th></tr></thead><tbody><tr><td>Praos</td><td>Length of discarded chain at slot 1000</td><td style="text-align:right">68</td><td style="text-align:right">1000</td></tr><tr><td></td><td>Length of dominant chain at slot 1000</td><td style="text-align:right">73</td><td style="text-align:right">1000</td></tr><tr><td></td><td>Number of blocks in discarded chain after slot 1000</td><td style="text-align:right">2</td><td style="text-align:right"></td></tr><tr><td>Peras</td><td>Length of discarded chain at slot 1000</td><td style="text-align:right">75</td><td style="text-align:right">1000</td></tr><tr><td></td><td>Length of dominant chain at slot 1000</td><td style="text-align:right">66</td><td style="text-align:right">1000</td></tr><tr><td></td><td>Number of blocks in discarded chain after slot 1000</td><td style="text-align:right">3</td><td style="text-align:right">137</td></tr><tr><td></td><td></td><td style="text-align:right">1</td><td style="text-align:right">118</td></tr><tr><td></td><td></td><td style="text-align:right">1</td><td style="text-align:right">137</td></tr><tr><td></td><td></td><td style="text-align:right">1</td><td style="text-align:right">141</td></tr><tr><td></td><td></td><td style="text-align:right">1</td><td style="text-align:right">55</td></tr><tr><td></td><td></td><td style="text-align:right">1</td><td style="text-align:right">24</td></tr><tr><td></td><td></td><td style="text-align:right">1</td><td style="text-align:right">18</td></tr><tr><td></td><td>Number of blocks afters slot 1000 to reach quorum</td><td style="text-align:right">18</td><td style="text-align:right">304</td></tr></tbody></table>
<p>The primary findings from this experiment follow.</p>
<ul>
<li>The complexity of the forking, voting, and cool-down in the Peras results highlights the need for capable visualization and analysis tools.</li>
<li>The voting boost can impede the reestablishment of consensus after a network partition is restored.</li>
<li>It would be convenient to be able to start a simulation from an existing chain, instead of from genesis.</li>
<li>VRF-based randomization makes it easier to compare simulations with different parameters.</li>
<li>Even though <code>peras-iosim</code> runs are not particularly fast, one probably does not need to parallelize them because typical experiments involve many executions of simulations, which means we can take advantage of CPU resources simply by running those different scenarios in parallel.</li>
<li>The memory footprint of <code>peras-iosim</code> is small (less than 100 MB) if tracing is turned off; with tracing, it is about twenty times that, but still modest.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="congestion">Congestion<a href="#congestion" class="hash-link" aria-label="Direct link to Congestion" title="Direct link to Congestion">​</a></h4>
<p>A coarse study exercised several aspects of <code>peras-iosim</code> in a simulation experiment involving network congestion: simulation/analysis workflow, scalability and performance, and observability. A full factorial experiment varied bandwidth and latency on a small network with semi-realistic Peras parameters. Each block has its maximum size: i.e., each block is completely full of transactions. There were  250 nodes with fivefold connectivity and a mean of 25 committee members; latency varied from 0.25 s to 1.00 s, and bandwidth varied from 8 Mb/s to 400 Mb/s, but other parameters remained constant.</p>
<p>The main caveat is that the memory pool and other non-block/non-vote messages were not modeled. Several findings were garnered from this experiment:</p>
<ul>
<li>A threshold is readily detectable at a bandwidth of ~20 Mb/s.<!-- -->
<ul>
<li>It is important to realize that this simulation was neither calibrated to realistic conditions nor validated.</li>
<li>Much better empirical data inputs for on node processing times (e.g., signature verification, block assembly, etc.) are needed.</li>
</ul>
</li>
<li>Non-block and not-vote messages such as those related to the memory pool must be accounted for in congestion.</li>
<li>The existing <code>peras-iosim</code> event logging and statistics system easily supports analyses such as these.</li>
</ul>
<p>The following diagram shows the cumulative bytes received by nodes as a function of network latency and bandwidth, illustrating the threshold below which bandwidth is saturated by the protocol and block/vote diffusion.</p>
<p><img decoding="async" loading="lazy" alt="Cumulative bytes received by nodes as a function of network latency and bandwidth" src="/peras-design/assets/images/congestion-11cb39fac7c6d77b8761cc38c2e02770.png" width="1200" height="800" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rust-based-simulation">Rust-based simulation<a href="#rust-based-simulation" class="hash-link" aria-label="Direct link to Rust-based simulation" title="Direct link to Rust-based simulation">​</a></h2>
<p>The Rust types for Peras nodes and networks mimic the Haskell ones and the messages conform to the Agda-generated types. The Rust implementation demonstrates the feasibility of using language-independent serialization and a foreign-function interface (FFI) for Haskell-based QuickCheck testing of Peras implementations. In particular, the Rust package <code>serde</code> has sufficiently configurable serialization so that it interoperates with the default Haskell serializations provided by <code>Data.Aeson</code>. (The new <code>agda2rust</code> tool has not yet reached a stable release, but it may eventually open possibilities for generating Rust code from the Agda types and specification.) A Rust static library can be linked into Haskell code via Cabal configuration.</p>
<p>The Rust node generates Praos blocks according to the slot-leadership recipe. The Rust network uses the Innovation Team&#x27;s new network simulation <a href="https://github.com/input-output-hk/ce-netsim" target="_blank" rel="noopener noreferrer">ce-netsim</a> for transportation block-production and preferred-chain messages among the nodes.</p>
<p>The key findings from Rust experiments follow.</p>
<ul>
<li>It is eminently practical to interface non-Haskell code to QuickCheck Dynamic via language-independent serialization and a foreign-function interface.</li>
<li>It is also possible to co-design Rust and Haskell code for Peras so that the implementations mirror each other, aside from language-specific constructs. This might result in not employing the advanced and idiosyncratic features of these two languages, however.</li>
<li>The <code>ce-netsim</code> architecture and threading model is compatible with Peras simulations, even ones linked to <code>quickcheck-dynamic</code> test via FFI.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overall-findings-from-simulation-studies">Overall findings from simulation studies<a href="#overall-findings-from-simulation-studies" class="hash-link" aria-label="Direct link to Overall findings from simulation studies" title="Direct link to Overall findings from simulation studies">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="simulation-results">Simulation results<a href="#simulation-results" class="hash-link" aria-label="Direct link to Simulation results" title="Direct link to Simulation results">​</a></h3>
<ul>
<li>Both Peras and Praos are so stable that one would need very long simulations to observe forks of more than one or two blocks.<!-- -->
<ul>
<li>Only in cases of very sparse connectivity or slow message diffusion are longer forks seen in honest networks.</li>
<li>Peras quickly stabilizes the chain at the first block or two in each round, so even longer forks typically never last beyond then.</li>
<li>Hence, even for honest nodes, we need a mechanism to inject rare events such as multi-block forks, so that the effect of Peras can be studied efficiently.</li>
</ul>
</li>
<li>The voting boost can impede the reestablishment of consensus after a network partition is restored.</li>
<li>The simulation results are strongly dependent upon the speed of diffusion of messages through the network, so a moderately high fidelity model for that is required.</li>
<li>Congesting experiments can detect when vote-related messages impact node performance.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="simulation-experiments">Simulation experiments<a href="#simulation-experiments" class="hash-link" aria-label="Direct link to Simulation experiments" title="Direct link to Simulation experiments">​</a></h3>
<ul>
<li>Single-threaded simulations of 1000s of nodes for one or more simulated days are feasible.</li>
<li>The parameter space is large enough (approximately ten dimensions) that statistically designed experiments (latin hypercubes, orthogonal arrays, or hybrids) and importance sampling will be needed to focus computational resources on the performance regimes of most interest.</li>
<li>Finely crafted, demonstrative simulation scenarios are needed for highlighting the value added by Peras.</li>
<li>The complexity of the forking, voting, and cool-down in the Peras results highlights the need for capable visualization and analysis tools.</li>
<li>More data on CPU usage for various node activities (verifying signatures, forging blocks, etc.) is needed for realistic simulation of node resource usage.<!-- -->
<ul>
<li>The performance reports being prepared for the Conway era have some of this information, but it is not quite at the granularity needed for a simulation.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="simulator-design">Simulator design<a href="#simulator-design" class="hash-link" aria-label="Direct link to Simulator design" title="Direct link to Simulator design">​</a></h3>
<ul>
<li>There is little point in expending the extra effort to develop multi-threaded, parallel network simulations because CPU resources could instead be devoted to the large ensembles of simulations that will be needed for some studies.<!-- -->
<ul>
<li>Furthermore, the Ouroboros security parameter of 2160 blocks limits the duration of interesting simulations.</li>
<li>However, A conservative parallel discrete event is feasible to implement if higher performance is needed for the simulation studies.</li>
</ul>
</li>
<li>Congestion modeling may require representing all message traffic between nodes (not just blocks, votes, and certificates).<!-- -->
<ul>
<li>However, the March version of the Peras protocol imposes a far lighter network load than the February version.</li>
<li>Hence, analytic estimates or ΔQ analyses may be sufficient for assessing the message-traffic overhead resulting from Peras.</li>
</ul>
</li>
<li>It would be convenient to be able to start a simulation from an existing chain, instead of from genesis.</li>
<li>Non-block and not-vote messages such as those related to the memory pool must be accounted for in congestion.</li>
<li>The following detail for event logging is sufficient for analysis and visualization of the simulations.<!-- -->
<ul>
<li>CPU resource consumption.</li>
<li>Bytes transmitted and received.</li>
<li>Slot leadership and committee membership.</li>
<li>Occurrence of rollbacks.</li>
<li>The sending, receiving, and dropping of messages.</li>
</ul>
</li>
<li>Language-independent schemas (in YAML or JSON) for scenario definition, network topology, observability, and visualization create seamless interoperability between Haskell and Rust simulators.<!-- -->
<ul>
<li>Query tools such as <code>jq</code> and <code>mongo</code> work well for ad-hoc analysis of the event logs.</li>
<li>Log analysis and visualization tools can be compatible with Peras observability.</li>
</ul>
</li>
<li>Haskell<!-- -->
<ul>
<li>The <code>agda2hs</code> tool generates Haskell that is usable in simulations and QuickCheck.<!-- -->
<ul>
<li>The biggest awkwardness is that one has to write some orphan instances (including <code>Arbitrary</code>) in Haskell instead of in Agda.</li>
</ul>
</li>
<li>Keeping the exported Haskell implementation &quot;boring&quot; (i.e., avoiding type-level machinery, complex monad transformer stacks, no STM, etc.) facilitates its interoperability with <code>quickcheck-dynamic</code> and language-independent APIs.</li>
<li>An efficient Haskell simulation requires auxiliary data structures to index the blocks, votes, and certificates in the block tree, to memoize quorum checks, etc.</li>
</ul>
</li>
<li>Rust<!-- -->
<ul>
<li>The <code>serde</code> Rust libraries successfully mimic Haskell&#x27;s <code>aeson</code> serialization for JSON.</li>
<li>The <code>serde</code> library also supports serialization as CBOR, though its compatibility with Cardano&#x27;s CBOR serialization has not yet been assessed.</li>
<li>The <code>agda2rust</code> tool is not sufficiently mature to generate Peras&#x27;s Agda types for use in Rust.</li>
<li>The <code>ce-netsim</code> library is useful for the message-passing portions of Peras simulations written in Rust.</li>
<li>Using WASM as a Rust compilation target may enable running serverless simulations in a web browser.</li>
</ul>
</li>
<li>IOSim<!-- -->
<ul>
<li>IOSim&#x27;s single-threaded implementation hinders its usefulness for high performance simulations.</li>
<li>It is quite awkward to use random numbers (e.g., <code>StatefulGen</code>) within <code>IOSim</code> because it lacks the requisite monad-transformer instances. The experimental and outdated <code>io-classes-mtl</code> package does not solve this problem.</li>
</ul>
</li>
<li>QuickCheck<!-- -->
<ul>
<li>Some tests of node behavior may be statistical, but the current codebase demonstrates how properties that only hold statistically can be incorporated into continuous-integration (CI) tests.</li>
</ul>
</li>
<li>Ideally, simulation analysis and visualization tools could be browser-based, so that stakeholders could explore Peras and build intuition about it without installing any software.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="integration-with-quickcheck-dynamic">Integration with QuickCheck Dynamic<a href="#integration-with-quickcheck-dynamic" class="hash-link" aria-label="Direct link to Integration with QuickCheck Dynamic" title="Direct link to Integration with QuickCheck Dynamic">​</a></h3>
<p>Now that it has been demonstrated that it is feasible to export Agda types, functions, and QuickCheck dynamic models to Haskell for testing, an optimal path forward would be to have those generated types dictate the public interfaces for node and network simulations (both in Haskell and in Rust). The current simulation codebase is consistent with this test-driven development (TDD) approach and will only require minor adjustments to yield simulations that are faithful to Peras and that are primarily based on exported Agda types and functions. The same simulation implementation will both conform to the <code>quickcheck-dynamic</code> models and the requirement for efficient simulation.</p>
<h1>Integration into Cardano Node</h1>
<p>This section studies the required work and potential impacts of implementing Peras as a core component of the Cardano node. The main impacts identified are that:</p>
<ul>
<li>Peras requires significant changes to message traffic between nodes, with new types of messages and network protocols,</li>
<li>It <em>might</em> require changes to the structure of blocks,</li>
<li>It increases the computational resources used by nodes through the need to produce and validate votes.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="networking">Networking<a href="#networking" class="hash-link" aria-label="Direct link to Networking" title="Direct link to Networking">​</a></h2>
<p>Peras introduces two new constructs: votes and certificates. Members of the Peras committee cast votes each voting round, and the votes must be received by a block-producing node before the votes expire. A certificate memorializes a quorum of votes (approximately 80% of the committee)  made in the same round for a particular block. A certificate must be included in the first block of a cool-down period, though at least one variant of the protocol envisions each round&#x27;s certificate being included regardless of cool-down status. Nodes syncing from genesis or an earlier point in the chain&#x27;s history must be provided the votes or equivalent certificates in order for them to verify the weight of the chain. Thus, the protocol results in the following message traffic:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="votes">Votes<a href="#votes" class="hash-link" aria-label="Direct link to Votes" title="Direct link to Votes">​</a></h3>
<ul>
<li>Vote messages diffuse votes from voters to the block-producing nodes.<!-- -->
<ul>
<li>An upper bound (worst-case scenario) on message traffic is that every vote diffuses to every node.</li>
<li>Votes would likely be sent via a new mini-protocol very similar to how transactions are propagated:<!-- -->
<ul>
<li>The downstream peers request list of IDs from upstream peers</li>
<li>They select the ones they do not have in their &quot;mempools&quot; for download</li>
<li>When quorum is reached they stop downloading votes for given round</li>
</ul>
</li>
<li>Backpressure for a node&#x27;s receiving is necessary in order to mitigate DoS attacks that flood a node with votes.</li>
<li>Nodes that have large stake might be allotted several votes. Instead of sending one message per vote, these could be bundled as a message that indicates the number of votes cast.</li>
<li>Votes not recorded on the chain or in a certificate need to be kept by the node and persistently cached if the node is restarted. They might have to be provided to newly syncing nodes.</li>
</ul>
</li>
<li>It is relatively straightforward to know the size the votes mempool would take<!-- -->
<ul>
<li>The size of a vote is likely a couple of hundred bytes.</li>
<li>Votes have a TTL (parameter max. age <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">A</span></span></span></span> of the protocol) which implies there is a strict upper bound on the overall size of the votes mempool</li>
<li>There is also a cap on the number of votes per round (quorum parameter <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.1132em">τ</span></span></span></span>)</li>
<li>And it is always possible to trade a bunch of votes with a certificate representing those votes</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="certificates-1">Certificates<a href="#certificates-1" class="hash-link" aria-label="Direct link to Certificates" title="Direct link to Certificates">​</a></h3>
<p>Certificates (or equivalently quorum of votes in a round) have an impact on the chain selection process as they change the weight:</p>
<ul>
<li>Sending a certificate is equivalent to sending a quorum of votes.<!-- -->
<ul>
<li>Once a node sees a quorum, it can create and diffuse a certificate so it no longer needs to send any more votes for the round.</li>
<li>If non-quorum certificates were to obey monoid laws, then votes could be sent as singleton certificates that progressively aggregate votes towards a quorum. This use of non-quorum certificates would reduce message traffic.</li>
<li>If a certificate for every round is included on the chain, then newly started or syncing nodes need not request certificates or votes for rounds older than the last certificate recorded on the chain.</li>
<li>Certificates not recorded on the chain need to be kept by the node and persistently cached in case the node is restarted. They might have to be provided to newly syncing nodes.</li>
<li>The size of a certificate is likely a few thousand bytes or more</li>
<li>Conceptually, diffusion of certificates can be thought as similar to the diffusion of blocks as certificates are explicitly or implicitly chained together</li>
</ul>
</li>
<li>Certificates are likely too large to be included in the block header without increasing its size over the constitutionally-constrained byte limit.<!-- -->
<ul>
<li>If the CDDL for blocks were altered, they could be included as a new entry in the block.</li>
<li>Alternatively, a certificate could be stored as a transaction in the block. Such certificate-transactions would incur a fee and would also need to be prioritized ahead of transactions in the memory pool.</li>
</ul>
</li>
<li>At least conceptually, certificates are <em>fungible</em>: e.g. if I have certificate X for block A and a certificate Y for block B s.t. A extends B, then I can count the chain from B as having twice the weight which is equivalent to having a certificate <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo>=</mo><mi>X</mi><mo>∘</mo><mi>Y</mi></mrow><annotation encoding="application/x-tex">Z = X \circ Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.07153em">Z</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.07847em">X</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">∘</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.22222em">Y</span></span></span></span>.<!-- -->
<ul>
<li>This implies that an implementation could choose to merge certificates that are past some threshold, e.g. when enough weight has been accumulated the chances of chain fork are negligible, which would limit the storage requirements.</li>
<li>This needs to be validated by researchers and is highly dependent on the particular technology used to form certificates.</li>
</ul>
</li>
<li>Creating, and to a lesser extent validating, certificates could be relatively CPU intensive operations.<!-- -->
<ul>
<li>This means there is an interesting operational tradeoff between resources, CPU on one hand, and memory/network bandwidth on the other, that could be used by an implementation adaptively depending on the environment&#x27;s conditions: Share quorum of votes directly if there is no pressure on memory and network bandwidth, or spend CPU time to build certificates to reduce footprint.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="consensus">Consensus<a href="#consensus" class="hash-link" aria-label="Direct link to Consensus" title="Direct link to Consensus">​</a></h2>
<p>The node&#x27;s chain-selection algorithm will have to be modified to compute chain weight that includes the boosts from the certificates on the chain. It will also have to do bookkeeping on unrecorded votes and certificates and adjust the relevant data structures when a new preferred chain is selected.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a href="#resources" class="hash-link" aria-label="Direct link to Resources" title="Direct link to Resources">​</a></h2>
<p>Peras requires several new types of work by the node: votes and certificates must be created, diffused, persistently cached, and verified. CPU resources for creating a vote are on the order of those used by creating a signature. Verifying a vote likely will use resources similar to verifying the slot leadership of another node, since a similar VRF scheme is used for both voting and slot leadership. Resources for creating or verifying a certificate will depend upon the particular certification scheme selected, for example Approximate Lower Bounds. The burden of verifying votes might be lessened if the certificates containing them can be built incrementally and forwarded to downstream peers which will not have to re-verify the votes.</p>
<p>If certificates for each round are not stored permanently on the chain, then they will have to be persisted locally by each node. This has the drawback of making it impossible to verify the evolution of the chain without having the off-chain information about certificates.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementation-path">Implementation path<a href="#implementation-path" class="hash-link" aria-label="Direct link to Implementation path" title="Direct link to Implementation path">​</a></h2>
<p>The somewhat nice decoupling between the voting layer and the Nakamoto consensus layer, along with the fact that votes are only taken into account in bulk, e.g. when they form a quorum on some round, seems to make it possible to implement Peras in a way that does not impact too much consensus, and at very least in an incremental way.</p>
<ul>
<li>It might be possible to experiment with Peras using real nodes on a special-purpose testnet. Votes and certificates could be represented as ordinary transactions with well-known characteristics. A thread could be added to the node to create and verify votes and certificates. The node&#x27;s chain-selection code would have to communicate with that thread.</li>
<li>A dedicated votes and certificate management process could be built and run separately, with the node only periodically checking this process when it needs to decide upon chain selection. While this might not be acceptable on a real production network due to the added latency on a critical path, it might be good enough to experiment with Peras on a testnet.</li>
<li>The network protocol for diffusing votes bears a lot of similarity to the kind of network needed by <a href="https://hackmd.io/jwAdFPzZQj-llwfavl8Ahw" target="_blank" rel="noopener noreferrer">Mithril</a> on its path to increased decentralization, so the effort to develop those protocols could be shared.</li>
</ul>
<h1>Conclusion</h1>
<p>The analyses described in this report provides some evidence that the Peras protocol could be a viable addition to the Cardano blockchain, in that it would significantly speed settlement (or, more precisely, rapidly decrease settlement-failure probabilities) without burdening the nodes with substantial additional computational or bandwidth requirements. Feedback regarding early versions of the Peras protocol, which was untenable for efficient implementation, resulted in minor adjustments to the protocol which seem to make it more practical for deployment. The analyses were achieved via a combined program of formalization in Agda, network modeling using the ΔQ methodology, message-passing simulations in Haskell and Rust, and dynamic QuickCheck testing. An important byproduct of this work was the formulation and demonstration of a potentially reusable methodology that delivers a formal specification that is closely tied to a chain of evidence involving modeling, simulation, and conformance testing.</p>
<p>The foregoing analyses have quantified and reduced several risks related to adoption of Peras. In particular, the number and size of vote and certificate messages passing between nodes would not significantly impact a node&#x27;s performance or tax its bandwidth. Similarly, the size of the block headers would not be impacted by Peras, though some block bodies (one per voting round) would be several hundred bytes longer to accommodate a certificate that attests to a voting quorum having been achieved. The chain weight can be verified externally by examining the history of certificates attached to blocks, but following the current best chain would require a knowledge of the votes or certificates that had not yet been memorialized by inclusion of a certificate in a block: nodes would have to persistently cache such information, which would only require negligible memory and disk space.  Vote and certificate processing have some temporal flexibility, so their resource usage can be managed via backpressure and thread pools.</p>
<p>Several Peras-related risks remain. Primary is that the amount of adversarial stake required to repeatedly force the protocol into a cool-down period has not yet been quantified: the length of that cool-down period would be inversely proportional to the length of the round. Further research is warranted to study variants of the Peras protocol that would shrink the duration of cool-down, or eliminate it altogether, but without increasing the attack surface of the protocol. A related risk is that the settings for the Peras parameters have not been concretised: this would elucidate the tradeoff between rapidity of settlement versus vulnerability to adversarial stake or network disruptions. Committee size is a particularly important parameter to tune because it affects not only the resistance to adversarial conditions but also the network and computations resource burdens, and the size of certificates to be shared and stored. Other heretofore unmitigated risks relate to the computational burden on nodes. Specifically, the CPU resources required to construct and verify voting certificates can only be measured after the detailed algorithm for certificate construction has been specified.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="recommendations">Recommendations<a href="#recommendations" class="hash-link" aria-label="Direct link to Recommendations" title="Direct link to Recommendations">​</a></h2>
<p>The next steps for Peras center upon consolidating the findings of this technical report into a full specification for Peras with suitable level of detail and quantification for the drafting of a Cardano Improvement Proposal (CIP). The detail should be sufficient to subsequently write a request for proposals (RFP) that includes acceptance criteria for implementations. Concomitant with that would be an executable specification and QuickCheck Dynamic conformance tests for evaluating implementations: ideally, both would be directly derived from the Agda formulation of Peras. The executable specification could be packaged as a web-based, interactive simulator so that stakeholders can explore the behavior of Peras themselves and build intuition about the protocol. Such artifacts could play an important role in developing a unique value proposition for Peras.</p>
<p>Work on the Peras protocol highlighted three areas where co-evolving improved tooling would facilitate the full specification of the protocol and provide evidence for the business case for Peras&#x27;s adoption. Such improvements would lay the groundwork for rapid assessment of other proposed and future protocols.</p>
<p>First, numerically quantifying the tradeoffs in settlement time vs. resistance to adversaries as a function of the nine new parameters required for configuring Peras requires moderately detailed network simulation. Although work on Peras could continue down the path of elaborating the &quot;homegrown&quot; network simulations described in this document, the alternative approach would be to invest in a more general simulator of network mini-protocols. Such a simulation would operate at a higher level than the existing <code>netsim</code>, which currently emphasizes the routing of messages, but could be built upon it. In general, time management and representation of mini-protocols would be required in such a simulator. This recommendation reinforces the conclusions of the recent <em>Network Simulation Tools Comparison</em> document, which states &quot;We are now ready to extract these utility tools and combine them into a general-purpose framework so that the team and partners can utilize them and produce consistent output.&quot;</p>
<p>Second, polishing the ΔQ toolset via a few capability enhancements, calibrated default settings, improved documentation, and publication would enable a more rigorous analysis of Peras that stakeholders such as researchers, SPOs, and implementers could reproduce and use in studying Peras variants and other proposed protocols. The ΔQ software is already reasonably close to providing such capabilities, but needs some investment and refinement.</p>
<p>Third, the Peras work so far has highlighted the opportunity for co-design of an Agda DSL (domain-specific language) for specifying network consensus protocols in order to bridge the gap between research and implementation. Researchers could employ such a DSL to concretely express the core constructs of protocols, and prototyping teams can elaborate that into a formal specification along with the QuickCheck Dynamics tests that would verify conformance of implementations to that specification. This provides a tighter &quot;chain of evidence&quot; from the research papers defining a protocol into an implementable specification. The proof of principle in this Peras work can be generalized to support development of other consensus protocols and network definitions.</p>
<p>Finally, additional research may further improve the efficiency of the certificate schema by making the certificates monoidal (i.e., composable) or otherwise incremental. Safely shortening the cool-down period would also be highly advantageous.</p>
<h1>References</h1>
<ul>
<li><a href="https://docs.google.com/presentation/d/1QGCvDoOJIWug8jJgCNv3p9BZV-R8UZCyvosgNmN-lJU/edit?usp=sharing" target="_blank" rel="noopener noreferrer">Protocol overview</a> (April 2023)</li>
<li><a href="https://docs.google.com/document/d/1w_jHsojcBxZHgGrr63ZGa4nhkgEpkL6a2cFYiq8Vf8c/edit" target="_blank" rel="noopener noreferrer">Latest version of the algorithm</a> (March 2024)</li>
<li><a href="https://docs.google.com/document/d/1lywi65s1nQpAGgMpzPXD-sLzYNES-FZ8SHXF75VCKuI/edit#heading=h.dqvlvyqlb2s4" target="_blank" rel="noopener noreferrer">Post-workshop algorithm pseudocode</a> (November 2023)</li>
<li><a href="https://docs.google.com/document/d/1QMn1CqS4zSbKzvozhcAtc7MN_nMfVHhP25pMTxyhhZ8/edit#heading=h.8bsvt41k7bj1" target="_blank" rel="noopener noreferrer">Pre-workshop algorithm pseudocode</a> (November 2023)</li>
<li><a href="https://docs.google.com/document/d/1dv796m2Fc7WH38DNmGc68WOXnqtxj7F30o-kGzM4zKA/edit" target="_blank" rel="noopener noreferrer">Peras Workshop Report</a> (November 2023)</li>
<li><a href="https://docs.google.com/document/d/1PsmhCYlpSlkpICghog0vBWVTnWAdICuQT1khGZ_feec/edit#heading=h.wefcmsmvzoy5" target="_blank" rel="noopener noreferrer">Quick wins for settlement</a> (November 2023)</li>
<li><a href="https://docs.google.com/presentation/d/1eKkrFeQMKlCRQV72yR7xg_RzD8WHaM4jPtUh9rwsrR0/edit#slide=id.g27ebcf9a0c4_3_0" target="_blank" rel="noopener noreferrer">Peras presentation at CSM</a> (September 2023)</li>
<li><a href="https://eprint.iacr.org/2022/1571.pdf" target="_blank" rel="noopener noreferrer">Practical Settlement bounds for longest-chain consensus</a> (August 2023)</li>
<li><a href="https://input-output.atlassian.net/wiki/spaces/SID/pages/3829956994/Main+Chain+to+Sidechain+Finality+Improvement" target="_blank" rel="noopener noreferrer">Sidechains requirements for fast settlement</a> (April 2023)</li>
<li><a href="https://github.com/w3f/consensus/blob/master/pdf/grandpa.pdf" target="_blank" rel="noopener noreferrer">Polkadot&#x27;s Grandpa finality algorithm</a> (June 2020)</li>
<li><a href="https://eprint.iacr.org/2019/504" target="_blank" rel="noopener noreferrer">Afgjort: A Partially Synchronous Finality Layer for Blockchains</a> (November 2021)</li>
<li><a href="https://eprint.iacr.org/2017/913.pdf" target="_blank" rel="noopener noreferrer">Thunderella</a> (2017)</li>
<li><a href="https://arxiv.org/abs/2209.03255" target="_blank" rel="noopener noreferrer">Goldfish</a> (September 2022)</li>
<li><a href="https://arxiv.org/abs/2203.14711" target="_blank" rel="noopener noreferrer">Towards Formal Verification of HotStuff-based Byzantine Fault Tolerant Consensus in Agda</a> (March 2022)</li>
<li><a href="https://github.com/input-output-hk/ouroboros-high-assurance" target="_blank" rel="noopener noreferrer">Ouroboros High Assurance work</a></li>
<li><a href="https://docs.google.com/presentation/d/1xNgpC6ioIC4xM3Gn-LvFPZpw4onwAKNc-3EJY4GKEjs/edit#slide=id.p" target="_blank" rel="noopener noreferrer">Peras Project February Monthly demo</a> (February 2023)</li>
<li><a href="https://docs.google.com/presentation/d/1LZn1FhfbLH6rXtgxTvui1gz9yN0vT6NpmCrOdo2xnfo/edit#slide=id.g124655d21b1_2_509" target="_blank" rel="noopener noreferrer">Peras Project March Monthly demo</a> (March 2023)</li>
<li><a href="https://drive.google.com/file/d/1loxfRSv7q-TBM9f0Ch4Ap_SuBPOKk0uu/view?usp=sharing" target="_blank" rel="noopener noreferrer">Network Simulation Tools Comparison</a> (April 2024)</li>
<li><a href="https://iohk.io/en/research/library/papers/approximate-lower-bound-arguments/" target="_blank" rel="noopener noreferrer">Approximate Lower Bound Arguments (ALBA)</a> (May 2024)</li>
</ul>
<h1>Endnotes</h1>
<!-- -->
<section data-footnotes="true" class="footnotes"><h2 class="anchor anchorWithStickyNavbar_LWe7 sr-only" id="footnote-label">Footnotes<a href="#footnote-label" class="hash-link" aria-label="Direct link to Footnotes" title="Direct link to Footnotes">​</a></h2>
<ol>
<li id="user-content-fn-2">
<p>This data was kindly provided by <a href="https://www.linkedin.com/in/markus-gufler" target="_blank" rel="noopener noreferrer">Markus Gufler</a> <a href="#user-content-fnref-2" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">↩</a></p>
</li>
</ol>
</section></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/reports/tech-report-1.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/peras-design/docs/reports/cip"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Peras - Faster Settlement on Cardano</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/peras-design/docs/reports/tech-report-2"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Peras Technical Report #2</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#findings" class="table-of-contents__link toc-highlight">Findings</a><ul><li><a href="#product-wise" class="table-of-contents__link toc-highlight">Product-wise</a></li><li><a href="#process-wise" class="table-of-contents__link toc-highlight">Process-wise</a></li></ul></li><li><a href="#remaining-questions" class="table-of-contents__link toc-highlight">Remaining questions</a></li><li><a href="#peras-workshop" class="table-of-contents__link toc-highlight">Peras workshop</a><ul><li><a href="#questions-about-peras" class="table-of-contents__link toc-highlight">Questions about Peras</a></li><li><a href="#potential-experiments-for-peras" class="table-of-contents__link toc-highlight">Potential experiments for Peras</a></li><li><a href="#srl" class="table-of-contents__link toc-highlight">SRL</a></li></ul></li><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a><ul><li><a href="#certificates" class="table-of-contents__link toc-highlight">Certificates</a></li></ul></li><li><a href="#pseudo-code" class="table-of-contents__link toc-highlight">Pseudo-code</a></li><li><a href="#settlement-time" class="table-of-contents__link toc-highlight">Settlement time</a><ul><li><a href="#settlement-bounds-for-peras" class="table-of-contents__link toc-highlight">Settlement bounds for Peras</a></li></ul></li><li><a href="#agda-specification" class="table-of-contents__link toc-highlight">Agda specification</a><ul><li><a href="#domain-model" class="table-of-contents__link toc-highlight">Domain model</a></li><li><a href="#small-step-semantics" class="table-of-contents__link toc-highlight">Small-step semantics</a></li><li><a href="#proofs" class="table-of-contents__link toc-highlight">Proofs</a></li></ul></li><li><a href="#certificates-in-block-header" class="table-of-contents__link toc-highlight">Certificates in block header</a><ul><li><a href="#baseline---praos-δq-modeling" class="table-of-contents__link toc-highlight">Baseline - Praos ΔQ modeling</a></li><li><a href="#peras-δq-model---blocks" class="table-of-contents__link toc-highlight">Peras ΔQ model - blocks</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></li><li><a href="#votes--certificates-diffusion" class="table-of-contents__link toc-highlight">Votes &amp; certificates diffusion</a></li><li><a href="#impact-on-user-experience" class="table-of-contents__link toc-highlight">Impact on user experience</a><ul><li><a href="#model" class="table-of-contents__link toc-highlight">Model</a></li></ul></li><li><a href="#praos-properties" class="table-of-contents__link toc-highlight">Praos properties</a></li><li><a href="#peras-properties" class="table-of-contents__link toc-highlight">Peras properties</a></li><li><a href="#relating-test-model-to-formal-model" class="table-of-contents__link toc-highlight">Relating test model to formal model</a></li><li><a href="#haskell-based-simulation" class="table-of-contents__link toc-highlight">Haskell-based simulation</a><ul><li><a href="#design" class="table-of-contents__link toc-highlight">Design</a></li><li><a href="#experiments" class="table-of-contents__link toc-highlight">Experiments</a></li></ul></li><li><a href="#rust-based-simulation" class="table-of-contents__link toc-highlight">Rust-based simulation</a></li><li><a href="#overall-findings-from-simulation-studies" class="table-of-contents__link toc-highlight">Overall findings from simulation studies</a><ul><li><a href="#simulation-results" class="table-of-contents__link toc-highlight">Simulation results</a></li><li><a href="#simulation-experiments" class="table-of-contents__link toc-highlight">Simulation experiments</a></li><li><a href="#simulator-design" class="table-of-contents__link toc-highlight">Simulator design</a></li><li><a href="#integration-with-quickcheck-dynamic" class="table-of-contents__link toc-highlight">Integration with QuickCheck Dynamic</a></li></ul></li><li><a href="#networking" class="table-of-contents__link toc-highlight">Networking</a><ul><li><a href="#votes" class="table-of-contents__link toc-highlight">Votes</a></li><li><a href="#certificates-1" class="table-of-contents__link toc-highlight">Certificates</a></li></ul></li><li><a href="#consensus" class="table-of-contents__link toc-highlight">Consensus</a></li><li><a href="#resources" class="table-of-contents__link toc-highlight">Resources</a></li><li><a href="#implementation-path" class="table-of-contents__link toc-highlight">Implementation path</a></li><li><a href="#recommendations" class="table-of-contents__link toc-highlight">Recommendations</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/peras-design/">Documents</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/9EgySPJk" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/input-output-hk/peras-design/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/peras-design/weekly">Updates</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/peras-design" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 <strong>Input Output Global</strong> <br> <a href="https://static.iohk.io/terms/iog-privacy-policy.pdf" target="_blank" class="footer__link-item">Privacy Policy</a> | <a href="https://static.iohk.io/terms/iohktermsandconditions.pdf" target="_blank" class="footer__link-item">Terms & Conditions</a> <br> <small>Built with Docusaurus</small></div></div></div></footer></div>
</body>
</html>